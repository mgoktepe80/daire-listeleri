<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daire Se√ßim Listeleri</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style id="theme-style">
        /* Dropdown option'larƒ± i√ßin tema stilleri */
        select option {
            background-color: white !important;
            color: #111827 !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // ==========================================
        // FIREBASE YAPILANDIRMASI
        // ==========================================
        // ‚ö†Ô∏è √ñNEMLƒ∞: A≈üaƒüƒ±daki bilgileri kendi Firebase projenizden alƒ±n!
        // Firebase Console ‚Üí Project Settings ‚Üí Your apps ‚Üí Firebase SDK snippet
        
        /* 
        ==========================================
        üîê Fƒ∞REBASE G√úVENLƒ∞K KURALLARI (FIRESTORE)
        ==========================================
        Firebase Console ‚Üí Firestore Database ‚Üí Rules sekmesine a≈üaƒüƒ±daki kurallarƒ± yapƒ±≈ütƒ±rƒ±n:
        
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Kullanƒ±cƒ± kimlik doƒürulamasƒ± kontrol√º
            function isSignedIn() {
              return request.auth != null;
            }
            
            // Kullanƒ±cƒ± kendi verisine eri≈üiyor mu?
            function isOwner(userId) {
              return request.auth.uid == userId;
            }
            
            // Kullanƒ±cƒ± verisi - sadece kendi verisine eri≈üebilir
            match /users/{userId} {
              allow read, write: if isSignedIn() && isOwner(userId);
            }
            
            // Kullanƒ±cƒ± ayarlarƒ± (tema vb.) - sadece kendi ayarlarƒ±na eri≈üebilir
            match /userSettings/{userId} {
              allow read, write: if isSignedIn() && isOwner(userId);
            }
            
            // Diƒüer t√ºm eri≈üimler reddedilir
            match /{document=**} {
              allow read, write: if false;
            }
          }
        }
        
        ==========================================
        Bu kurallar:
        ‚úÖ Kullanƒ±cƒ±lar sadece kendi verilerine eri≈üebilir
        ‚úÖ Giri≈ü yapmadan veri okunamaz/yazƒ±lamaz
        ‚úÖ Kalƒ±cƒ± g√ºvenlik (s√ºre sƒ±nƒ±rƒ± yok)
        ‚úÖ Production-ready
        ==========================================
        */
        
        const firebaseConfig = {
            apiKey: "AIzaSyArx5M6zeXeAqYToThIIDwC3YNi8iWmd3Q",
            authDomain: "malzeme-takip-6e4d5.firebaseapp.com",
            projectId: "malzeme-takip-6e4d5",
            storageBucket: "malzeme-takip-6e4d5.firebasestorage.app",
            messagingSenderId: "473422973374",
            appId: "1:473422973374:web:f05b4573c9fcac19a511ef"
        };

        // Firebase'i ba≈ülat
        let db = null;
        let auth = null;
        let firebaseEnabled = false;
        
        try {
            // Firebase SDK y√ºkl√º m√º kontrol et
            if (typeof firebase === 'undefined') {
                console.log('‚ö†Ô∏è Firebase SDK y√ºklenemedi - sadece localStorage kullanƒ±lƒ±yor');
            } else if (firebaseConfig.apiKey !== "BURAYA_KENDI_API_KEY") {
                // Firebase'i ba≈ülat
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                firebaseEnabled = true;
                console.log('‚úÖ Firebase baƒülantƒ±sƒ± ba≈üarƒ±lƒ±!');
            } else {
                console.log('‚ö†Ô∏è Firebase yapƒ±landƒ±rmasƒ± eksik - sadece localStorage kullanƒ±lƒ±yor');
            }
        } catch (error) {
            console.error('‚ùå Firebase ba≈ülatma hatasƒ±:', error);
            console.log('‚ö†Ô∏è Sadece localStorage kullanƒ±lacak');
        }

        // ==========================================
        // AUTHENTICATION FONKSƒ∞YONLARI
        // ==========================================
        
        // Kullanƒ±cƒ± giri≈üi
        const signIn = async (email, password) => {
            if (!auth) return { success: false, error: 'Firebase yapƒ±landƒ±rƒ±lmamƒ±≈ü' };
            try {
                await auth.signInWithEmailAndPassword(email, password);
                return { success: true };
            } catch (error) {
                let errorMsg = 'Giri≈ü ba≈üarƒ±sƒ±z';
                if (error.code === 'auth/wrong-password') errorMsg = '≈ûifre yanlƒ±≈ü';
                else if (error.code === 'auth/user-not-found') errorMsg = 'Kullanƒ±cƒ± bulunamadƒ±';
                else if (error.code === 'auth/invalid-email') errorMsg = 'Ge√ßersiz email';
                return { success: false, error: errorMsg };
            }
        };

        // Kullanƒ±cƒ± kaydƒ±
        const signUp = async (email, password) => {
            if (!auth) return { success: false, error: 'Firebase yapƒ±landƒ±rƒ±lmamƒ±≈ü' };
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                return { success: true };
            } catch (error) {
                let errorMsg = 'Kayƒ±t ba≈üarƒ±sƒ±z';
                if (error.code === 'auth/email-already-in-use') errorMsg = 'Bu email zaten kullanƒ±mda';
                else if (error.code === 'auth/weak-password') errorMsg = '≈ûifre en az 6 karakter olmalƒ±';
                else if (error.code === 'auth/invalid-email') errorMsg = 'Ge√ßersiz email';
                return { success: false, error: errorMsg };
            }
        };

        // √áƒ±kƒ±≈ü yap
        const signOut = async () => {
            if (!auth) return;
            try {
                await auth.signOut();
            } catch (error) {
                console.error('√áƒ±kƒ±≈ü hatasƒ±:', error);
            }
        };

        // ≈ûifremi unuttum
        const resetPassword = async (email) => {
            if (!auth) return { success: false, error: 'Firebase yapƒ±landƒ±rƒ±lmamƒ±≈ü' };
            try {
                await auth.sendPasswordResetEmail(email);
                return { success: true };
            } catch (error) {
                let errorMsg = '≈ûifre sƒ±fƒ±rlama ba≈üarƒ±sƒ±z';
                if (error.code === 'auth/user-not-found') errorMsg = 'Bu email kayƒ±tlƒ± deƒüil';
                else if (error.code === 'auth/invalid-email') errorMsg = 'Ge√ßersiz email';
                return { success: false, error: errorMsg };
            }
        };

        // ==========================================
        // FIREBASE SYNC FONKSƒ∞YONLARI
        // ==========================================
        
        // Verileri Firebase'e kaydet
        const saveToFirebase = async (data) => {
            if (!firebaseEnabled || !db) return false;
            
            try {
                await db.collection('appData').doc('mainData').set({
                    ...data,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Firebase\'e kaydedildi');
                return true;
            } catch (error) {
                console.error('‚ùå Firebase kayƒ±t hatasƒ±:', error);
                return false;
            }
        };

        // Firebase'den verileri y√ºkle
        const loadFromFirebase = async () => {
            if (!firebaseEnabled || !db) return null;
            
            try {
                const doc = await db.collection('appData').doc('mainData').get();
                if (doc.exists) {
                    console.log('‚úÖ Firebase\'den y√ºklendi');
                    return doc.data();
                }
                return null;
            } catch (error) {
                console.error('‚ùå Firebase y√ºkleme hatasƒ±:', error);
                return null;
            }
        };

        // Ger√ßek zamanlƒ± senkronizasyon dinleyicisi
        const setupFirebaseListener = (callback) => {
            if (!firebaseEnabled || !db) return null;
            
            return db.collection('appData').doc('mainData').onSnapshot((doc) => {
                if (doc.exists) {
                    console.log('üîÑ Firebase\'den g√ºncelleme alƒ±ndƒ±');
                    callback(doc.data());
                }
            }, (error) => {
                console.error('‚ùå Firebase listener hatasƒ±:', error);
            });
        };

        // ==========================================
        // UYGULAMA KODLARI
        // ==========================================

        const DEFAULT_ROOMS = [
            { id: 'salon', name: 'Salon', fields: ['zemin', 'boya', 'foto'], editable: true, deletable: true },
            { id: 'mutfak', name: 'Mutfak', fields: ['zemin', 'boya', 'dolap_alt', 'dolap_ust', 'tezgah', 'panel', 'foto'], editable: true, deletable: true },
            { id: 'hol', name: 'Hol ve Antre', fields: ['zemin', 'boya', 'foto'], editable: true, deletable: true },
            { id: 'genel_banyo', name: 'Genel Banyo', fields: ['zemin', 'duvar_kaplama', 'lavabo', 'klozet', 'dus', 'batarya', 'ayna', 'foto'], editable: true, deletable: true },
            { id: 'ebeveyn_banyo', name: 'Ebeveyn Banyo', fields: ['zemin', 'duvar_kaplama', 'lavabo', 'klozet', 'dus', 'batarya', 'ayna', 'foto'], editable: true, deletable: true },
            { id: 'oda1', name: 'Oda-1', fields: ['zemin', 'boya', 'foto'], editable: true, deletable: true },
            { id: 'oda2', name: 'Oda-2', fields: ['zemin', 'boya', 'foto'], editable: true, deletable: true },
            { id: 'ebeveyn_oda', name: 'Ebeveyn Odasƒ±', fields: ['zemin', 'boya', 'foto'], editable: true, deletable: true }
        ];

        const DEFAULT_FIELD_LABELS = {
            zemin: { label: 'Zemin Kaplama', unit: 'm¬≤', category: 'Zemin' },
            boya: { label: 'Duvar Boya', unit: 'm¬≤', category: 'Boya' },
            dolap_alt: { label: 'Dolap Alt', unit: 'Adet', category: 'Dolap' },
            dolap_ust: { label: 'Dolap √úst', unit: 'Adet', category: 'Dolap' },
            tezgah: { label: 'Tezgah', unit: 'mt', category: 'Tezgah' },
            panel: { label: 'Panel', unit: 'm¬≤', category: 'Panel' },
            duvar_kaplama: { label: 'Duvar Kaplama', unit: 'm¬≤', category: 'Kaplama' },
            lavabo: { label: 'Lavabo', unit: 'Adet', category: 'Armat√ºr' },
            klozet: { label: 'Klozet', unit: 'Adet', category: 'Armat√ºr' },
            dus: { label: 'Du≈ü', unit: 'Adet', category: 'Armat√ºr' },
            batarya: { label: 'Batarya', unit: 'Adet', category: 'Armat√ºr' },
            ayna: { label: 'Ayna', unit: 'Adet', category: 'Aksesuar' },
            aydinlatma: { label: 'Aydƒ±nlatma', unit: 'Adet', category: 'Elektrik' },
            priz: { label: 'Priz', unit: 'Adet', category: 'Elektrik' },
            kapi: { label: 'Kapƒ±', unit: 'Adet', category: 'Doƒürama' },
            pencere: { label: 'Pencere', unit: 'Adet', category: 'Doƒürama' },
            perde: { label: 'Perde', unit: 'm', category: 'Tekstil' },
            tavan: { label: 'Tavan Kaplama', unit: 'm¬≤', category: 'Kaplama' },
            foto: { label: 'Fotoƒüraf', unit: '', category: 'Diƒüer' }
        };

        const DEFAULT_MATERIALS = {
            'Zemin': {
                'Seramik': ['60x60 Beyaz Seramik', '80x80 Gri Seramik', 'Mozaik Seramik'],
                'Parke': ['Laminat Parke Me≈üe', 'Laminat Parke Ceviz', 'Masif Parke'],
                'Granit': ['Siyah Granit', 'Beyaz Granit', 'Gri Granit'],
                'Mermer': ['Beyaz Mermer', 'Krem Mermer', 'Siyah Mermer']
            },
            'Boya': {
                'Saten': ['Beyaz Saten', 'Krem Saten', 'Gri Saten'],
                'Mat': ['Mat Beyaz', 'Mat Gri', 'Mat Bej'],
                'ƒ∞pek': ['ƒ∞pek Beyaz', 'ƒ∞pek Krem']
            },
            'Kaplama': {
                'Seramik': ['Beyaz Seramik 30x60', 'Gri Seramik 30x60', 'Mozaik'],
                'Ta≈ü': ['Doƒüal Ta≈ü', 'Traverten', 'K√ºlt√ºr Ta≈üƒ±']
            },
            'Dolap': {
                'Lake': ['Beyaz Lake', 'Gri Lake', 'Antrasit Lake'],
                'Ah≈üap': ['Me≈üe Kaplama', 'Ceviz Kaplama']
            },
            'Tezgah': {
                'Granit': ['Granit Siyah', 'Granit Beyaz'],
                'Mermer': ['Mermer Beyaz', 'Mermer Krem'],
                'Kompakt': ['Kompakt Beyaz', 'Kompakt Gri']
            },
            'Panel': {
                'Cam': ['Cam Panel Beyaz', 'Cam Panel Gri'],
                'Seramik': ['Seramik Panel']
            },
            'Armat√ºr': {
                'Krom': ['Standart Krom', 'Parlak Krom'],
                'Mat Siyah': ['Mat Siyah Batarya', 'Mat Siyah Du≈ü'],
                'Gold': ['Gold Batarya', 'Gold Du≈ü']
            },
            'Aksesuar': {
                'Ayna': ['Ayna 60x80', 'Ayna 80x100', 'LED Ayna'],
                'Raf': ['Cam Raf', 'Ah≈üap Raf']
            },
            'Elektrik': {
                'Aydƒ±nlatma': ['LED Spot', 'Avize', 'Aplik', '≈ûerit LED'],
                'Priz': ['Beyaz Priz', 'Gri Priz', 'USB\'li Priz']
            },
            'Doƒürama': {
                'PVC': ['Beyaz PVC', 'Gri PVC'],
                'Ah≈üap': ['Ah≈üap Kaplama', 'Masif Ah≈üap'],
                'Al√ºminyum': ['Beyaz Al√ºminyum', 'Gri Al√ºminyum']
            },
            'Tekstil': {
                'Perde': ['Blackout', 'T√ºl', 'Jaluzi'],
                'Stor': ['Zebra Stor', 'Rulo Stor']
            }
        };

        // ==========================================
        // LOGIN SCREEN COMPONENT
        // ==========================================
        
        function LoginScreen() {
            const [mode, setMode] = useState('login'); // 'login', 'signup', 'reset'
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setLoading(true);

                if (mode === 'login') {
                    const result = await signIn(email, password);
                    if (!result.success) {
                        setError(result.error);
                    }
                } else if (mode === 'signup') {
                    if (password.length < 6) {
                        setError('≈ûifre en az 6 karakter olmalƒ±');
                        setLoading(false);
                        return;
                    }
                    const result = await signUp(email, password);
                    if (result.success) {
                        setSuccess('Hesap olu≈üturuldu! Giri≈ü yapƒ±lƒ±yor...');
                    } else {
                        setError(result.error);
                    }
                } else if (mode === 'reset') {
                    const result = await resetPassword(email);
                    if (result.success) {
                        setSuccess('≈ûifre sƒ±fƒ±rlama linki email adresinize g√∂nderildi!');
                        setTimeout(() => setMode('login'), 2000);
                    } else {
                        setError(result.error);
                    }
                }

                setLoading(false);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        {/* Logo */}
                        <div className="text-center mb-8">
                            <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-full p-4 inline-block mb-4">
                                <svg className="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">Daire Se√ßim Listeleri</h1>
                            <p className="text-gray-600">
                                {mode === 'login' && 'Hesabƒ±nƒ±za giri≈ü yapƒ±n'}
                                {mode === 'signup' && 'Yeni hesap olu≈üturun'}
                                {mode === 'reset' && '≈ûifrenizi sƒ±fƒ±rlayƒ±n'}
                            </p>
                        </div>

                        {/* Error/Success Messages */}
                        {error && (
                            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2">
                                <svg className="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span className="text-red-800 text-sm">{error}</span>
                            </div>
                        )}
                        {success && (
                            <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2">
                                <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span className="text-green-800 text-sm">{success}</span>
                            </div>
                        )}

                        {/* Form */}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Email
                                </label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all"
                                    placeholder="ornek@email.com"
                                />
                            </div>

                            {mode !== 'reset' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        ≈ûifre
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    />
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? (
                                    <span className="flex items-center justify-center gap-2">
                                        <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>ƒ∞≈üleniyor...</span>
                                    </span>
                                ) : (
                                    <>
                                        {mode === 'login' && 'Giri≈ü Yap'}
                                        {mode === 'signup' && 'Hesap Olu≈ütur'}
                                        {mode === 'reset' && '≈ûifre Sƒ±fƒ±rlama Linki G√∂nder'}
                                    </>
                                )}
                            </button>
                        </form>

                        {/* Mode Switch */}
                        <div className="mt-6 text-center space-y-2">
                            {mode === 'login' && (
                                <>
                                    <button
                                        onClick={() => setMode('reset')}
                                        className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                                    >
                                        ≈ûifremi unuttum
                                    </button>
                                    <div className="text-gray-600 text-sm">
                                        Hesabƒ±nƒ±z yok mu?{' '}
                                        <button
                                            onClick={() => setMode('signup')}
                                            className="text-blue-600 hover:text-blue-800 font-medium"
                                        >
                                            Kayƒ±t olun
                                        </button>
                                    </div>
                                </>
                            )}
                            {mode === 'signup' && (
                                <div className="text-gray-600 text-sm">
                                    Zaten hesabƒ±nƒ±z var mƒ±?{' '}
                                    <button
                                        onClick={() => setMode('login')}
                                        className="text-blue-600 hover:text-blue-800 font-medium"
                                    >
                                        Giri≈ü yapƒ±n
                                    </button>
                                </div>
                            )}
                            {mode === 'reset' && (
                                <button
                                    onClick={() => setMode('login')}
                                    className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                                >
                                    ‚Üê Giri≈ü sayfasƒ±na d√∂n
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // MAIN APP COMPONENT
        // ==========================================

        function App() {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [projects, setProjects] = useState([{ id: 1, name: 'Proje 1', apartments: [{ id: 1, name: 'Daire 1', data: {}, wallCount: {} }] }]);
            const [currentPrj, setCurrentPrj] = useState(1);
            const [currentApt, setCurrentApt] = useState(1);
            const [currentRoom, setCurrentRoom] = useState('salon');
            const [customRooms, setCustomRooms] = useState([]);
            const [baseRooms, setBaseRooms] = useState(DEFAULT_ROOMS);
            const [roomOrder, setRoomOrder] = useState([]);
            const [fieldLabels, setFieldLabels] = useState(DEFAULT_FIELD_LABELS);
            const [materials, setMaterials] = useState(DEFAULT_MATERIALS);
            const [showDB, setShowDB] = useState(false);
            const [activeDBTab, setActiveDBTab] = useState('Zemin');
            const [draggedTab, setDraggedTab] = useState(null);
            const [searchRoom, setSearchRoom] = useState('');
            const [searchMaterial, setSearchMaterial] = useState('');
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
            const [showMaterialAnalysis, setShowMaterialAnalysis] = useState(false);
            const [activeAnalysisTab, setActiveAnalysisTab] = useState('T√ºm√º');
            const [showCopyModal, setShowCopyModal] = useState(false);
            const [copyOptions, setCopyOptions] = useState({
                rooms: true,
                materials: true,
                amounts: true,
                photos: false
            });
            const [copyCount, setCopyCount] = useState(1); // Ka√ß adet kopyalanacak
            const [showCopyAmountsModal, setShowCopyAmountsModal] = useState(false);
            const [sourceAptForAmounts, setSourceAptForAmounts] = useState(null);
            const [selectedFieldsForCopy, setSelectedFieldsForCopy] = useState({});
            const [showFieldManager, setShowFieldManager] = useState(false);
            const [autoBackupEnabled, setAutoBackupEnabled] = useState(false);
            const [lastBackupDate, setLastBackupDate] = useState(null);
            const [backupInterval, setBackupInterval] = useState(7);
            const [lightbox, setLightbox] = useState(null);
            const [firebaseSync, setFirebaseSync] = useState(firebaseEnabled);
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const [firebaseStatus, setFirebaseStatus] = useState({ connected: firebaseEnabled, message: '', type: 'connected' });

            // Authentication durumunu dinle
            useEffect(() => {
                if (!auth) {
                    setAuthLoading(false);
                    return;
                }
                
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    setUser(user);
                    setAuthLoading(false);
                    if (user) {
                        console.log('‚úÖ Kullanƒ±cƒ± giri≈ü yaptƒ±:', user.email);
                    } else {
                        console.log('‚ùå Kullanƒ±cƒ± √ßƒ±kƒ±≈ü yaptƒ±');
                    }
                });
                
                return () => unsubscribe();
            }, []);

            // Tema y√ºklendiƒüinde CSS g√ºncelle
            useEffect(() => {
                const themeStyle = document.getElementById('theme-style');
                if (themeStyle) {
                    if (theme === 'dark') {
                        themeStyle.innerHTML = `
                            select option {
                                background-color: #374151 !important;
                                color: #f3f4f6 !important;
                            }
                        `;
                    } else {
                        themeStyle.innerHTML = `
                            select option {
                                background-color: white !important;
                                color: #111827 !important;
                            }
                        `;
                    }
                }
            }, [theme]);

            // ƒ∞lk y√ºkleme - Firebase varsa sadece oradan, yoksa localStorage'dan y√ºkle
            useEffect(() => {
                const loadData = async () => {
                    // Firebase aktif ve kullanƒ±cƒ± giri≈ü yapmƒ±≈üsa, √∂nce Firebase'den y√ºkle
                    if (firebaseEnabled && user) {
                        console.log('üî• Firebase aktif - veriler Firebase\'den y√ºkleniyor...');
                        setFirebaseStatus({ connected: true, message: 'Firebase\'den veriler y√ºkleniyor...', type: 'loading' });
                        
                        try {
                            const firebaseData = await loadFromFirebase();
                            if (firebaseData) {
                                if (firebaseData.projects) setProjects(firebaseData.projects);
                                if (firebaseData.customRooms) setCustomRooms(firebaseData.customRooms);
                                if (firebaseData.baseRooms) setBaseRooms(firebaseData.baseRooms);
                                if (firebaseData.fieldLabels) setFieldLabels(firebaseData.fieldLabels);
                                if (firebaseData.roomOrder) setRoomOrder(firebaseData.roomOrder);
                                if (firebaseData.materials) setMaterials(firebaseData.materials);
                                const firebaseTimestamp = firebaseData.lastUpdate?.toMillis() || Date.now();
                                setLastSyncTime(new Date(firebaseTimestamp));
                                console.log('‚úÖ Firebase\'den veri y√ºkleme tamamlandƒ±');
                                setFirebaseStatus({ connected: true, message: '', type: 'connected' });
                            } else {
                                console.log('‚ö†Ô∏è Firebase\'de veri bulunamadƒ±, varsayƒ±lan veriler kullanƒ±lƒ±yor');
                                setFirebaseStatus({ connected: true, message: 'Firebase\'de veri bulunamadƒ±', type: 'warning' });
                                setTimeout(() => setFirebaseStatus({ connected: true, message: '', type: 'connected' }), 3000);
                            }
                        } catch (error) {
                            console.error('‚ùå Firebase veri y√ºkleme hatasƒ±:', error);
                            setFirebaseStatus({ connected: false, message: 'Firebase baƒülantƒ± hatasƒ±! Yerel veriler kullanƒ±lƒ±yor.', type: 'error' });
                            
                            // Hata durumunda localStorage'dan y√ºkle
                            const saved = localStorage.getItem('projects_data');
                            if (saved) {
                                const loaded = JSON.parse(saved);
                                setProjects(loaded);
                                if (loaded[0] && loaded[0].apartments[0]) setCurrentApt(loaded[0].apartments[0].id);
                            }
                            const savedRooms = localStorage.getItem('custom_rooms');
                            if (savedRooms) setCustomRooms(JSON.parse(savedRooms));
                            const savedBaseRooms = localStorage.getItem('base_rooms');
                            if (savedBaseRooms) setBaseRooms(JSON.parse(savedBaseRooms));
                            const savedFieldLabels = localStorage.getItem('field_labels');
                            if (savedFieldLabels) setFieldLabels(JSON.parse(savedFieldLabels));
                            const savedRoomOrder = localStorage.getItem('room_order');
                            if (savedRoomOrder) setRoomOrder(JSON.parse(savedRoomOrder));
                            const savedMat = localStorage.getItem('material_database');
                            if (savedMat) setMaterials(JSON.parse(savedMat));
                        }
                        
                        // Kullanƒ±cƒ± ayarlarƒ±nƒ± y√ºkle (tema tercihi)
                        if (db) {
                            try {
                                const userSettingsDoc = await db.collection('userSettings').doc(user.uid).get();
                                if (userSettingsDoc.exists) {
                                    const settings = userSettingsDoc.data();
                                    if (settings.theme) {
                                        setTheme(settings.theme);
                                        console.log('‚úÖ Tema tercihi Firebase\'den y√ºklendi:', settings.theme);
                                    }
                                }
                            } catch (error) {
                                console.error('‚ùå Tema Firebase\'den y√ºklenemedi:', error);
                            }
                        }
                    } else {
                        // Firebase yoksa localStorage'dan y√ºkle
                        console.log('üíæ Firebase devre dƒ±≈üƒ± - veriler localStorage\'dan y√ºkleniyor...');
                        setFirebaseStatus({ connected: false, message: '√áevrimdƒ±≈üƒ± mod - Yerel veriler kullanƒ±lƒ±yor', type: 'warning' });
                        setTimeout(() => setFirebaseStatus({ connected: false, message: '', type: 'offline' }), 3000);
                        
                        const saved = localStorage.getItem('projects_data');
                        if (saved) {
                            const loaded = JSON.parse(saved);
                            setProjects(loaded);
                            if (loaded[0] && loaded[0].apartments[0]) setCurrentApt(loaded[0].apartments[0].id);
                        }
                        const savedRooms = localStorage.getItem('custom_rooms');
                        if (savedRooms) setCustomRooms(JSON.parse(savedRooms));
                        
                        const savedBaseRooms = localStorage.getItem('base_rooms');
                        if (savedBaseRooms) setBaseRooms(JSON.parse(savedBaseRooms));
                        
                        const savedFieldLabels = localStorage.getItem('field_labels');
                        if (savedFieldLabels) setFieldLabels(JSON.parse(savedFieldLabels));
                        
                        const savedRoomOrder = localStorage.getItem('room_order');
                        if (savedRoomOrder) setRoomOrder(JSON.parse(savedRoomOrder));
                        
                        const savedMat = localStorage.getItem('material_database');
                        if (savedMat) setMaterials(JSON.parse(savedMat));
                        
                        // Otomatik yedekleme ayarlarƒ±nƒ± y√ºkle
                        const savedAutoBackup = localStorage.getItem('auto_backup_enabled');
                        if (savedAutoBackup === 'true') setAutoBackupEnabled(true);
                        
                        const savedLastBackup = localStorage.getItem('last_backup_date');
                        if (savedLastBackup) setLastBackupDate(new Date(savedLastBackup));
                        
                        const savedBackupInterval = localStorage.getItem('backup_interval');
                        if (savedBackupInterval) setBackupInterval(parseInt(savedBackupInterval));
                    }
                };
                
                loadData();
                
                const handleEsc = (e) => { if (e.key === 'Escape') setLightbox(null); };
                document.addEventListener('keydown', handleEsc);
                
                // Number input'larda mouse scroll'u engelle
                const preventNumberScroll = (e) => {
                    if (e.target.type === 'number') {
                        e.preventDefault();
                    }
                };
                document.addEventListener('wheel', preventNumberScroll, { passive: false });
                
                return () => {
                    document.removeEventListener('keydown', handleEsc);
                    document.removeEventListener('wheel', preventNumberScroll);
                };
            }, []);

            // Firebase ger√ßek zamanlƒ± senkronizasyon
            useEffect(() => {
                if (!firebaseSync || !firebaseEnabled || !user) return;
                
                console.log('üëÇ Firebase ger√ßek zamanlƒ± dinleyici ba≈ülatƒ±ldƒ±');
                let isFirstLoad = true;
                let lastLocalUpdateTime = Date.now();
                
                const unsubscribe = setupFirebaseListener((data) => {
                    // ƒ∞lk y√ºklemeyi atla (sayfa y√ºklenirken tetiklenir)
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        lastLocalUpdateTime = data.lastUpdate?.toMillis() || Date.now();
                        console.log('üìù ƒ∞lk Firebase dinleyici tetiklemesi (atlandƒ±)');
                        return;
                    }
                    
                    const firebaseTimestamp = data.lastUpdate?.toMillis() || Date.now();
                    
                    // Sadece Firebase daha yeni ise g√ºncelle (kendi deƒüi≈üikliklerimizi atla)
                    if (firebaseTimestamp > lastLocalUpdateTime + 1000) { // 1 saniye tolerans
                        console.log('üîÑ Ba≈üka cihazdan g√ºncelleme alƒ±ndƒ±');
                        if (data.projects) setProjects(data.projects);
                        if (data.customRooms) setCustomRooms(data.customRooms);
                        if (data.baseRooms) setBaseRooms(data.baseRooms);
                        if (data.fieldLabels) setFieldLabels(data.fieldLabels);
                        if (data.roomOrder) setRoomOrder(data.roomOrder);
                        if (data.materials) setMaterials(data.materials);
                        lastLocalUpdateTime = firebaseTimestamp;
                        setLastSyncTime(new Date(firebaseTimestamp));
                        
                        // Ge√ßici bildirim g√∂ster
                        setFirebaseStatus({ connected: true, message: 'Ba≈üka cihazdan g√ºncelleme alƒ±ndƒ±', type: 'success' });
                        setTimeout(() => setFirebaseStatus({ connected: true, message: '', type: 'connected' }), 3000);
                    } else {
                        console.log('üìù Kendi deƒüi≈üikliƒüimiz veya eski veri (atlandƒ±)');
                    }
                });
                
                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, [firebaseSync, user]);
            
            // NOT: Otomatik kaydetme devre dƒ±≈üƒ± - sonsuz d√∂ng√º engellendi
            // Kullanƒ±cƒ± "Kaydet" butonuna basmalƒ± veya manuel kaydetme yapƒ±lmalƒ±

            const getProject = () => projects.find(p => p.id === currentPrj) || projects[0];
            
            // Daireleri doƒüal sƒ±ralama ile sƒ±rala (Daire 1, Daire 2, Daire 25, Daire 26...)
            const apartments = [...(getProject().apartments || [])].sort((a, b) => {
                return a.name.localeCompare(b.name, 'tr', { numeric: true, sensitivity: 'base' });
            });
            
            const getApt = () => apartments.find(a => a.id === currentApt) || apartments[0];
            const getRoomData = () => (getApt().data[currentRoom] || {});

            // Her daire i√ßin g√∂r√ºn√ºr mekanlarƒ± filtrele ve sƒ±rala
            const allRoomsUnsorted = [...baseRooms, ...customRooms];
            const allRooms = roomOrder.length > 0 
                ? roomOrder.map(id => allRoomsUnsorted.find(r => r.id === id)).filter(r => r)
                    .concat(allRoomsUnsorted.filter(r => !roomOrder.includes(r.id)))
                : allRoomsUnsorted;
            const visibleRooms = allRooms.filter(room => {
                const apt = getApt();
                const hiddenRooms = apt.hiddenRooms || [];
                return !hiddenRooms.includes(room.id);
            });

            const updateProjects = (newProjects) => setProjects(newProjects);
            const updateApartments = (newApts) => {
                setProjects(projects.map(p => p.id === currentPrj ? { ...p, apartments: newApts } : p));
            };

            const save = async () => {
                // Firebase aktifse √∂nce oraya kaydet
                if (firebaseSync && firebaseEnabled && user) {
                    console.log('üî• Veriler Firebase\'e kaydediliyor...');
                    const success = await saveToFirebase({
                        projects,
                        customRooms,
                        baseRooms,
                        roomOrder,
                        fieldLabels,
                        materials
                    });
                    
                    if (success) {
                        const now = Date.now();
                        setLastSyncTime(new Date(now));
                        setFirebaseStatus({ connected: true, message: '', type: 'connected' });
                        // Yedek olarak localStorage'a da kaydet
                        localStorage.setItem('projects_data', JSON.stringify(projects));
                        localStorage.setItem('custom_rooms', JSON.stringify(customRooms));
                        localStorage.setItem('base_rooms', JSON.stringify(baseRooms));
                        localStorage.setItem('room_order', JSON.stringify(roomOrder));
                        localStorage.setItem('field_labels', JSON.stringify(fieldLabels));
                        localStorage.setItem('material_database', JSON.stringify(materials));
                        alert('‚úÖ Kaydedildi!\n\n‚òÅÔ∏è Firebase: Ba≈üarƒ±lƒ±\nüíæ Yerel yedek: Olu≈üturuldu');
                    } else {
                        // Firebase ba≈üarƒ±sƒ±z, localStorage'a kaydet
                        localStorage.setItem('projects_data', JSON.stringify(projects));
                        localStorage.setItem('custom_rooms', JSON.stringify(customRooms));
                        localStorage.setItem('base_rooms', JSON.stringify(baseRooms));
                        localStorage.setItem('room_order', JSON.stringify(roomOrder));
                        localStorage.setItem('field_labels', JSON.stringify(fieldLabels));
                        localStorage.setItem('material_database', JSON.stringify(materials));
                        alert('‚ö†Ô∏è Kaydedildi!\n\n‚òÅÔ∏è Firebase: Baƒülantƒ± hatasƒ±\nüíæ Yerel: Ba≈üarƒ±lƒ± (yedek)');
                    }
                } else {
                    // Firebase yoksa localStorage'a kaydet
                    console.log('üíæ Veriler localStorage\'a kaydediliyor...');
                    localStorage.setItem('projects_data', JSON.stringify(projects));
                    localStorage.setItem('custom_rooms', JSON.stringify(customRooms));
                    localStorage.setItem('base_rooms', JSON.stringify(baseRooms));
                    localStorage.setItem('room_order', JSON.stringify(roomOrder));
                    localStorage.setItem('field_labels', JSON.stringify(fieldLabels));
                    localStorage.setItem('material_database', JSON.stringify(materials));
                    alert('‚úÖ Kaydedildi!\n\nüíæ Yerel: Ba≈üarƒ±lƒ±');
                }
                
                // Otomatik yedekleme kontrol√º
                setTimeout(checkAutoBackup, 500);
            };

            // Metin formatƒ±nƒ± d√∂n√º≈üt√ºr: ilk harf B√úY√úK, diƒüerleri k√º√ß√ºk
            const convertAllText = () => {
                if (!confirm('T√úM METƒ∞NLERƒ∞ ve MALZEME VERƒ∞TABANINI d√∂n√º≈üt√ºrmek istediƒüinize emin misiniz?\n\nFormat: "ƒ∞lk Harf B√ºy√ºk diƒüerleri k√º√ß√ºk"\n\n√ñrnek: "VB - NOCTURNE BEYAZ 60X120" ‚Üí "Vb - Nocturne Beyaz 60x120"\n\nHem veri giri≈üleri hem de malzeme veritabanƒ± g√ºncellenecek!\n\nBu i≈ülem GERƒ∞ ALINAMAZ!')) {
                    return;
                }
                
                const convertText = (text) => {
                    if (!text || typeof text !== 'string') return text;
                    
                    // Kelimeleri b√∂l
                    const words = text.split(' ');
                    
                    // Her kelimeyi d√∂n√º≈üt√ºr: ilk harf B√úY√úK, diƒüerleri k√º√ß√ºk
                    const converted = words.map(word => {
                        if (word.length === 0) return word;
                        if (word.length === 1) return word.toUpperCase();
                        
                        // ƒ∞lk karakter B√úY√úK, diƒüerleri k√º√ß√ºk
                        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                    });
                    
                    return converted.join(' ');
                };
                
                // 1. MALZEME VERƒ∞TABANINI D√ñN√ú≈ûT√úR
                const convertedMaterials = {};
                Object.keys(materials).forEach(category => {
                    const categoryData = materials[category];
                    
                    // Hiyerar≈üik yapƒ± mƒ± (alt gruplar var mƒ±)?
                    if (typeof categoryData === 'object' && !Array.isArray(categoryData)) {
                        // Alt gruplu yapƒ±
                        convertedMaterials[category] = {};
                        Object.keys(categoryData).forEach(subgroup => {
                            const convertedSubgroup = convertText(subgroup);
                            const malzemeList = categoryData[subgroup];
                            
                            // Malzemeleri d√∂n√º≈üt√ºr
                            convertedMaterials[category][convertedSubgroup] = malzemeList.map(m => convertText(m));
                        });
                    } else if (Array.isArray(categoryData)) {
                        // D√ºz liste
                        convertedMaterials[category] = categoryData.map(m => convertText(m));
                    } else {
                        // Diƒüer tipler
                        convertedMaterials[category] = categoryData;
                    }
                });
                
                // 2. VERƒ∞ Gƒ∞Rƒ∞≈ûLERƒ∞Nƒ∞ D√ñN√ú≈ûT√úR
                const updatedProjects = projects.map(proj => ({
                    ...proj,
                    apartments: proj.apartments.map(apt => {
                        const newData = {};
                        
                        // Her mekanƒ±n verilerini d√∂n√º≈üt√ºr
                        Object.keys(apt.data).forEach(roomId => {
                            const roomData = apt.data[roomId];
                            const convertedRoomData = {};
                            
                            Object.keys(roomData).forEach(fieldKey => {
                                const fieldValue = roomData[fieldKey];
                                
                                // Fotoƒüraf alanƒ±nƒ± atla
                                if (fieldKey === 'foto') {
                                    convertedRoomData[fieldKey] = fieldValue;
                                    return;
                                }
                                
                                // Duvar kaplama (object i√ßinde object)
                                if (fieldKey === 'duvar_kaplama' && typeof fieldValue === 'object') {
                                    const convertedWalls = {};
                                    Object.keys(fieldValue).forEach(wallIdx => {
                                        const wall = fieldValue[wallIdx];
                                        convertedWalls[wallIdx] = {
                                            ...wall,
                                            subgroup: wall.subgroup ? convertText(wall.subgroup) : wall.subgroup,
                                            malzeme: wall.malzeme ? convertText(wall.malzeme) : wall.malzeme
                                        };
                                    });
                                    convertedRoomData[fieldKey] = convertedWalls;
                                }
                                // Normal alanlar (object: {subgroup, malzeme, miktar})
                                else if (fieldValue && typeof fieldValue === 'object' && !Array.isArray(fieldValue)) {
                                    convertedRoomData[fieldKey] = {
                                        ...fieldValue,
                                        subgroup: fieldValue.subgroup ? convertText(fieldValue.subgroup) : fieldValue.subgroup,
                                        malzeme: fieldValue.malzeme ? convertText(fieldValue.malzeme) : fieldValue.malzeme
                                    };
                                }
                                // Diƒüer tipler (string veya number)
                                else {
                                    convertedRoomData[fieldKey] = fieldValue;
                                }
                            });
                            
                            newData[roomId] = convertedRoomData;
                        });
                        
                        return { ...apt, data: newData };
                    })
                }));
                
                // 3. STATE'LERƒ∞ G√úNCELLE
                setMaterials(convertedMaterials);
                setProjects(updatedProjects);
                
                // 4. LOCALSTORAGE'A KAYDET
                localStorage.setItem('material_database', JSON.stringify(convertedMaterials));
                localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                
                alert('‚úÖ T√ºm metinler d√∂n√º≈üt√ºr√ºld√º!\n\n"ƒ∞lk Harf B√ºy√ºk diƒüerleri k√º√ß√ºk" formatƒ± uygulandƒ±.\n\nüì¶ Malzeme veritabanƒ± g√ºncellendi\nüìù Veri giri≈üleri g√ºncellendi');
            };

            // Drag & Drop fonksiyonlarƒ±
            const [draggedRoom, setDraggedRoom] = useState(null);

            const handleDragStart = (e, roomId) => {
                setDraggedRoom(roomId);
                e.dataTransfer.effectAllowed = 'move';
                e.currentTarget.style.opacity = '0.4';
            };

            const handleDragEnd = (e) => {
                e.currentTarget.style.opacity = '1';
                setDraggedRoom(null);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, targetRoomId) => {
                e.preventDefault();
                if (!draggedRoom || draggedRoom === targetRoomId) return;

                const visibleRoomIds = visibleRooms.map(r => r.id);
                const draggedIndex = visibleRoomIds.indexOf(draggedRoom);
                const targetIndex = visibleRoomIds.indexOf(targetRoomId);

                if (draggedIndex === -1 || targetIndex === -1) return;

                // Yeni sƒ±ralama olu≈ütur
                const newOrder = [...visibleRoomIds];
                newOrder.splice(draggedIndex, 1);
                newOrder.splice(targetIndex, 0, draggedRoom);

                setRoomOrder(newOrder);
                localStorage.setItem('room_order', JSON.stringify(newOrder));
            };

            const resetRoomOrder = () => {
                if (confirm('Mekan sƒ±ralamasƒ±nƒ± varsayƒ±lana d√∂nd√ºrmek istediƒüinize emin misiniz?')) {
                    setRoomOrder([]);
                    localStorage.removeItem('room_order');
                    alert('Sƒ±ralama sƒ±fƒ±rlandƒ±!');
                }
            };

            // Otomatik Yedekleme Fonksiyonlarƒ±
            const createBackup = (autoMode = false) => {
                const data = {
                    projects,
                    customRooms,
                    baseRooms,
                    roomOrder,
                    fieldLabels,
                    materials,
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                // Genel dosya adƒ±: malzeme_yedek_2026-01-24_14-30-45.json
                const date = new Date();
                const dateStr = date.toISOString().slice(0, 10); // 2026-01-24
                const timeStr = date.toTimeString().slice(0, 8).replace(/:/g, '-'); // 14-30-45
                const fileName = 'malzeme_yedek_' + dateStr + '_' + timeStr + '.json';
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();
                URL.revokeObjectURL(link.href);

                // Son yedek tarihini kaydet
                const now = new Date();
                setLastBackupDate(now);
                localStorage.setItem('last_backup_date', now.toISOString());

                if (!autoMode) {
                    alert('‚úÖ Yedek olu≈üturuldu!\n\nüìÅ Dosya: ' + fileName + '\nüìÇ Konum: ƒ∞ndirilenler klas√∂r√º');
                }
            };

            const checkAutoBackup = () => {
                if (!autoBackupEnabled) return;
                if (!lastBackupDate) {
                    // ƒ∞lk yedek
                    if (confirm('üîî Otomatik yedekleme a√ßƒ±k!\n\nƒ∞lk yedeƒüinizi almak ister misiniz?')) {
                        createBackup(true);
                    }
                    return;
                }

                const daysSinceBackup = (new Date() - lastBackupDate) / (1000 * 60 * 60 * 24);
                if (daysSinceBackup >= backupInterval) {
                    if (confirm('üîî Yedekleme Zamanƒ±!\n\nSon yedeƒüiniz ' + Math.floor(daysSinceBackup) + ' g√ºn √∂nce alƒ±ndƒ±.\n\n≈ûimdi yedek almak ister misiniz?')) {
                        createBackup(true);
                    }
                }
            };

            const toggleAutoBackup = () => {
                const newState = !autoBackupEnabled;
                setAutoBackupEnabled(newState);
                localStorage.setItem('auto_backup_enabled', newState);
                
                if (newState) {
                    alert('‚úÖ Otomatik yedekleme aktif!\n\nüìÖ Sƒ±klƒ±k: Her ' + backupInterval + ' g√ºnde bir\nüîî Size hatƒ±rlatma g√∂ndereceƒüiz');
                } else {
                    alert('‚ùå Otomatik yedekleme kapatƒ±ldƒ±');
                }
            };

            const updateBackupInterval = (days) => {
                setBackupInterval(days);
                localStorage.setItem('backup_interval', days);
            };

            // Sayfa y√ºklendiƒüinde ve her saatte bir kontrol et
            React.useEffect(() => {
                checkAutoBackup();
                const interval = setInterval(checkAutoBackup, 60 * 60 * 1000); // Her saat
                return () => clearInterval(interval);
            }, [autoBackupEnabled, lastBackupDate, backupInterval]);

            const addField = () => {
                const id = prompt('Alan ID (kucuk harf, bosluksuz, ornek: mutfak_dolabi):');
                if (!id || !id.trim()) return;
                const fieldId = id.trim().toLowerCase().replace(/\s+/g, '_');
                
                if (fieldLabels[fieldId]) {
                    alert('Bu ID zaten mevcut!');
                    return;
                }
                
                const label = prompt('Alan Adi (ornek: Mutfak Dolabƒ±):');
                if (!label || !label.trim()) return;
                
                const unit = prompt('Birim (m¬≤, Adet, mt, vb.) - OPSIYONEL, bos birakilabilir:');
                
                const category = prompt('Kategori (ornek: Dolap, Armat√ºr, Elektrik):');
                if (!category || !category.trim()) return;
                
                const newFieldLabels = {
                    ...fieldLabels,
                    [fieldId]: {
                        label: label.trim(),
                        unit: unit ? unit.trim() : '',
                        category: category.trim()
                    }
                };
                
                setFieldLabels(newFieldLabels);
                localStorage.setItem('field_labels', JSON.stringify(newFieldLabels));
                
                // Kategoriye malzeme veritabanƒ± ekle
                if (!materials[category.trim()]) {
                    const newMaterials = { ...materials, [category.trim()]: [] };
                    setMaterials(newMaterials);
                    localStorage.setItem('material_database', JSON.stringify(newMaterials));
                }
                
                alert('Alan eklendi!\n\nID: ' + fieldId + '\nAd: ' + label.trim() + '\nBirim: ' + (unit ? unit.trim() : '(Yok)') + '\nKategori: ' + category.trim());
            };

            const deleteField = (fieldId) => {
                if (fieldId === 'foto') {
                    alert('Fotograf alani silinemez!');
                    return;
                }
                
                if (confirm('Bu alani silmek istediginize emin misiniz?\n\nAlan ID: ' + fieldId + '\nAd: ' + fieldLabels[fieldId].label + '\n\nBu alan t√ºm mekanlardan kaldƒ±rƒ±lacaktƒ±r!')) {
                    // fieldLabels'dan sil
                    const newFieldLabels = { ...fieldLabels };
                    delete newFieldLabels[fieldId];
                    setFieldLabels(newFieldLabels);
                    localStorage.setItem('field_labels', JSON.stringify(newFieldLabels));
                    
                    // T√ºm mekanlarƒ±n fields dizisinden sil
                    const updatedBaseRooms = baseRooms.map(room => ({
                        ...room,
                        fields: room.fields.filter(f => f !== fieldId)
                    }));
                    setBaseRooms(updatedBaseRooms);
                    localStorage.setItem('base_rooms', JSON.stringify(updatedBaseRooms));
                    
                    const updatedCustomRooms = customRooms.map(room => ({
                        ...room,
                        fields: room.fields.filter(f => f !== fieldId)
                    }));
                    setCustomRooms(updatedCustomRooms);
                    localStorage.setItem('custom_rooms', JSON.stringify(updatedCustomRooms));
                    
                    // T√ºm projelerdeki t√ºm dairelerdeki bu alanƒ±n verisini sil
                    const updatedProjects = projects.map(proj => ({
                        ...proj,
                        apartments: proj.apartments.map(apt => {
                            const newData = { ...apt.data };
                            // Her mekandan bu alanƒ± sil
                            Object.keys(newData).forEach(roomId => {
                                if (newData[roomId] && newData[roomId][fieldId]) {
                                    const roomData = { ...newData[roomId] };
                                    delete roomData[fieldId];
                                    newData[roomId] = roomData;
                                }
                            });
                            return { ...apt, data: newData };
                        })
                    }));
                    setProjects(updatedProjects);
                    localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                    
                    alert('Alan ve t√ºm veriler t√ºm mekanlardan kaldƒ±rƒ±ldƒ±!');
                }
            };

            const editField = (fieldId) => {
                if (fieldId === 'foto') {
                    alert('Fotograf alani duzenlenemez!');
                    return;
                }
                
                const field = fieldLabels[fieldId];
                const label = prompt('Alan Adi:', field.label);
                if (!label || !label.trim()) return;
                
                const unit = prompt('Birim (OPSIYONEL, bos birakilabilir):', field.unit);
                
                const category = prompt('Kategori:', field.category);
                if (!category || !category.trim()) return;
                
                const newFieldLabels = {
                    ...fieldLabels,
                    [fieldId]: {
                        label: label.trim(),
                        unit: unit ? unit.trim() : '',
                        category: category.trim()
                    }
                };
                
                setFieldLabels(newFieldLabels);
                localStorage.setItem('field_labels', JSON.stringify(newFieldLabels));
                alert('Alan guncellendi!');
            };

            const addCustomRoom = () => {
                const name = prompt('Yeni mekan adi:');
                if (!name || !name.trim()) return;
                
                // fieldLabels'dan dinamik olarak alan listesi olu≈ütur
                const availableFields = Object.entries(fieldLabels).map(([id, field], index) => ({
                    id,
                    label: field.label,
                    number: index + 1
                }));
                
                // Prompt metnini dinamik olu≈ütur
                let promptText = 'Hangi alanlari eklemek istiyorsunuz?\n\n';
                
                // Alanlarƒ± listele (her satƒ±rda 3 alan)
                availableFields.forEach((field, idx) => {
                    promptText += field.number + '=' + field.label;
                    if ((idx + 1) % 3 === 0) {
                        promptText += '\n';
                    } else {
                        promptText += ', ';
                    }
                });
                
                promptText += '\n\nOrnekler:\n';
                promptText += '- "1,2" = Zemin + Boya\n';
                promptText += '- Virg√ºlle ayƒ±rarak secin\n\n';
                promptText += 'Seciminiz:';
                
                let selectedFields = ['zemin', 'boya', 'foto']; // Varsayƒ±lan
                const selection = prompt(promptText, '1,2');
                
                if (selection) {
                    const nums = selection.split(',').map(n => parseInt(n.trim()));
                    
                    // Numara -> ID mapping
                    selectedFields = nums.map(num => {
                        const found = availableFields.find(f => f.number === num);
                        return found ? found.id : null;
                    }).filter(f => f !== null);
                    
                    if (selectedFields.length === 0) selectedFields = ['zemin', 'boya', 'foto'];
                }
                
                const id = 'custom_' + Date.now();
                const newRoom = { id, name: name.trim(), fields: selectedFields, custom: true };
                const updated = [...customRooms, newRoom];
                setCustomRooms(updated);
                localStorage.setItem('custom_rooms', JSON.stringify(updated));
                setCurrentRoom(id);
                
                // Toplu ekleme se√ßeneƒüi
                const applyChoice = prompt(
                    'Bu mekani nereye eklemek istiyorsunuz?\n\n' +
                    '1 = Sadece bu daire\n' +
                    '2 = Bu projedeki TUM daireler\n' +
                    '3 = TUM projeler, TUM daireler\n\n' +
                    'Seciminiz (1/2/3):',
                    '1'
                );
                
                if (applyChoice === '2') {
                    // Bu projedeki t√ºm dairelere ekle
                    const currentProj = getProject();
                    const confirmMsg = currentProj.name + ' projesindeki ' + currentProj.apartments.length + ' daireye "' + name.trim() + '" mekani eklensin mi?';
                    if (confirm(confirmMsg)) {
                        const updatedApts = currentProj.apartments.map(apt => ({
                            ...apt,
                            wallCount: { ...apt.wallCount, [id]: selectedFields.includes('duvar_kaplama') ? 1 : 0 }
                        }));
                        updateProjects(projects.map(p => p.id === currentPrj ? { ...p, apartments: updatedApts } : p));
                        alert('Eklendi! ' + currentProj.apartments.length + ' daireye "' + name.trim() + '" mekani eklendi.');
                    }
                } else if (applyChoice === '3') {
                    // T√ºm projelerdeki t√ºm dairelere ekle
                    let totalApts = 0;
                    projects.forEach(p => { totalApts += p.apartments.length; });
                    const confirmMsg = 'TUM projelerdeki ' + totalApts + ' daireye "' + name.trim() + '" mekani eklensin mi?';
                    if (confirm(confirmMsg)) {
                        const updatedProjects = projects.map(proj => ({
                            ...proj,
                            apartments: proj.apartments.map(apt => ({
                                ...apt,
                                wallCount: { ...apt.wallCount, [id]: selectedFields.includes('duvar_kaplama') ? 1 : 0 }
                            }))
                        }));
                        setProjects(updatedProjects);
                        localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                        alert('Eklendi! ' + totalApts + ' daireye "' + name.trim() + '" mekani eklendi.');
                    }
                }
                
                alert('Mekan olusturuldu!\nEklenen alanlar:\n' + selectedFields.map(f => fieldNames[f] || f).join('\n'));
            };

            const editRoomName = (roomId) => {
                const room = allRooms.find(r => r.id === roomId);
                if (!room) {
                    alert('Mekan bulunamadi!');
                    return;
                }
                
                const newName = prompt('Yeni mekan adi:', room.name);
                if (newName && newName.trim()) {
                    if (room.custom) {
                        // √ñzel mekan
                        const updated = customRooms.map(r => r.id === roomId ? { ...r, name: newName.trim() } : r);
                        setCustomRooms(updated);
                        localStorage.setItem('custom_rooms', JSON.stringify(updated));
                    } else {
                        // Varsayƒ±lan mekan
                        const updated = baseRooms.map(r => r.id === roomId ? { ...r, name: newName.trim() } : r);
                        setBaseRooms(updated);
                        localStorage.setItem('base_rooms', JSON.stringify(updated));
                    }
                }
            };

            const copyRoom = (roomId) => {
                const room = allRooms.find(r => r.id === roomId);
                if (!room) {
                    alert('Mekan bulunamadi!');
                    return;
                }
                
                const newName = prompt('Yeni mekan adi:', room.name + ' Kopya');
                if (!newName || !newName.trim()) return;
                
                const newId = 'custom_' + Date.now();
                const newRoom = {
                    id: newId,
                    name: newName.trim(),
                    fields: [...room.fields],
                    custom: true
                };
                
                const updated = [...customRooms, newRoom];
                setCustomRooms(updated);
                localStorage.setItem('custom_rooms', JSON.stringify(updated));
                
                // Toplu ekleme se√ßeneƒüi
                const applyChoice = prompt(
                    'Bu mekani nereye eklemek istiyorsunuz?\n\n' +
                    '1 = Sadece bu daire\n' +
                    '2 = Bu projedeki TUM daireler\n' +
                    '3 = TUM projeler, TUM daireler\n\n' +
                    'Seciminiz (1/2/3):',
                    '1'
                );
                
                if (applyChoice === '2') {
                    const currentProj = getProject();
                    if (confirm(currentProj.name + ' projesindeki ' + currentProj.apartments.length + ' daireye "' + newName.trim() + '" mekani eklensin mi?')) {
                        const updatedApts = currentProj.apartments.map(apt => ({
                            ...apt,
                            wallCount: { ...apt.wallCount, [newId]: room.fields.includes('duvar_kaplama') ? 1 : 0 }
                        }));
                        updateProjects(projects.map(p => p.id === currentPrj ? { ...p, apartments: updatedApts } : p));
                        alert('Eklendi! ' + currentProj.apartments.length + ' daireye "' + newName.trim() + '" mekani eklendi.');
                    }
                } else if (applyChoice === '3') {
                    let totalApts = 0;
                    projects.forEach(p => { totalApts += p.apartments.length; });
                    if (confirm('TUM projelerdeki ' + totalApts + ' daireye "' + newName.trim() + '" mekani eklensin mi?')) {
                        const updatedProjects = projects.map(proj => ({
                            ...proj,
                            apartments: proj.apartments.map(apt => ({
                                ...apt,
                                wallCount: { ...apt.wallCount, [newId]: room.fields.includes('duvar_kaplama') ? 1 : 0 }
                            }))
                        }));
                        setProjects(updatedProjects);
                        localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                        alert('Eklendi! ' + totalApts + ' daireye "' + newName.trim() + '" mekani eklendi.');
                    }
                }
                
                setCurrentRoom(newId);
                alert('Mekan kopyalandi!\n\n"' + room.name + '" -> "' + newName.trim() + '"\n\nAlanlar: ' + room.fields.length + ' adet');
            };

            const editRoomFields = (roomId) => {
                const room = allRooms.find(r => r.id === roomId);
                if (!room) {
                    alert('Mekan bulunamadi!');
                    return;
                }
                
                // fieldLabels'dan dinamik olarak alan listesi olu≈ütur
                const availableFields = Object.entries(fieldLabels).map(([id, field], index) => ({
                    id,
                    label: field.label,
                    number: index + 1
                }));
                
                // Mevcut alanlarƒ± g√∂ster
                const currentFieldsText = room.fields.map(f => {
                    const field = fieldLabels[f];
                    return field ? field.label : f;
                }).join(', ');
                
                // Prompt metnini dinamik olu≈ütur
                let promptText = room.name + ' - Mevcut alanlar:\n' + currentFieldsText + '\n\n' +
                    'Yeni alan secimi:\n\n';
                
                // Alanlarƒ± listele (her satƒ±rda 3 alan)
                availableFields.forEach((field, idx) => {
                    promptText += field.number + '=' + field.label;
                    if ((idx + 1) % 3 === 0) {
                        promptText += '\n';
                    } else {
                        promptText += ', ';
                    }
                });
                
                promptText += '\n\nSeciminiz (virg√ºlle ayƒ±rƒ±n):';
                
                // Mevcut alanlarƒ± numara olarak g√∂ster
                const currentFieldNumbers = room.fields.map(f => {
                    const found = availableFields.find(af => af.id === f);
                    return found ? found.number : null;
                }).filter(n => n !== null).join(',');
                
                const selection = prompt(promptText, currentFieldNumbers);
                
                if (selection) {
                    const nums = selection.split(',').map(n => parseInt(n.trim()));
                    
                    // Numara -> ID mapping
                    let newFields = nums.map(num => {
                        const found = availableFields.find(f => f.number === num);
                        return found ? found.id : null;
                    }).filter(f => f !== null);
                    
                    if (newFields.length === 0) newFields = ['zemin', 'boya'];
                    
                    if (room.custom) {
                        // √ñzel mekan - customRooms'da g√ºncelle
                        const updated = customRooms.map(r => r.id === roomId ? { ...r, fields: newFields } : r);
                        setCustomRooms(updated);
                        localStorage.setItem('custom_rooms', JSON.stringify(updated));
                    } else {
                        // Varsayƒ±lan mekan - baseRooms'da g√ºncelle
                        const updated = baseRooms.map(r => r.id === roomId ? { ...r, fields: newFields } : r);
                        setBaseRooms(updated);
                        localStorage.setItem('base_rooms', JSON.stringify(updated));
                    }
                    
                    // G√ºncellenen alanlarƒ± g√∂ster
                    const updatedFieldNames = newFields.map(f => {
                        const field = fieldLabels[f];
                        return field ? field.label : f;
                    }).join('\n');
                    
                    alert('Guncellenen alanlar:\n' + updatedFieldNames);
                }
            };

            const deleteRoom = (roomId) => {
                const room = allRooms.find(r => r.id === roomId);
                if (!room) {
                    alert('Mekan bulunamadi!');
                    return;
                }
                
                const deleteChoice = prompt(
                    '"' + room.name + '" mekanini nereden silmek istiyorsunuz?\n\n' +
                    '1 = Sadece bu daire (listeden KALKAR + veriler silinir)\n' +
                    '2 = Bu projedeki TUM daireler (listeden KALKAR)\n' +
                    '3 = TUM projeler, TUM daireler (mekani TAMAMEN sil)\n' +
                    '4 = IPTAL\n\n' +
                    'Seciminiz (1/2/3/4):',
                    '1'
                );
                
                if (deleteChoice === '1') {
                    // Sadece bu daireden tamamen kaldƒ±r (listeden + veriler)
                    console.log('SECENEK 1 - Basladi');
                    console.log('roomId:', roomId);
                    console.log('currentApt:', currentApt);
                    console.log('currentPrj:', currentPrj);
                    
                    if (confirm('Bu daireden "' + room.name + '" mekani TAMAMEN kaldirilacak (listeden de gidecek). Diger daireler etkilenmez. Devam?')) {
                        console.log('Onaylandi, isleme baslaniyor...');
                        const currentProj = getProject();
                        
                        const updatedApts = currentProj.apartments.map(a => {
                            if (a.id === currentApt) {
                                console.log('Daire bulundu, silme yapiliyor:', a.name);
                                
                                // Veriyi sil
                                const newData = { ...a.data };
                                delete newData[roomId];
                                
                                // Duvar sayƒ±sƒ±nƒ± sil
                                const newWallCount = { ...a.wallCount };
                                delete newWallCount[roomId];
                                
                                // Gizli mekanlar listesine ekle
                                const newHiddenRooms = [...(a.hiddenRooms || [])];
                                if (!newHiddenRooms.includes(roomId)) {
                                    newHiddenRooms.push(roomId);
                                }
                                
                                console.log('Yeni data:', newData);
                                console.log('Gizli mekanlar:', newHiddenRooms);
                                
                                return { ...a, data: newData, wallCount: newWallCount, hiddenRooms: newHiddenRooms };
                            }
                            return a;
                        });
                        
                        console.log('updatedApts:', updatedApts);
                        const updatedProjects = projects.map(p => p.id === currentPrj ? { ...p, apartments: updatedApts } : p);
                        console.log('updatedProjects:', updatedProjects);
                        
                        setProjects(updatedProjects);
                        localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                        console.log('State ve localStorage guncellendi');
                        
                        setCurrentRoom('salon');
                        alert('Mekan bu daireden TAMAMEN kaldirildi! Diger daireler etkilenmedi.');
                        console.log('SECENEK 1 - Tamamlandi');
                    } else {
                        console.log('Kullanici iptal etti');
                    }
                } else if (deleteChoice === '2') {
                    // Bu projedeki t√ºm dairelerden tamamen kaldƒ±r
                    const currentProj = getProject();
                    if (confirm(currentProj.name + ' projesindeki ' + currentProj.apartments.length + ' daireden "' + room.name + '" mekani TAMAMEN kaldirilsin mi?')) {
                        const updatedApts = currentProj.apartments.map(apt => {
                            // Veriyi sil
                            const newData = { ...apt.data };
                            delete newData[roomId];
                            
                            // Duvar sayƒ±sƒ±nƒ± sil
                            const newWallCount = { ...apt.wallCount };
                            delete newWallCount[roomId];
                            
                            // Gizli mekanlar listesine ekle
                            const newHiddenRooms = [...(apt.hiddenRooms || [])];
                            if (!newHiddenRooms.includes(roomId)) {
                                newHiddenRooms.push(roomId);
                            }
                            
                            return { ...apt, data: newData, wallCount: newWallCount, hiddenRooms: newHiddenRooms };
                        });
                        const updatedProjects = projects.map(p => p.id === currentPrj ? { ...p, apartments: updatedApts } : p);
                        setProjects(updatedProjects);
                        localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                        setCurrentRoom('salon');
                        alert('Mekan bu projedeki tum dairelerden TAMAMEN kaldirildi!');
                    }
                } else if (deleteChoice === '3') {
                    // T√ºm projelerden tamamen sil
                    let totalApts = 0;
                    projects.forEach(p => { totalApts += p.apartments.length; });
                    if (confirm('TUM projelerdeki ' + totalApts + ' daireden "' + room.name + '" mekani tamamen silinecek. Devam?')) {
                        // √ñnce t√ºm dairelerden verileri temizle
                        const updatedProjects = projects.map(proj => ({
                            ...proj,
                            apartments: proj.apartments.map(apt => {
                                const newData = { ...apt.data };
                                delete newData[roomId];
                                const newWallCount = { ...apt.wallCount };
                                delete newWallCount[roomId];
                                return { ...apt, data: newData, wallCount: newWallCount };
                            })
                        }));
                        setProjects(updatedProjects);
                        localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                        
                        // Sonra mekanƒ± tamamen sil
                        if (room.custom) {
                            const updated = customRooms.filter(r => r.id !== roomId);
                            setCustomRooms(updated);
                            localStorage.setItem('custom_rooms', JSON.stringify(updated));
                        } else {
                            const updated = baseRooms.filter(r => r.id !== roomId);
                            setBaseRooms(updated);
                            localStorage.setItem('base_rooms', JSON.stringify(updated));
                        }
                        
                        setCurrentRoom('salon');
                        alert('Mekan tamamen silindi! ' + totalApts + ' daireden tum veriler temizlendi.');
                    }
                }
                // 4 veya ba≈üka bir deƒüer = ƒ∞ptal (hi√ßbir ≈üey yapma)
            };

            const updateField = (field, value) => {
                updateApartments(apartments.map(a => {
                    if (a.id === currentApt) {
                        return { ...a, data: { ...a.data, [currentRoom]: { ...a.data[currentRoom], [field]: value } } };
                    }
                    return a;
                }));
            };

            const updateWallCover = (idx, type, val) => {
                const current = getRoomData().duvar_kaplama || {};
                const updated = { ...current, [idx]: { ...current[idx], [type]: val } };
                updateField('duvar_kaplama', updated);
            };

            const addWallCover = () => {
                const rd = getRoomData();
                const currentWalls = rd.duvar_kaplama || {};
                const currentCount = getApt().wallCount && getApt().wallCount[currentRoom] ? getApt().wallCount[currentRoom] : 1;
                
                // Yeni duvar i√ßin bo≈ü object ekle
                const newWalls = { ...currentWalls };
                newWalls[currentCount] = {}; // Yeni index i√ßin bo≈ü object
                
                updateField('duvar_kaplama', newWalls);
                
                // wallCount'u artƒ±r
                updateApartments(apartments.map(a => {
                    if (a.id === currentApt) {
                        return { ...a, wallCount: { ...a.wallCount, [currentRoom]: currentCount + 1 } };
                    }
                    return a;
                }));
            };

            const uploadPhoto = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 5000000) { alert('Max 5MB!'); return; }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const rd = getRoomData();
                    const photos = rd.foto || {};
                    updateField('foto', { ...photos, [Object.keys(photos).length]: ev.target.result });
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            const delPhoto = (idx) => {
                const photos = { ...getRoomData().foto };
                delete photos[idx];
                updateField('foto', Object.keys(photos).length > 0 ? photos : undefined);
            };

            const addMaterial = (cat, name) => {
                const newMat = { ...materials };
                if (Array.isArray(materials[cat])) {
                    newMat[cat] = [...materials[cat], name];
                } else {
                    // Hiyerar≈üik yapƒ± - kullanƒ±lmƒ±yor artƒ±k, UI'dan direkt ekleniyor
                    return;
                }
                setMaterials(newMat);
                localStorage.setItem('material_database', JSON.stringify(newMat));
            };

            const deleteMaterial = (cat, name) => {
                if (confirm('Bu malzemeyi silmek istediginize emin misiniz?\n\nKategori: ' + cat + '\nMalzeme: ' + name)) {
                    const newMat = { ...materials };
                    if (Array.isArray(materials[cat])) {
                        newMat[cat] = materials[cat].filter(m => m !== name);
                    }
                    setMaterials(newMat);
                    localStorage.setItem('material_database', JSON.stringify(newMat));
                }
            };

            // Sekme sƒ±rasƒ±nƒ± deƒüi≈ütir (drag & drop)
            const reorderTabs = (fromIndex, toIndex) => {
                const categories = Object.keys(materials);
                const [movedCat] = categories.splice(fromIndex, 1);
                categories.splice(toIndex, 0, movedCat);
                
                const newMat = {};
                categories.forEach(cat => {
                    newMat[cat] = materials[cat];
                });
                
                setMaterials(newMat);
                localStorage.setItem('material_database', JSON.stringify(newMat));
            };

            // Mekan ikonlarƒ±
            const getRoomIcon = (roomName) => {
                const name = roomName.toLowerCase();
                
                // Salon
                if (name.includes('salon') || name.includes('oturma')) {
                    return (
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    );
                }
                
                // Mutfak
                if (name.includes('mutfak') || name.includes('kitchen')) {
                    return (
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    );
                }
                
                // Yatak Odasƒ±
                if (name.includes('yatak') || name.includes('oda-') || name.includes('bedroom')) {
                    return (
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    );
                }
                
                // Banyo
                if (name.includes('banyo') || name.includes('wc') || name.includes('tuvalet')) {
                    return (
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    );
                }
                
                // Hol/Antre
                if (name.includes('hol') || name.includes('antre') || name.includes('koridor') || name.includes('giri≈ü')) {
                    return (
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    );
                }
                
                // Balkon/Teras
                if (name.includes('balkon') || name.includes('teras')) {
                    return (
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
                        </svg>
                    );
                }
                
                // √áama≈üƒ±r/Kiler
                if (name.includes('√ßama≈üƒ±r') || name.includes('kiler') || name.includes('depo')) {
                    return (
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                        </svg>
                    );
                }
                
                // Tavan/√áatƒ±
                if (name.includes('tavan') || name.includes('√ßatƒ±')) {
                    return (
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                        </svg>
                    );
                }
                
                // Default - Genel mekan ikonu
                return (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                    </svg>
                );
            };

            // Tema deƒüi≈ütirme
            const toggleTheme = async () => {
                const newTheme = theme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Firebase'e kaydet (kullanƒ±cƒ± giri≈ü yapmƒ±≈üsa)
                if (user && firebaseEnabled && db) {
                    try {
                        await db.collection('userSettings').doc(user.uid).set({
                            theme: newTheme,
                            updatedAt: new Date().toISOString()
                        }, { merge: true });
                        console.log('‚úÖ Tema tercihi Firebase\'e kaydedildi:', newTheme);
                    } catch (error) {
                        console.error('‚ùå Tema Firebase\'e kaydedilemedi:', error);
                    }
                }
                
                // Dropdown option'larƒ± i√ßin global CSS g√ºncelle
                const themeStyle = document.getElementById('theme-style');
                if (themeStyle) {
                    if (newTheme === 'dark') {
                        themeStyle.innerHTML = `
                            select option {
                                background-color: #374151 !important;
                                color: #f3f4f6 !important;
                            }
                        `;
                    } else {
                        themeStyle.innerHTML = `
                            select option {
                                background-color: white !important;
                                color: #111827 !important;
                            }
                        `;
                    }
                }
            };

            // Daire kopyalama fonksiyonu
            const copyApartment = () => {
                const sourceApt = getApt();
                const count = parseInt(copyCount) || 1;
                
                if (count < 1 || count > 50) {
                    alert('L√ºtfen 1-50 arasƒ± bir sayƒ± girin!');
                    return;
                }
                
                // Kaynak daire isminden sayƒ±yƒ± √ßƒ±kar
                const baseName = sourceApt.name.replace(/\s*\d+\s*$/, '').trim() || 'Daire';
                
                // Mevcut en b√ºy√ºk numarayƒ± bul
                const existingNumbers = apartments
                    .map(a => {
                        const match = a.name.match(new RegExp(baseName + '\\s*(\\d+)'));
                        return match ? parseInt(match[1]) : 0;
                    })
                    .filter(n => n > 0);
                
                const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
                
                const newApartments = [];
                let nextId = Math.max(...apartments.map(a => a.id), 0) + 1;
                
                // Belirlenen sayƒ±da daire olu≈ütur
                for (let i = 0; i < count; i++) {
                    const newNumber = maxNumber + i + 1;
                    const newName = `${baseName} ${newNumber}`;
                    
                    const newData = {};
                    const newWallCount = {};
                    const newHiddenRooms = [...(sourceApt.hiddenRooms || [])];
                    
                    // Se√ßili mekanlarƒ± kopyala
                    if (copyOptions.rooms) {
                        Object.keys(sourceApt.data).forEach(roomId => {
                            const roomData = sourceApt.data[roomId];
                            newData[roomId] = {};
                            
                            Object.keys(roomData).forEach(field => {
                                if (field === 'foto') {
                                    // Fotoƒüraflarƒ± sadece se√ßiliyse kopyala
                                    if (copyOptions.photos) {
                                        newData[roomId][field] = { ...roomData[field] };
                                    }
                                } else if (field === 'duvar_kaplama') {
                                    // Duvar kaplama - hem array hem obje olabilir
                                    if (Array.isArray(roomData[field])) {
                                        // Array formatƒ± (yeni)
                                        const copiedWalls = roomData[field].map(wall => {
                                            const newWall = {};
                                            if (copyOptions.materials) {
                                                newWall.subgroup = wall.subgroup || '';
                                                newWall.malzeme = wall.malzeme || '';
                                            }
                                            if (copyOptions.amounts) {
                                                newWall.miktar = wall.miktar || '';
                                            }
                                            return newWall;
                                        });
                                        // Sadece dolu duvarlarƒ± kopyala
                                        if (copiedWalls.some(w => w.subgroup || w.malzeme || w.miktar)) {
                                            newData[roomId][field] = copiedWalls;
                                        }
                                    } else if (typeof roomData[field] === 'object') {
                                        // Obje formatƒ± (eski) - her key bir duvar indexi
                                        const copiedWalls = {};
                                        Object.keys(roomData[field]).forEach(wallIdx => {
                                            const wall = roomData[field][wallIdx];
                                            if (wall && typeof wall === 'object') {
                                                const newWall = {};
                                                if (copyOptions.materials) {
                                                    newWall.subgroup = wall.subgroup || '';
                                                    newWall.malzeme = wall.malzeme || '';
                                                }
                                                if (copyOptions.amounts) {
                                                    newWall.miktar = wall.miktar || '';
                                                }
                                                // Sadece dolu duvarlarƒ± ekle
                                                if (newWall.subgroup || newWall.malzeme || newWall.miktar) {
                                                    copiedWalls[wallIdx] = newWall;
                                                }
                                            }
                                        });
                                        if (Object.keys(copiedWalls).length > 0) {
                                            newData[roomId][field] = copiedWalls;
                                        }
                                    }
                                } else if (roomData[field] && typeof roomData[field] === 'object') {
                                    // Diƒüer malzeme alanlarƒ±
                                    const newField = {};
                                    if (copyOptions.materials) {
                                        newField.subgroup = roomData[field].subgroup || '';
                                        newField.malzeme = roomData[field].malzeme || '';
                                    }
                                    if (copyOptions.amounts) {
                                        newField.miktar = roomData[field].miktar || '';
                                    }
                                    // Sadece dolu alanlarƒ± ekle
                                    if (newField.subgroup || newField.malzeme || newField.miktar) {
                                        newData[roomId][field] = newField;
                                    }
                                }
                            });
                        });
                        
                        // Duvar sayƒ±larƒ±nƒ± her zaman kopyala (mekanlar se√ßiliyse)
                        if (sourceApt.wallCount) {
                            Object.assign(newWallCount, sourceApt.wallCount);
                        }
                    }
                    
                    const newApartment = {
                        id: nextId++,
                        name: newName,
                        data: newData,
                        wallCount: newWallCount,
                        hiddenRooms: newHiddenRooms
                    };
                    
                    newApartments.push(newApartment);
                }
                
                updateApartments([...apartments, ...newApartments]);
                setCurrentApt(newApartments[0].id); // ƒ∞lk olu≈üturulan daireye ge√ß
                setShowCopyModal(false);
                
                // Kopyalama se√ßeneklerini sƒ±fƒ±rla
                setCopyOptions({
                    rooms: true,
                    materials: true,
                    amounts: true,
                    photos: false
                });
                setCopyCount(1);
                
                alert(`‚úÖ ${count} adet daire ba≈üarƒ±yla kopyalandƒ±!\n\n${newApartments.map(a => a.name).join('\n')}`);
            };

            // Ba≈üka daireden miktar kopyalama
            const copyAmountsFromApartment = () => {
                if (!sourceAptForAmounts) return;
                
                const sourceApt = apartments.find(a => a.id === sourceAptForAmounts);
                const targetApt = getApt();
                
                if (!sourceApt) return;
                
                const updatedData = { ...targetApt.data };
                
                // Her mekan i√ßin
                Object.keys(sourceApt.data).forEach(roomId => {
                    if (!updatedData[roomId]) return; // Hedef dairede bu mekan yoksa atla
                    
                    const sourceRoomData = sourceApt.data[roomId];
                    const targetRoomData = updatedData[roomId];
                    
                    // Her alan i√ßin
                    Object.keys(sourceRoomData).forEach(field => {
                        if (field === 'foto') return; // Fotoƒüraflarƒ± atla
                        
                        // Alan se√ßilmemi≈üse atla
                        if (!selectedFieldsForCopy[field]) return;
                        
                        if (field === 'duvar_kaplama') {
                            // Duvar kaplama - T√úM duvarlarƒ± kopyala
                            if (typeof sourceRoomData[field] === 'object' && sourceRoomData[field] !== null) {
                                // Hedefte duvar_kaplama objesi yoksa olu≈ütur
                                if (!targetRoomData[field] || typeof targetRoomData[field] !== 'object') {
                                    targetRoomData[field] = {};
                                }
                                
                                // Obje formatƒ± (her duvar index ile)
                                Object.keys(sourceRoomData[field]).forEach(wallIdx => {
                                    const sourceWall = sourceRoomData[field][wallIdx];
                                    
                                    // Kaynak duvarda miktar alanƒ± varsa (bo≈ü bile olsa) kopyala
                                    if (sourceWall && typeof sourceWall === 'object' && ('miktar' in sourceWall)) {
                                        // Hedefte bu duvar yoksa olu≈ütur
                                        if (!targetRoomData[field][wallIdx]) {
                                            targetRoomData[field][wallIdx] = {};
                                        }
                                        // Miktarƒ± kopyala (bo≈ü string veya 0 olsa bile)
                                        targetRoomData[field][wallIdx] = {
                                            ...targetRoomData[field][wallIdx],
                                            miktar: sourceWall.miktar
                                        };
                                    }
                                });
                            }
                        } else if (sourceRoomData[field] && typeof sourceRoomData[field] === 'object') {
                            // Diƒüer alanlar - hedefte alan yoksa atla
                            if (!targetRoomData[field]) return;
                            
                            // Kaynak alanda miktar alanƒ± varsa kopyala (bo≈ü bile olsa)
                            if ('miktar' in sourceRoomData[field]) {
                                targetRoomData[field] = {
                                    ...targetRoomData[field],
                                    miktar: sourceRoomData[field].miktar
                                };
                            }
                        }
                    });
                });
                
                // G√ºncellenmi≈ü veriyi kaydet
                updateApartments(apartments.map(a => 
                    a.id === currentApt ? { ...a, data: updatedData } : a
                ));
                
                setShowCopyAmountsModal(false);
                setSourceAptForAmounts(null);
                setSelectedFieldsForCopy({});
            };

            // Malzeme kullanƒ±m analizi
            const getMaterialUsageAnalysis = () => {
                const analysis = {};
                
                projects.forEach(project => {
                    project.apartments.forEach(apt => {
                        allRooms.forEach(room => {
                            const rd = apt.data[room.id];
                            if (!rd) return;
                            
                            room.fields.forEach(f => {
                                if (f === 'foto') return;
                                const fc = fieldLabels[f];
                                if (!fc) return;
                                
                                if (f === 'duvar_kaplama' && rd[f]) {
                                    const wallCount = apt.wallCount && apt.wallCount[room.id] ? apt.wallCount[room.id] : 1;
                                    for (let wallIdx = 0; wallIdx < wallCount; wallIdx++) {
                                        const v = rd[f][wallIdx];
                                        if (v && v.malzeme) {
                                            const key = `${fc.category}|${v.subgroup || '-'}|${v.malzeme}`;
                                            if (!analysis[key]) {
                                                analysis[key] = {
                                                    category: fc.category,
                                                    subgroup: v.subgroup || '-',
                                                    material: v.malzeme,
                                                    unit: fc.unit || '',
                                                    totalAmount: 0,
                                                    usages: []
                                                };
                                            }
                                            analysis[key].totalAmount += parseFloat(v.miktar || 0);
                                            analysis[key].usages.push({
                                                project: project.name,
                                                apartment: apt.name,
                                                room: room.name,
                                                field: fc.label,
                                                amount: parseFloat(v.miktar || 0)
                                            });
                                        }
                                    }
                                } else if (rd[f] && rd[f].malzeme) {
                                    const key = `${fc.category}|${rd[f].subgroup || '-'}|${rd[f].malzeme}`;
                                    if (!analysis[key]) {
                                        analysis[key] = {
                                            category: fc.category,
                                            subgroup: rd[f].subgroup || '-',
                                            material: rd[f].malzeme,
                                            unit: fc.unit || '',
                                            totalAmount: 0,
                                            usages: []
                                        };
                                    }
                                    analysis[key].totalAmount += parseFloat(rd[f].miktar || 0);
                                    analysis[key].usages.push({
                                        project: project.name,
                                        apartment: apt.name,
                                        room: room.name,
                                        field: fc.label,
                                        amount: parseFloat(rd[f].miktar || 0)
                                    });
                                }
                            });
                        });
                    });
                });
                
                return Object.values(analysis).sort((a, b) => {
                    if (a.category !== b.category) return a.category.localeCompare(b.category);
                    if (a.subgroup !== b.subgroup) return a.subgroup.localeCompare(b.subgroup);
                    return a.material.localeCompare(b.material);
                });
            };

            const exportData = () => {
                const exportObj = {
                    projects: projects,
                    customRooms: customRooms,
                    baseRooms: baseRooms,
                    fieldLabels: fieldLabels,
                    materials: materials,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'malzeme_sistemi_yedek_' + new Date().toISOString().split('T')[0] + '.json';
                link.click();
                URL.revokeObjectURL(url);
                alert('Veriler indirildi! Bu dosyayi baska cihazda yukleyebilirsiniz.');
            };

            const importData = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const imported = JSON.parse(ev.target.result);
                            if (!imported.projects || !Array.isArray(imported.projects)) {
                                alert('Gecersiz dosya formati!');
                                return;
                            }
                            if (confirm('Mevcut veriler silinecek ve yukleyeceginiz veriler ile degistirilecek. Devam etmek istiyor musunuz?\n\n(Oneri: Once mevcut verilerinizi yedegin disa aktarin)')) {
                                setProjects(imported.projects || []);
                                setCustomRooms(imported.customRooms || []);
                                setBaseRooms(imported.baseRooms || DEFAULT_ROOMS);
                                setFieldLabels(imported.fieldLabels || DEFAULT_FIELD_LABELS);
                                setMaterials(imported.materials || DEFAULT_MATERIALS);
                                localStorage.setItem('projects_data', JSON.stringify(imported.projects));
                                localStorage.setItem('custom_rooms', JSON.stringify(imported.customRooms || []));
                                localStorage.setItem('base_rooms', JSON.stringify(imported.baseRooms || DEFAULT_ROOMS));
                                localStorage.setItem('field_labels', JSON.stringify(imported.fieldLabels || DEFAULT_FIELD_LABELS));
                                localStorage.setItem('material_database', JSON.stringify(imported.materials || DEFAULT_MATERIALS));
                                if (imported.projects[0]) {
                                    setCurrentPrj(imported.projects[0].id);
                                    if (imported.projects[0].apartments[0]) {
                                        setCurrentApt(imported.projects[0].apartments[0].id);
                                    }
                                }
                                alert('Veriler basariyla yuklendi!\nProje sayisi: ' + imported.projects.length + '\nOzel mekan sayisi: ' + (imported.customRooms?.length || 0));
                            }
                        } catch (err) {
                            alert('Dosya okunamadi! Hata: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            const downloadExcel = () => {
                const wb = XLSX.utils.book_new();
                const proj = getProject();
                
                // GENEL √ñZET SAYFASI
                const summaryData = [
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    ['üìä PROJE √ñZET RAPORU'],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    [],
                    ['üè¢ Proje Adƒ±:', proj.name],
                    ['üìÖ Rapor Tarihi:', new Date().toLocaleDateString('tr-TR')],
                    ['üè† Toplam Daire Sayƒ±sƒ±:', proj.apartments.length],
                    [],
                    ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'],
                    ['üìã DAƒ∞RE Lƒ∞STESƒ∞'],
                    ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'],
                    ['No', 'Daire Adƒ±', 'Mekan Sayƒ±sƒ±', 'Malzeme Sayƒ±sƒ±', 'Fotoƒüraf Sayƒ±sƒ±']
                ];
                
                proj.apartments.forEach((apt, idx) => {
                    let mekanSayisi = 0;
                    let malzemeSayisi = 0;
                    let fotoSayisi = 0;
                    
                    allRooms.forEach(room => {
                        const rd = apt.data[room.id];
                        if (rd) {
                            mekanSayisi++;
                            room.fields.forEach(f => {
                                if (f === 'foto') {
                                    fotoSayisi += Object.keys(rd.foto || {}).length;
                                } else if (f === 'duvar_kaplama' && rd[f]) {
                                    malzemeSayisi += Object.values(rd[f]).filter(v => v && v.malzeme).length;
                                } else if (rd[f] && rd[f].malzeme) {
                                    malzemeSayisi++;
                                }
                            });
                        }
                    });
                    
                    summaryData.push([idx + 1, apt.name, mekanSayisi, malzemeSayisi, fotoSayisi]);
                });
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWs['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
                summaryWs['!rows'] = [
                    { hpt: 5 },  // √úst √ßizgi
                    { hpt: 25 }, // Ba≈ülƒ±k
                    { hpt: 5 },  // Alt √ßizgi
                    { hpt: 10 }, // Bo≈üluk
                    { hpt: 18 }, // Proje adƒ±
                    { hpt: 18 }, // Tarih
                    { hpt: 18 }, // Daire sayƒ±sƒ±
                    { hpt: 10 }, // Bo≈üluk
                    { hpt: 5 },  // Ayƒ±rƒ±cƒ± √ßizgi
                    { hpt: 20 }, // Alt ba≈ülƒ±k
                    { hpt: 5 },  // Ayƒ±rƒ±cƒ± √ßizgi
                    { hpt: 20 }  // Tablo ba≈ülƒ±klarƒ±
                ];
                // Ba≈ülƒ±k satƒ±rƒ±nƒ± birle≈ütir
                if (!summaryWs['!merges']) summaryWs['!merges'] = [];
                summaryWs['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }); // √úst √ßizgi
                summaryWs['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } }); // Ba≈ülƒ±k
                summaryWs['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 4 } }); // Alt √ßizgi
                summaryWs['!merges'].push({ s: { r: 8, c: 0 }, e: { r: 8, c: 4 } }); // Ayƒ±rƒ±cƒ±
                summaryWs['!merges'].push({ s: { r: 9, c: 0 }, e: { r: 9, c: 4 } }); // Alt ba≈ülƒ±k
                summaryWs['!merges'].push({ s: { r: 10, c: 0 }, e: { r: 10, c: 4 } }); // Ayƒ±rƒ±cƒ±
                // Otomatik filtre ekleme (tablo ba≈ülƒ±k satƒ±rƒ± = 11. satƒ±r, index 11)
                summaryWs['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r: 11, c: 0 }, e: { r: 11 + proj.apartments.length, c: 4 } }) };
                XLSX.utils.book_append_sheet(wb, summaryWs, 'üìä √ñZET');
                
                // PROJE TOPLAM MALZEME Lƒ∞STESƒ∞
                const allMaterials = {};
                proj.apartments.forEach(apt => {
                    allRooms.forEach(room => {
                        const rd = apt.data[room.id];
                        if (!rd) return;
                        room.fields.forEach(f => {
                            if (f === 'foto') return;
                            const fc = fieldLabels[f];
                            if (!fc) return; // Alan tanƒ±mƒ± yoksa atla
                            if (!rd[f]) return; // Veri yoksa atla
                            
                            if (f === 'duvar_kaplama' && rd[f]) {
                                // wallCount'a g√∂re sadece o kadar duvar say
                                const wallCount = apt.wallCount && apt.wallCount[room.id] ? apt.wallCount[room.id] : 1;
                                for (let wallIdx = 0; wallIdx < wallCount; wallIdx++) {
                                    const v = rd[f][wallIdx];
                                    if (v && v.malzeme) {
                                        const subgroup = v.subgroup || '-';
                                        const materialKey = fc.category + '|' + subgroup + '|' + v.malzeme + '|' + (fc.unit || '');
                                        allMaterials[materialKey] = (allMaterials[materialKey] || 0) + parseFloat(v.miktar || 0);
                                    }
                                }
                            } else if (rd[f] && rd[f].malzeme) {
                                const subgroup = rd[f].subgroup || '-';
                                const key = fc.category + '|' + subgroup + '|' + rd[f].malzeme + '|' + (fc.unit || '');
                                allMaterials[key] = (allMaterials[key] || 0) + parseFloat(rd[f].miktar || 0);
                            }
                        });
                    });
                });
                
                const totalData = [
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    ['üì¶ PROJE TOPLAM MALZEME Lƒ∞STESƒ∞'],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    [],
                    ['üè¢ Proje:', proj.name],
                    ['üìÖ Tarih:', new Date().toLocaleDateString('tr-TR')],
                    [],
                    ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'],
                    ['KATEGORƒ∞', 'ALT GRUP', 'MALZEME', 'TOPLAM Mƒ∞KTAR', 'Bƒ∞Rƒ∞M']
                ];
                
                Object.keys(allMaterials).sort().forEach(key => {
                    const [category, subgroup, material, unit] = key.split('|');
                    // Sayƒ±yƒ± number olarak tut, Excel'de g√∂r√ºnmesi i√ßin
                    totalData.push([category, subgroup, material, parseFloat(allMaterials[key].toFixed(2)), unit]);
                });
                
                const totalWs = XLSX.utils.aoa_to_sheet(totalData);
                totalWs['!cols'] = [{ wch: 18 }, { wch: 18 }, { wch: 35 }, { wch: 15 }, { wch: 10 }];
                if (!totalWs['!merges']) totalWs['!merges'] = [];
                totalWs['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }); // √úst √ßizgi
                totalWs['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } }); // Ba≈ülƒ±k
                totalWs['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 4 } }); // Alt √ßizgi
                totalWs['!merges'].push({ s: { r: 7, c: 0 }, e: { r: 7, c: 4 } }); // Ayƒ±rƒ±cƒ±
                // Otomatik filtre (tablo ba≈ülƒ±k satƒ±rƒ± = 8. satƒ±r, index 8)
                const totalDataRows = totalData.length - 1; // Veri satƒ±r sayƒ±sƒ±
                totalWs['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r: 8, c: 0 }, e: { r: totalDataRows, c: 4 } }) };
                XLSX.utils.book_append_sheet(wb, totalWs, 'üì¶ TOPLAM MALZEME');
                
                // HER DAƒ∞RE ƒ∞√áƒ∞N AYRI SAYFA
                proj.apartments.forEach(apt => {
                    const data = [
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['üè† ' + apt.name.toUpperCase() + ' - DETAYLI MALZEME Lƒ∞STESƒ∞'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['üè¢ Proje:', proj.name],
                        ['üìÖ Tarih:', new Date().toLocaleDateString('tr-TR')],
                        [],
                        ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'],
                        ['MEKAN', 'T√úR', 'ALT GRUP', 'MALZEME', 'Mƒ∞KTAR', 'Bƒ∞Rƒ∞M']
                    ];
                    
                    let hasData = false;
                    allRooms.forEach(room => {
                        const rd = apt.data[room.id];
                        if (!rd) return;
                        
                        let roomHasData = false;
                        const roomData = [];
                        
                        room.fields.forEach(f => {
                            if (f === 'foto') return;
                            const fc = fieldLabels[f];
                            if (!fc) return; // Alan tanƒ±mƒ± yoksa atla
                            if (!rd[f]) return; // Veri yoksa atla
                            
                            if (f === 'duvar_kaplama' && rd[f]) {
                                // wallCount'a g√∂re sadece o kadar duvar yaz
                                const wallCount = apt.wallCount && apt.wallCount[room.id] ? apt.wallCount[room.id] : 1;
                                for (let wallIdx = 0; wallIdx < wallCount; wallIdx++) {
                                    const v = rd[f][wallIdx];
                                    if (v && v.malzeme) {
                                        const miktar = v.miktar ? (isNaN(v.miktar) ? v.miktar : parseFloat(v.miktar)) : '-';
                                        const subgroup = v.subgroup || '-';
                                        roomData.push([room.name, fc.label + ' ' + (wallIdx + 1), subgroup, v.malzeme, miktar, fc.unit || '']);
                                        roomHasData = true;
                                    }
                                }
                            } else if (rd[f] && rd[f].malzeme) {
                                const miktar = rd[f].miktar ? (isNaN(rd[f].miktar) ? rd[f].miktar : parseFloat(rd[f].miktar)) : '-';
                                const subgroup = rd[f].subgroup || '-';
                                roomData.push([room.name, fc.label, subgroup, rd[f].malzeme, miktar, fc.unit || '']);
                                roomHasData = true;
                            }
                        });
                        
                        if (roomHasData) {
                            data.push(...roomData);
                            hasData = true;
                        }
                    });
                    
                    if (hasData) {
                        // Fotoƒüraf sayƒ±sƒ± bilgisi ekle
                        let totalPhotos = 0;
                        allRooms.forEach(room => {
                            const rd = apt.data[room.id];
                            if (rd && rd.foto) {
                                totalPhotos += Object.keys(rd.foto).length;
                            }
                        });
                        
                        if (totalPhotos > 0) {
                            data.push([]);
                            data.push(['FOTOƒûRAF Bƒ∞LGƒ∞Sƒ∞']);
                            allRooms.forEach(room => {
                                const rd = apt.data[room.id];
                                if (rd && rd.foto && Object.keys(rd.foto).length > 0) {
                                    data.push([room.name, 'Fotoƒüraf', Object.keys(rd.foto).length + ' adet', '', '']);
                                }
                            });
                        }
                        
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        ws['!cols'] = [{ wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 30 }, { wch: 15 }, { wch: 12 }];
                        if (!ws['!merges']) ws['!merges'] = [];
                        ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }); // √úst √ßizgi
                        ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 5 } }); // Ba≈ülƒ±k
                        ws['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 5 } }); // Alt √ßizgi
                        ws['!merges'].push({ s: { r: 7, c: 0 }, e: { r: 7, c: 5 } }); // Ayƒ±rƒ±cƒ±
                        // Otomatik filtre (tablo ba≈ülƒ±k satƒ±rƒ± = 8. satƒ±r)
                        const dataRows = data.length - 1;
                        ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r: 8, c: 0 }, e: { r: dataRows, c: 5 } }) };
                        XLSX.utils.book_append_sheet(wb, ws, 'üè† ' + apt.name.substring(0, 28));
                    }
                });
                
                // MEKAN BAZLI √ñZET
                const roomSummaryData = [
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    ['üèòÔ∏è MEKAN BAZLI MALZEME √ñZET'],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    [],
                    ['üè¢ Proje:', proj.name],
                    [],
                    ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'],
                    ['MEKAN', 'MALZEME T√úR√ú', 'TOPLAM KULLANIM (Daire Sayƒ±sƒ±)']
                ];
                
                const roomMaterials = {};
                proj.apartments.forEach(apt => {
                    allRooms.forEach(room => {
                        const rd = apt.data[room.id];
                        if (!rd) return;
                        
                        if (!roomMaterials[room.name]) roomMaterials[room.name] = {};
                        
                        room.fields.forEach(f => {
                            if (f === 'foto') return;
                            const fc = fieldLabels[f];
                            if (!fc) return; // Alan tanƒ±mƒ± yoksa atla
                            if (!rd[f]) return; // Veri yoksa atla
                            
                            if (f === 'duvar_kaplama' && rd[f]) {
                                // wallCount'a g√∂re sadece o kadar duvar say
                                const wallCount = apt.wallCount && apt.wallCount[room.id] ? apt.wallCount[room.id] : 1;
                                for (let wallIdx = 0; wallIdx < wallCount; wallIdx++) {
                                    const v = rd[f][wallIdx];
                                    if (v && v.malzeme) {
                                        if (!roomMaterials[room.name][fc.label]) roomMaterials[room.name][fc.label] = 0;
                                        roomMaterials[room.name][fc.label]++;
                                    }
                                }
                            } else if (rd[f] && rd[f].malzeme) {
                                if (!roomMaterials[room.name][fc.label]) roomMaterials[room.name][fc.label] = 0;
                                roomMaterials[room.name][fc.label]++;
                            }
                        });
                    });
                });
                
                Object.keys(roomMaterials).sort().forEach(roomName => {
                    Object.keys(roomMaterials[roomName]).sort().forEach(materialType => {
                        roomSummaryData.push([roomName, materialType, roomMaterials[roomName][materialType] + ' daire']);
                    });
                });
                
                const roomSummaryWs = XLSX.utils.aoa_to_sheet(roomSummaryData);
                roomSummaryWs['!cols'] = [{ wch: 28 }, { wch: 28 }, { wch: 22 }];
                if (!roomSummaryWs['!merges']) roomSummaryWs['!merges'] = [];
                roomSummaryWs['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }); // √úst √ßizgi
                roomSummaryWs['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 2 } }); // Ba≈ülƒ±k
                roomSummaryWs['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 2 } }); // Alt √ßizgi
                roomSummaryWs['!merges'].push({ s: { r: 6, c: 0 }, e: { r: 6, c: 2 } }); // Ayƒ±rƒ±cƒ±
                // Otomatik filtre (tablo ba≈ülƒ±k satƒ±rƒ± = 7. satƒ±r)
                const roomDataRows = roomSummaryData.length - 1;
                roomSummaryWs['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r: 7, c: 0 }, e: { r: roomDataRows, c: 2 } }) };
                XLSX.utils.book_append_sheet(wb, roomSummaryWs, 'üèòÔ∏è MEKAN √ñZET');
                
                XLSX.writeFile(wb, proj.name + '_detayli_rapor_' + new Date().toISOString().split('T')[0] + '.xlsx');
                alert('‚úÖ Detaylƒ± Excel raporu olu≈üturuldu!\n\nüìä Sayfalar:\n- üìä √ñZET\n- üì¶ TOPLAM MALZEME (Alt gruplu)\n- üèòÔ∏è MEKAN √ñZET\n- üè† Her daire i√ßin ayrƒ± sayfa\n\n‚ú® √ñzellikler:\n‚úÖ Profesyonel g√∂r√ºn√ºm\n‚úÖ Hiyerar≈üik malzeme yapƒ±sƒ±\nüîç Otomatik filtreler (t√ºm sayfalarda)');
            };

            const generatePrintForm = () => {
                const apt = getApt();
                const proj = getProject();
                const photoSize = prompt('Fotograf boyutu:\n1=Kucuk(200px) 2=Orta(300px) 3=Buyuk(400px) 4=CokBuyuk(500px)', '3');
                const size = { '1': 200, '2': 300, '3': 400, '4': 500 }[photoSize] || 400;
                
                let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + proj.name + ' - ' + apt.name + '</title><style>';
                html += 'body{font-family:Arial;margin:40px}h1{text-align:center;color:#2563eb;border-bottom:3px solid #2563eb;padding-bottom:10px}';
                html += 'h2{color:#1e40af;margin-top:30px;border-bottom:2px solid #ddd}table{width:100%;border-collapse:collapse;margin:20px 0;table-layout:fixed}';
                html += 'th,td{border:1px solid #ddd;padding:12px;word-wrap:break-word}th{background:#2563eb;color:white}tr:nth-child(even){background:#f8f9fa}';
                html += 'th:nth-child(1),td:nth-child(1){width:20%}th:nth-child(2),td:nth-child(2){width:18%}th:nth-child(3),td:nth-child(3){width:32%}th:nth-child(4),td:nth-child(4){width:18%}th:nth-child(5),td:nth-child(5){width:12%}';
                html += '.photo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(' + size + 'px,1fr));gap:20px;margin:20px 0}';
                html += '.photo-item{border:3px solid #ddd;padding:15px;text-align:center;border-radius:8px}';
                html += '.photo-item img{max-width:100%;height:' + size + 'px;object-fit:cover;border-radius:5px}';
                html += '.print-btn{position:fixed;top:20px;right:20px;background:#2563eb;color:white;padding:15px 30px;cursor:pointer;border-radius:5px}';
                html += '@media print{.print-btn{display:none}}</style></head><body>';
                html += '<button class="print-btn" onclick="window.print()">Yazdir/PDF</button>';
                html += '<h1>MALZEME ONAY FORMU</h1><div style="text-align:center;font-size:20px;margin-bottom:30px">' + proj.name + ' - ' + apt.name + '<br>Tarih: ' + new Date().toLocaleDateString('tr-TR') + '</div>';
                
                allRooms.forEach(room => {
                    const rd = apt.data[room.id];
                    if (!rd) return;
                    html += '<h2>' + room.name + '</h2><table><tr><th>Tur</th><th>Alt Grup</th><th>Malzeme</th><th>Miktar/Detay</th><th>Birim</th></tr>';
                    room.fields.forEach(f => {
                        if (f === 'foto') return;
                        const fc = fieldLabels[f];
                        if (!fc) return; // Alan tanƒ±mƒ± yoksa atla
                        if (!rd[f]) return; // Veri yoksa atla
                        
                        if (f === 'duvar_kaplama' && rd[f]) {
                            // wallCount'a g√∂re sadece o kadar duvar yaz
                            const wallCount = apt.wallCount && apt.wallCount[room.id] ? apt.wallCount[room.id] : 1;
                            for (let wallIdx = 0; wallIdx < wallCount; wallIdx++) {
                                const v = rd[f][wallIdx];
                                if (v && v.malzeme) {
                                    const subgroup = v.subgroup || '-';
                                    html += '<tr><td>' + fc.label + ' ' + (wallIdx + 1) + '</td><td>' + subgroup + '</td><td>' + v.malzeme + '</td><td>' + (v.miktar || '-') + '</td><td>' + (fc.unit || '-') + '</td></tr>';
                                }
                            }
                        } else if (rd[f] && rd[f].malzeme) {
                            const subgroup = rd[f].subgroup || '-';
                            html += '<tr><td>' + fc.label + '</td><td>' + subgroup + '</td><td>' + rd[f].malzeme + '</td><td>' + (rd[f].miktar || '-') + '</td><td>' + (fc.unit || '-') + '</td></tr>';
                        }
                    });
                    html += '</table>';
                    if (rd.foto && Object.keys(rd.foto).length > 0) {
                        html += '<h3>Fotograflar</h3><div class="photo-grid">';
                        Object.values(rd.foto).forEach((p, i) => {
                            if (p) html += '<div class="photo-item"><img src="' + p + '"><div>Foto ' + (i + 1) + '</div></div>';
                        });
                        html += '</div>';
                    }
                });
                html += '<div style="margin-top:50px;border-top:2px solid #333;padding-top:30px"><h2>ONAY</h2><p>Belirtilen malzemeleri onayliyorum.</p><br><br>';
                html += 'Daire Sahibi: _____________________ Imza: _____________________ Tarih: _____________________</div></body></html>';
                
                const w = window.open('', '_blank');
                w.document.write(html);
                w.document.close();
            };

            const renderField = (f) => {
                const data = getRoomData();
                const fc = fieldLabels[f];
                if (!fc) return null; // Alan tanƒ±mƒ± yoksa g√∂sterme
                const opts = materials[fc.category] || [];

                if (f === 'foto') {
                    const photos = Object.entries(data.foto || {}).filter(([_, p]) => p);
                    return (
                        <div key="foto" className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 border border-purple-100">
                            <label className="block text-sm font-semibold text-purple-900 mb-4 flex items-center gap-2">
                                <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Fotoƒüraflar
                                <span className="ml-auto bg-purple-600 text-white text-xs px-2.5 py-1 rounded-full">{photos.length}</span>
                            </label>
                            <input type="file" accept="image/*" onChange={uploadPhoto} className="hidden" id="file-up" />
                            <label htmlFor="file-up" className="inline-flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg cursor-pointer hover:from-purple-700 hover:to-pink-700 shadow-md hover:shadow-lg transition-all">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Fotoƒüraf Ekle
                            </label>
                            {photos.length > 0 && (
                                <div className="grid grid-cols-3 gap-3 mt-4">
                                    {photos.map(([i, p]) => (
                                        <div key={i} className="relative group">
                                            <img src={p} className="w-full h-32 object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-purple-400 transition-all shadow-sm" onClick={() => setLightbox(p)} />
                                            <button onClick={() => delPhoto(i)} className="absolute top-2 right-2 bg-red-500 text-white w-7 h-7 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-lg hover:bg-red-600 flex items-center justify-center">√ó</button>
                                            <div className="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">#{parseInt(i) + 1}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    );
                }

                if (f === 'duvar_kaplama') {
                    const count = getApt().wallCount[currentRoom] || 1;
                    const categoryData = materials[fc.category] || {};
                    const isHierarchical = typeof categoryData === 'object' && !Array.isArray(categoryData);
                    
                    return (
                        <div key={f} className="bg-gradient-to-br from-orange-50 to-yellow-50 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 border border-orange-100">
                            <div className="flex justify-between items-center mb-4">
                                <label className="font-semibold text-orange-900 flex items-center gap-2">
                                    <svg className="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                                    </svg>
                                    {fc.label}
                                    <span className="ml-auto bg-orange-600 text-white text-xs px-2.5 py-1 rounded-full">{count} Duvar</span>
                                </label>
                                <button onClick={addWallCover} className="px-3 py-1.5 bg-gradient-to-r from-green-500 to-green-600 text-white text-xs rounded-lg hover:from-green-600 hover:to-green-700 shadow-md flex items-center gap-1">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Duvar Ekle
                                </button>
                            </div>
                            <div className="space-y-3">
                                {[...Array(count)].map((_, i) => {
                                    const wallData = data.duvar_kaplama && data.duvar_kaplama[i] ? data.duvar_kaplama[i] : {};
                                    return (
                                        <div key={i} className="bg-white rounded-lg p-4 border-2 border-orange-200 hover:border-orange-300 transition-all">
                                            <div className="flex justify-between items-center mb-3">
                                                <span className="text-sm font-semibold text-orange-800 flex items-center gap-2">
                                                    <span className="w-6 h-6 bg-orange-500 text-white rounded-full flex items-center justify-center text-xs">{i + 1}</span>
                                                    Duvar {i + 1}
                                                </span>
                                                {count > 1 && (
                                                    <button 
                                                        onClick={() => {
                                                            if (confirm('Bu duvar kaplamasƒ±nƒ± silmek istediƒüinize emin misiniz?')) {
                                                                // G√úNCEL veriyi al
                                                                const currentData = getRoomData();
                                                                const currentWalls = currentData.duvar_kaplama || {};
                                                                
                                                                // Sadece malzemesi olan duvarlarƒ± array'e al (se√ßileni hari√ß tut)
                                                                const newWallArray = [];
                                                                for (let j = 0; j < count; j++) {
                                                                    if (j !== i) { // Se√ßilen duvarƒ± atlama
                                                                        if (currentWalls[j] && currentWalls[j].malzeme) {
                                                                            // Sadece dolu duvarlarƒ± ekle
                                                                            newWallArray.push(currentWalls[j]);
                                                                        }
                                                                    }
                                                                }
                                                                
                                                                // Yeni object olu≈ütur - array'i 0'dan ba≈ülayarak indexle
                                                                const newWallData = {};
                                                                newWallArray.forEach((wall, idx) => {
                                                                    newWallData[idx] = wall;
                                                                });
                                                                
                                                                // wallCount'u azalt
                                                                const newCount = count - 1;
                                                                
                                                                // ƒ∞Kƒ∞ state'i de aynƒ± anda g√ºncelle
                                                                const updatedApts = apartments.map(a => {
                                                                    if (a.id === currentApt) {
                                                                        return {
                                                                            ...a,
                                                                            wallCount: { ...a.wallCount, [currentRoom]: newCount },
                                                                            data: {
                                                                                ...a.data,
                                                                                [currentRoom]: {
                                                                                    ...a.data[currentRoom],
                                                                                    duvar_kaplama: newWallData
                                                                                }
                                                                            }
                                                                        };
                                                                    }
                                                                    return a;
                                                                });
                                                                
                                                                updateApartments(updatedApts);
                                                            }
                                                        }}
                                                        className="px-2 py-1 bg-red-500 text-white rounded-lg text-xs hover:bg-red-600 flex items-center gap-1"
                                                    >
                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                        Sil
                                                    </button>
                                                )}
                                            </div>
                                        {isHierarchical ? (
                                            /* Hiyerar≈üik Se√ßim */
                                            <div className="space-y-2">
                                                <div className="flex flex-col gap-2">
                                                    <select 
                                                        value={wallData.subgroup || ''} 
                                                        onChange={(e) => updateWallCover(i, 'subgroup', e.target.value)} 
                                                        className={`border-2 rounded-lg px-3 py-2 text-sm w-auto min-w-full focus:ring transition-all ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-orange-400 focus:ring-orange-500'
                                                                : 'border-gray-200 bg-white text-gray-900 focus:border-orange-500 focus:ring-orange-200'
                                                        }`}
                                                        style={{ width: 'fit-content', minWidth: '100%' }}
                                                    >
                                                        <option value="">üîπ Alt Grup Se√ßiniz</option>
                                                        {Object.keys(categoryData).map(sg => (
                                                            <option key={sg} value={sg}>{sg}</option>
                                                        ))}
                                                    </select>
                                                    {wallData.subgroup ? (
                                                        <select 
                                                            value={wallData.malzeme || ''} 
                                                            onChange={(e) => updateWallCover(i, 'malzeme', e.target.value)} 
                                                            className={`border-2 rounded-lg px-3 py-2 text-sm w-auto min-w-full focus:ring transition-all ${
                                                                theme === 'dark'
                                                                    ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-orange-400 focus:ring-orange-500'
                                                                    : 'border-gray-200 bg-white text-gray-900 focus:border-orange-500 focus:ring-orange-200'
                                                            }`}
                                                            style={{ width: 'fit-content', minWidth: '100%' }}
                                                        >
                                                            <option value="">üî∏ Malzeme Se√ßiniz</option>
                                                            {(categoryData[wallData.subgroup] || []).map(m => (
                                                                <option key={m} value={m}>{m}</option>
                                                            ))}
                                                        </select>
                                                    ) : (
                                                        <div className="border-2 border-dashed border-gray-200 rounded-lg px-3 py-2 bg-gray-50 text-gray-400 flex items-center text-xs">
                                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                            </svg>
                                                            √ñnce alt grup se√ßiniz
                                                        </div>
                                                    )}
                                                </div>
                                                {wallData.malzeme && (
                                                    <div className="relative">
                                                        <input 
                                                            type="number" 
                                                            step="0.01" 
                                                            value={wallData.miktar || ''} 
                                                            onChange={(e) => updateWallCover(i, 'miktar', e.target.value)} 
                                                            placeholder="0.00" 
                                                            className={`border-2 rounded-lg px-3 py-2 text-sm w-full focus:ring transition-all pr-12 ${
                                                                theme === 'dark'
                                                                    ? 'border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 focus:border-green-400 focus:ring-green-500'
                                                                    : 'border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-200'
                                                            }`}
                                                        />
                                                        <span className={`absolute right-3 top-1/2 -translate-y-1/2 text-sm font-medium ${
                                                            theme === 'dark' ? 'text-gray-400' : 'text-gray-500'
                                                        }`}>m¬≤</span>
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            /* D√ºz Liste */
                                            <div className="flex flex-col gap-2">
                                                <select 
                                                    value={wallData.malzeme || ''} 
                                                    onChange={(e) => updateWallCover(i, 'malzeme', e.target.value)} 
                                                    className={`border-2 rounded-lg px-3 py-2 text-sm w-auto min-w-full focus:ring transition-all ${
                                                        theme === 'dark'
                                                            ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-orange-400 focus:ring-orange-500'
                                                            : 'border-gray-200 bg-white text-gray-900 focus:border-orange-500 focus:ring-orange-200'
                                                    }`}
                                                    style={{ width: 'fit-content', minWidth: '100%' }}
                                                >
                                                    <option value="">Se√ßiniz...</option>
                                                    {(Array.isArray(categoryData) ? categoryData : []).map(m => (
                                                        <option key={m} value={m}>{m}</option>
                                                    ))}
                                                </select>
                                                <div className="relative">
                                                    <input 
                                                        type="number" 
                                                        step="0.01" 
                                                        value={wallData.miktar || ''} 
                                                        onChange={(e) => updateWallCover(i, 'miktar', e.target.value)} 
                                                        placeholder="0.00" 
                                                        className={`border-2 rounded-lg px-3 py-2 text-sm w-full focus:ring transition-all pr-12 ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 focus:border-green-400 focus:ring-green-500'
                                                                : 'border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-200'
                                                        }`}
                                                    />
                                                    <span className={`absolute right-3 top-1/2 -translate-y-1/2 text-sm font-medium ${
                                                        theme === 'dark' ? 'text-gray-400' : 'text-gray-500'
                                                    }`}>m¬≤</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            </div>
                        </div>
                    );
                }

                // Kategoriye g√∂re renk ve ikon belirleme
                const getCategoryStyle = (category) => {
                    const styles = {
                        'Zemin': { 
                            from: 'from-emerald-50', to: 'to-green-50', border: 'border-emerald-200', 
                            icon: 'text-emerald-600', badge: 'bg-emerald-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>'
                        },
                        'Boya': { 
                            from: 'from-blue-50', to: 'to-cyan-50', border: 'border-blue-200', 
                            icon: 'text-blue-600', badge: 'bg-blue-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>'
                        },
                        'Kaplama': { 
                            from: 'from-purple-50', to: 'to-pink-50', border: 'border-purple-200', 
                            icon: 'text-purple-600', badge: 'bg-purple-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>'
                        },
                        'Dolap': { 
                            from: 'from-amber-50', to: 'to-yellow-50', border: 'border-amber-200', 
                            icon: 'text-amber-600', badge: 'bg-amber-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>'
                        },
                        'Tezgah': { 
                            from: 'from-orange-50', to: 'to-red-50', border: 'border-orange-200', 
                            icon: 'text-orange-600', badge: 'bg-orange-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>'
                        },
                        'Panel': { 
                            from: 'from-teal-50', to: 'to-cyan-50', border: 'border-teal-200', 
                            icon: 'text-teal-600', badge: 'bg-teal-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>'
                        },
                        'Armat√ºr': { 
                            from: 'from-indigo-50', to: 'to-purple-50', border: 'border-indigo-200', 
                            icon: 'text-indigo-600', badge: 'bg-indigo-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>'
                        },
                        'Aksesuar': { 
                            from: 'from-pink-50', to: 'to-rose-50', border: 'border-pink-200', 
                            icon: 'text-pink-600', badge: 'bg-pink-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>'
                        },
                        'Elektrik': { 
                            from: 'from-yellow-50', to: 'to-amber-50', border: 'border-yellow-200', 
                            icon: 'text-yellow-600', badge: 'bg-yellow-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>'
                        },
                        'Doƒürama': { 
                            from: 'from-slate-50', to: 'to-gray-50', border: 'border-slate-200', 
                            icon: 'text-slate-600', badge: 'bg-slate-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>'
                        },
                        'Tekstil': { 
                            from: 'from-rose-50', to: 'to-pink-50', border: 'border-rose-200', 
                            icon: 'text-rose-600', badge: 'bg-rose-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>'
                        },
                        'Elektrik': { 
                            from: 'from-yellow-50', to: 'to-amber-50', border: 'border-yellow-200', 
                            icon: 'text-yellow-600', badge: 'bg-yellow-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>'
                        },
                        'Doƒürama': { 
                            from: 'from-slate-50', to: 'to-gray-50', border: 'border-slate-200', 
                            icon: 'text-slate-600', badge: 'bg-slate-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>'
                        },
                        'Tekstil': { 
                            from: 'from-rose-50', to: 'to-pink-50', border: 'border-rose-200', 
                            icon: 'text-rose-600', badge: 'bg-rose-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>'
                        }
                    };
                    return styles[category] || { 
                        from: 'from-gray-50', to: 'to-slate-50', border: 'border-gray-200', 
                        icon: 'text-gray-600', badge: 'bg-gray-600',
                        svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>'
                    };
                };

                const categoryStyle = getCategoryStyle(fc.category);

                return (
                    <div key={f} className={`bg-gradient-to-br ${categoryStyle.from} ${categoryStyle.to} rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 border-2 ${categoryStyle.border}`}>
                        <label className={`block text-sm font-semibold mb-4 flex items-center gap-2 ${categoryStyle.icon}`}>
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" dangerouslySetInnerHTML={{ __html: categoryStyle.svg }}>
                            </svg>
                            {fc.label}
                            {fc.unit && <span className={`ml-auto text-white text-xs px-3 py-1 rounded-full ${categoryStyle.badge}`}>{fc.unit}</span>}
                        </label>
                        <div className="flex flex-col gap-3">
                            {/* Ana Kategori Altƒ±nda Alt Gruplar Var mƒ± Kontrol */}
                            {typeof materials[fc.category] === 'object' && !Array.isArray(materials[fc.category]) ? (
                                <>
                                    {/* Alt Grup Se√ßimi */}
                                    <select 
                                        value={data[f] ? data[f].subgroup || '' : ''} 
                                        onChange={(e) => updateField(f, { ...(data[f] || {}), subgroup: e.target.value, malzeme: '' })} 
                                        className={`border-2 rounded-lg px-4 py-2.5 w-auto min-w-full focus:ring transition-all ${
                                            theme === 'dark'
                                                ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-blue-400 focus:ring-blue-500'
                                                : 'border-gray-200 bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-200'
                                        }`}
                                        style={{ width: 'fit-content', minWidth: '100%' }}
                                    >
                                        <option value="">üîπ Alt Grup Se√ßiniz</option>
                                        {Object.keys(materials[fc.category]).map(sg => (
                                            <option key={sg} value={sg}>{sg}</option>
                                        ))}
                                    </select>
                                    {/* Malzeme Se√ßimi - Sadece alt grup se√ßilmi≈üse */}
                                    {data[f] && data[f].subgroup ? (
                                        <select 
                                            value={data[f].malzeme || ''} 
                                            onChange={(e) => updateField(f, { ...(data[f] || {}), malzeme: e.target.value })} 
                                            className={`border-2 rounded-lg px-4 py-2.5 w-auto min-w-full focus:ring transition-all ${
                                                theme === 'dark'
                                                    ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-blue-400 focus:ring-blue-500'
                                                    : 'border-gray-200 bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-200'
                                            }`}
                                            style={{ width: 'fit-content', minWidth: '100%' }}
                                        >
                                            <option value="">üî∏ Malzeme Se√ßiniz</option>
                                            {(materials[fc.category][data[f].subgroup] || []).map(m => (
                                                <option key={m} value={m}>{m}</option>
                                            ))}
                                        </select>
                                    ) : (
                                        <div className="border-2 border-dashed border-gray-300 rounded-lg px-4 py-3 bg-white text-gray-400 flex items-center text-sm">
                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            √ñnce alt grup se√ßiniz
                                        </div>
                                    )}
                                </>
                            ) : (
                                /* Eski D√ºz Liste Yapƒ±sƒ± - Geriye Uyumluluk */
                                <select 
                                    value={data[f] ? data[f].malzeme || '' : ''} 
                                    onChange={(e) => updateField(f, { ...(data[f] || {}), malzeme: e.target.value })} 
                                    className="border-2 border-gray-200 bg-white rounded-lg px-4 py-2.5 w-auto min-w-full focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all"
                                    style={{ width: 'fit-content', minWidth: '100%' }}
                                >
                                    <option value="">Se√ßiniz...</option>
                                    {(Array.isArray(materials[fc.category]) ? materials[fc.category] : []).map(m => (
                                        <option key={m} value={m}>{m}</option>
                                    ))}
                                </select>
                            )}
                        </div>
                        {/* Miktar/Detay - Alt satƒ±r */}
                        {(data[f] && data[f].malzeme) && (
                            <div className="mt-3 pt-3 border-t-2 border-white">
                                {fc.unit ? (
                                    <div className="relative">
                                        <input 
                                            type="number" 
                                            step="0.01" 
                                            value={data[f].miktar || ''} 
                                            onChange={(e) => updateField(f, { ...(data[f] || {}), miktar: e.target.value })} 
                                            placeholder="0.00" 
                                            className={`border-2 rounded-lg px-4 py-2.5 w-full focus:ring transition-all pr-16 ${
                                                theme === 'dark'
                                                    ? 'border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 focus:border-green-400 focus:ring-green-500'
                                                    : 'border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-200'
                                            }`}
                                        />
                                        <span className={`absolute right-4 top-1/2 -translate-y-1/2 text-white text-sm font-bold px-2 py-1 rounded ${categoryStyle.badge}`}>{fc.unit}</span>
                                    </div>
                                ) : (
                                    <input 
                                        type="text" 
                                        value={data[f].miktar || ''} 
                                        onChange={(e) => updateField(f, { ...(data[f] || {}), miktar: e.target.value })} 
                                        placeholder="Detay giriniz..." 
                                        className={`border-2 rounded-lg px-4 py-2.5 w-full focus:ring transition-all ${
                                            theme === 'dark'
                                                ? 'border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 focus:border-green-400 focus:ring-green-500'
                                                : 'border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-200'
                                        }`} 
                                    />
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            const room = allRooms.find(r => r.id === currentRoom);

            // Auth y√ºkleniyor ekranƒ±
            if (authLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                            <p className="text-white text-xl font-semibold">Y√ºkleniyor...</p>
                        </div>
                    </div>
                );
            }

            // Giri≈ü yapƒ±lmamƒ±≈üsa login ekranƒ±nƒ± g√∂ster
            if (!user && firebaseEnabled) {
                return <LoginScreen />;
            }

            return (
                <div className={`min-h-screen p-4 transition-colors duration-300 ${
                    theme === 'dark' 
                        ? 'bg-gray-900' 
                        : 'bg-gray-100'
                }`}>
                    {showDB && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg p-6 max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                                <div className="flex justify-between mb-4">
                                    <h2 className="text-xl font-bold">Malzeme Veritabani</h2>
                                    <div className="flex gap-2 items-center">
                                        <button onClick={() => {
                                            if (confirm('Malzeme veritabanini varsayilan degerlere sifirlamak istediginize emin misiniz?\n\nBu islem geri alinamaz!')) {
                                                setMaterials(DEFAULT_MATERIALS);
                                                localStorage.setItem('material_database', JSON.stringify(DEFAULT_MATERIALS));
                                                alert('Malzeme veritabani sifirandi!');
                                            }
                                        }} className="px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600">üîÑ Sƒ±fƒ±rla</button>
                                        <button onClick={() => setShowDB(false)} className="text-2xl">√ó</button>
                                    </div>
                                </div>
                                
                                {/* Arama Kutusu */}
                                <div className="mb-4">
                                    <div className="relative">
                                        <input
                                            type="text"
                                            placeholder="Malzeme ara..."
                                            value={searchMaterial}
                                            onChange={(e) => setSearchMaterial(e.target.value)}
                                            className="w-full pl-10 pr-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                                        />
                                        <svg className="absolute left-3 top-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                
                                {/* Sekmeler */}
                                <div className="flex gap-2 mb-4 overflow-x-auto pb-2 border-b-2 flex-shrink-0">
                                    {Object.keys(materials).map((cat, index) => (
                                        <button
                                            key={cat}
                                            draggable
                                            onDragStart={() => setDraggedTab(index)}
                                            onDragOver={(e) => {
                                                e.preventDefault();
                                                e.currentTarget.style.borderLeft = '3px solid #3b82f6';
                                            }}
                                            onDragLeave={(e) => {
                                                e.currentTarget.style.borderLeft = 'none';
                                            }}
                                            onDrop={(e) => {
                                                e.preventDefault();
                                                e.currentTarget.style.borderLeft = 'none';
                                                if (draggedTab !== null && draggedTab !== index) {
                                                    reorderTabs(draggedTab, index);
                                                }
                                                setDraggedTab(null);
                                            }}
                                            onClick={() => setActiveDBTab(cat)}
                                            className={`px-4 py-2 rounded-t-lg font-semibold whitespace-nowrap transition-all cursor-move ${
                                                activeDBTab === cat 
                                                    ? 'bg-blue-500 text-white shadow-md' 
                                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }`}
                                            title="S√ºr√ºkleyerek sƒ±ra deƒüi≈ütir"
                                        >
                                            ‚†ø {cat}
                                        </button>
                                    ))}
                                </div>
                                
                                {/* Sekme ƒ∞√ßeriƒüi */}
                                <div className="flex-1 overflow-auto">
                                    {Object.keys(materials).map(cat => activeDBTab === cat && (
                                        <div key={cat} className="border-2 border-gray-300 rounded-lg p-4 bg-gradient-to-br from-white to-gray-50">
                                            <div className="flex justify-between items-center mb-3 pb-3 border-b-2 border-gray-200">
                                                <h3 className="font-bold text-blue-700 text-lg flex items-center gap-2">
                                                    <span className="w-2 h-2 bg-blue-600 rounded-full"></span>
                                                    {cat}
                                                </h3>
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => {
                                                            const newName = prompt('Yeni kategori adƒ±:', cat);
                                                            if (newName && newName.trim() && newName !== cat) {
                                                                if (materials[newName.trim()]) {
                                                                    alert('Bu kategori adƒ± zaten mevcut!');
                                                                    return;
                                                                }
                                                                const newMat = { ...materials };
                                                                newMat[newName.trim()] = newMat[cat];
                                                                delete newMat[cat];
                                                                setMaterials(newMat);
                                                                localStorage.setItem('material_database', JSON.stringify(newMat));
                                                            }
                                                        }}
                                                        className="px-3 py-2 bg-gradient-to-r from-yellow-500 to-amber-500 text-white rounded-lg text-sm font-semibold hover:from-yellow-600 hover:to-amber-600 shadow-md hover:shadow-lg transition-all flex items-center gap-1"
                                                        title="Kategori adƒ±nƒ± deƒüi≈ütir"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                        </svg>
                                                        D√ºzenle
                                                    </button>
                                                    <button 
                                                        onClick={() => {
                                                            if (confirm(`"${cat}" kategorisini ve t√ºm i√ßeriƒüini silmek istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`)) {
                                                                const newMat = { ...materials };
                                                                delete newMat[cat];
                                                                setMaterials(newMat);
                                                                localStorage.setItem('material_database', JSON.stringify(newMat));
                                                            }
                                                        }}
                                                        className="px-3 py-2 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg text-sm font-semibold hover:from-red-600 hover:to-rose-700 shadow-md hover:shadow-lg transition-all flex items-center gap-1"
                                                        title="Kategoriyi sil"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                        Sil
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            {/* Hiyerar≈üik Yapƒ± */}
                                            {typeof materials[cat] === 'object' && !Array.isArray(materials[cat]) ? (
                                                <div className="space-y-4">
                                                    {Object.keys(materials[cat]).map(subgroup => (
                                                        <div key={subgroup} className="border-2 border-blue-300 rounded-lg p-4 bg-blue-50 shadow-sm">
                                                            {/* Alt Grup Header */}
                                                            <div className="flex justify-between items-center mb-3 pb-2 border-b-2 border-blue-200">
                                                                <div className="font-bold text-base text-gray-800">{subgroup}</div>
                                                                <div className="flex gap-2">
                                                                    <button
                                                                        onClick={() => {
                                                                            const newName = prompt('Yeni alt grup adƒ±:', subgroup);
                                                                            if (newName && newName.trim() && newName !== subgroup) {
                                                                                if (materials[cat][newName.trim()]) {
                                                                                    alert('Bu alt grup adƒ± zaten mevcut!');
                                                                                    return;
                                                                                }
                                                                                const newMat = { ...materials };
                                                                                newMat[cat][newName.trim()] = newMat[cat][subgroup];
                                                                                delete newMat[cat][subgroup];
                                                                                setMaterials(newMat);
                                                                                localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                            }
                                                                        }}
                                                                        className="px-3 py-1.5 bg-gradient-to-r from-yellow-400 to-amber-400 text-white rounded-lg text-sm font-semibold hover:from-yellow-500 hover:to-amber-500 shadow-sm hover:shadow-md transition-all flex items-center gap-1"
                                                                        title="Alt grup adƒ±nƒ± deƒüi≈ütir"
                                                                    >
                                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                        </svg>
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            if (confirm(`"${subgroup}" alt grubunu ve t√ºm malzemelerini silmek istediƒüinize emin misiniz?`)) {
                                                                                const newMat = { ...materials };
                                                                                delete newMat[cat][subgroup];
                                                                                setMaterials(newMat);
                                                                                localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                            }
                                                                        }}
                                                                        className="px-3 py-1.5 bg-gradient-to-r from-red-400 to-rose-500 text-white rounded-lg text-sm font-semibold hover:from-red-500 hover:to-rose-600 shadow-sm hover:shadow-md transition-all flex items-center gap-1"
                                                                        title="Alt grubu sil"
                                                                    >
                                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Yeni Malzeme Input - √ústte */}
                                                            <div className="flex gap-2 mb-3">
                                                                <input 
                                                                    type="text" 
                                                                    id={'new-' + cat + '-' + subgroup} 
                                                                    placeholder="Yeni malzeme ekle..." 
                                                                    className="flex-1 border-2 border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all" 
                                                                    onKeyPress={(e) => {
                                                                        if (e.key === 'Enter') {
                                                                            const inp = document.getElementById('new-' + cat + '-' + subgroup);
                                                                            if (inp.value.trim()) {
                                                                                const newMat = { ...materials };
                                                                                newMat[cat][subgroup].push(inp.value.trim());
                                                                                setMaterials(newMat);
                                                                                localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                                inp.value = '';
                                                                            }
                                                                        }
                                                                    }}
                                                                />
                                                                <button onClick={() => {
                                                                    const inp = document.getElementById('new-' + cat + '-' + subgroup);
                                                                    if (inp.value.trim()) {
                                                                        const newMat = { ...materials };
                                                                        newMat[cat][subgroup].push(inp.value.trim());
                                                                        setMaterials(newMat);
                                                                        localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                        inp.value = '';
                                                                    }
                                                                }} className="px-6 py-2.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-sm font-bold hover:from-green-600 hover:to-emerald-700 shadow-md hover:shadow-lg transition-all whitespace-nowrap">+ Ekle</button>
                                                            </div>
                                                            
                                                            {/* Malzeme Listesi */}
                                                            <div className="space-y-2 max-h-64 overflow-auto">
                                                                {materials[cat][subgroup].filter(m => 
                                                                    m.toLowerCase().includes(searchMaterial.toLowerCase())
                                                                ).map(m => (
                                                                    <div key={m} className="flex justify-between items-center bg-white border-2 border-gray-200 px-4 py-3 rounded-lg text-sm group hover:border-blue-400 hover:shadow-md transition-all">
                                                                        <span className="text-gray-800 font-medium">{m}</span>
                                                                        <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                            <button 
                                                                                onClick={() => {
                                                                                    const newName = prompt('Yeni malzeme adƒ±:', m);
                                                                                    if (newName && newName.trim() && newName !== m) {
                                                                                        const newMat = { ...materials };
                                                                                        const index = newMat[cat][subgroup].indexOf(m);
                                                                                        if (index !== -1) {
                                                                                            newMat[cat][subgroup][index] = newName.trim();
                                                                                            setMaterials(newMat);
                                                                                            localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                                        }
                                                                                    }
                                                                                }}
                                                                                className="px-2 py-1 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-lg text-xs font-semibold hover:from-blue-600 hover:to-cyan-700 shadow-sm hover:shadow-md transition-all flex items-center gap-1"
                                                                                title="Malzeme adƒ±nƒ± deƒüi≈ütir"
                                                                            >
                                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                                </svg>
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => {
                                                                                    if (confirm('Silmek istediginize emin misiniz?\n' + m)) {
                                                                                        const newMat = { ...materials };
                                                                                        newMat[cat][subgroup] = newMat[cat][subgroup].filter(item => item !== m);
                                                                                        setMaterials(newMat);
                                                                                        localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                                    }
                                                                                }}
                                                                                className="px-2 py-1 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg text-xs font-semibold hover:from-red-600 hover:to-rose-700 shadow-sm hover:shadow-md transition-all flex items-center gap-1"
                                                                                title="Malzemeyi sil"
                                                                            >
                                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {/* Yeni Alt Grup Ekle */}
                                                    <button onClick={() => {
                                                        const newSubgroup = prompt('Yeni alt grup adi (' + cat + ' icin):');
                                                        if (newSubgroup && newSubgroup.trim()) {
                                                            const newMat = { ...materials };
                                                            newMat[cat][newSubgroup.trim()] = [];
                                                            setMaterials(newMat);
                                                            localStorage.setItem('material_database', JSON.stringify(newMat));
                                                        }
                                                    }} className="w-full px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">+ Alt Grup Ekle</button>
                                                </div>
                                            ) : (
                                                /* Eski D√ºz Liste */
                                                <div>
                                                    <div className="flex gap-2 mb-2">
                                                        <input type="text" id={'new-' + cat} placeholder="Yeni malzeme ekle..." className="flex-1 border-2 border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all" />
                                                        <button onClick={() => {
                                                            const inp = document.getElementById('new-' + cat);
                                                            if (inp.value.trim()) { addMaterial(cat, inp.value.trim()); inp.value = ''; }
                                                        }} className="px-3 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-sm font-bold hover:from-green-600 hover:to-emerald-700 shadow-md hover:shadow-lg transition-all">+</button>
                                                    </div>
                                                    <div className="space-y-2 max-h-40 overflow-auto">
                                                        {(Array.isArray(materials[cat]) ? materials[cat] : []).map(m => (
                                                            <div key={m} className="flex justify-between items-center bg-white border border-gray-200 px-3 py-2 rounded-lg text-sm group hover:border-blue-300 hover:shadow-sm transition-all">
                                                                <span className="text-gray-700">{m}</span>
                                                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <button 
                                                                        onClick={() => {
                                                                            const newName = prompt('Yeni malzeme adƒ±:', m);
                                                                            if (newName && newName.trim() && newName !== m) {
                                                                                const newMat = { ...materials };
                                                                                const index = newMat[cat].indexOf(m);
                                                                                if (index !== -1) {
                                                                                    newMat[cat][index] = newName.trim();
                                                                                    setMaterials(newMat);
                                                                                    localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                                }
                                                                            }
                                                                        }}
                                                                        className="px-2 py-1 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-lg text-xs font-semibold hover:from-blue-600 hover:to-cyan-700 shadow-sm hover:shadow-md transition-all flex items-center gap-1"
                                                                        title="Malzeme adƒ±nƒ± deƒüi≈ütir"
                                                                    >
                                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                        </svg>
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => deleteMaterial(cat, m)} 
                                                                        className="px-2 py-1 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg text-xs font-semibold hover:from-red-600 hover:to-rose-700 shadow-sm hover:shadow-md transition-all flex items-center gap-1" 
                                                                        title="Malzemeyi sil"
                                                                    >
                                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* DAƒ∞RE KOPYALAMA MODAL */}
                    {showCopyModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-md w-full transition-colors ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <h2 className={`text-2xl font-bold flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                        Daire Kopyala
                                    </h2>
                                    <button 
                                        onClick={() => setShowCopyModal(false)} 
                                        className="text-3xl hover:text-gray-600 transition-colors"
                                    >√ó</button>
                                </div>
                                
                                <div className={`mb-4 p-4 rounded-lg ${
                                    theme === 'dark' ? 'bg-purple-900 border-purple-700' : 'bg-purple-50 border-purple-200'
                                } border-l-4`}>
                                    <p className={`text-sm ${theme === 'dark' ? 'text-purple-100' : 'text-purple-800'}`}>
                                        <strong>{getApt().name}</strong> dairesinden hangi verileri kopyalamak istiyorsunuz?
                                    </p>
                                </div>
                                
                                <div className="space-y-4 mb-6">
                                    {/* Mekanlar */}
                                    <label className={`flex items-center gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                        copyOptions.rooms
                                            ? theme === 'dark'
                                                ? 'border-purple-600 bg-purple-900 bg-opacity-20'
                                                : 'border-purple-500 bg-purple-50'
                                            : theme === 'dark'
                                                ? 'border-gray-700 bg-gray-750'
                                                : 'border-gray-200 bg-gray-50'
                                    }`}>
                                        <input
                                            type="checkbox"
                                            checked={copyOptions.rooms}
                                            onChange={(e) => setCopyOptions({ ...copyOptions, rooms: e.target.checked })}
                                            className="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
                                        />
                                        <div className="flex-1">
                                            <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                üè† Mekanlar ve Yapƒ±
                                            </div>
                                            <div className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                Gizli/g√∂r√ºn√ºr mekanlar, duvar sayƒ±larƒ±
                                            </div>
                                        </div>
                                    </label>
                                    
                                    {/* Malzemeler */}
                                    <label className={`flex items-center gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                        copyOptions.materials
                                            ? theme === 'dark'
                                                ? 'border-purple-600 bg-purple-900 bg-opacity-20'
                                                : 'border-purple-500 bg-purple-50'
                                            : theme === 'dark'
                                                ? 'border-gray-700 bg-gray-750'
                                                : 'border-gray-200 bg-gray-50'
                                    }`}>
                                        <input
                                            type="checkbox"
                                            checked={copyOptions.materials}
                                            onChange={(e) => setCopyOptions({ ...copyOptions, materials: e.target.checked })}
                                            className="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
                                            disabled={!copyOptions.rooms}
                                        />
                                        <div className="flex-1">
                                            <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                üé® Malzemeler
                                            </div>
                                            <div className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                Se√ßili malzemeler ve alt gruplar
                                            </div>
                                        </div>
                                    </label>
                                    
                                    {/* Miktarlar */}
                                    <label className={`flex items-center gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                        copyOptions.amounts
                                            ? theme === 'dark'
                                                ? 'border-purple-600 bg-purple-900 bg-opacity-20'
                                                : 'border-purple-500 bg-purple-50'
                                            : theme === 'dark'
                                                ? 'border-gray-700 bg-gray-750'
                                                : 'border-gray-200 bg-gray-50'
                                    }`}>
                                        <input
                                            type="checkbox"
                                            checked={copyOptions.amounts}
                                            onChange={(e) => setCopyOptions({ ...copyOptions, amounts: e.target.checked })}
                                            className="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
                                            disabled={!copyOptions.rooms}
                                        />
                                        <div className="flex-1">
                                            <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                üìè Miktarlar
                                            </div>
                                            <div className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                m¬≤, adet gibi miktar bilgileri (Malzemelerden baƒüƒ±msƒ±z)
                                            </div>
                                        </div>
                                    </label>
                                    
                                    {/* Fotoƒüraflar */}
                                    <label className={`flex items-center gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                        copyOptions.photos
                                            ? theme === 'dark'
                                                ? 'border-purple-600 bg-purple-900 bg-opacity-20'
                                                : 'border-purple-500 bg-purple-50'
                                            : theme === 'dark'
                                                ? 'border-gray-700 bg-gray-750'
                                                : 'border-gray-200 bg-gray-50'
                                    }`}>
                                        <input
                                            type="checkbox"
                                            checked={copyOptions.photos}
                                            onChange={(e) => setCopyOptions({ ...copyOptions, photos: e.target.checked })}
                                            className="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
                                            disabled={!copyOptions.rooms}
                                        />
                                        <div className="flex-1">
                                            <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                üì∏ Fotoƒüraflar
                                            </div>
                                            <div className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                T√ºm y√ºkl√º fotoƒüraflar
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                
                                {/* Kopyalama Sayƒ±sƒ± */}
                                <div className={`mb-6 p-4 rounded-lg border-2 ${
                                    theme === 'dark'
                                        ? 'border-amber-700 bg-amber-900 bg-opacity-20'
                                        : 'border-amber-300 bg-amber-50'
                                }`}>
                                    <label className={`block text-sm font-semibold mb-2 ${
                                        theme === 'dark' ? 'text-amber-200' : 'text-amber-800'
                                    }`}>
                                        üî¢ Ka√ß Adet Kopyalamak ƒ∞stiyorsunuz?
                                    </label>
                                    <input
                                        type="number"
                                        min="1"
                                        max="50"
                                        value={copyCount}
                                        onChange={(e) => setCopyCount(e.target.value)}
                                        className={`w-full px-4 py-3 border-2 rounded-lg text-center text-xl font-bold focus:ring-2 transition-colors ${
                                            theme === 'dark'
                                                ? 'border-amber-600 bg-gray-700 text-amber-200 focus:border-amber-400 focus:ring-amber-500'
                                                : 'border-amber-400 bg-white text-amber-900 focus:border-amber-500 focus:ring-amber-200'
                                        }`}
                                    />
                                    <p className={`text-xs mt-2 ${
                                        theme === 'dark' ? 'text-amber-300' : 'text-amber-700'
                                    }`}>
                                        üí° Otomatik sƒ±ra numarasƒ± verilecek (√∂rn: Daire 3, Daire 4, Daire 5...)
                                    </p>
                                </div>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowCopyModal(false)}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-100 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                    <button
                                        onClick={copyApartment}
                                        className="flex-1 px-4 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                        Kopyala
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Mƒ∞KTAR KOPYALAMA MODAL */}
                    {showCopyAmountsModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-md w-full transition-colors ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <h2 className={`text-2xl font-bold flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-7 h-7 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                        Miktar Kopyala
                                    </h2>
                                    <button 
                                        onClick={() => {
                                            setShowCopyAmountsModal(false);
                                            setSourceAptForAmounts(null);
                                            setSelectedFieldsForCopy({});
                                        }} 
                                        className="text-3xl hover:text-gray-600 transition-colors"
                                    >√ó</button>
                                </div>
                                
                                <div className={`mb-4 p-4 rounded-lg ${
                                    theme === 'dark' ? 'bg-cyan-900 border-cyan-700' : 'bg-cyan-50 border-cyan-200'
                                } border-l-4`}>
                                    <p className={`text-sm mb-2 ${theme === 'dark' ? 'text-cyan-100' : 'text-cyan-800'}`}>
                                        <strong>{getApt().name}</strong> dairesine hangi daireden miktarlarƒ± kopyalamak istiyorsunuz?
                                    </p>
                                    <p className={`text-xs ${theme === 'dark' ? 'text-cyan-200' : 'text-cyan-700'}`}>
                                        ‚ÑπÔ∏è Sadece e≈üle≈üen mekan ve malzemeler i√ßin miktarlar kopyalanƒ±r
                                    </p>
                                </div>
                                
                                <div className="mb-6">
                                    <label className={`block text-sm font-semibold mb-2 ${
                                        theme === 'dark' ? 'text-gray-200' : 'text-gray-700'
                                    }`}>
                                        Kaynak Daire:
                                    </label>
                                    <select 
                                        value={sourceAptForAmounts || ''}
                                        onChange={(e) => setSourceAptForAmounts(parseInt(e.target.value))}
                                        className={`w-full px-4 py-3 border-2 rounded-lg focus:ring-2 transition-colors ${
                                            theme === 'dark'
                                                ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-cyan-400 focus:ring-cyan-500'
                                                : 'border-gray-300 bg-white text-gray-900 focus:border-cyan-500 focus:ring-cyan-200'
                                        }`}
                                    >
                                        <option value="">Daire se√ßin...</option>
                                        {apartments.filter(a => a.id !== currentApt).map(apt => (
                                            <option key={apt.id} value={apt.id} className={theme === 'dark' ? 'bg-gray-700 text-gray-100' : 'bg-white text-gray-900'}>
                                                {apt.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                
                                {/* Alan Se√ßimi */}
                                {sourceAptForAmounts && (
                                    <div className="mb-6">
                                        <label className={`block text-sm font-semibold mb-3 ${
                                            theme === 'dark' ? 'text-gray-200' : 'text-gray-700'
                                        }`}>
                                            Hangi Alanlarƒ±n Miktarlarƒ±nƒ± Kopyalamak ƒ∞stiyorsunuz?
                                        </label>
                                        <div className="space-y-2 max-h-48 overflow-y-auto">
                                            {Object.keys(fieldLabels).filter(f => f !== 'foto').map(field => {
                                                const fc = fieldLabels[field];
                                                return (
                                                    <label 
                                                        key={field}
                                                        className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all ${
                                                            selectedFieldsForCopy[field]
                                                                ? theme === 'dark'
                                                                    ? 'border-cyan-600 bg-cyan-900 bg-opacity-20'
                                                                    : 'border-cyan-500 bg-cyan-50'
                                                                : theme === 'dark'
                                                                    ? 'border-gray-700 hover:border-gray-600'
                                                                    : 'border-gray-200 hover:border-gray-300'
                                                        }`}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedFieldsForCopy[field] || false}
                                                            onChange={(e) => setSelectedFieldsForCopy({
                                                                ...selectedFieldsForCopy,
                                                                [field]: e.target.checked
                                                            })}
                                                            className="w-4 h-4 text-cyan-600 rounded focus:ring-2 focus:ring-cyan-500"
                                                        />
                                                        <div className="flex-1">
                                                            <span className={`font-medium text-sm ${
                                                                theme === 'dark' ? 'text-gray-100' : 'text-gray-900'
                                                            }`}>
                                                                {fc.label}
                                                            </span>
                                                            {fc.unit && (
                                                                <span className={`ml-2 text-xs ${
                                                                    theme === 'dark' ? 'text-gray-400' : 'text-gray-500'
                                                                }`}>
                                                                    ({fc.unit})
                                                                </span>
                                                            )}
                                                        </div>
                                                    </label>
                                                );
                                            })}
                                        </div>
                                        <button
                                            onClick={() => {
                                                const allFields = {};
                                                Object.keys(fieldLabels).filter(f => f !== 'foto').forEach(f => {
                                                    allFields[f] = true;
                                                });
                                                setSelectedFieldsForCopy(allFields);
                                            }}
                                            className={`mt-2 text-xs font-semibold ${
                                                theme === 'dark' ? 'text-cyan-400 hover:text-cyan-300' : 'text-cyan-600 hover:text-cyan-700'
                                            }`}
                                        >
                                            ‚úì T√ºm√ºn√º Se√ß
                                        </button>
                                    </div>
                                )}
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setShowCopyAmountsModal(false);
                                            setSourceAptForAmounts(null);
                                            setSelectedFieldsForCopy({});
                                        }}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-100 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                    <button
                                        onClick={copyAmountsFromApartment}
                                        disabled={!sourceAptForAmounts || Object.values(selectedFieldsForCopy).every(v => !v)}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${
                                            sourceAptForAmounts && Object.values(selectedFieldsForCopy).some(v => v)
                                                ? 'bg-cyan-600 text-white hover:bg-cyan-700'
                                                : theme === 'dark'
                                                    ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
                                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                        Kopyala
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* MALZEME ANALƒ∞Zƒ∞ MODAL */}
                    {showMaterialAnalysis && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-7xl w-full h-[90vh] flex flex-col transition-colors ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between mb-6 pb-4 border-b">
                                    <h2 className={`text-2xl font-bold flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-7 h-7 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                        Malzeme Kullanƒ±m Analizi
                                    </h2>
                                    <button 
                                        onClick={() => setShowMaterialAnalysis(false)} 
                                        className="text-3xl hover:text-gray-600 transition-colors"
                                    >√ó</button>
                                </div>
                                
                                {(() => {
                                    const analysis = getMaterialUsageAnalysis();
                                    
                                    // Kategorileri al ve alfabetik sƒ±rala, T√ºm√º'y√º sona ekle
                                    const uniqueCategories = [...new Set(analysis.map(item => item.category))].sort();
                                    const categories = [...uniqueCategories, 'T√ºm√º'];
                                    
                                    // Aktif sekmeye g√∂re filtrele
                                    const filteredAnalysis = activeAnalysisTab === 'T√ºm√º' 
                                        ? analysis 
                                        : analysis.filter(item => item.category === activeAnalysisTab);
                                    
                                    return analysis.length === 0 ? (
                                        <div className={`text-center py-12 ${
                                            theme === 'dark' ? 'text-gray-400' : 'text-gray-500'
                                        }`}>
                                            <svg className="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                            </svg>
                                            <p className="text-lg font-medium">Hen√ºz malzeme kullanƒ±mƒ± yok</p>
                                            <p className="text-sm mt-2">Dairelere malzeme ekledik√ße burada g√∂r√ºnecek</p>
                                        </div>
                                    ) : (
                                        <>
                                            {/* Sekmeler */}
                                            <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                                                {categories.map(category => (
                                                    <button
                                                        key={category}
                                                        onClick={() => setActiveAnalysisTab(category)}
                                                        className={`px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap transition-all ${
                                                            activeAnalysisTab === category
                                                                ? theme === 'dark'
                                                                    ? 'bg-cyan-600 text-white shadow-lg'
                                                                    : 'bg-cyan-500 text-white shadow-lg'
                                                                : theme === 'dark'
                                                                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                        }`}
                                                    >
                                                        {category}
                                                        <span className={`ml-2 px-2 py-0.5 rounded-full text-xs ${
                                                            activeAnalysisTab === category
                                                                ? 'bg-white bg-opacity-30'
                                                                : theme === 'dark'
                                                                    ? 'bg-gray-600'
                                                                    : 'bg-gray-300'
                                                        }`}>
                                                            {category === 'T√ºm√º' 
                                                                ? analysis.length 
                                                                : analysis.filter(item => item.category === category).length
                                                            }
                                                        </span>
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            {/* Malzeme Listesi */}
                                            <div className="flex-1 overflow-auto">
                                                <div className="space-y-3">
                                                    {filteredAnalysis.map((item, idx) => {
                                                    const uniqueProjects = [...new Set(item.usages.map(u => u.project))];
                                                    const uniqueApartments = [...new Set(item.usages.map(u => `${u.project}|${u.apartment}`))];
                                                    
                                                    return (
                                                        <div 
                                                            key={idx} 
                                                            className={`border-2 rounded-lg p-4 transition-all ${
                                                                theme === 'dark'
                                                                    ? 'border-gray-700 bg-gray-750 hover:bg-gray-700'
                                                                    : 'border-gray-200 bg-white hover:shadow-md'
                                                            }`}
                                                        >
                                                            <div className="flex items-center justify-between mb-3">
                                                                <div className="flex-1">
                                                                    <div className="flex items-center gap-3 mb-2">
                                                                        <h3 className={`font-bold text-lg ${
                                                                            theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                                                        }`}>
                                                                            {item.material}
                                                                        </h3>
                                                                        <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                            theme === 'dark'
                                                                                ? 'bg-blue-900 text-blue-100'
                                                                                : 'bg-blue-100 text-blue-800'
                                                                        }`}>
                                                                            {item.category}
                                                                        </span>
                                                                        {item.subgroup !== '-' && (
                                                                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                                theme === 'dark'
                                                                                    ? 'bg-purple-900 text-purple-100'
                                                                                    : 'bg-purple-100 text-purple-800'
                                                                            }`}>
                                                                                {item.subgroup}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    <div className={`flex gap-6 text-sm ${
                                                                        theme === 'dark' ? 'text-gray-400' : 'text-gray-600'
                                                                    }`}>
                                                                        <span>üè¢ {uniqueProjects.length} Proje</span>
                                                                        <span>üè† {uniqueApartments.length} Daire</span>
                                                                        <span>üìç {item.usages.length} Kullanƒ±m</span>
                                                                    </div>
                                                                </div>
                                                                <div className={`text-right ${
                                                                    theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                                                }`}>
                                                                    <div className="text-2xl font-bold text-cyan-600">
                                                                        {item.totalAmount.toFixed(2)}
                                                                    </div>
                                                                    <div className="text-sm">{item.unit}</div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Kullanƒ±m Detaylarƒ± */}
                                                            <details className="mt-3">
                                                                <summary className={`cursor-pointer font-medium ${
                                                                    theme === 'dark' ? 'text-cyan-400' : 'text-cyan-600'
                                                                } hover:underline`}>
                                                                    Detaylarƒ± G√∂ster ({item.usages.length} kullanƒ±m)
                                                                </summary>
                                                                <div className="mt-3 space-y-2 max-h-48 overflow-auto">
                                                                    {item.usages.map((usage, uIdx) => (
                                                                        <div 
                                                                            key={uIdx}
                                                                            className={`flex justify-between items-center p-3 rounded-lg text-sm ${
                                                                                theme === 'dark'
                                                                                    ? 'bg-gray-800 border border-gray-700'
                                                                                    : 'bg-gray-50 border border-gray-200'
                                                                            }`}
                                                                        >
                                                                            <div className={theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}>
                                                                                <span className="font-medium">{usage.project}</span>
                                                                                <span className="mx-2">‚Üí</span>
                                                                                <span className="font-medium">{usage.apartment}</span>
                                                                                <span className="mx-2">‚Üí</span>
                                                                                <span>{usage.room}</span>
                                                                                <span className="mx-2 text-gray-400">‚Ä¢</span>
                                                                                <span className={theme === 'dark' ? 'text-gray-500' : 'text-gray-500'}>
                                                                                    {usage.field}
                                                                                </span>
                                                                            </div>
                                                                            <div className={`font-bold ${
                                                                                theme === 'dark' ? 'text-cyan-400' : 'text-cyan-600'
                                                                            }`}>
                                                                                {usage.amount.toFixed(2)} {item.unit}
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </details>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                        </>
                                    );
                                })()}
                            </div>
                        </div>
                    )}
                    
                    {showFieldManager && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg p-6 max-w-5xl w-full max-h-[85vh] overflow-auto">
                                <div className="flex justify-between mb-4">
                                    <h2 className="text-xl font-bold">Alan Y√∂netimi</h2>
                                    <button onClick={() => setShowFieldManager(false)} className="text-2xl hover:text-red-500">√ó</button>
                                </div>
                                
                                <div className="mb-4 p-4 bg-blue-50 rounded border border-blue-200">
                                    <p className="text-sm text-blue-800">
                                        Buradan yeni alanlar ekleyebilir, mevcut alanlarƒ± d√ºzenleyebilir veya silebilirsiniz. 
                                        Eklediƒüiniz alanlar mekan olu≈ütururken ve d√ºzenlerken kullanƒ±labilir olacaktƒ±r.
                                    </p>
                                </div>
                                
                                <button onClick={addField} className="mb-4 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 font-semibold">
                                    + Yeni Alan Ekle
                                </button>
                                
                                <div className="overflow-x-auto">
                                    <table className="w-full border-collapse">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border px-4 py-2 text-left">ID</th>
                                                <th className="border px-4 py-2 text-left">Alan Adƒ±</th>
                                                <th className="border px-4 py-2 text-left">Birim</th>
                                                <th className="border px-4 py-2 text-left">Kategori</th>
                                                <th className="border px-4 py-2 text-center">ƒ∞≈ülemler</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.entries(fieldLabels).map(([fieldId, field]) => (
                                                <tr key={fieldId} className="hover:bg-gray-50">
                                                    <td className="border px-4 py-2 font-mono text-sm">{fieldId}</td>
                                                    <td className="border px-4 py-2">{field.label}</td>
                                                    <td className="border px-4 py-2">
                                                        {field.unit || <span className="text-gray-400 italic">Yok</span>}
                                                    </td>
                                                    <td className="border px-4 py-2">
                                                        <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">
                                                            {field.category}
                                                        </span>
                                                    </td>
                                                    <td className="border px-4 py-2 text-center">
                                                        <button onClick={() => editField(fieldId)} className="px-3 py-1 bg-yellow-500 text-white rounded text-sm mr-2 hover:bg-yellow-600" title="D√ºzenle">‚úèÔ∏è</button>
                                                        <button onClick={() => deleteField(fieldId)} className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600" title="Sil">üóëÔ∏è</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div className="mt-4 p-4 bg-yellow-50 rounded border border-yellow-200">
                                    <p className="text-sm text-yellow-800">
                                        <strong>Not:</strong> Alan silerseniz, o alanƒ± kullanan mekanlardan otomatik olarak kaldƒ±rƒ±lmaz. 
                                        Manuel olarak mekan d√ºzenlemeden kaldƒ±rmanƒ±z gerekir.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {lightbox && (
                        <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50" onClick={() => setLightbox(null)}>
                            <img src={lightbox} className="max-w-full max-h-full rounded" />
                            <button className="absolute top-4 right-4 text-white text-3xl bg-black bg-opacity-50 w-12 h-12 rounded-full">√ó</button>
                        </div>
                    )}
                    
                    <div className={`max-w-6xl mx-auto rounded-lg shadow p-6 transition-colors ${
                        theme === 'dark'
                            ? 'bg-gray-800 text-gray-100'
                            : 'bg-white text-gray-900'
                    }`}>
                        <div className="flex items-center justify-between mb-4">
                            <h1 className={`text-2xl font-bold ${theme === 'dark' ? 'text-blue-400' : 'text-blue-600'}`}>Daire Se√ßim Listeleri</h1>
                            
                            {/* Firebase Durum G√∂stergesi */}
                            <div className="flex items-center gap-3">
                                {/* Ge√ßici Bildirimler (ba≈üarƒ±/hata) */}
                                {firebaseStatus.message && firebaseStatus.type !== 'connected' && (
                                    <div className={`flex items-center gap-2 px-4 py-2 rounded-lg shadow-md animate-pulse ${
                                        firebaseStatus.type === 'success' 
                                            ? 'bg-green-100 text-green-800 border border-green-300' 
                                            : firebaseStatus.type === 'error'
                                            ? 'bg-red-100 text-red-800 border border-red-300'
                                            : firebaseStatus.type === 'loading'
                                            ? 'bg-blue-100 text-blue-800 border border-blue-300'
                                            : 'bg-yellow-100 text-yellow-800 border border-yellow-300'
                                    }`}>
                                        {firebaseStatus.type === 'success' && (
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        )}
                                        {firebaseStatus.type === 'error' && (
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        )}
                                        {firebaseStatus.type === 'loading' && (
                                            <svg className="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                            </svg>
                                        )}
                                        {firebaseStatus.type === 'warning' && (
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                        )}
                                        <span className="text-sm font-semibold">{firebaseStatus.message}</span>
                                    </div>
                                )}
                                
                                {/* Sabit Online/Offline G√∂stergesi */}
                                {firebaseEnabled && user && (
                                    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full shadow-sm border ${
                                        firebaseStatus.connected
                                            ? 'bg-green-50 text-green-700 border-green-200'
                                            : 'bg-red-50 text-red-700 border-red-200'
                                    }`}>
                                        <div className={`w-2 h-2 rounded-full ${
                                            firebaseStatus.connected ? 'bg-green-500' : 'bg-red-500'
                                        }`}></div>
                                        <span className="text-xs font-medium">
                                            {firebaseStatus.connected ? '√áevrimi√ßi' : '√áevrimdƒ±≈üƒ±'}
                                        </span>
                                        {lastSyncTime && firebaseStatus.connected && (
                                            <span className="text-xs opacity-60">
                                                ‚Ä¢ {lastSyncTime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                            </span>
                                        )}
                                    </div>
                                )}
                                
                                {/* √áƒ±kƒ±≈ü Butonu */}
                                <button 
                                    onClick={async () => {
                                        if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?')) {
                                            if (user && firebaseEnabled) {
                                                await signOut();
                                            } else {
                                                // Firebase yoksa manuel √ßƒ±kƒ±≈ü
                                                window.location.reload();
                                            }
                                        }
                                    }}
                                    className="bg-red-500 hover:bg-red-600 rounded-lg px-4 py-2 flex items-center gap-2 transition-all shadow-md hover:shadow-lg"
                                    title={user?.email || '√áƒ±kƒ±≈ü'}
                                >
                                    <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    <span className="text-white text-sm font-bold">√áƒ±kƒ±≈ü</span>
                                </button>
                            </div>
                        </div>
                        <div className="mb-4 pb-3 border-b space-y-3">
                            <div className="flex gap-2 items-center">
                                <span className={`font-semibold ${theme === 'dark' ? 'text-purple-400' : 'text-purple-600'}`}>Proje:</span>
                                <select value={currentPrj} onChange={(e) => { 
                                    const newPrj = parseInt(e.target.value);
                                    setCurrentPrj(newPrj); 
                                    const proj = projects.find(p => p.id === newPrj);
                                    if (proj && proj.apartments[0]) setCurrentApt(proj.apartments[0].id); 
                                }} className={`px-4 py-2 border-2 rounded-lg font-semibold focus:ring-2 transition-colors ${
                                    theme === 'dark'
                                        ? 'border-purple-600 text-purple-300 bg-gray-700 focus:ring-purple-500'
                                        : 'border-purple-500 text-purple-700 bg-white focus:ring-purple-300'
                                }`}>
                                    {projects.map(proj => (
                                        <option key={proj.id} value={proj.id} className={theme === 'dark' ? 'bg-gray-700 text-gray-100' : 'bg-white text-gray-900'}>{proj.name}</option>
                                    ))}
                                </select>
                                <button onClick={() => {
                                    const newName = prompt('Proje adi:', getProject().name);
                                    if (newName && newName.trim()) {
                                        updateProjects(projects.map(p => p.id === currentPrj ? { ...p, name: newName.trim() } : p));
                                    }
                                }} className="px-3 py-2 bg-yellow-500 text-white rounded-lg text-sm hover:bg-yellow-600" title="Proje adini degistir">‚úèÔ∏è</button>
                                <button onClick={() => {
                                    const newId = Math.max(...projects.map(p => p.id), 0) + 1;
                                    const newName = prompt('Yeni proje adi:', 'Proje ' + newId);
                                    if (newName && newName.trim()) {
                                        updateProjects([...projects, { id: newId, name: newName.trim(), apartments: [{ id: 1, name: 'Daire 1', data: {}, wallCount: {}, hiddenRooms: [] }] }]);
                                        setCurrentPrj(newId);
                                        setCurrentApt(1);
                                    }
                                }} className="px-3 py-2 bg-purple-500 text-white rounded-lg text-sm font-semibold hover:bg-purple-600">+ Yeni Proje</button>
                                {projects.length > 1 && (
                                    <button onClick={() => { 
                                        if (confirm('Bu projeyi silmek istediginize emin misiniz?')) {
                                            const remaining = projects.filter(p => p.id !== currentPrj);
                                            updateProjects(remaining);
                                            setCurrentPrj(remaining[0].id);
                                            if (remaining[0].apartments[0]) setCurrentApt(remaining[0].apartments[0].id);
                                        }
                                    }} className="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600" title="Projeyi sil">üóëÔ∏è</button>
                                )}
                            </div>
                            
                            <div className="flex gap-2 items-center flex-wrap">
                                <span className={`font-semibold ${theme === 'dark' ? 'text-blue-400' : 'text-blue-600'}`}>Daire:</span>
                                <select value={currentApt} onChange={(e) => setCurrentApt(parseInt(e.target.value))} className={`px-4 py-2 border-2 rounded-lg font-semibold focus:ring-2 min-w-[200px] transition-colors ${
                                    theme === 'dark'
                                        ? 'border-blue-600 text-blue-300 bg-gray-700 focus:ring-blue-500'
                                        : 'border-blue-500 text-blue-700 bg-white focus:ring-blue-300'
                                }`}>
                                    {apartments.map(apt => (
                                        <option key={apt.id} value={apt.id} className={theme === 'dark' ? 'bg-gray-700 text-gray-100' : 'bg-white text-gray-900'}>{apt.name}</option>
                                    ))}
                                </select>
                                <button onClick={() => {
                                    const newName = prompt('Daire adi:', getApt().name);
                                    if (newName && newName.trim()) {
                                        updateApartments(apartments.map(a => a.id === currentApt ? { ...a, name: newName.trim() } : a));
                                    }
                                }} className="px-3 py-2 bg-yellow-500 text-white rounded-lg text-sm hover:bg-yellow-600" title="Daire adini degistir">‚úèÔ∏è</button>
                                <button 
                                    onClick={() => setShowCopyModal(true)} 
                                    className="px-3 py-2 bg-purple-500 text-white rounded-lg text-sm font-semibold hover:bg-purple-600 flex items-center gap-1" 
                                    title="Daireyi kopyala"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Kopyala
                                </button>
                                <button 
                                    onClick={() => setShowCopyAmountsModal(true)}
                                    className="px-3 py-2 bg-cyan-500 text-white rounded-lg text-sm font-semibold hover:bg-cyan-600 flex items-center gap-1"
                                    title="Ba≈üka daireden miktarlarƒ± kopyala"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                    üìè Miktar
                                </button>
                                <button onClick={() => {
                                    const newId = Math.max(...apartments.map(a => a.id), 0) + 1;
                                    const newName = prompt('Yeni daire adi:', 'Daire ' + newId);
                                    if (newName && newName.trim()) {
                                        updateApartments([...apartments, { id: newId, name: newName.trim(), data: {}, wallCount: {}, hiddenRooms: [] }]);
                                        setCurrentApt(newId);
                                    }
                                }} className="px-3 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold hover:bg-green-600">+ Yeni Daire</button>
                                {apartments.length > 1 && (
                                    <button onClick={() => {
                                        if (confirm('Bu daireyi silmek istediginize emin misiniz?')) {
                                            const remaining = apartments.filter(a => a.id !== currentApt);
                                            updateApartments(remaining);
                                            if (remaining[0]) setCurrentApt(remaining[0].id);
                                        }
                                    }} className="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600" title="Daireyi sil">üóëÔ∏è</button>
                                )}
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-4">
                            <div className={`rounded-xl shadow-lg p-5 border transition-colors ${
                                theme === 'dark'
                                    ? 'bg-gray-800 border-gray-700'
                                    : 'bg-white border-gray-200'
                            }`}>
                                {/* Header */}
                                <div className="flex justify-between items-center mb-4 pb-3 border-b-2 border-gray-100">
                                    <h3 className={`font-bold text-lg flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                        </svg>
                                        Mahaller
                                    </h3>
                                    <div className="flex gap-2">
                                        <button onClick={resetRoomOrder} className="px-3 py-2 bg-gray-500 text-white rounded-lg text-sm font-medium hover:bg-gray-600 shadow-sm hover:shadow-md transition-all" title="Sƒ±ralamayƒ± sƒ±fƒ±rla">
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                            </svg>
                                        </button>
                                        <button onClick={addCustomRoom} className="px-3 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600 shadow-sm hover:shadow-md transition-all flex items-center gap-1" title="Yeni mekan ekle">
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Arama Kutusu */}
                                <div className="mb-3">
                                    <div className="relative">
                                        <input
                                            type="text"
                                            placeholder="Mekan ara..."
                                            value={searchRoom}
                                            onChange={(e) => setSearchRoom(e.target.value)}
                                            className="w-full pl-10 pr-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                                        />
                                        <svg className="absolute left-3 top-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                
                                {/* Mekan Listesi */}
                                <div className="space-y-2">
                                {visibleRooms.filter(r => r.name.toLowerCase().includes(searchRoom.toLowerCase())).map(r => (
                                    <div 
                                        key={r.id} 
                                        className={`group relative rounded-lg border-2 transition-all duration-200 ${
                                            currentRoom === r.id 
                                                ? 'border-blue-500 bg-gradient-to-r from-blue-50 to-blue-100 shadow-md' 
                                                : 'border-gray-200 bg-white hover:border-blue-300 hover:shadow-md'
                                        }`}
                                        draggable="true"
                                        onDragStart={(e) => handleDragStart(e, r.id)}
                                        onDragEnd={handleDragEnd}
                                        onDragOver={handleDragOver}
                                        onDrop={(e) => handleDrop(e, r.id)}
                                    >
                                        <div className="flex items-center gap-2 p-2">
                                            {/* Drag Handle */}
                                            <span className="text-gray-400 hover:text-blue-600 cursor-move px-1 transition-colors" title="S√ºr√ºkleyip ta≈üƒ±yƒ±n">
                                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z"></path>
                                                </svg>
                                            </span>
                                            
                                            {/* Mekan Adƒ± */}
                                            <button 
                                                onClick={() => setCurrentRoom(r.id)} 
                                                className={`flex-1 text-left px-3 py-2.5 rounded-lg font-medium text-sm transition-all flex items-center gap-2 ${
                                                    currentRoom === r.id 
                                                        ? 'text-blue-700 font-semibold' 
                                                        : 'text-gray-700 hover:text-blue-600'
                                                }`}
                                            >
                                                <span className={currentRoom === r.id ? 'text-blue-600' : 'text-gray-400'}>
                                                    {getRoomIcon(r.name)}
                                                </span>
                                                {r.name}
                                            </button>
                                            
                                            {/* Action Buttons - Hover'da g√∂r√ºn√ºr */}
                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                {/* Alan D√ºzenleme */}
                                                {(r.custom || r.editable) && (
                                                    <button 
                                                        onClick={() => editRoomFields(r.id)} 
                                                        className="p-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors shadow-sm" 
                                                        title="Alanlarƒ± d√ºzenle"
                                                    >
                                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                        </svg>
                                                    </button>
                                                )}
                                                
                                                {/* ƒ∞sim D√ºzenleme */}
                                                <button 
                                                    onClick={() => editRoomName(r.id)} 
                                                    className="p-1.5 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors shadow-sm" 
                                                    title="ƒ∞sim d√ºzenle"
                                                >
                                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                    </svg>
                                                </button>
                                                
                                                {/* Kopyalama */}
                                                <button 
                                                    onClick={() => copyRoom(r.id)} 
                                                    className="p-1.5 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors shadow-sm" 
                                                    title="Kopyala"
                                                >
                                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                    </svg>
                                                </button>
                                                
                                                {/* Silme */}
                                                {(r.custom || r.deletable) && (
                                                    <button 
                                                        onClick={() => deleteRoom(r.id)} 
                                                        className="p-1.5 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors shadow-sm" 
                                                        title="Sil"
                                                    >
                                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                </div>
                                
                                {/* Kaydet Butonu */}
                                <button onClick={save} className="w-full mt-6 px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-green-600 hover:to-emerald-700 transition-all flex items-center justify-center gap-2">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                    </svg>
                                    Kaydet
                                </button>
                                
                                {/* Tema Deƒüi≈ütirme */}
                                <div className="mt-4 border-t pt-4">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Analiz & Raporlar</h4>
                                    
                                    <button 
                                        onClick={() => setShowMaterialAnalysis(true)}
                                        className="w-full mb-3 px-4 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-cyan-600 hover:to-blue-700 transition-all flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                        Malzeme Analizi
                                    </button>
                                </div>
                                
                                <div className="mt-4 border-t pt-4">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">G√∂r√ºn√ºm</h4>
                                    
                                    <button 
                                        onClick={toggleTheme}
                                        className="w-full px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-indigo-600 hover:to-purple-700 transition-all flex items-center justify-center gap-2"
                                    >
                                        {theme === 'light' ? (
                                            <>
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                                </svg>
                                                Koyu Tema
                                            </>
                                        ) : (
                                            <>
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                                </svg>
                                                A√ßƒ±k Tema
                                            </>
                                        )}
                                    </button>
                                </div>
                                
                                <div className="mt-4 border-t pt-4">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Yedekleme</h4>
                                    
                                    <button 
                                        onClick={() => createBackup(false)} 
                                        className="w-full mb-2 px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-blue-700 hover:to-blue-800 transition-all flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                        </svg>
                                        ≈ûimdi Yedekle
                                    </button>
                                    
                                    <button 
                                        onClick={toggleAutoBackup}
                                        className={'w-full mb-2 px-4 py-3 rounded-lg font-semibold shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 ' + (autoBackupEnabled ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white hover:from-green-700 hover:to-emerald-700' : 'bg-gray-300 text-gray-700 hover:bg-gray-400')}
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        {autoBackupEnabled ? 'Otomatik A√ßƒ±k' : 'Otomatik Kapalƒ±'}
                                    </button>
                                    
                                    {autoBackupEnabled && (
                                        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-3 mb-2">
                                            <p className="text-xs text-blue-900 font-semibold mb-2 flex items-center gap-1">
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                Sƒ±klƒ±k: Her {backupInterval} g√ºnde bir
                                            </p>
                                            <select 
                                                value={backupInterval}
                                                onChange={(e) => updateBackupInterval(parseInt(e.target.value))}
                                                className="w-full text-xs border-2 border-blue-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all"
                                            >
                                                <option value="1">Her g√ºn</option>
                                                <option value="3">3 g√ºnde bir</option>
                                                <option value="7">Haftada bir</option>
                                                <option value="14">2 haftada bir</option>
                                                <option value="30">Ayda bir</option>
                                            </select>
                                            {lastBackupDate && (
                                                <p className="text-xs text-gray-600 mt-2 flex items-center gap-1">
                                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    Son: {lastBackupDate.toLocaleDateString('tr-TR')}
                                                </p>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                <div className="border-t pt-3 mt-3">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Bulut Senkronizasyon</h4>
                                    
                                    {firebaseEnabled ? (
                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                                                <div className="flex items-center gap-2">
                                                    <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                                                    </svg>
                                                    <div>
                                                        <div className="text-sm font-semibold text-blue-900">Firebase Senkronizasyon</div>
                                                        <div className="text-xs text-blue-700">√áoklu cihaz desteƒüi</div>
                                                    </div>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={firebaseSync} 
                                                        onChange={(e) => {
                                                            setFirebaseSync(e.target.checked);
                                                            localStorage.setItem('firebase_sync', e.target.checked);
                                                        }}
                                                        className="sr-only peer" 
                                                    />
                                                    <div className="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                </label>
                                            </div>
                                            {lastSyncTime && (
                                                <p className="text-xs text-gray-600 flex items-center gap-1 px-2">
                                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    Son senkronizasyon: {lastSyncTime.toLocaleString('tr-TR')}
                                                </p>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                            <div className="flex items-start gap-2">
                                                <svg className="w-5 h-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                </svg>
                                                <div className="text-xs text-yellow-800">
                                                    <p className="font-semibold mb-1">Firebase yapƒ±landƒ±rmasƒ± eksik</p>
                                                    <p>√áoklu cihaz senkronizasyonu i√ßin Firebase yapƒ±landƒ±rmasƒ± gerekiyor.</p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="border-t pt-3 mt-3">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Veri Y√∂netimi</h4>
                                    <button onClick={exportData} className="w-full mb-2 px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-indigo-600 hover:to-purple-700 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                        </svg>
                                        Dƒ±≈üa Aktar
                                    </button>
                                    <button onClick={importData} className="w-full px-4 py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-orange-600 hover:to-red-700 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        ƒ∞√ße Aktar
                                    </button>
                                </div>
                                
                                <div className="border-t pt-3 mt-3">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Raporlar</h4>
                                    <button onClick={generatePrintForm} className="w-full mb-2 px-4 py-3 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-red-600 hover:to-rose-700 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Onay Formu
                                    </button>
                                    <button onClick={downloadExcel} className="w-full px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-700 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-green-700 hover:to-emerald-800 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Excel Raporu
                                    </button>
                                </div>
                                
                                <div className="border-t pt-3 mt-3">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Ayarlar</h4>
                                    <button onClick={() => setShowFieldManager(true)} className="w-full mb-2 px-4 py-3 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-teal-600 hover:to-cyan-700 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                        </svg>
                                        Alan Y√∂netimi
                                    </button>
                                    <button onClick={() => setShowDB(true)} className="w-full mb-2 px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-purple-600 hover:to-pink-700 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                                        </svg>
                                        Malzeme DB
                                    </button>
                                    <button onClick={convertAllText} className="w-full px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-amber-600 hover:to-orange-700 transition-all flex items-center justify-center gap-2" title="T√ºm metinleri 'ƒ∞lk Harf B√ºy√ºk diƒüerleri k√º√ß√ºk' formatƒ±na √ßevirir">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                                        </svg>
                                        Metin Formatƒ±
                                    </button>
                                </div>
                            </div>
                            
                            <div className="col-span-2">
                                {/* Modern Header */}
                                <div className="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg shadow-lg p-6 mb-6">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-4">
                                            {/* Logo */}
                                            <div className="bg-white rounded-full p-3 shadow-md">
                                                <svg className="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                                </svg>
                                            </div>
                                            {/* Ba≈ülƒ±k Bilgileri */}
                                            <div>
                                                <h1 className="text-2xl font-bold text-white">{room ? room.name : ''}</h1>
                                                <p className="text-blue-100 text-sm flex items-center gap-2">
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                                    </svg>
                                                    {getProject().name}
                                                    <span className="mx-2">‚Ä¢</span>
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                                    </svg>
                                                    {getApt().name}
                                                </p>
                                            </div>
                                        </div>
                                        {/* Saƒü Taraf: Tarih */}
                                        <div className="flex items-center gap-3">
                                            {/* Tarih Badge */}
                                            <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-lg px-4 py-2">
                                                <p className="text-white text-xs font-medium">
                                                    {new Date().toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Veri Giri≈ü Alanlarƒ± - Card Tasarƒ±m */}
                                <div className="space-y-4">
                                    {room && room.fields.map(f => renderField(f))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
