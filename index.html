<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daire Se√ßim Listeleri</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style id="theme-style">
        /* Dropdown option'larƒ± i√ßin tema stilleri */
        select option {
            background-color: white !important;
            color: #111827 !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // ==========================================
        // FIREBASE YAPILANDIRMASI
        // ==========================================
        // ‚ö†Ô∏è √ñNEMLƒ∞: A≈üaƒüƒ±daki bilgileri kendi Firebase projenizden alƒ±n!
        // Firebase Console ‚Üí Project Settings ‚Üí Your apps ‚Üí Firebase SDK snippet
        
        /* 
        ==========================================
        üîê Fƒ∞REBASE G√úVENLƒ∞K KURALLARI (FIRESTORE)
        ==========================================
        Firebase Console ‚Üí Firestore Database ‚Üí Rules sekmesine a≈üaƒüƒ±daki kurallarƒ± yapƒ±≈ütƒ±rƒ±n:
        
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Kullanƒ±cƒ± kimlik doƒürulamasƒ± kontrol√º
            function isSignedIn() {
              return request.auth != null;
            }
            
            // Kullanƒ±cƒ± kendi verisine eri≈üiyor mu?
            function isOwner(userId) {
              return request.auth.uid == userId;
            }
            
            // Kullanƒ±cƒ± verisi - sadece kendi verisine eri≈üebilir
            match /users/{userId} {
              allow read, write: if isSignedIn() && isOwner(userId);
            }
            
            // Kullanƒ±cƒ± ayarlarƒ± (tema vb.) - sadece kendi ayarlarƒ±na eri≈üebilir
            match /userSettings/{userId} {
              allow read, write: if isSignedIn() && isOwner(userId);
            }
            
            // Diƒüer t√ºm eri≈üimler reddedilir
            match /{document=**} {
              allow read, write: if false;
            }
          }
        }
        
        ==========================================
        Bu kurallar:
        ‚úÖ Kullanƒ±cƒ±lar sadece kendi verilerine eri≈üebilir
        ‚úÖ Giri≈ü yapmadan veri okunamaz/yazƒ±lamaz
        ‚úÖ Kalƒ±cƒ± g√ºvenlik (s√ºre sƒ±nƒ±rƒ± yok)
        ‚úÖ Production-ready
        ==========================================
        */
        
        const firebaseConfig = {
            apiKey: "AIzaSyArx5M6zeXeAqYToThIIDwC3YNi8iWmd3Q",
            authDomain: "malzeme-takip-6e4d5.firebaseapp.com",
            projectId: "malzeme-takip-6e4d5",
            storageBucket: "malzeme-takip-6e4d5.firebasestorage.app",
            messagingSenderId: "473422973374",
            appId: "1:473422973374:web:f05b4573c9fcac19a511ef"
        };

        // Firebase'i ba≈ülat
        let db = null;
        let auth = null;
        let storage = null;
        let firebaseEnabled = false;
        
        try {
            // Firebase SDK y√ºkl√º m√º kontrol et
            if (typeof firebase === 'undefined') {
                console.log('‚ö†Ô∏è Firebase SDK y√ºklenemedi - sadece localStorage kullanƒ±lƒ±yor');
            } else if (firebaseConfig.apiKey !== "BURAYA_KENDI_API_KEY") {
                // Firebase'i ba≈ülat
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
                firebaseEnabled = true;
                console.log('‚úÖ Firebase baƒülantƒ±sƒ± ba≈üarƒ±lƒ±! (Firestore + Storage + Auth)');
            } else {
                console.log('‚ö†Ô∏è Firebase yapƒ±landƒ±rmasƒ± eksik - sadece localStorage kullanƒ±lƒ±yor');
            }
        } catch (error) {
            console.error('‚ùå Firebase ba≈ülatma hatasƒ±:', error);
            console.log('‚ö†Ô∏è Sadece localStorage kullanƒ±lacak');
        }

        // ==========================================
        // FIREBASE STORAGE FONKSƒ∞YONLARI (FOTOƒûRAFLAR ƒ∞√áƒ∞N)
        // ==========================================
        
        // Fotoƒürafƒ± Firebase Storage'a y√ºkle
        const uploadPhotoToStorage = async (base64Data, userId, projectId, apartmentId, roomId, photoIndex) => {
            if (!storage || !auth || !auth.currentUser) {
                console.log('‚ö†Ô∏è Storage kullanƒ±lamƒ±yor, base64 olarak kaydediliyor');
                return base64Data; // Fallback: base64 olarak d√∂nd√ºr
            }
            
            try {
                // Base64'ten blob'a √ßevir
                const response = await fetch(base64Data);
                const blob = await response.blob();
                
                // Dosya yolu: users/{userId}/photos/{projectId}/{apartmentId}/{roomId}/{photoIndex}.jpg
                const path = `users/${userId}/photos/${projectId}/${apartmentId}/${roomId}/${photoIndex}.jpg`;
                const storageRef = storage.ref(path);
                
                // Y√ºkle
                await storageRef.put(blob, {
                    contentType: 'image/jpeg',
                    cacheControl: 'public, max-age=31536000'
                });
                
                // URL'yi al
                const downloadURL = await storageRef.getDownloadURL();
                console.log('‚úÖ Fotoƒüraf Storage\'a y√ºklendi:', path);
                return downloadURL;
            } catch (error) {
                console.error('‚ùå Storage y√ºkleme hatasƒ±:', error);
                return base64Data; // Hata durumunda base64 kullan
            }
        };
        
        // ƒ∞con'u Firebase Storage'a y√ºkle
        const uploadIconToStorage = async (base64Data, userId, iconType, iconId) => {
            if (!storage || !auth || !auth.currentUser) {
                console.log('‚ö†Ô∏è Storage kullanƒ±lamƒ±yor, base64 olarak kaydediliyor');
                return base64Data; // Fallback: base64 olarak d√∂nd√ºr
            }
            
            try {
                // Base64'ten blob'a √ßevir
                const response = await fetch(base64Data);
                const blob = await response.blob();
                
                // Dosya uzantƒ±sƒ±nƒ± belirle
                const mimeType = blob.type;
                const extension = mimeType.split('/')[1] || 'jpg';
                
                // Dosya yolu: users/{userId}/icons/{iconType}/{iconId}.{extension}
                // iconType: "room" veya "field"
                const timestamp = Date.now();
                const path = `users/${userId}/icons/${iconType}/${iconId}_${timestamp}.${extension}`;
                const storageRef = storage.ref(path);
                
                // Y√ºkle
                await storageRef.put(blob, {
                    contentType: mimeType,
                    cacheControl: 'public, max-age=31536000'
                });
                
                // URL'yi al
                const downloadURL = await storageRef.getDownloadURL();
                console.log('‚úÖ ƒ∞con Storage\'a y√ºklendi:', path);
                return downloadURL;
            } catch (error) {
                console.error('‚ùå Icon storage y√ºkleme hatasƒ±:', error);
                return base64Data; // Hata durumunda base64 kullan
            }
        };
        
        // Storage'dan fotoƒürafƒ± sil
        const deletePhotoFromStorage = async (photoURL) => {
            if (!storage || !photoURL || !photoURL.includes('firebasestorage')) {
                return; // Storage URL'i deƒüilse silme
            }
            
            try {
                const storageRef = storage.refFromURL(photoURL);
                await storageRef.delete();
                console.log('‚úÖ Fotoƒüraf Storage\'dan silindi');
            } catch (error) {
                console.error('‚ùå Storage silme hatasƒ±:', error);
            }
        };
        
        // Fotoƒürafƒ± sƒ±kƒ±≈ütƒ±r (agresif sƒ±kƒ±≈ütƒ±rma - Firestore 1MB limiti i√ßin)
        const compressImage = async (base64Data, maxWidth = 800, quality = 0.5) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Boyutu k√º√ß√ºlt (800px max)
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Agresif sƒ±kƒ±≈ütƒ±rma (%50 kalite)
                    const compressed = canvas.toDataURL('image/jpeg', quality);
                    
                    const originalSize = (base64Data.length / 1024).toFixed(0);
                    const compressedSize = (compressed.length / 1024).toFixed(0);
                    console.log(`üóúÔ∏è Sƒ±kƒ±≈ütƒ±rma: ${originalSize}KB ‚Üí ${compressedSize}KB (%${Math.round((1 - compressed.length / base64Data.length) * 100)} azalma)`);
                    
                    resolve(compressed);
                };
                img.src = base64Data;
            });
        };

        // ==========================================
        // AR≈ûƒ∞VLEME FONKSƒ∞YONLARI
        // ==========================================
        
        // Projeyi ar≈üivle (Firebase Storage'a kaydet)
        const archiveProject = async (project) => {
            if (!storage || !auth || !auth.currentUser) {
                alert('‚ö†Ô∏è Ar≈üivleme i√ßin Firebase\'e giri≈ü yapmanƒ±z gerekiyor!');
                return false;
            }
            
            try {
                const userId = auth.currentUser.uid;
                const timestamp = Date.now();
                const fileName = `${project.name.replace(/[^a-zA-Z0-9]/g, '_')}_${timestamp}.json`;
                const path = `users/${userId}/archives/${fileName}`;
                
                // Ar≈üiv verisi
                const archiveData = {
                    project: project,
                    archivedAt: timestamp,
                    archivedBy: auth.currentUser.email,
                    version: '1.0'
                };
                
                // JSON'a √ßevir ve blob olu≈ütur
                const jsonBlob = new Blob([JSON.stringify(archiveData, null, 2)], { type: 'application/json' });
                
                // Storage'a y√ºkle
                const storageRef = storage.ref(path);
                await storageRef.put(jsonBlob, {
                    contentType: 'application/json',
                    customMetadata: {
                        projectName: project.name,
                        projectId: project.id.toString(),
                        apartmentCount: project.apartments.length.toString(),
                        archivedAt: new Date(timestamp).toISOString()
                    }
                });
                
                console.log('‚úÖ Proje ar≈üivlendi:', path);
                return true;
            } catch (error) {
                console.error('‚ùå Ar≈üivleme hatasƒ±:', error);
                alert('‚ùå Ar≈üivleme ba≈üarƒ±sƒ±z: ' + error.message);
                return false;
            }
        };
        
        // Ar≈üivlenmi≈ü projeleri listele
        const loadArchivedProjects = async () => {
            if (!storage || !auth || !auth.currentUser) {
                return [];
            }
            
            try {
                setLoadingArchives(true);
                const userId = auth.currentUser.uid;
                const archivesRef = storage.ref(`users/${userId}/archives`);
                
                // T√ºm ar≈üiv dosyalarƒ±nƒ± listele
                const result = await archivesRef.listAll();
                
                // Her dosya i√ßin metadata al
                const archives = await Promise.all(
                    result.items.map(async (item) => {
                        const metadata = await item.getMetadata();
                        const downloadURL = await item.getDownloadURL();
                        
                        return {
                            name: item.name,
                            path: item.fullPath,
                            downloadURL: downloadURL,
                            projectName: metadata.customMetadata?.projectName || 'Bilinmeyen Proje',
                            projectId: metadata.customMetadata?.projectId,
                            apartmentCount: metadata.customMetadata?.apartmentCount || '0',
                            archivedAt: metadata.customMetadata?.archivedAt || metadata.timeCreated,
                            size: (metadata.size / 1024).toFixed(2) + ' KB'
                        };
                    })
                );
                
                // Tarihe g√∂re sƒ±rala (en yeni √∂nce)
                archives.sort((a, b) => new Date(b.archivedAt) - new Date(a.archivedAt));
                
                setArchivedProjects(archives);
                setLoadingArchives(false);
                return archives;
            } catch (error) {
                console.error('‚ùå Ar≈üiv y√ºkleme hatasƒ±:', error);
                setLoadingArchives(false);
                return [];
            }
        };
        
        // Ar≈üivden projeyi geri y√ºkle
        const restoreProject = async (archive) => {
            try {
                // JSON dosyasƒ±nƒ± indir
                const response = await fetch(archive.downloadURL);
                const archiveData = await response.json();
                
                if (!archiveData.project) {
                    alert('‚ùå Ge√ßersiz ar≈üiv dosyasƒ±!');
                    return false;
                }
                
                const restoredProject = archiveData.project;
                
                // Yeni ID ata (√ßakƒ±≈ümayƒ± √∂nlemek i√ßin)
                const newId = Math.max(...projects.map(p => p.id), 0) + 1;
                restoredProject.id = newId;
                restoredProject.name = restoredProject.name + ' (Geri Y√ºklendi)';
                
                // Projeyi ekle
                const updatedProjects = [...projects, restoredProject];
                updateProjects(updatedProjects);
                setCurrentPrj(newId);
                
                if (restoredProject.apartments[0]) {
                    setCurrentApt(restoredProject.apartments[0].id);
                }
                
                alert(`‚úÖ "${restoredProject.name}" ba≈üarƒ±yla geri y√ºklendi!`);
                setShowArchiveModal(false);
                return true;
            } catch (error) {
                console.error('‚ùå Geri y√ºkleme hatasƒ±:', error);
                alert('‚ùå Geri y√ºkleme ba≈üarƒ±sƒ±z: ' + error.message);
                return false;
            }
        };
        
        // Ar≈üivi local'e indir (JSON dosyasƒ± olarak)
        const downloadArchive = async (archive) => {
            try {
                const response = await fetch(archive.downloadURL);
                const archiveData = await response.json();
                
                // JSON dosyasƒ± olu≈ütur ve indir
                const blob = new Blob([JSON.stringify(archiveData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = archive.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Ar≈üiv indirildi!');
            } catch (error) {
                console.error('‚ùå ƒ∞ndirme hatasƒ±:', error);
                alert('‚ùå ƒ∞ndirme ba≈üarƒ±sƒ±z: ' + error.message);
            }
        };
        
        // Ar≈üivi sil
        const deleteArchive = async (archive) => {
            if (!storage) return false;
            
            if (!confirm(`"${archive.projectName}" ar≈üivini kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?`)) {
                return false;
            }
            
            try {
                const storageRef = storage.ref(archive.path);
                await storageRef.delete();
                
                // Listeyi g√ºncelle
                setArchivedProjects(archivedProjects.filter(a => a.path !== archive.path));
                
                alert('‚úÖ Ar≈üiv silindi!');
                return true;
            } catch (error) {
                console.error('‚ùå Ar≈üiv silme hatasƒ±:', error);
                alert('‚ùå Silme ba≈üarƒ±sƒ±z: ' + error.message);
                return false;
            }
        };

        // ==========================================
        // AUTHENTICATION FONKSƒ∞YONLARI
        // ==========================================
        
        // Kullanƒ±cƒ± giri≈üi
        const signIn = async (email, password) => {
            if (!auth) return { success: false, error: 'Firebase yapƒ±landƒ±rƒ±lmamƒ±≈ü' };
            try {
                await auth.signInWithEmailAndPassword(email, password);
                return { success: true };
            } catch (error) {
                let errorMsg = 'Giri≈ü ba≈üarƒ±sƒ±z';
                if (error.code === 'auth/wrong-password') errorMsg = '≈ûifre yanlƒ±≈ü';
                else if (error.code === 'auth/user-not-found') errorMsg = 'Kullanƒ±cƒ± bulunamadƒ±';
                else if (error.code === 'auth/invalid-email') errorMsg = 'Ge√ßersiz email';
                return { success: false, error: errorMsg };
            }
        };

        // Kullanƒ±cƒ± kaydƒ±
        const signUp = async (email, password) => {
            if (!auth) return { success: false, error: 'Firebase yapƒ±landƒ±rƒ±lmamƒ±≈ü' };
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                return { success: true };
            } catch (error) {
                let errorMsg = 'Kayƒ±t ba≈üarƒ±sƒ±z';
                if (error.code === 'auth/email-already-in-use') errorMsg = 'Bu email zaten kullanƒ±mda';
                else if (error.code === 'auth/weak-password') errorMsg = '≈ûifre en az 6 karakter olmalƒ±';
                else if (error.code === 'auth/invalid-email') errorMsg = 'Ge√ßersiz email';
                return { success: false, error: errorMsg };
            }
        };

        // √áƒ±kƒ±≈ü yap
        const signOut = async () => {
            if (!auth) return;
            try {
                await auth.signOut();
            } catch (error) {
                console.error('√áƒ±kƒ±≈ü hatasƒ±:', error);
            }
        };

        // ≈ûifremi unuttum
        const resetPassword = async (email) => {
            if (!auth) return { success: false, error: 'Firebase yapƒ±landƒ±rƒ±lmamƒ±≈ü' };
            try {
                await auth.sendPasswordResetEmail(email);
                return { success: true };
            } catch (error) {
                let errorMsg = '≈ûifre sƒ±fƒ±rlama ba≈üarƒ±sƒ±z';
                if (error.code === 'auth/user-not-found') errorMsg = 'Bu email kayƒ±tlƒ± deƒüil';
                else if (error.code === 'auth/invalid-email') errorMsg = 'Ge√ßersiz email';
                return { success: false, error: errorMsg };
            }
        };

        // ==========================================
        // OTURUM Y√ñNETƒ∞Mƒ∞ (Session Management)
        // ==========================================
        
        // Mevcut oturum ID'sini olu≈ütur
        const generateSessionId = () => {
            return `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        };
        
        let currentSessionId = generateSessionId();
        
        // Aktif oturum bilgisini Firebase'e kaydet
        const updateSessionInfo = async (user) => {
            if (!firebaseEnabled || !db || !user) return;
            
            try {
                // activeSessions'a kaydet
                await db.collection('activeSessions').doc(user.uid).set({
                    sessionId: currentSessionId,
                    email: user.email,
                    userEmail: user.email, // Admin i√ßin ekstra
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent,
                    platform: navigator.platform
                });
                
                // userSettings'e de email'i kaydet (admin i√ßin)
                await db.collection('userSettings').doc(user.uid).set({
                    email: user.email
                }, { merge: true }); // merge: mevcut ayarlarƒ± korur
                
                console.log('üìù Oturum bilgisi g√ºncellendi:', currentSessionId);
            } catch (error) {
                console.error('‚ùå Oturum bilgisi g√ºncelleme hatasƒ±:', error);
            }
        };
        
        // Ba≈üka bir cihazdan oturum a√ßƒ±ldƒ±ƒüƒ±nƒ± kontrol et
        const checkSessionConflict = (callback) => {
            if (!firebaseEnabled || !db || !auth || !auth.currentUser) return null;
            
            return db.collection('activeSessions').doc(auth.currentUser.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.sessionId && data.sessionId !== currentSessionId) {
                        console.log('‚ö†Ô∏è Ba≈üka bir cihazdan oturum a√ßƒ±ldƒ±!');
                        callback(data);
                    }
                }
            }, (error) => {
                console.error('‚ùå Oturum kontrol√º hatasƒ±:', error);
            });
        };

        // ==========================================
        // FIREBASE SYNC FONKSƒ∞YONLARI
        // ==========================================
        
        // Verileri Firebase'e kaydet
        // Icon'larƒ± Storage'a migrate et (base64 ‚Üí Firebase Storage URL)
        const migrateIconsToStorage = async (data) => {
            if (!storage || !auth || !auth.currentUser) {
                console.log('‚ö†Ô∏è Storage kullanƒ±lamƒ±yor, migration atlanƒ±yor');
                return data;
            }
            
            const userId = auth.currentUser.uid;
            let hasChanges = false;
            const migratedData = { ...data };
            
            try {
                // 1. fieldLabels'daki icon'larƒ± migrate et
                if (migratedData.fieldLabels) {
                    console.log('üì¶ Field icon\'larƒ± kontrol ediliyor...');
                    const newFieldLabels = { ...migratedData.fieldLabels };
                    
                    for (const [fieldKey, fieldConfig] of Object.entries(newFieldLabels)) {
                        if (fieldConfig.icon && fieldConfig.icon.startsWith('data:image')) {
                            console.log(`üì§ ${fieldKey} icon'u Storage'a y√ºkleniyor...`);
                            const storageURL = await uploadIconToStorage(fieldConfig.icon, userId, 'field', fieldKey);
                            if (storageURL && !storageURL.startsWith('data:')) {
                                newFieldLabels[fieldKey] = { ...fieldConfig, icon: storageURL };
                                hasChanges = true;
                                console.log(`‚úÖ ${fieldKey} icon'u migrate edildi`);
                            }
                        }
                    }
                    
                    if (hasChanges) {
                        migratedData.fieldLabels = newFieldLabels;
                    }
                }
                
                // 2. customRooms'daki icon'larƒ± migrate et
                if (migratedData.customRooms && Array.isArray(migratedData.customRooms)) {
                    console.log('üì¶ Custom room icon\'larƒ± kontrol ediliyor...');
                    const newCustomRooms = [...migratedData.customRooms];
                    
                    for (let i = 0; i < newCustomRooms.length; i++) {
                        const room = newCustomRooms[i];
                        if (room.customIcon && room.customIcon.startsWith('data:image')) {
                            console.log(`üì§ ${room.name} icon'u Storage'a y√ºkleniyor...`);
                            const storageURL = await uploadIconToStorage(room.customIcon, userId, 'room', room.id);
                            if (storageURL && !storageURL.startsWith('data:')) {
                                newCustomRooms[i] = { ...room, customIcon: storageURL };
                                hasChanges = true;
                                console.log(`‚úÖ ${room.name} icon'u migrate edildi`);
                            }
                        }
                    }
                    
                    if (hasChanges) {
                        migratedData.customRooms = newCustomRooms;
                    }
                }
                
                // 3. baseRooms'daki icon'larƒ± migrate et
                if (migratedData.baseRooms && Array.isArray(migratedData.baseRooms)) {
                    console.log('üì¶ Base room icon\'larƒ± kontrol ediliyor...');
                    const newBaseRooms = [...migratedData.baseRooms];
                    
                    for (let i = 0; i < newBaseRooms.length; i++) {
                        const room = newBaseRooms[i];
                        if (room.customIcon && room.customIcon.startsWith('data:image')) {
                            console.log(`üì§ ${room.name} icon'u Storage'a y√ºkleniyor...`);
                            const storageURL = await uploadIconToStorage(room.customIcon, userId, 'room', room.id);
                            if (storageURL && !storageURL.startsWith('data:')) {
                                newBaseRooms[i] = { ...room, customIcon: storageURL };
                                hasChanges = true;
                                console.log(`‚úÖ ${room.name} icon'u migrate edildi`);
                            }
                        }
                    }
                    
                    if (hasChanges) {
                        migratedData.baseRooms = newBaseRooms;
                    }
                }
                
                if (hasChanges) {
                    console.log('‚úÖ Icon migration tamamlandƒ±!');
                } else {
                    console.log('‚ÑπÔ∏è Migration gerektiren icon yok');
                }
                
                return migratedData;
            } catch (error) {
                console.error('‚ùå Icon migration hatasƒ±:', error);
                return data; // Hata olursa orijinal veriyi d√∂nd√ºr
            }
        };

        const saveToFirebase = async (data) => {
            if (!firebaseEnabled || !db || !auth || !auth.currentUser) return false;
            
            try {
                const userId = auth.currentUser.uid;
                
                // Icon'larƒ± Storage'a migrate et
                const migratedData = await migrateIconsToStorage(data);
                
                await db.collection('appData').doc(userId).set({
                    ...migratedData,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Firebase\'e kaydedildi (Kullanƒ±cƒ±:', userId.substring(0, 8) + '...)');
                return true;
            } catch (error) {
                console.error('‚ùå Firebase kayƒ±t hatasƒ±:', error);
                return false;
            }
        };
        
        // Admin i√ßin: Belirtilen kullanƒ±cƒ±ya kaydet
        const saveToFirebaseWithUserId = async (targetUserId, data) => {
            if (!firebaseEnabled || !db) return false;
            
            try {
                // Icon'larƒ± Storage'a migrate et
                const migratedData = await migrateIconsToStorage(data);
                
                await db.collection('appData').doc(targetUserId).set({
                    ...migratedData,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Firebase\'e kaydedildi (Hedef:', targetUserId.substring(0, 8) + '...)');
                return true;
            } catch (error) {
                console.error('‚ùå Firebase kayƒ±t hatasƒ±:', error);
                return false;
            }
        };

        // Firebase'den verileri y√ºkle
        const loadFromFirebase = async () => {
            if (!firebaseEnabled || !db || !auth || !auth.currentUser) return null;
            
            try {
                const userId = auth.currentUser.uid;
                const doc = await db.collection('appData').doc(userId).get();
                if (doc.exists) {
                    console.log('‚úÖ Firebase\'den y√ºklendi (Kullanƒ±cƒ±:', userId.substring(0, 8) + '...)');
                    return doc.data();
                }
                console.log('‚ÑπÔ∏è Firebase\'de veri yok, yeni kullanƒ±cƒ±');
                return null;
            } catch (error) {
                console.error('‚ùå Firebase y√ºkleme hatasƒ±:', error);
                return null;
            }
        };

        // Ger√ßek zamanlƒ± senkronizasyon dinleyicisi
        const setupFirebaseListener = (callback) => {
            if (!firebaseEnabled || !db || !auth || !auth.currentUser) return null;
            
            const userId = auth.currentUser.uid;
            return db.collection('appData').doc(userId).onSnapshot((doc) => {
                if (doc.exists) {
                    console.log('üîÑ Firebase\'den g√ºncelleme alƒ±ndƒ± (Kullanƒ±cƒ±:', userId.substring(0, 8) + '...)');
                    callback(doc.data());
                }
            }, (error) => {
                console.error('‚ùå Firebase listener hatasƒ±:', error);
            });
        };

        // ==========================================
        // UYGULAMA KODLARI
        // ==========================================

        const DEFAULT_ROOMS = [
            { id: 'salon', name: 'Salon', fields: ['zemin', 'boya', 'foto'], editable: true, deletable: true },
            { id: 'mutfak', name: 'Mutfak', fields: ['zemin', 'boya', 'dolap_alt', 'dolap_ust', 'tezgah', 'panel', 'foto'], editable: true, deletable: true },
            { id: 'hol', name: 'Hol ve Antre', fields: ['zemin', 'boya', 'foto'], editable: true, deletable: true },
            { id: 'genel_banyo', name: 'Genel Banyo', fields: ['zemin', 'duvar_kaplama', 'lavabo', 'klozet', 'dus', 'batarya', 'ayna', 'foto'], editable: true, deletable: true },
            { id: 'ebeveyn_banyo', name: 'Ebeveyn Banyo', fields: ['zemin', 'duvar_kaplama', 'lavabo', 'klozet', 'dus', 'batarya', 'ayna', 'foto'], editable: true, deletable: true },
            { id: 'oda1', name: 'Oda-1', fields: ['zemin', 'boya', 'foto'], editable: true, deletable: true },
            { id: 'oda2', name: 'Oda-2', fields: ['zemin', 'boya', 'foto'], editable: true, deletable: true },
            { id: 'ebeveyn_oda', name: 'Ebeveyn Odasƒ±', fields: ['zemin', 'boya', 'foto'], editable: true, deletable: true }
        ];

        // Daire ≈üablonlarƒ± - Yeni proje olu≈üturulurken kullanƒ±lacak
        const APARTMENT_TEMPLATES = {
            '1+1': [
                { id: 'salon', name: 'Salon', fields: ['zemin', 'boya', 'foto'] },
                { id: 'mutfak', name: 'Mutfak', fields: ['zemin', 'boya', 'dolap_alt', 'dolap_ust', 'tezgah', 'panel', 'foto'] },
                { id: 'yatak_odasi', name: 'Yatak Odasƒ±', fields: ['zemin', 'boya', 'foto'] },
                { id: 'banyo', name: 'Banyo', fields: ['zemin', 'duvar_kaplama', 'lavabo', 'klozet', 'dus', 'batarya', 'ayna', 'foto'] },
                { id: 'hol', name: 'Hol', fields: ['zemin', 'boya', 'foto'] }
            ],
            '2+1': [
                { id: 'salon', name: 'Salon', fields: ['zemin', 'boya', 'foto'] },
                { id: 'mutfak', name: 'Mutfak', fields: ['zemin', 'boya', 'dolap_alt', 'dolap_ust', 'tezgah', 'panel', 'foto'] },
                { id: 'ebeveyn_oda', name: 'Ana Yatak Odasƒ±', fields: ['zemin', 'boya', 'foto'] },
                { id: 'cocuk_oda', name: '√áocuk Odasƒ±', fields: ['zemin', 'boya', 'foto'] },
                { id: 'banyo', name: 'Banyo', fields: ['zemin', 'duvar_kaplama', 'lavabo', 'klozet', 'dus', 'batarya', 'ayna', 'foto'] },
                { id: 'hol', name: 'Hol', fields: ['zemin', 'boya', 'foto'] }
            ],
            '3+1': [
                { id: 'salon', name: 'Salon', fields: ['zemin', 'boya', 'foto'] },
                { id: 'mutfak', name: 'Mutfak', fields: ['zemin', 'boya', 'dolap_alt', 'dolap_ust', 'tezgah', 'panel', 'foto'] },
                { id: 'ebeveyn_oda', name: 'Ana Yatak Odasƒ±', fields: ['zemin', 'boya', 'foto'] },
                { id: 'cocuk_oda_1', name: '√áocuk Odasƒ± 1', fields: ['zemin', 'boya', 'foto'] },
                { id: 'cocuk_oda_2', name: '√áocuk Odasƒ± 2', fields: ['zemin', 'boya', 'foto'] },
                { id: 'banyo', name: 'Banyo', fields: ['zemin', 'duvar_kaplama', 'lavabo', 'klozet', 'dus', 'batarya', 'ayna', 'foto'] },
                { id: 'ebeveyn_banyo', name: 'Ebeveyn Banyo', fields: ['zemin', 'duvar_kaplama', 'lavabo', 'klozet', 'dus', 'batarya', 'ayna', 'foto'] },
                { id: 'hol', name: 'Hol', fields: ['zemin', 'boya', 'foto'] }
            ],
            '4+1': [
                { id: 'salon', name: 'Salon', fields: ['zemin', 'boya', 'foto'] },
                { id: 'mutfak', name: 'Mutfak', fields: ['zemin', 'boya', 'dolap_alt', 'dolap_ust', 'tezgah', 'panel', 'foto'] },
                { id: 'ebeveyn_oda', name: 'Ana Yatak Odasƒ±', fields: ['zemin', 'boya', 'foto'] },
                { id: 'cocuk_oda_1', name: '√áocuk Odasƒ± 1', fields: ['zemin', 'boya', 'foto'] },
                { id: 'cocuk_oda_2', name: '√áocuk Odasƒ± 2', fields: ['zemin', 'boya', 'foto'] },
                { id: 'cocuk_oda_3', name: '√áocuk Odasƒ± 3', fields: ['zemin', 'boya', 'foto'] },
                { id: 'banyo', name: 'Banyo', fields: ['zemin', 'duvar_kaplama', 'lavabo', 'klozet', 'dus', 'batarya', 'ayna', 'foto'] },
                { id: 'ebeveyn_banyo', name: 'Ebeveyn Banyo', fields: ['zemin', 'duvar_kaplama', 'lavabo', 'klozet', 'dus', 'batarya', 'ayna', 'foto'] },
                { id: 'hol', name: 'Hol', fields: ['zemin', 'boya', 'foto'] }
            ]
        };

        const DEFAULT_FIELD_LABELS = {
            zemin: { label: 'Zemin Kaplama', unit: 'm¬≤', category: 'Zemin' },
            boya: { label: 'Duvar Boya', unit: 'm¬≤', category: 'Boya' },
            dolap_alt: { label: 'Dolap Alt', unit: 'Adet', category: 'Dolap' },
            dolap_ust: { label: 'Dolap √úst', unit: 'Adet', category: 'Dolap' },
            tezgah: { label: 'Tezgah', unit: 'mt', category: 'Tezgah' },
            panel: { label: 'Panel', unit: 'm¬≤', category: 'Panel' },
            duvar_kaplama: { label: 'Duvar Kaplama', unit: 'm¬≤', category: 'Kaplama' },
            lavabo: { label: 'Lavabo', unit: 'Adet', category: 'Armat√ºr' },
            klozet: { label: 'Klozet', unit: 'Adet', category: 'Armat√ºr' },
            dus: { label: 'Du≈ü', unit: 'Adet', category: 'Armat√ºr' },
            batarya: { label: 'Batarya', unit: 'Adet', category: 'Armat√ºr' },
            ayna: { label: 'Ayna', unit: 'Adet', category: 'Aksesuar' },
            aydinlatma: { label: 'Aydƒ±nlatma', unit: 'Adet', category: 'Elektrik' },
            priz: { label: 'Priz', unit: 'Adet', category: 'Elektrik' },
            kapi: { label: 'Kapƒ±', unit: 'Adet', category: 'Doƒürama' },
            pencere: { label: 'Pencere', unit: 'Adet', category: 'Doƒürama' },
            perde: { label: 'Perde', unit: 'm', category: 'Tekstil' },
            tavan: { label: 'Tavan Kaplama', unit: 'm¬≤', category: 'Kaplama' },
            foto: { label: 'Fotoƒüraf', unit: '', category: 'Diƒüer' }
        };

        const DEFAULT_MATERIALS = {
            'Seramik': {
                '‚öôÔ∏è √ñzel': ['Seramik Veri Tabanƒ± - Saƒüdaki panelden y√∂netin']
                // √ñzel seramik kategorisi - ceramicData ile y√∂netiliyor
                // UI'da √∂zel panel g√∂sterilecek
            },
            'Zemin': {
                'Seramik': ['60x60 Beyaz Seramik', '80x80 Gri Seramik', 'Mozaik Seramik'],
                'Parke': ['Laminat Parke Me≈üe', 'Laminat Parke Ceviz', 'Masif Parke'],
                'Granit': ['Siyah Granit', 'Beyaz Granit', 'Gri Granit'],
                'Mermer': ['Beyaz Mermer', 'Krem Mermer', 'Siyah Mermer']
            },
            'Boya': {
                'Saten': ['Beyaz Saten', 'Krem Saten', 'Gri Saten'],
                'Mat': ['Mat Beyaz', 'Mat Gri', 'Mat Bej'],
                'ƒ∞pek': ['ƒ∞pek Beyaz', 'ƒ∞pek Krem']
            },
            'Kaplama': {
                'Seramik': ['Beyaz Seramik 30x60', 'Gri Seramik 30x60', 'Mozaik'],
                'Ta≈ü': ['Doƒüal Ta≈ü', 'Traverten', 'K√ºlt√ºr Ta≈üƒ±']
            },
            'Dolap': {
                'Lake': ['Beyaz Lake', 'Gri Lake', 'Antrasit Lake'],
                'Ah≈üap': ['Me≈üe Kaplama', 'Ceviz Kaplama']
            },
            'Tezgah': {
                'Granit': ['Granit Siyah', 'Granit Beyaz'],
                'Mermer': ['Mermer Beyaz', 'Mermer Krem'],
                'Kompakt': ['Kompakt Beyaz', 'Kompakt Gri']
            },
            'Panel': {
                'Cam': ['Cam Panel Beyaz', 'Cam Panel Gri'],
                'Seramik': ['Seramik Panel']
            },
            'Armat√ºr': {
                'Krom': ['Standart Krom', 'Parlak Krom'],
                'Mat Siyah': ['Mat Siyah Batarya', 'Mat Siyah Du≈ü'],
                'Gold': ['Gold Batarya', 'Gold Du≈ü']
            },
            'Aksesuar': {
                'Ayna': ['Ayna 60x80', 'Ayna 80x100', 'LED Ayna'],
                'Raf': ['Cam Raf', 'Ah≈üap Raf']
            },
            'Elektrik': {
                'Aydƒ±nlatma': ['LED Spot', 'Avize', 'Aplik', '≈ûerit LED'],
                'Priz': ['Beyaz Priz', 'Gri Priz', 'USB\'li Priz']
            },
            'Doƒürama': {
                'PVC': ['Beyaz PVC', 'Gri PVC'],
                'Ah≈üap': ['Ah≈üap Kaplama', 'Masif Ah≈üap'],
                'Al√ºminyum': ['Beyaz Al√ºminyum', 'Gri Al√ºminyum']
            },
            'Tekstil': {
                'Perde': ['Blackout', 'T√ºl', 'Jaluzi'],
                'Stor': ['Zebra Stor', 'Rulo Stor']
            },
            'Seramik': {
                // √ñzel seramik kategorisi - ceramicData ile y√∂netiliyor
                // UI'da √∂zel panel g√∂sterilecek
            }
        };

        // ==========================================
        // LOGIN SCREEN COMPONENT
        // ==========================================
        
        function LoginScreen() {
            const [mode, setMode] = useState('login'); // 'login', 'signup', 'reset'
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setSuccess('');
                setLoading(true);

                if (mode === 'login') {
                    const result = await signIn(email, password);
                    if (!result.success) {
                        setError(result.error);
                    }
                } else if (mode === 'signup') {
                    if (password.length < 6) {
                        setError('≈ûifre en az 6 karakter olmalƒ±');
                        setLoading(false);
                        return;
                    }
                    const result = await signUp(email, password);
                    if (result.success) {
                        setSuccess('Hesap olu≈üturuldu! Giri≈ü yapƒ±lƒ±yor...');
                    } else {
                        setError(result.error);
                    }
                } else if (mode === 'reset') {
                    const result = await resetPassword(email);
                    if (result.success) {
                        setSuccess('≈ûifre sƒ±fƒ±rlama linki email adresinize g√∂nderildi!');
                        setTimeout(() => setMode('login'), 2000);
                    } else {
                        setError(result.error);
                    }
                }

                setLoading(false);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        {/* Logo */}
                        <div className="text-center mb-8">
                            <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-full p-4 inline-block mb-4">
                                <svg className="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">Daire Se√ßim Listeleri</h1>
                            <p className="text-gray-600">
                                {mode === 'login' && 'Hesabƒ±nƒ±za giri≈ü yapƒ±n'}
                                {mode === 'signup' && 'Yeni hesap olu≈üturun'}
                                {mode === 'reset' && '≈ûifrenizi sƒ±fƒ±rlayƒ±n'}
                            </p>
                        </div>

                        {/* Error/Success Messages */}
                        {error && (
                            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2">
                                <svg className="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span className="text-red-800 text-sm">{error}</span>
                            </div>
                        )}
                        {success && (
                            <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2">
                                <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span className="text-green-800 text-sm">{success}</span>
                            </div>
                        )}

                        {/* Form */}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Email
                                </label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all"
                                    placeholder="ornek@email.com"
                                />
                            </div>

                            {mode !== 'reset' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        ≈ûifre
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    />
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? (
                                    <span className="flex items-center justify-center gap-2">
                                        <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>ƒ∞≈üleniyor...</span>
                                    </span>
                                ) : (
                                    <>
                                        {mode === 'login' && 'Giri≈ü Yap'}
                                        {mode === 'signup' && 'Hesap Olu≈ütur'}
                                        {mode === 'reset' && '≈ûifre Sƒ±fƒ±rlama Linki G√∂nder'}
                                    </>
                                )}
                            </button>
                        </form>

                        {/* Mode Switch */}
                        <div className="mt-6 text-center space-y-2">
                            {mode === 'login' && (
                                <>
                                    <button
                                        onClick={() => setMode('reset')}
                                        className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                                    >
                                        ≈ûifremi unuttum
                                    </button>
                                    <div className="text-gray-600 text-sm">
                                        Hesabƒ±nƒ±z yok mu?{' '}
                                        <button
                                            onClick={() => setMode('signup')}
                                            className="text-blue-600 hover:text-blue-800 font-medium"
                                        >
                                            Kayƒ±t olun
                                        </button>
                                    </div>
                                </>
                            )}
                            {mode === 'signup' && (
                                <div className="text-gray-600 text-sm">
                                    Zaten hesabƒ±nƒ±z var mƒ±?{' '}
                                    <button
                                        onClick={() => setMode('login')}
                                        className="text-blue-600 hover:text-blue-800 font-medium"
                                    >
                                        Giri≈ü yapƒ±n
                                    </button>
                                </div>
                            )}
                            {mode === 'reset' && (
                                <button
                                    onClick={() => setMode('login')}
                                    className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                                >
                                    ‚Üê Giri≈ü sayfasƒ±na d√∂n
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // MAIN APP COMPONENT
        // ==========================================

        function App() {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [authLoading, setAuthLoading] = useState(true);
            const [projects, setProjects] = useState([{ id: 1, name: 'Proje 1', apartments: [{ id: 1, name: 'Daire 1', data: {}, wallCount: {} }] }]);
            const [currentPrj, setCurrentPrj] = useState(1);
            const [currentApt, setCurrentApt] = useState(1);
            const [currentRoom, setCurrentRoom] = useState('salon');
            const [customRooms, setCustomRooms] = useState([]);
            const [baseRooms, setBaseRooms] = useState(DEFAULT_ROOMS);
            const [roomOrder, setRoomOrder] = useState([]);
            const [fieldLabels, setFieldLabels] = useState(DEFAULT_FIELD_LABELS);
            const [materials, setMaterials] = useState(DEFAULT_MATERIALS);
            const [ceramicData, setCeramicData] = useState(() => {
                const saved = localStorage.getItem('ceramic_data');
                return saved ? JSON.parse(saved) : {
                    series: ["Graniti", "Stone", "Marmi"],
                    sizes: ["60x120", "80x80", "60x60", "30x60"],
                    items: []
                };
            });
            const [showDB, setShowDB] = useState(false);
            const [showDefaultSettings, setShowDefaultSettings] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [editingCategory, setEditingCategory] = useState(null);
            const [activeDBTab, setActiveDBTab] = useState('Seramik');
            const [draggedTab, setDraggedTab] = useState(null);
            const [searchRoom, setSearchRoom] = useState('');
            const [searchMaterial, setSearchMaterial] = useState('');
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
            const [showMaterialAnalysis, setShowMaterialAnalysis] = useState(false);
            const [activeAnalysisTab, setActiveAnalysisTab] = useState('T√ºm√º');
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [allUsers, setAllUsers] = useState([]);
            const [allUsersData, setAllUsersData] = useState({});
            const [selectedUser, setSelectedUser] = useState(null);
            const [adminTab, setAdminTab] = useState('users'); // users, stats, settings
            const [viewingUserId, setViewingUserId] = useState(null); // Admin ba≈üka kullanƒ±cƒ± verilerini g√∂r√ºnt√ºl√ºyorsa
            const [showAdminCopyModal, setShowAdminCopyModal] = useState(false);
            const [adminCopySource, setAdminCopySource] = useState(null); // {type: 'project'|'apartment', data: {...}}
            const [adminCopyTarget, setAdminCopyTarget] = useState(null); // userId
            const [showCopyModal, setShowCopyModal] = useState(false);
            const [copyOptions, setCopyOptions] = useState({
                rooms: true,
                materials: true,
                amounts: true,
                photos: false
            });
            const [copyCount, setCopyCount] = useState(1); // Ka√ß adet kopyalanacak
            const [numberingMode, setNumberingMode] = useState('sequential'); // sequential, odd, even, custom
            const [customNumbers, setCustomNumbers] = useState(''); // √ñzel numaralar (virg√ºlle ayrƒ±lmƒ±≈ü)
            const [startNumber, setStartNumber] = useState(''); // Ba≈ülangƒ±√ß numarasƒ±
            const [showCopyAmountsModal, setShowCopyAmountsModal] = useState(false);
            const [sourceAptForAmounts, setSourceAptForAmounts] = useState(null);
            const [selectedFieldsForCopy, setSelectedFieldsForCopy] = useState({});
            const [showIconPicker, setShowIconPicker] = useState(false);
            const [selectedRoomForIcon, setSelectedRoomForIcon] = useState(null);
            const [selectedFieldForIcon, setSelectedFieldForIcon] = useState(null);
            const [iconLibrary, setIconLibrary] = useState(() => {
                const saved = localStorage.getItem('icon_library');
                return saved ? JSON.parse(saved) : [];
            });
            const [showArchiveModal, setShowArchiveModal] = useState(false);
            const [archivedProjects, setArchivedProjects] = useState([]);
            const [loadingArchives, setLoadingArchives] = useState(false);
            const [lightbox, setLightbox] = useState(null);
            const [firebaseSync, setFirebaseSync] = useState(firebaseEnabled);
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const [firebaseStatus, setFirebaseStatus] = useState({ connected: firebaseEnabled, message: '', type: 'connected' });
            const [showBulkDeleteModal, setShowBulkDeleteModal] = useState(false);
            const [selectedApartmentsForDelete, setSelectedApartmentsForDelete] = useState([]);
            const [sessionConflict, setSessionConflict] = useState(null);
            const [showSessionConflictModal, setShowSessionConflictModal] = useState(false);
            const [refreshKey, setRefreshKey] = useState(0); // Form yenileme i√ßin - ayarlar deƒüi≈ütiƒüinde formu g√ºnceller
            const [showNewProjectModal, setShowNewProjectModal] = useState(false);
            const [newProjectName, setNewProjectName] = useState('');
            const [selectedTemplate, setSelectedTemplate] = useState('2+1');
            const [customRoomSetup, setCustomRoomSetup] = useState([]);
            const [showNewApartmentModal, setShowNewApartmentModal] = useState(false);
            const [newApartmentName, setNewApartmentName] = useState('');
            const [showBulkMaterialModal, setShowBulkMaterialModal] = useState(false);
            const [bulkMaterialFields, setBulkMaterialFields] = useState({});
            const [bulkMaterialSelections, setBulkMaterialSelections] = useState({});
            const [bulkTargetApartments, setBulkTargetApartments] = useState('all');
            const [bulkSelectedApartments, setBulkSelectedApartments] = useState([]);
            const [bulkTargetRoomTypes, setBulkTargetRoomTypes] = useState('all');
            const [bulkSelectedRoomTypes, setBulkSelectedRoomTypes] = useState([]);
            const [showBulkAmountModal, setShowBulkAmountModal] = useState(false);
            const [bulkAmountFields, setBulkAmountFields] = useState({});
            const [bulkAmountValues, setBulkAmountValues] = useState({});
            const [bulkAmountTargetApartments, setBulkAmountTargetApartments] = useState('all');
            const [bulkAmountSelectedApartments, setBulkAmountSelectedApartments] = useState([]);
            const [bulkAmountTargetRoomTypes, setBulkAmountTargetRoomTypes] = useState('all');
            const [bulkAmountSelectedRoomTypes, setBulkAmountSelectedRoomTypes] = useState([]);
            const [showBulkActionsDropdown, setShowBulkActionsDropdown] = useState(false);
            const [showArchiveDropdown, setShowArchiveDropdown] = useState(false);
            const [showCopyDropdown, setShowCopyDropdown] = useState(false);

            // Authentication durumunu dinle
            useEffect(() => {
                if (!auth) {
                    setAuthLoading(false);
                    return;
                }
                
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    setUser(user);
                    setAuthLoading(false);
                    if (user) {
                        console.log('‚úÖ Kullanƒ±cƒ± giri≈ü yaptƒ±:', user.email);
                        
                        // Admin kontrol√º
                        try {
                            const adminDoc = await db.collection('admins').doc(user.uid).get();
                            const isUserAdmin = adminDoc.exists && adminDoc.data().role === 'admin';
                            setIsAdmin(isUserAdmin);
                            if (isUserAdmin) {
                                console.log('üëë Admin kullanƒ±cƒ±');
                            }
                        } catch (error) {
                            console.error('Admin kontrol√º hatasƒ±:', error);
                            setIsAdmin(false);
                        }
                        
                        // Oturum bilgisini g√ºncelle
                        updateSessionInfo(user);
                    } else {
                        console.log('‚ùå Kullanƒ±cƒ± √ßƒ±kƒ±≈ü yaptƒ±');
                        setIsAdmin(false);
                    }
                });
                
                return () => unsubscribe();
            }, []);
            
            // Oturum √ßakƒ±≈ümasƒ±nƒ± kontrol et
            useEffect(() => {
                if (!firebaseEnabled || !user) return;
                
                const unsubscribe = checkSessionConflict((conflictData) => {
                    console.log('‚ö†Ô∏è Oturum √ßakƒ±≈ümasƒ± tespit edildi:', conflictData);
                    setSessionConflict(conflictData);
                    setShowSessionConflictModal(true);
                });
                
                // Her 30 saniyede bir oturum bilgisini g√ºncelle (aktif olduƒüunu g√∂ster)
                const interval = setInterval(() => {
                    if (user) {
                        updateSessionInfo(user);
                    }
                }, 30000);
                
                return () => {
                    if (unsubscribe) unsubscribe();
                    clearInterval(interval);
                };
            }, [user, firebaseEnabled]);

            // Dropdown men√ºleri dƒ±≈üƒ±na tƒ±klandƒ±ƒüƒ±nda kapat
            useEffect(() => {
                const handleClickOutside = (event) => {
                    // Tƒ±klanan element dropdown i√ßinde mi kontrol et
                    const isInsideDropdown = event.target.closest('.dropdown-container');
                    
                    if (!isInsideDropdown) {
                        setShowBulkActionsDropdown(false);
                        setShowArchiveDropdown(false);
                        setShowCopyDropdown(false);
                    }
                };
                
                // Document'a event listener ekle
                document.addEventListener('mousedown', handleClickOutside);
                
                // Cleanup
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, []);

            // SAYFA ƒ∞LK Y√úKLENDIƒûINDE - localStorage'daki Seramik kategorisini garantile
            useEffect(() => {
                const savedMat = localStorage.getItem('material_database');
                if (savedMat) {
                    try {
                        const mat = JSON.parse(savedMat);
                        if (!mat['Seramik']) {
                            console.log('üîß localStorage d√ºzeltiliyor - Seramik kategorisi ekleniyor...');
                            // Seramik'i EN BA≈ûA ekle
                            const newMat = {
                                'Seramik': {
                                    '‚öôÔ∏è √ñzel': ['Seramik Veri Tabanƒ± - Saƒüdaki panelden y√∂netin']
                                },
                                ...mat
                            };
                            localStorage.setItem('material_database', JSON.stringify(newMat));
                            setMaterials(newMat);
                            console.log('‚úÖ Seramik kategorisi eklendi!');
                        }
                    } catch (err) {
                        console.error('‚ùå localStorage okuma hatasƒ±:', err);
                    }
                }
            }, []); // Sadece component mount olduƒüunda bir kere √ßalƒ±≈üƒ±r

            // Seramik kategorisini her zaman garantile
            useEffect(() => {
                if (!materials['Seramik']) {
                    console.log('‚ö†Ô∏è Seramik kategorisi bulunamadƒ±, ekleniyor...');
                    const newMat = { 
                        'Seramik': {
                            '‚öôÔ∏è √ñzel': ['Seramik Veri Tabanƒ± - Saƒüdaki panelden y√∂netin']
                        },
                        ...materials 
                    };
                    setMaterials(newMat);
                }
            }, [materials]);

            // Materials ve CeramicData deƒüi≈ütiƒüinde Firebase'e otomatik kaydet
            useEffect(() => {
                if (authLoading || !user) return; // ƒ∞lk y√ºkleme tamamlanana kadar bekle
                
                if (firebaseSync && firebaseEnabled && user) {
                    // Debounce: 2 saniye bekle, ardƒ±ndan kaydet (gereksiz kayƒ±tlarƒ± engelle)
                    const saveTimeout = setTimeout(async () => {
                        await saveToFirebase({
                            projects,
                            customRooms,
                            baseRooms,
                            roomOrder,
                            fieldLabels,
                            materials,
                            ceramicData
                        });
                    }, 2000);
                    
                    return () => clearTimeout(saveTimeout);
                }
            }, [materials, ceramicData, firebaseSync, user]);

            // Tema y√ºklendiƒüinde CSS g√ºncelle
            useEffect(() => {
                const themeStyle = document.getElementById('theme-style');
                if (themeStyle) {
                    if (theme === 'dark') {
                        themeStyle.innerHTML = `
                            select option {
                                background-color: #374151 !important;
                                color: #f3f4f6 !important;
                            }
                        `;
                    } else {
                        themeStyle.innerHTML = `
                            select option {
                                background-color: white !important;
                                color: #111827 !important;
                            }
                        `;
                    }
                }
            }, [theme]);

            // Materials veya fieldLabels deƒüi≈ütiƒüinde formu yenile
            useEffect(() => {
                setRefreshKey(prev => prev + 1);
            }, [materials, fieldLabels]);

            // Eski dairelere (customRooms olmayan) otomatik ≈üablon ata
            useEffect(() => {
                let needsUpdate = false;
                const updatedProjects = projects.map(project => ({
                    ...project,
                    apartments: project.apartments.map(apt => {
                        // Eƒüer dairede customRooms yoksa, varsayƒ±lan 2+1 ≈üablonunu ata
                        if (!apt.customRooms || apt.customRooms.length === 0) {
                            needsUpdate = true;
                            return {
                                ...apt,
                                customRooms: JSON.parse(JSON.stringify(APARTMENT_TEMPLATES['2+1']))
                            };
                        }
                        return apt;
                    })
                }));
                
                if (needsUpdate) {
                    console.log('üîÑ Eski dairelere otomatik ≈üablon atandƒ±');
                    setProjects(updatedProjects);
                }
            }, []); // Sadece ilk y√ºklemede √ßalƒ±≈üƒ±r

            // ƒ∞lk y√ºkleme - Firebase varsa sadece oradan, yoksa localStorage'dan y√ºkle
            useEffect(() => {
                // Auth y√ºklenene kadar bekle
                if (authLoading) {
                    console.log('‚è≥ Authentication y√ºkleniyor...');
                    return;
                }
                
                const loadData = async () => {
                    // Firebase aktif ve kullanƒ±cƒ± giri≈ü yapmƒ±≈üsa, √∂nce Firebase'den y√ºkle
                    if (firebaseEnabled && user) {
                        console.log('üî• Firebase aktif - veriler Firebase\'den y√ºkleniyor...');
                        setFirebaseStatus({ connected: true, message: 'Firebase\'den veriler y√ºkleniyor...', type: 'loading' });
                        
                        try {
                            const firebaseData = await loadFromFirebase();
                            if (firebaseData) {
                                if (firebaseData.projects) setProjects(firebaseData.projects);
                                if (firebaseData.customRooms) setCustomRooms(firebaseData.customRooms);
                                if (firebaseData.baseRooms) setBaseRooms(firebaseData.baseRooms);
                                if (firebaseData.fieldLabels) setFieldLabels(firebaseData.fieldLabels);
                                if (firebaseData.roomOrder) setRoomOrder(firebaseData.roomOrder);
                                if (firebaseData.materials) setMaterials(firebaseData.materials);
                                if (firebaseData.ceramicData) setCeramicData(firebaseData.ceramicData);
                                const firebaseTimestamp = firebaseData.lastUpdate?.toMillis() || Date.now();
                                setLastSyncTime(new Date(firebaseTimestamp));
                                console.log('‚úÖ Firebase\'den veri y√ºkleme tamamlandƒ±');
                                setFirebaseStatus({ connected: true, message: '', type: 'connected' });
                            } else {
                                console.log('‚ö†Ô∏è Firebase\'de veri bulunamadƒ±, varsayƒ±lan veriler kullanƒ±lƒ±yor');
                                setFirebaseStatus({ connected: true, message: 'Firebase\'de veri bulunamadƒ±', type: 'warning' });
                                setTimeout(() => setFirebaseStatus({ connected: true, message: '', type: 'connected' }), 3000);
                            }
                        } catch (error) {
                            console.error('‚ùå Firebase veri y√ºkleme hatasƒ±:', error);
                            setFirebaseStatus({ connected: false, message: 'Firebase baƒülantƒ± hatasƒ±! Yerel veriler kullanƒ±lƒ±yor.', type: 'error' });
                            
                            // Hata durumunda localStorage'dan y√ºkle
                            const saved = localStorage.getItem('projects_data');
                            if (saved) {
                                const loaded = JSON.parse(saved);
                                setProjects(loaded);
                                if (loaded[0] && loaded[0].apartments[0]) setCurrentApt(loaded[0].apartments[0].id);
                            }
                            const savedRooms = localStorage.getItem('custom_rooms');
                            if (savedRooms) setCustomRooms(JSON.parse(savedRooms));
                            const savedBaseRooms = localStorage.getItem('base_rooms');
                            if (savedBaseRooms) setBaseRooms(JSON.parse(savedBaseRooms));
                            const savedFieldLabels = localStorage.getItem('field_labels');
                            if (savedFieldLabels) setFieldLabels(JSON.parse(savedFieldLabels));
                            const savedRoomOrder = localStorage.getItem('room_order');
                            if (savedRoomOrder) setRoomOrder(JSON.parse(savedRoomOrder));
                            const savedMat = localStorage.getItem('material_database');
                            if (savedMat) {
                                const loadedMat = JSON.parse(savedMat);
                                // Seramik kategorisini garantile
                                if (!loadedMat['Seramik']) {
                                    loadedMat['Seramik'] = {
                                        '‚öôÔ∏è √ñzel': ['Seramik Veri Tabanƒ± - Saƒüdaki panelden y√∂netin']
                                    };
                                }
                                setMaterials(loadedMat);
                            }
                        }
                        
                        // Kullanƒ±cƒ± ayarlarƒ±nƒ± y√ºkle (tema tercihi)
                        if (db) {
                            try {
                                const userSettingsDoc = await db.collection('userSettings').doc(user.uid).get();
                                if (userSettingsDoc.exists) {
                                    const settings = userSettingsDoc.data();
                                    if (settings.theme) {
                                        setTheme(settings.theme);
                                        console.log('‚úÖ Tema tercihi Firebase\'den y√ºklendi:', settings.theme);
                                    }
                                }
                            } catch (error) {
                                console.error('‚ùå Tema Firebase\'den y√ºklenemedi:', error);
                            }
                        }
                    } else {
                        // Firebase yoksa localStorage'dan y√ºkle
                        console.log('üíæ Firebase devre dƒ±≈üƒ± - veriler localStorage\'dan y√ºkleniyor...');
                        setFirebaseStatus({ connected: false, message: '√áevrimdƒ±≈üƒ± mod - Yerel veriler kullanƒ±lƒ±yor', type: 'warning' });
                        setTimeout(() => setFirebaseStatus({ connected: false, message: '', type: 'offline' }), 3000);
                        
                        const saved = localStorage.getItem('projects_data');
                        if (saved) {
                            const loaded = JSON.parse(saved);
                            setProjects(loaded);
                            if (loaded[0] && loaded[0].apartments[0]) setCurrentApt(loaded[0].apartments[0].id);
                        }
                        const savedRooms = localStorage.getItem('custom_rooms');
                        if (savedRooms) setCustomRooms(JSON.parse(savedRooms));
                        
                        const savedBaseRooms = localStorage.getItem('base_rooms');
                        if (savedBaseRooms) setBaseRooms(JSON.parse(savedBaseRooms));
                        
                        const savedFieldLabels = localStorage.getItem('field_labels');
                        if (savedFieldLabels) setFieldLabels(JSON.parse(savedFieldLabels));
                        
                        const savedRoomOrder = localStorage.getItem('room_order');
                        if (savedRoomOrder) setRoomOrder(JSON.parse(savedRoomOrder));
                        
                        const savedMat = localStorage.getItem('material_database');
                        if (savedMat) {
                            const loadedMat = JSON.parse(savedMat);
                            // Seramik kategorisini garantile
                            if (!loadedMat['Seramik']) {
                                loadedMat['Seramik'] = {
                                    '‚öôÔ∏è √ñzel': ['Seramik Veri Tabanƒ± - Saƒüdaki panelden y√∂netin']
                                };
                            }
                            setMaterials(loadedMat);
                        }
                    }
                };
                
                loadData();
                
                const handleEsc = (e) => { if (e.key === 'Escape') setLightbox(null); };
                document.addEventListener('keydown', handleEsc);
                
                // Number input'larda mouse scroll'u engelle
                const preventNumberScroll = (e) => {
                    if (e.target.type === 'number') {
                        e.preventDefault();
                    }
                };
                document.addEventListener('wheel', preventNumberScroll, { passive: false });
                
                return () => {
                    document.removeEventListener('keydown', handleEsc);
                    document.removeEventListener('wheel', preventNumberScroll);
                };
            }, [user, authLoading]); // user deƒüi≈ütiƒüinde veya auth y√ºklendiƒüinde tekrar √ßalƒ±≈ütƒ±r
            
            // Browser online/offline durumunu dinle
            useEffect(() => {
                const handleOnline = () => {
                    console.log('üåê ƒ∞nternet baƒülantƒ±sƒ± geri geldi');
                    if (firebaseEnabled && user) {
                        setFirebaseStatus({ connected: true, message: 'ƒ∞nternet baƒülantƒ±sƒ± geri geldi', type: 'success' });
                        setTimeout(() => setFirebaseStatus({ connected: true, message: '', type: 'connected' }), 3000);
                    }
                };
                
                const handleOffline = () => {
                    console.log('üì° ƒ∞nternet baƒülantƒ±sƒ± kesildi');
                    setFirebaseStatus({ connected: false, message: 'ƒ∞nternet baƒülantƒ±sƒ± yok', type: 'error' });
                };
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                // Sayfa y√ºklendiƒüinde mevcut durumu kontrol et
                if (!navigator.onLine) {
                    setFirebaseStatus({ connected: false, message: 'ƒ∞nternet baƒülantƒ±sƒ± yok', type: 'error' });
                }
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, [firebaseEnabled, user]);

            // Firebase ger√ßek zamanlƒ± senkronizasyon
            useEffect(() => {
                if (!firebaseSync || !firebaseEnabled || !user) return;
                
                let isFirstLoad = true;
                let lastLocalUpdateTime = Date.now();
                
                const unsubscribe = setupFirebaseListener((data) => {
                    // ƒ∞lk y√ºklemeyi atla (sayfa y√ºklenirken tetiklenir)
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        lastLocalUpdateTime = data.lastUpdate?.toMillis() || Date.now();
                        return;
                    }
                    
                    const firebaseTimestamp = data.lastUpdate?.toMillis() || Date.now();
                    
                    // Sadece Firebase daha yeni ise g√ºncelle (kendi deƒüi≈üikliklerimizi atla)
                    if (firebaseTimestamp > lastLocalUpdateTime + 3000) { // 3 saniye tolerans
                        console.log('üîÑ Ba≈üka cihazdan g√ºncelleme alƒ±ndƒ±');
                        if (data.projects) setProjects(data.projects);
                        if (data.customRooms) setCustomRooms(data.customRooms);
                        if (data.baseRooms) setBaseRooms(data.baseRooms);
                        if (data.fieldLabels) setFieldLabels(data.fieldLabels);
                        if (data.roomOrder) setRoomOrder(data.roomOrder);
                        if (data.materials) setMaterials(data.materials);
                        if (data.ceramicData) setCeramicData(data.ceramicData);
                        lastLocalUpdateTime = firebaseTimestamp;
                        setLastSyncTime(new Date(firebaseTimestamp));
                        
                        // Ge√ßici bildirim g√∂ster
                        setFirebaseStatus({ connected: true, message: 'Ba≈üka cihazdan g√ºncelleme alƒ±ndƒ±', type: 'success' });
                        setTimeout(() => setFirebaseStatus({ connected: true, message: '', type: 'connected' }), 3000);
                    }
                    // Kendi deƒüi≈üikliƒüimiz - sessizce atla
                });
                
                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, [firebaseSync, user]);
            
            // Eski daireleri yeni sisteme migrate et (sadece ilk y√ºklemede bir kere)
            useEffect(() => {
                if (authLoading) return; // Auth y√ºklenene kadar bekle
                
                let needsMigration = false;
                const migratedProjects = projects.map(project => {
                    const migratedApartments = project.apartments.map(apt => {
                        // Eƒüer customRooms yoksa (eski sistem), baseRooms'u customRooms olarak ekle
                        if (!apt.customRooms || apt.customRooms.length === 0) {
                            needsMigration = true;
                            console.log(`üîÑ "${apt.name}" dairesi yeni sisteme migrate ediliyor...`);
                            return {
                                ...apt,
                                customRooms: baseRooms.map(room => ({
                                    id: room.id,
                                    name: room.name,
                                    fields: [...room.fields]
                                }))
                            };
                        }
                        return apt;
                    });
                    return { ...project, apartments: migratedApartments };
                });
                
                if (needsMigration) {
                    console.log('‚úÖ Eski daireler yeni sisteme migrate edildi');
                    updateProjects(migratedProjects);
                }
            }, [authLoading]); // Sadece auth y√ºklendiƒüinde bir kere √ßalƒ±≈ü
            
            // NOT: Otomatik kaydetme devre dƒ±≈üƒ± - sonsuz d√∂ng√º engellendi
            // Kullanƒ±cƒ± "Kaydet" butonuna basmalƒ± veya manuel kaydetme yapƒ±lmalƒ±

            const getProject = () => projects.find(p => p.id === currentPrj) || projects[0];
            
            // Daireleri doƒüal sƒ±ralama ile sƒ±rala (Daire 1, Daire 2, Daire 25, Daire 26...)
            const apartments = [...(getProject().apartments || [])].sort((a, b) => {
                return a.name.localeCompare(b.name, 'tr', { numeric: true, sensitivity: 'base' });
            });
            
            const getApt = () => apartments.find(a => a.id === currentApt) || apartments[0];
            const getRoomData = () => (getApt().data[currentRoom] || {});

            // Her daire i√ßin g√∂r√ºn√ºr mekanlarƒ± filtrele ve sƒ±rala
            const apt = getApt();
            const apartmentCustomRooms = apt.customRooms || [];
            
            // Eƒüer dairenin √∂zel mekanlarƒ± varsa (yeni sistem), onlarƒ± kullan
            // Yoksa (eski veriler), baseRooms kullan (geriye d√∂n√ºk uyumluluk i√ßin)
            const allRoomsUnsorted = apartmentCustomRooms.length > 0 
                ? [...apartmentCustomRooms, ...customRooms]  // Yeni sistem - sadece daire mekanlarƒ± + global custom
                : [...baseRooms, ...customRooms];  // Eski sistem - base mekanlar + global custom
            
            const allRooms = roomOrder.length > 0 
                ? roomOrder.map(id => allRoomsUnsorted.find(r => r.id === id)).filter(r => r)
                    .concat(allRoomsUnsorted.filter(r => !roomOrder.includes(r.id)))
                : allRoomsUnsorted;
            const visibleRooms = allRooms.filter(room => {
                const apt = getApt();
                const hiddenRooms = apt.hiddenRooms || [];
                return !hiddenRooms.includes(room.id);
            });

            const updateProjects = (newProjects) => setProjects(newProjects);
            const updateApartments = (newApts) => {
                setProjects(projects.map(p => p.id === currentPrj ? { ...p, apartments: newApts } : p));
            };

            const save = async () => {
                // ƒ∞nternet kontrol√º
                if (!navigator.onLine) {
                    alert('‚ö†Ô∏è ƒ∞nternet baƒülantƒ±sƒ± yok!\n\nKayƒ±t yapƒ±lamadƒ±. ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.');
                    return;
                }
                
                // Firebase aktifse √∂nce oraya kaydet
                if (firebaseSync && firebaseEnabled && user) {
                    // Admin ba≈üka kullanƒ±cƒ± verilerini g√∂r√ºnt√ºl√ºyorsa, onun ID'sine kaydet
                    const targetUserId = viewingUserId || user.uid;
                    
                    console.log('üî• Veriler Firebase\'e kaydediliyor...');
                    if (viewingUserId) {
                        console.log('üëë Admin ba≈üka kullanƒ±cƒ± verisini kaydediyor:', viewingUserId.substring(0, 8) + '...');
                    }
                    
                    const success = await saveToFirebaseWithUserId(targetUserId, {
                        projects,
                        customRooms,
                        baseRooms,
                        roomOrder,
                        fieldLabels,
                        materials
                    });
                    
                    if (success) {
                        const now = Date.now();
                        setLastSyncTime(new Date(now));
                        setFirebaseStatus({ connected: true, message: '', type: 'connected' });
                        
                        if (viewingUserId) {
                            alert('‚úÖ Kaydedildi!\n\n‚òÅÔ∏è Firebase: Ba≈üarƒ±lƒ±\nüë§ Kullanƒ±cƒ± verileri g√ºncellendi');
                        } else {
                            alert('‚úÖ Kaydedildi!\n\n‚òÅÔ∏è Firebase: Ba≈üarƒ±lƒ±');
                        }
                    } else {
                        alert('‚ö†Ô∏è Kayƒ±t ba≈üarƒ±sƒ±z!\n\n‚òÅÔ∏è Firebase baƒülantƒ± hatasƒ±');
                    }
                } else {
                    alert('‚ö†Ô∏è Firebase yapƒ±landƒ±rƒ±lmamƒ±≈ü!\n\nL√ºtfen Firebase ayarlarƒ±nƒ± kontrol edin.');
                }
            };

            // Metin formatƒ±nƒ± d√∂n√º≈üt√ºr: ilk harf B√úY√úK, diƒüerleri k√º√ß√ºk
            const convertAllText = () => {
                if (!confirm('T√úM METƒ∞NLERƒ∞ ve MALZEME VERƒ∞TABANINI d√∂n√º≈üt√ºrmek istediƒüinize emin misiniz?\n\nFormat: "ƒ∞lk Harf B√ºy√ºk diƒüerleri k√º√ß√ºk"\n\n√ñrnek: "VB - NOCTURNE BEYAZ 60X120" ‚Üí "Vb - Nocturne Beyaz 60x120"\n\nHem veri giri≈üleri hem de malzeme veritabanƒ± g√ºncellenecek!\n\nBu i≈ülem GERƒ∞ ALINAMAZ!')) {
                    return;
                }
                
                const convertText = (text) => {
                    if (!text || typeof text !== 'string') return text;
                    
                    // Kelimeleri b√∂l
                    const words = text.split(' ');
                    
                    // Her kelimeyi d√∂n√º≈üt√ºr: ilk harf B√úY√úK, diƒüerleri k√º√ß√ºk
                    const converted = words.map(word => {
                        if (word.length === 0) return word;
                        if (word.length === 1) return word.toUpperCase();
                        
                        // ƒ∞lk karakter B√úY√úK, diƒüerleri k√º√ß√ºk
                        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                    });
                    
                    return converted.join(' ');
                };
                
                // 1. MALZEME VERƒ∞TABANINI D√ñN√ú≈ûT√úR
                const convertedMaterials = {};
                Object.keys(materials).forEach(category => {
                    const categoryData = materials[category];
                    
                    // Hiyerar≈üik yapƒ± mƒ± (alt gruplar var mƒ±)?
                    if (typeof categoryData === 'object' && !Array.isArray(categoryData)) {
                        // Alt gruplu yapƒ±
                        convertedMaterials[category] = {};
                        Object.keys(categoryData).forEach(subgroup => {
                            const convertedSubgroup = convertText(subgroup);
                            const malzemeList = categoryData[subgroup];
                            
                            // Malzemeleri d√∂n√º≈üt√ºr
                            convertedMaterials[category][convertedSubgroup] = malzemeList.map(m => convertText(m));
                        });
                    } else if (Array.isArray(categoryData)) {
                        // D√ºz liste
                        convertedMaterials[category] = categoryData.map(m => convertText(m));
                    } else {
                        // Diƒüer tipler
                        convertedMaterials[category] = categoryData;
                    }
                });
                
                // 2. VERƒ∞ Gƒ∞Rƒ∞≈ûLERƒ∞Nƒ∞ D√ñN√ú≈ûT√úR
                const updatedProjects = projects.map(proj => ({
                    ...proj,
                    apartments: proj.apartments.map(apt => {
                        const newData = {};
                        
                        // Her mekanƒ±n verilerini d√∂n√º≈üt√ºr
                        Object.keys(apt.data).forEach(roomId => {
                            const roomData = apt.data[roomId];
                            const convertedRoomData = {};
                            
                            Object.keys(roomData).forEach(fieldKey => {
                                const fieldValue = roomData[fieldKey];
                                
                                // Fotoƒüraf alanƒ±nƒ± atla
                                if (fieldKey === 'foto') {
                                    convertedRoomData[fieldKey] = fieldValue;
                                    return;
                                }
                                
                                // Duvar kaplama (object i√ßinde object)
                                if (fieldKey === 'duvar_kaplama' && typeof fieldValue === 'object') {
                                    const convertedWalls = {};
                                    Object.keys(fieldValue).forEach(wallIdx => {
                                        const wall = fieldValue[wallIdx];
                                        convertedWalls[wallIdx] = {
                                            ...wall,
                                            subgroup: wall.subgroup ? convertText(wall.subgroup) : wall.subgroup,
                                            malzeme: wall.malzeme ? convertText(wall.malzeme) : wall.malzeme
                                        };
                                    });
                                    convertedRoomData[fieldKey] = convertedWalls;
                                }
                                // Normal alanlar (object: {subgroup, malzeme, miktar})
                                else if (fieldValue && typeof fieldValue === 'object' && !Array.isArray(fieldValue)) {
                                    convertedRoomData[fieldKey] = {
                                        ...fieldValue,
                                        subgroup: fieldValue.subgroup ? convertText(fieldValue.subgroup) : fieldValue.subgroup,
                                        malzeme: fieldValue.malzeme ? convertText(fieldValue.malzeme) : fieldValue.malzeme
                                    };
                                }
                                // Diƒüer tipler (string veya number)
                                else {
                                    convertedRoomData[fieldKey] = fieldValue;
                                }
                            });
                            
                            newData[roomId] = convertedRoomData;
                        });
                        
                        return { ...apt, data: newData };
                    })
                }));
                
                // 3. STATE'LERƒ∞ G√úNCELLE
                setMaterials(convertedMaterials);
                setProjects(updatedProjects);
                
                // 4. LOCALSTORAGE'A KAYDET
                localStorage.setItem('material_database', JSON.stringify(convertedMaterials));
                localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                
                alert('‚úÖ T√ºm metinler d√∂n√º≈üt√ºr√ºld√º!\n\n"ƒ∞lk Harf B√ºy√ºk diƒüerleri k√º√ß√ºk" formatƒ± uygulandƒ±.\n\nüì¶ Malzeme veritabanƒ± g√ºncellendi\nüìù Veri giri≈üleri g√ºncellendi');
            };

            // Drag & Drop fonksiyonlarƒ±
            const [draggedRoom, setDraggedRoom] = useState(null);

            const handleDragStart = (e, roomId) => {
                setDraggedRoom(roomId);
                e.dataTransfer.effectAllowed = 'move';
                e.currentTarget.style.opacity = '0.4';
            };

            const handleDragEnd = (e) => {
                e.currentTarget.style.opacity = '1';
                setDraggedRoom(null);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, targetRoomId) => {
                e.preventDefault();
                if (!draggedRoom || draggedRoom === targetRoomId) return;

                const visibleRoomIds = visibleRooms.map(r => r.id);
                const draggedIndex = visibleRoomIds.indexOf(draggedRoom);
                const targetIndex = visibleRoomIds.indexOf(targetRoomId);

                if (draggedIndex === -1 || targetIndex === -1) return;

                // Yeni sƒ±ralama olu≈ütur
                const newOrder = [...visibleRoomIds];
                newOrder.splice(draggedIndex, 1);
                newOrder.splice(targetIndex, 0, draggedRoom);

                setRoomOrder(newOrder);
                localStorage.setItem('room_order', JSON.stringify(newOrder));
            };

            const resetRoomOrder = () => {
                if (confirm('Mekan sƒ±ralamasƒ±nƒ± varsayƒ±lana d√∂nd√ºrmek istediƒüinize emin misiniz?')) {
                    setRoomOrder([]);
                    localStorage.removeItem('room_order');
                    alert('Sƒ±ralama sƒ±fƒ±rlandƒ±!');
                }
            };

            // Otomatik Yedekleme Fonksiyonlarƒ±
            const addField = () => {
                const id = prompt('Alan ID (kucuk harf, bosluksuz, ornek: mutfak_dolabi):');
                if (!id || !id.trim()) return;
                const fieldId = id.trim().toLowerCase().replace(/\s+/g, '_');
                
                if (fieldLabels[fieldId]) {
                    alert('Bu ID zaten mevcut!');
                    return;
                }
                
                const label = prompt('Alan Adi (ornek: Mutfak Dolabƒ±):');
                if (!label || !label.trim()) return;
                
                const unit = prompt('Birim (m¬≤, Adet, mt, vb.) - OPSIYONEL, bos birakilabilir:');
                
                const category = prompt('Kategori (ornek: Dolap, Armat√ºr, Elektrik):');
                if (!category || !category.trim()) return;
                
                const newFieldLabels = {
                    ...fieldLabels,
                    [fieldId]: {
                        label: label.trim(),
                        unit: unit ? unit.trim() : '',
                        category: category.trim()
                    }
                };
                
                setFieldLabels(newFieldLabels);
                localStorage.setItem('field_labels', JSON.stringify(newFieldLabels));
                
                // Kategoriye malzeme veritabanƒ± ekle
                if (!materials[category.trim()]) {
                    const newMaterials = { ...materials, [category.trim()]: [] };
                    setMaterials(newMaterials);
                    localStorage.setItem('material_database', JSON.stringify(newMaterials));
                }
                
                alert('Alan eklendi!\n\nID: ' + fieldId + '\nAd: ' + label.trim() + '\nBirim: ' + (unit ? unit.trim() : '(Yok)') + '\nKategori: ' + category.trim());
            };

            const deleteField = async (fieldId) => {
                if (fieldId === 'foto') {
                    alert('Fotograf alani silinemez!');
                    return;
                }
                
                if (confirm('Bu alani silmek istediginize emin misiniz?\n\nAlan ID: ' + fieldId + '\nAd: ' + fieldLabels[fieldId].label + '\n\nBu alan t√ºm mekanlardan kaldƒ±rƒ±lacaktƒ±r!')) {
                    // Eski icon'u sil (eƒüer Firebase Storage URL'i ise)
                    const oldIcon = fieldLabels[fieldId]?.icon;
                    if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                        await deletePhotoFromStorage(oldIcon);
                        console.log('üóëÔ∏è Alan silindi, icon da temizlendi');
                    }
                    
                    // fieldLabels'dan sil
                    const newFieldLabels = { ...fieldLabels };
                    delete newFieldLabels[fieldId];
                    setFieldLabels(newFieldLabels);
                    localStorage.setItem('field_labels', JSON.stringify(newFieldLabels));
                    
                    // T√ºm mekanlarƒ±n fields dizisinden sil
                    const updatedBaseRooms = baseRooms.map(room => ({
                        ...room,
                        fields: room.fields.filter(f => f !== fieldId)
                    }));
                    setBaseRooms(updatedBaseRooms);
                    localStorage.setItem('base_rooms', JSON.stringify(updatedBaseRooms));
                    
                    const updatedCustomRooms = customRooms.map(room => ({
                        ...room,
                        fields: room.fields.filter(f => f !== fieldId)
                    }));
                    setCustomRooms(updatedCustomRooms);
                    localStorage.setItem('custom_rooms', JSON.stringify(updatedCustomRooms));
                    
                    // T√ºm projelerdeki t√ºm dairelerdeki bu alanƒ±n verisini sil
                    const updatedProjects = projects.map(proj => ({
                        ...proj,
                        apartments: proj.apartments.map(apt => {
                            const newData = { ...apt.data };
                            // Her mekandan bu alanƒ± sil
                            Object.keys(newData).forEach(roomId => {
                                if (newData[roomId] && newData[roomId][fieldId]) {
                                    const roomData = { ...newData[roomId] };
                                    delete roomData[fieldId];
                                    newData[roomId] = roomData;
                                }
                            });
                            return { ...apt, data: newData };
                        })
                    }));
                    setProjects(updatedProjects);
                    localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                    
                    alert('Alan ve t√ºm veriler t√ºm mekanlardan kaldƒ±rƒ±ldƒ±!');
                }
            };

            const editField = (fieldId) => {
                if (fieldId === 'foto') {
                    alert('Fotograf alani duzenlenemez!');
                    return;
                }
                
                const field = fieldLabels[fieldId];
                const label = prompt('Alan Adi:', field.label);
                if (!label || !label.trim()) return;
                
                const unit = prompt('Birim (OPSIYONEL, bos birakilabilir):', field.unit);
                
                const category = prompt('Kategori:', field.category);
                if (!category || !category.trim()) return;
                
                const newFieldLabels = {
                    ...fieldLabels,
                    [fieldId]: {
                        label: label.trim(),
                        unit: unit ? unit.trim() : '',
                        category: category.trim()
                    }
                };
                
                setFieldLabels(newFieldLabels);
                localStorage.setItem('field_labels', JSON.stringify(newFieldLabels));
                alert('Alan guncellendi!');
            };

            const addCustomRoom = () => {
                const name = prompt('Yeni mekan adi:');
                if (!name || !name.trim()) return;
                
                // fieldLabels'dan dinamik olarak alan listesi olu≈ütur
                const availableFields = Object.entries(fieldLabels).map(([id, field], index) => ({
                    id,
                    label: field.label,
                    number: index + 1
                }));
                
                // Prompt metnini dinamik olu≈ütur
                let promptText = 'Hangi alanlari eklemek istiyorsunuz?\n\n';
                
                // Alanlarƒ± listele (her satƒ±rda 3 alan)
                availableFields.forEach((field, idx) => {
                    promptText += field.number + '=' + field.label;
                    if ((idx + 1) % 3 === 0) {
                        promptText += '\n';
                    } else {
                        promptText += ', ';
                    }
                });
                
                promptText += '\n\nOrnekler:\n';
                promptText += '- "1,2" = Zemin + Boya\n';
                promptText += '- Virg√ºlle ayƒ±rarak secin\n\n';
                promptText += 'Seciminiz:';
                
                let selectedFields = ['zemin', 'boya', 'foto']; // Varsayƒ±lan
                const selection = prompt(promptText, '1,2');
                
                if (selection) {
                    const nums = selection.split(',').map(n => parseInt(n.trim()));
                    
                    // Numara -> ID mapping
                    selectedFields = nums.map(num => {
                        const found = availableFields.find(f => f.number === num);
                        return found ? found.id : null;
                    }).filter(f => f !== null);
                    
                    if (selectedFields.length === 0) selectedFields = ['zemin', 'boya', 'foto'];
                }
                
                const id = 'custom_' + Date.now();
                const newRoom = { id, name: name.trim(), fields: selectedFields, custom: true };
                const updated = [...customRooms, newRoom];
                setCustomRooms(updated);
                localStorage.setItem('custom_rooms', JSON.stringify(updated));
                setCurrentRoom(id);
                
                // Toplu ekleme se√ßeneƒüi
                const applyChoice = prompt(
                    'Bu mekani nereye eklemek istiyorsunuz?\n\n' +
                    '1 = Sadece bu daire\n' +
                    '2 = Bu projedeki TUM daireler\n' +
                    '3 = TUM projeler, TUM daireler\n\n' +
                    'Seciminiz (1/2/3):',
                    '1'
                );
                
                if (applyChoice === '2') {
                    // Bu projedeki t√ºm dairelere ekle
                    const currentProj = getProject();
                    const confirmMsg = currentProj.name + ' projesindeki ' + currentProj.apartments.length + ' daireye "' + name.trim() + '" mekani eklensin mi?';
                    if (confirm(confirmMsg)) {
                        const updatedApts = currentProj.apartments.map(apt => ({
                            ...apt,
                            wallCount: { ...apt.wallCount, [id]: selectedFields.includes('duvar_kaplama') ? 1 : 0 }
                        }));
                        updateProjects(projects.map(p => p.id === currentPrj ? { ...p, apartments: updatedApts } : p));
                        alert('Eklendi! ' + currentProj.apartments.length + ' daireye "' + name.trim() + '" mekani eklendi.');
                    }
                } else if (applyChoice === '3') {
                    // T√ºm projelerdeki t√ºm dairelere ekle
                    let totalApts = 0;
                    projects.forEach(p => { totalApts += p.apartments.length; });
                    const confirmMsg = 'TUM projelerdeki ' + totalApts + ' daireye "' + name.trim() + '" mekani eklensin mi?';
                    if (confirm(confirmMsg)) {
                        const updatedProjects = projects.map(proj => ({
                            ...proj,
                            apartments: proj.apartments.map(apt => ({
                                ...apt,
                                wallCount: { ...apt.wallCount, [id]: selectedFields.includes('duvar_kaplama') ? 1 : 0 }
                            }))
                        }));
                        setProjects(updatedProjects);
                        localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                        alert('Eklendi! ' + totalApts + ' daireye "' + name.trim() + '" mekani eklendi.');
                    }
                }
                
                alert('Mekan olusturuldu!\nEklenen alanlar:\n' + selectedFields.map(f => fieldNames[f] || f).join('\n'));
            };

            const editRoomName = (roomId) => {
                const room = allRooms.find(r => r.id === roomId);
                if (!room) {
                    alert('Mekan bulunamadi!');
                    return;
                }
                
                const newName = prompt('Yeni mekan adi:', room.name);
                if (newName && newName.trim()) {
                    if (room.custom) {
                        // √ñzel mekan
                        const updated = customRooms.map(r => r.id === roomId ? { ...r, name: newName.trim() } : r);
                        setCustomRooms(updated);
                        localStorage.setItem('custom_rooms', JSON.stringify(updated));
                    } else {
                        // Varsayƒ±lan mekan
                        const updated = baseRooms.map(r => r.id === roomId ? { ...r, name: newName.trim() } : r);
                        setBaseRooms(updated);
                        localStorage.setItem('base_rooms', JSON.stringify(updated));
                    }
                }
            };

            const copyRoom = (roomId) => {
                const room = allRooms.find(r => r.id === roomId);
                if (!room) {
                    alert('Mekan bulunamadi!');
                    return;
                }
                
                const newName = prompt('Yeni mekan adi:', room.name + ' Kopya');
                if (!newName || !newName.trim()) return;
                
                const newId = 'custom_' + Date.now();
                const newRoom = {
                    id: newId,
                    name: newName.trim(),
                    fields: [...room.fields],
                    custom: true
                };
                
                const updated = [...customRooms, newRoom];
                setCustomRooms(updated);
                localStorage.setItem('custom_rooms', JSON.stringify(updated));
                
                // Toplu ekleme se√ßeneƒüi
                const applyChoice = prompt(
                    'Bu mekani nereye eklemek istiyorsunuz?\n\n' +
                    '1 = Sadece bu daire\n' +
                    '2 = Bu projedeki TUM daireler\n' +
                    '3 = TUM projeler, TUM daireler\n\n' +
                    'Seciminiz (1/2/3):',
                    '1'
                );
                
                if (applyChoice === '2') {
                    const currentProj = getProject();
                    if (confirm(currentProj.name + ' projesindeki ' + currentProj.apartments.length + ' daireye "' + newName.trim() + '" mekani eklensin mi?')) {
                        const updatedApts = currentProj.apartments.map(apt => ({
                            ...apt,
                            wallCount: { ...apt.wallCount, [newId]: room.fields.includes('duvar_kaplama') ? 1 : 0 }
                        }));
                        updateProjects(projects.map(p => p.id === currentPrj ? { ...p, apartments: updatedApts } : p));
                        alert('Eklendi! ' + currentProj.apartments.length + ' daireye "' + newName.trim() + '" mekani eklendi.');
                    }
                } else if (applyChoice === '3') {
                    let totalApts = 0;
                    projects.forEach(p => { totalApts += p.apartments.length; });
                    if (confirm('TUM projelerdeki ' + totalApts + ' daireye "' + newName.trim() + '" mekani eklensin mi?')) {
                        const updatedProjects = projects.map(proj => ({
                            ...proj,
                            apartments: proj.apartments.map(apt => ({
                                ...apt,
                                wallCount: { ...apt.wallCount, [newId]: room.fields.includes('duvar_kaplama') ? 1 : 0 }
                            }))
                        }));
                        setProjects(updatedProjects);
                        localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                        alert('Eklendi! ' + totalApts + ' daireye "' + newName.trim() + '" mekani eklendi.');
                    }
                }
                
                setCurrentRoom(newId);
                alert('Mekan kopyalandi!\n\n"' + room.name + '" -> "' + newName.trim() + '"\n\nAlanlar: ' + room.fields.length + ' adet');
            };

            const editRoomFields = (roomId) => {
                const room = allRooms.find(r => r.id === roomId);
                if (!room) {
                    alert('Mekan bulunamadi!');
                    return;
                }
                
                // fieldLabels'dan dinamik olarak alan listesi olu≈ütur
                const availableFields = Object.entries(fieldLabels).map(([id, field], index) => ({
                    id,
                    label: field.label,
                    number: index + 1
                }));
                
                // Mevcut alanlarƒ± g√∂ster
                const currentFieldsText = room.fields.map(f => {
                    const field = fieldLabels[f];
                    return field ? field.label : f;
                }).join(', ');
                
                // Prompt metnini dinamik olu≈ütur
                let promptText = room.name + ' - Mevcut alanlar:\n' + currentFieldsText + '\n\n' +
                    'Yeni alan secimi:\n\n';
                
                // Alanlarƒ± listele (her satƒ±rda 3 alan)
                availableFields.forEach((field, idx) => {
                    promptText += field.number + '=' + field.label;
                    if ((idx + 1) % 3 === 0) {
                        promptText += '\n';
                    } else {
                        promptText += ', ';
                    }
                });
                
                promptText += '\n\nSeciminiz (virg√ºlle ayƒ±rƒ±n):';
                
                // Mevcut alanlarƒ± numara olarak g√∂ster
                const currentFieldNumbers = room.fields.map(f => {
                    const found = availableFields.find(af => af.id === f);
                    return found ? found.number : null;
                }).filter(n => n !== null).join(',');
                
                const selection = prompt(promptText, currentFieldNumbers);
                
                if (selection) {
                    const nums = selection.split(',').map(n => parseInt(n.trim()));
                    
                    // Numara -> ID mapping
                    let newFields = nums.map(num => {
                        const found = availableFields.find(f => f.number === num);
                        return found ? found.id : null;
                    }).filter(f => f !== null);
                    
                    if (newFields.length === 0) newFields = ['zemin', 'boya'];
                    
                    if (room.custom) {
                        // √ñzel mekan - customRooms'da g√ºncelle
                        const updated = customRooms.map(r => r.id === roomId ? { ...r, fields: newFields } : r);
                        setCustomRooms(updated);
                        localStorage.setItem('custom_rooms', JSON.stringify(updated));
                    } else {
                        // Varsayƒ±lan mekan - baseRooms'da g√ºncelle
                        const updated = baseRooms.map(r => r.id === roomId ? { ...r, fields: newFields } : r);
                        setBaseRooms(updated);
                        localStorage.setItem('base_rooms', JSON.stringify(updated));
                    }
                    
                    // G√ºncellenen alanlarƒ± g√∂ster
                    const updatedFieldNames = newFields.map(f => {
                        const field = fieldLabels[f];
                        return field ? field.label : f;
                    }).join('\n');
                    
                    alert('Guncellenen alanlar:\n' + updatedFieldNames);
                }
            };

            const deleteRoom = async (roomId) => {
                const room = allRooms.find(r => r.id === roomId);
                if (!room) {
                    alert('Mekan bulunamadi!');
                    return;
                }
                
                // Eski icon'u sil (eƒüer Firebase Storage URL'i ise)
                const oldIcon = room?.customIcon;
                if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                    await deletePhotoFromStorage(oldIcon);
                    console.log('üóëÔ∏è Mekan silindi, icon da temizlendi');
                }
                
                const deleteChoice = prompt(
                    '"' + room.name + '" mekanini nereden silmek istiyorsunuz?\n\n' +
                    '1 = Sadece bu daire (listeden KALKAR + veriler silinir)\n' +
                    '2 = Bu projedeki TUM daireler (listeden KALKAR)\n' +
                    '3 = TUM projeler, TUM daireler (mekani TAMAMEN sil)\n' +
                    '4 = IPTAL\n\n' +
                    'Seciminiz (1/2/3/4):',
                    '1'
                );
                
                if (deleteChoice === '1') {
                    // Sadece bu daireden tamamen kaldƒ±r (listeden + veriler)
                    console.log('SECENEK 1 - Basladi');
                    console.log('roomId:', roomId);
                    console.log('currentApt:', currentApt);
                    console.log('currentPrj:', currentPrj);
                    
                    if (confirm('Bu daireden "' + room.name + '" mekani TAMAMEN kaldirilacak (listeden de gidecek). Diger daireler etkilenmez. Devam?')) {
                        console.log('Onaylandi, isleme baslaniyor...');
                        const currentProj = getProject();
                        
                        const updatedApts = currentProj.apartments.map(a => {
                            if (a.id === currentApt) {
                                console.log('Daire bulundu, silme yapiliyor:', a.name);
                                
                                // Veriyi sil
                                const newData = { ...a.data };
                                delete newData[roomId];
                                
                                // Duvar sayƒ±sƒ±nƒ± sil
                                const newWallCount = { ...a.wallCount };
                                delete newWallCount[roomId];
                                
                                // Gizli mekanlar listesine ekle
                                const newHiddenRooms = [...(a.hiddenRooms || [])];
                                if (!newHiddenRooms.includes(roomId)) {
                                    newHiddenRooms.push(roomId);
                                }
                                
                                console.log('Yeni data:', newData);
                                console.log('Gizli mekanlar:', newHiddenRooms);
                                
                                return { ...a, data: newData, wallCount: newWallCount, hiddenRooms: newHiddenRooms };
                            }
                            return a;
                        });
                        
                        console.log('updatedApts:', updatedApts);
                        const updatedProjects = projects.map(p => p.id === currentPrj ? { ...p, apartments: updatedApts } : p);
                        console.log('updatedProjects:', updatedProjects);
                        
                        setProjects(updatedProjects);
                        localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                        console.log('State ve localStorage guncellendi');
                        
                        setCurrentRoom('salon');
                        alert('Mekan bu daireden TAMAMEN kaldirildi! Diger daireler etkilenmedi.');
                        console.log('SECENEK 1 - Tamamlandi');
                    } else {
                        console.log('Kullanici iptal etti');
                    }
                } else if (deleteChoice === '2') {
                    // Bu projedeki t√ºm dairelerden tamamen kaldƒ±r
                    const currentProj = getProject();
                    if (confirm(currentProj.name + ' projesindeki ' + currentProj.apartments.length + ' daireden "' + room.name + '" mekani TAMAMEN kaldirilsin mi?')) {
                        const updatedApts = currentProj.apartments.map(apt => {
                            // Veriyi sil
                            const newData = { ...apt.data };
                            delete newData[roomId];
                            
                            // Duvar sayƒ±sƒ±nƒ± sil
                            const newWallCount = { ...apt.wallCount };
                            delete newWallCount[roomId];
                            
                            // Gizli mekanlar listesine ekle
                            const newHiddenRooms = [...(apt.hiddenRooms || [])];
                            if (!newHiddenRooms.includes(roomId)) {
                                newHiddenRooms.push(roomId);
                            }
                            
                            return { ...apt, data: newData, wallCount: newWallCount, hiddenRooms: newHiddenRooms };
                        });
                        const updatedProjects = projects.map(p => p.id === currentPrj ? { ...p, apartments: updatedApts } : p);
                        setProjects(updatedProjects);
                        localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                        setCurrentRoom('salon');
                        alert('Mekan bu projedeki tum dairelerden TAMAMEN kaldirildi!');
                    }
                } else if (deleteChoice === '3') {
                    // T√ºm projelerden tamamen sil
                    let totalApts = 0;
                    projects.forEach(p => { totalApts += p.apartments.length; });
                    if (confirm('TUM projelerdeki ' + totalApts + ' daireden "' + room.name + '" mekani tamamen silinecek. Devam?')) {
                        // √ñnce t√ºm dairelerden verileri temizle
                        const updatedProjects = projects.map(proj => ({
                            ...proj,
                            apartments: proj.apartments.map(apt => {
                                const newData = { ...apt.data };
                                delete newData[roomId];
                                const newWallCount = { ...apt.wallCount };
                                delete newWallCount[roomId];
                                return { ...apt, data: newData, wallCount: newWallCount };
                            })
                        }));
                        setProjects(updatedProjects);
                        localStorage.setItem('projects_data', JSON.stringify(updatedProjects));
                        
                        // Sonra mekanƒ± tamamen sil
                        if (room.custom) {
                            const updated = customRooms.filter(r => r.id !== roomId);
                            setCustomRooms(updated);
                            localStorage.setItem('custom_rooms', JSON.stringify(updated));
                        } else {
                            const updated = baseRooms.filter(r => r.id !== roomId);
                            setBaseRooms(updated);
                            localStorage.setItem('base_rooms', JSON.stringify(updated));
                        }
                        
                        setCurrentRoom('salon');
                        alert('Mekan tamamen silindi! ' + totalApts + ' daireden tum veriler temizlendi.');
                    }
                }
                // 4 veya ba≈üka bir deƒüer = ƒ∞ptal (hi√ßbir ≈üey yapma)
            };

            const updateField = (field, value) => {
                updateApartments(apartments.map(a => {
                    if (a.id === currentApt) {
                        return { ...a, data: { ...a.data, [currentRoom]: { ...a.data[currentRoom], [field]: value } } };
                    }
                    return a;
                }));
            };

            const updateWallCover = (idx, type, val) => {
                const current = getRoomData().duvar_kaplama || {};
                const updated = { ...current, [idx]: { ...current[idx], [type]: val } };
                updateField('duvar_kaplama', updated);
            };

            const addWallCover = () => {
                const apt = getApt();
                const rd = getRoomData();
                const currentWalls = rd.duvar_kaplama || {};
                const currentCount = apt.wallCount && apt.wallCount[currentRoom] ? apt.wallCount[currentRoom] : 1;
                
                // Yeni duvar i√ßin bo≈ü object ekle
                const newWalls = { ...currentWalls };
                newWalls[currentCount] = {}; // Yeni index i√ßin bo≈ü object
                
                // Hem data hem wallCount'u aynƒ± anda g√ºncelle
                updateApartments(apartments.map(a => {
                    if (a.id === currentApt) {
                        const currentRoomData = a.data[currentRoom] || {};
                        return { 
                            ...a, 
                            wallCount: { ...(a.wallCount || {}), [currentRoom]: currentCount + 1 },
                            data: { 
                                ...a.data, 
                                [currentRoom]: { 
                                    ...currentRoomData, 
                                    duvar_kaplama: newWalls 
                                } 
                            }
                        };
                    }
                    return a;
                }));
            };

            const uploadPhoto = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 5000000) { alert('Max 5MB!'); return; }
                
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        // 1. Fotoƒürafƒ± sƒ±kƒ±≈ütƒ±r
                        const compressed = await compressImage(ev.target.result, 1200, 0.7);
                        
                        // 2. Storage'a y√ºkle (kullanƒ±cƒ± giri≈ü yapmƒ±≈üsa)
                        let photoURL = compressed;
                        if (user && storage) {
                            const rd = getRoomData();
                            const photoIndex = Object.keys(rd.foto || {}).length;
                            photoURL = await uploadPhotoToStorage(
                                compressed,
                                user.uid,
                                currentPrj,
                                currentApt,
                                currentRoom,
                                photoIndex
                            );
                        }
                        
                        // 3. URL'yi Firestore'a kaydet
                        const rd = getRoomData();
                        const photos = rd.foto || {};
                        updateField('foto', { ...photos, [Object.keys(photos).length]: photoURL });
                        
                        console.log('‚úÖ Fotoƒüraf y√ºklendi:', photoURL.substring(0, 50) + '...');
                    } catch (error) {
                        console.error('‚ùå Fotoƒüraf y√ºkleme hatasƒ±:', error);
                        alert('Fotoƒüraf y√ºklenemedi!');
                    }
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            const delPhoto = async (idx) => {
                const photos = { ...getRoomData().foto };
                const photoURL = photos[idx];
                
                // Storage'dan sil (eƒüer Storage URL'i ise)
                if (photoURL && photoURL.includes('firebasestorage')) {
                    await deletePhotoFromStorage(photoURL);
                }
                
                delete photos[idx];
                updateField('foto', Object.keys(photos).length > 0 ? photos : undefined);
            };

            // Kategori y√∂netimi fonksiyonlarƒ±
            const addCategory = () => {
                if (!newCategoryName.trim()) {
                    alert('L√ºtfen kategori adƒ± girin!');
                    return;
                }
                
                if (materials[newCategoryName]) {
                    alert('Bu kategori zaten mevcut!');
                    return;
                }
                
                const newMaterials = {
                    ...materials,
                    [newCategoryName]: {} // Bo≈ü object olarak ekle (hiyerar≈üik yapƒ± i√ßin)
                };
                
                setMaterials(newMaterials);
                localStorage.setItem('material_database', JSON.stringify(newMaterials));
                
                setNewCategoryName('');
                alert(`‚úÖ "${newCategoryName}" kategorisi eklendi!`);
            };
            
            const renameCategory = (oldName, newName) => {
                if (!newName.trim()) {
                    alert('L√ºtfen yeni kategori adƒ± girin!');
                    return;
                }
                
                if (oldName === newName) {
                    setEditingCategory(null);
                    return;
                }
                
                if (materials[newName]) {
                    alert('Bu kategori adƒ± zaten kullanƒ±lƒ±yor!');
                    return;
                }
                
                const newMaterials = {};
                Object.keys(materials).forEach(key => {
                    if (key === oldName) {
                        newMaterials[newName] = materials[key];
                    } else {
                        newMaterials[key] = materials[key];
                    }
                });
                
                // fieldLabels'da da kategori adƒ±nƒ± g√ºncelle
                const newFieldLabels = {};
                Object.keys(fieldLabels).forEach(key => {
                    const config = fieldLabels[key];
                    if (config.category === oldName) {
                        newFieldLabels[key] = { ...config, category: newName };
                    } else {
                        newFieldLabels[key] = config;
                    }
                });
                
                setMaterials(newMaterials);
                setFieldLabels(newFieldLabels);
                localStorage.setItem('material_database', JSON.stringify(newMaterials));
                localStorage.setItem('field_labels', JSON.stringify(newFieldLabels));
                setEditingCategory(null);
                alert(`‚úÖ "${oldName}" kategorisi "${newName}" olarak deƒüi≈ütirildi!`);
            };
            
            const deleteCategory = (categoryName) => {
                // Kullanƒ±mda olan kategorileri kontrol et
                const usedInFields = Object.entries(fieldLabels)
                    .filter(([key, config]) => config.category === categoryName)
                    .map(([key, config]) => config.label);
                
                if (usedInFields.length > 0) {
                    const confirmMsg = `‚ö†Ô∏è Bu kategori ≈üu alanlarda kullanƒ±lƒ±yor:\n\n${usedInFields.join(', ')}\n\nYine de silmek istiyor musunuz?\n(Bu alanlardaki kategori se√ßimi sƒ±fƒ±rlanacak)`;
                    if (!confirm(confirmMsg)) {
                        return;
                    }
                    
                    // fieldLabels'dan kategori referanslarƒ±nƒ± kaldƒ±r
                    const newFieldLabels = {};
                    Object.keys(fieldLabels).forEach(key => {
                        const config = fieldLabels[key];
                        if (config.category === categoryName) {
                            newFieldLabels[key] = { ...config, category: '' };
                        } else {
                            newFieldLabels[key] = config;
                        }
                    });
                    setFieldLabels(newFieldLabels);
                    localStorage.setItem('field_labels', JSON.stringify(newFieldLabels));
                }
                
                const newMaterials = {};
                Object.keys(materials).forEach(key => {
                    if (key !== categoryName) {
                        newMaterials[key] = materials[key];
                    }
                });
                
                setMaterials(newMaterials);
                localStorage.setItem('material_database', JSON.stringify(newMaterials));
                alert(`‚úÖ "${categoryName}" kategorisi silindi!`);
            };

            const addMaterial = (cat, name) => {
                const newMat = { ...materials };
                if (Array.isArray(materials[cat])) {
                    newMat[cat] = [...materials[cat], name];
                } else {
                    // Hiyerar≈üik yapƒ± - kullanƒ±lmƒ±yor artƒ±k, UI'dan direkt ekleniyor
                    return;
                }
                setMaterials(newMat);
                localStorage.setItem('material_database', JSON.stringify(newMat));
            };

            const deleteMaterial = (cat, name) => {
                if (confirm('Bu malzemeyi silmek istediginize emin misiniz?\n\nKategori: ' + cat + '\nMalzeme: ' + name)) {
                    const newMat = { ...materials };
                    if (Array.isArray(materials[cat])) {
                        newMat[cat] = materials[cat].filter(m => m !== name);
                    }
                    setMaterials(newMat);
                    localStorage.setItem('material_database', JSON.stringify(newMat));
                }
            };

            // Seramik y√∂netim fonksiyonlarƒ±
            const addCeramicSerie = (serieName) => {
                if (!serieName.trim()) return;
                const newData = { ...ceramicData };
                if (!newData.series.includes(serieName.trim())) {
                    newData.series.push(serieName.trim());
                    setCeramicData(newData);
                    localStorage.setItem('ceramic_data', JSON.stringify(newData));
                }
            };

            const deleteCeramicSerie = (serieName) => {
                if (confirm(`"${serieName}" serisini silmek istediƒüinize emin misiniz?\n\nBu seriye ait t√ºm seramikler de silinecek!`)) {
                    const newData = { ...ceramicData };
                    newData.series = newData.series.filter(s => s !== serieName);
                    newData.items = newData.items.filter(item => item.serie !== serieName);
                    setCeramicData(newData);
                    localStorage.setItem('ceramic_data', JSON.stringify(newData));
                }
            };

            const addCeramicSize = (sizeName) => {
                if (!sizeName.trim()) return;
                const newData = { ...ceramicData };
                if (!newData.sizes.includes(sizeName.trim())) {
                    newData.sizes.push(sizeName.trim());
                    setCeramicData(newData);
                    localStorage.setItem('ceramic_data', JSON.stringify(newData));
                }
            };

            const deleteCeramicSize = (sizeName) => {
                if (confirm(`"${sizeName}" boyutunu silmek istediƒüinize emin misiniz?\n\nBu boyuttaki t√ºm seramikler de silinecek!`)) {
                    const newData = { ...ceramicData };
                    newData.sizes = newData.sizes.filter(s => s !== sizeName);
                    newData.items = newData.items.filter(item => item.size !== sizeName);
                    setCeramicData(newData);
                    localStorage.setItem('ceramic_data', JSON.stringify(newData));
                }
            };

            const addCeramicItem = (serie, name, size) => {
                if (!serie || !name.trim() || !size) {
                    alert('‚ö†Ô∏è L√ºtfen t√ºm alanlarƒ± doldurun!');
                    return;
                }
                
                const newData = { ...ceramicData };
                const fullName = `${serie} - ${name.trim()} (${size})`;
                
                // Aynƒ± seramik var mƒ± kontrol et
                const exists = newData.items.some(item => 
                    item.serie === serie && item.name === name.trim() && item.size === size
                );
                
                if (exists) {
                    alert('‚ö†Ô∏è Bu seramik zaten mevcut!');
                    return;
                }
                
                newData.items.push({
                    serie: serie,
                    name: name.trim(),
                    size: size,
                    fullName: fullName
                });
                
                setCeramicData(newData);
                localStorage.setItem('ceramic_data', JSON.stringify(newData));
                return true;
            };

            const deleteCeramicItem = (item) => {
                if (confirm(`"${item.fullName}" seramiƒüini silmek istediƒüinize emin misiniz?`)) {
                    const newData = { ...ceramicData };
                    newData.items = newData.items.filter(i => 
                        !(i.serie === item.serie && i.name === item.name && i.size === item.size)
                    );
                    setCeramicData(newData);
                    localStorage.setItem('ceramic_data', JSON.stringify(newData));
                }
            };

            const updateCeramicItem = (oldItem, newName) => {
                const newData = { ...ceramicData };
                const itemIndex = newData.items.findIndex(i => 
                    i.serie === oldItem.serie && i.name === oldItem.name && i.size === oldItem.size
                );
                
                if (itemIndex !== -1) {
                    newData.items[itemIndex].name = newName.trim();
                    newData.items[itemIndex].fullName = `${oldItem.serie} - ${newName.trim()} (${oldItem.size})`;
                    setCeramicData(newData);
                    localStorage.setItem('ceramic_data', JSON.stringify(newData));
                }
            };

            // Sekme sƒ±rasƒ±nƒ± deƒüi≈ütir (drag & drop)
            const reorderTabs = (fromIndex, toIndex) => {
                const categories = Object.keys(materials);
                const [movedCat] = categories.splice(fromIndex, 1);
                categories.splice(toIndex, 0, movedCat);
                
                const newMat = {};
                categories.forEach(cat => {
                    newMat[cat] = materials[cat];
                });
                
                setMaterials(newMat);
                localStorage.setItem('material_database', JSON.stringify(newMat));
            };

            // Icon K√ºt√ºphanesi
            const ROOM_ICONS = {
                // Temel Ev ƒ∞konlarƒ± (40 adet)
                'home': 'üè†', 'building': 'üè¢', 'apartment': 'üèòÔ∏è', 'office': 'üè¢',
                'kitchen': 'üç≥', 'bed': 'üõèÔ∏è', 'bath': 'üõÅ', 'toilet': 'üöΩ', 'shower': 'üöø',
                'door': 'üö™', 'window': 'ü™ü', 'sofa': 'üõãÔ∏è', 'chair': 'ü™ë', 'wardrobe': 'üóÑÔ∏è',
                'brick': 'üß±', 'wall': 'üß±', 'roof': 'üè†', 'floor': '‚¨õ', 'tile': '‚¨ú',
                'hammer': 'üî®', 'wrench': 'üîß', 'screwdriver': 'ü™õ', 'saw': 'ü™ö', 'drill': '‚öôÔ∏è',
                'paint': 'üé®', 'brush': 'üñåÔ∏è', 'roller': 'üñåÔ∏è', 'bucket': 'ü™£',
                'light': 'üí°', 'lamp': 'üí°', 'chandelier': 'üí°', 'switch': 'üí°',
                'pipe': 'üö∞', 'faucet': 'üö∞', 'sink': 'üö∞', 'radiator': 'üî•',
                'box': 'üì¶', 'ruler': 'üìè', 'level': 'üìê', 'measure': 'üìè'
            };

            // Icon se√ßme fonksiyonu
            const selectIconForRoom = (roomId) => {
                setSelectedRoomForIcon(roomId);
                setShowIconPicker(true);
            };

            const applyIconToRoom = async (iconKey) => {
                // Eski icon'u sil (eƒüer Firebase Storage URL'i ise)
                if (selectedFieldForIcon) {
                    const oldIcon = fieldLabels[selectedFieldForIcon]?.icon;
                    if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                        await deletePhotoFromStorage(oldIcon);
                        console.log('üóëÔ∏è Eski field icon silindi (hazƒ±r icon se√ßimi)');
                    }
                } else if (selectedRoomForIcon) {
                    const room = allRooms.find(r => r.id === selectedRoomForIcon);
                    const oldIcon = room?.customIcon;
                    if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                        await deletePhotoFromStorage(oldIcon);
                        console.log('üóëÔ∏è Eski room icon silindi (hazƒ±r icon se√ßimi)');
                    }
                }
                
                // Eƒüer alan i√ßin icon se√ßiyorsak
                if (selectedFieldForIcon) {
                    const updated = {
                        ...fieldLabels,
                        [selectedFieldForIcon]: {
                            ...fieldLabels[selectedFieldForIcon],
                            icon: ROOM_ICONS[iconKey]
                        }
                    };
                    setFieldLabels(updated);
                    localStorage.setItem('field_labels', JSON.stringify(updated));
                    setShowIconPicker(false);
                    setSelectedFieldForIcon(null);
                    return;
                }
                
                // Mekan i√ßin icon se√ßimi
                if (!selectedRoomForIcon) return;
                
                const room = allRooms.find(r => r.id === selectedRoomForIcon);
                if (!room) return;
                
                if (room.custom) {
                    const updated = customRooms.map(r => 
                        r.id === selectedRoomForIcon ? { ...r, icon: iconKey } : r
                    );
                    setCustomRooms(updated);
                    localStorage.setItem('custom_rooms', JSON.stringify(updated));
                } else {
                    const updated = baseRooms.map(r => 
                        r.id === selectedRoomForIcon ? { ...r, icon: iconKey } : r
                    );
                    setBaseRooms(updated);
                    localStorage.setItem('base_rooms', JSON.stringify(updated));
                    
                    // Eƒüer daire bazlƒ± customRooms varsa onu da g√ºncelle
                    const currentApt = getApt();
                    if (currentApt && currentApt.customRooms && currentApt.customRooms.length > 0) {
                        const updatedAptRooms = currentApt.customRooms.map(r =>
                            r.id === selectedRoomForIcon ? { ...r, icon: iconKey } : r
                        );
                        const updatedApt = { ...currentApt, customRooms: updatedAptRooms };
                        const currentProj = getProject();
                        const updatedApts = currentProj.apartments.map(apt =>
                            apt.id === currentApt.id ? updatedApt : apt
                        );
                        updateProjects(projects.map(p =>
                            p.id === currentPrj ? { ...p, apartments: updatedApts } : p
                        ));
                    }
                }
                
                setShowIconPicker(false);
                setSelectedRoomForIcon(null);
            };

            // Mekan ikonlarƒ± - √ñnce √∂zel icon, sonra otomatik se√ßim
            const getRoomIcon = (room) => {
                // Eƒüer mekan bir nesne deƒüilse (eski kullanƒ±m), onu objeye √ßevir
                const roomObj = typeof room === 'string' ? { name: room } : room;
                
                // 1. √ñnce kullanƒ±cƒ±nƒ±n kendi eklediƒüi icon'u kontrol et
                if (roomObj.customIcon) {
                    // Eƒüer resim URL'i ise (base64 veya Firebase Storage)
                    if (roomObj.customIcon.startsWith('data:image') || roomObj.customIcon.startsWith('http')) {
                        return <img src={roomObj.customIcon} className="w-12 h-12 object-contain" alt="icon" />;
                    }
                    // Emoji ise
                    return <span className="text-4xl">{roomObj.customIcon}</span>;
                }
                
                // 2. Eƒüer hazƒ±r iconlardan se√ßilmi≈üse onu g√∂ster
                if (roomObj.icon && ROOM_ICONS[roomObj.icon]) {
                    return <span className="text-4xl">{ROOM_ICONS[roomObj.icon]}</span>;
                }
                
                // 3. Otomatik icon se√ßimi
                const name = roomObj.name ? roomObj.name.toLowerCase() : '';
                
                if (name.includes('salon') || name.includes('oturma')) return <span className="text-4xl">üè†</span>;
                if (name.includes('mutfak') || name.includes('kitchen')) return <span className="text-4xl">üç≥</span>;
                if (name.includes('yatak') || name.includes('oda') || name.includes('bedroom') || name.includes('ebeveyn') || name.includes('√ßocuk')) return <span className="text-4xl">üõèÔ∏è</span>;
                if (name.includes('banyo') || name.includes('wc') || name.includes('tuvalet')) return <span className="text-4xl">üõÅ</span>;
                if (name.includes('hol') || name.includes('antre') || name.includes('koridor') || name.includes('giri≈ü')) return <span className="text-4xl">üö™</span>;
                if (name.includes('balkon') || name.includes('teras')) return <span className="text-4xl">üè†</span>;
                if (name.includes('√ßama≈üƒ±r') || name.includes('kiler') || name.includes('depo')) return <span className="text-4xl">üì¶</span>;
                
                // Default
                return <span className="text-4xl">üìê</span>;
            };

            // Icon K√ºt√ºphanesi Fonksiyonlarƒ±
            const addIconToLibrary = async (iconData, iconName) => {
                const newIcon = {
                    id: Date.now(),
                    name: iconName || 'Icon ' + (iconLibrary.length + 1),
                    icon: iconData,
                    isDefault: false,
                    createdAt: new Date().toISOString()
                };
                
                const updatedLibrary = [...iconLibrary, newIcon];
                setIconLibrary(updatedLibrary);
                localStorage.setItem('icon_library', JSON.stringify(updatedLibrary));
                return newIcon;
            };

            const toggleIconDefault = (iconId) => {
                const updatedLibrary = iconLibrary.map(icon => {
                    if (icon.id === iconId) {
                        return { ...icon, isDefault: !icon.isDefault };
                    }
                    return icon;
                });
                setIconLibrary(updatedLibrary);
                localStorage.setItem('icon_library', JSON.stringify(updatedLibrary));
            };

            const deleteIconFromLibrary = async (iconId) => {
                const icon = iconLibrary.find(i => i.id === iconId);
                if (!icon) return;
                
                // Eƒüer Firebase Storage URL'i ise sil
                if (icon.icon && icon.icon.startsWith('http') && icon.icon.includes('firebasestorage')) {
                    await deletePhotoFromStorage(icon.icon);
                }
                
                const updatedLibrary = iconLibrary.filter(i => i.id !== iconId);
                setIconLibrary(updatedLibrary);
                localStorage.setItem('icon_library', JSON.stringify(updatedLibrary));
            };

            const applyIconFromLibrary = async (iconData) => {
                // Eski icon'u sil (eƒüer Firebase Storage URL'i ise)
                if (selectedFieldForIcon) {
                    const oldIcon = fieldLabels[selectedFieldForIcon]?.icon;
                    if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                        await deletePhotoFromStorage(oldIcon);
                        console.log('üóëÔ∏è Eski field icon silindi (k√ºt√ºphaneden icon se√ßimi)');
                    }
                } else if (selectedRoomForIcon) {
                    const room = allRooms.find(r => r.id === selectedRoomForIcon);
                    const oldIcon = room?.customIcon;
                    if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                        await deletePhotoFromStorage(oldIcon);
                        console.log('üóëÔ∏è Eski room icon silindi (k√ºt√ºphaneden icon se√ßimi)');
                    }
                }
                
                // Eƒüer alan i√ßin icon se√ßiyorsak
                if (selectedFieldForIcon) {
                    const updated = {
                        ...fieldLabels,
                        [selectedFieldForIcon]: {
                            ...fieldLabels[selectedFieldForIcon],
                            icon: iconData
                        }
                    };
                    setFieldLabels(updated);
                    localStorage.setItem('field_labels', JSON.stringify(updated));
                    setShowIconPicker(false);
                    setSelectedFieldForIcon(null);
                    return;
                }
                
                // Mekan i√ßin icon se√ßimi
                if (!selectedRoomForIcon) return;
                
                const room = allRooms.find(r => r.id === selectedRoomForIcon);
                if (!room) return;
                
                if (room.custom) {
                    const updated = customRooms.map(r => 
                        r.id === selectedRoomForIcon ? { ...r, customIcon: iconData } : r
                    );
                    setCustomRooms(updated);
                    localStorage.setItem('custom_rooms', JSON.stringify(updated));
                } else {
                    const updated = baseRooms.map(r => 
                        r.id === selectedRoomForIcon ? { ...r, customIcon: iconData } : r
                    );
                    setBaseRooms(updated);
                    localStorage.setItem('base_rooms', JSON.stringify(updated));
                }
                
                setShowIconPicker(false);
                setSelectedRoomForIcon(null);
            };

            // Toplu Malzeme Atama Fonksiyonu
            const applyBulkMaterials = () => {
                // Se√ßilen alanlarƒ± kontrol et
                const selectedFields = Object.keys(bulkMaterialFields).filter(f => bulkMaterialFields[f]);
                if (selectedFields.length === 0) {
                    alert('‚ö†Ô∏è L√ºtfen en az bir alan se√ßin!');
                    return;
                }
                
                // Her alan i√ßin malzeme se√ßilmi≈ü mi kontrol et
                const missingMaterials = selectedFields.filter(field => {
                    const selection = bulkMaterialSelections[field];
                    return !selection || !selection.subgroup || !selection.malzeme;
                });
                
                if (missingMaterials.length > 0) {
                    alert('‚ö†Ô∏è Se√ßilen t√ºm alanlar i√ßin malzeme se√ßmelisiniz!\n\nEksik alanlar:\n' + 
                        missingMaterials.map(f => fieldLabels[f]?.label || f).join('\n'));
                    return;
                }
                
                // Hedef daireleri belirle
                let targetApts = [];
                if (bulkTargetApartments === 'all') {
                    targetApts = apartments;
                } else {
                    targetApts = apartments.filter(apt => bulkSelectedApartments.includes(apt.id));
                }
                
                if (targetApts.length === 0) {
                    alert('‚ö†Ô∏è L√ºtfen en az bir daire se√ßin!');
                    return;
                }
                
                // Hedef mekan tiplerini belirle
                let shouldApplyToRoom = (roomName) => {
                    if (bulkTargetRoomTypes === 'all') return true;
                    
                    const roomLower = roomName.toLowerCase();
                    return bulkSelectedRoomTypes.some(type => {
                        const typeLower = type.toLowerCase();
                        return roomLower.includes(typeLower);
                    });
                };
                
                // Onay mesajƒ±
                const fieldNames = selectedFields.map(f => fieldLabels[f]?.label || f).join(', ');
                const roomTypeText = bulkTargetRoomTypes === 'all' 
                    ? 'T√úM MEKANLARA' 
                    : bulkSelectedRoomTypes.join(', ') + ' mekanlarƒ±na';
                
                if (!confirm(
                    `üìã Toplu Malzeme Atama\n\n` +
                    `üé® Alanlar: ${fieldNames}\n` +
                    `üè† Daireler: ${targetApts.length} adet\n` +
                    `üìç Mekanlar: ${roomTypeText}\n\n` +
                    `Bu i≈ülem mevcut malzemelerin √úZERƒ∞NE yazacak!\n` +
                    `Devam etmek istediƒüinize emin misiniz?`
                )) {
                    return;
                }
                
                // Malzemeleri uygula
                let updatedCount = 0;
                const currentProj = getProject();
                const updatedApartments = currentProj.apartments.map(apt => {
                    // Bu daire hedef deƒüilse atla
                    if (!targetApts.find(t => t.id === apt.id)) return apt;
                    
                    const updatedData = { ...apt.data };
                    
                    // Her mekan i√ßin
                    Object.keys(updatedData).forEach(roomId => {
                        const room = allRooms.find(r => r.id === roomId);
                        if (!room) return;
                        
                        // Bu mekan hedef tipte mi?
                        if (!shouldApplyToRoom(room.name)) return;
                        
                        // Se√ßilen alanlarƒ± g√ºncelle
                        selectedFields.forEach(field => {
                            // Bu mekanda bu alan var mƒ±?
                            const roomFields = room.fields || [];
                            if (!roomFields.includes(field)) return;
                            
                            const materialSelection = bulkMaterialSelections[field];
                            
                            if (field === 'duvar_kaplama') {
                                // Duvar kaplama √∂zel - her duvara aynƒ± malzemeyi ata
                                const wallCount = apt.wallCount?.[roomId] || 4;
                                const walls = {};
                                for (let i = 0; i < wallCount; i++) {
                                    walls[i] = {
                                        subgroup: materialSelection.subgroup,
                                        malzeme: materialSelection.malzeme,
                                        miktar: '' // Miktar bo≈ü
                                    };
                                }
                                updatedData[roomId][field] = walls;
                            } else {
                                // Normal alan
                                if (!updatedData[roomId][field]) {
                                    updatedData[roomId][field] = {};
                                }
                                updatedData[roomId][field].subgroup = materialSelection.subgroup;
                                updatedData[roomId][field].malzeme = materialSelection.malzeme;
                                // Miktar deƒüi≈ütirilmesin
                            }
                            
                            updatedCount++;
                        });
                    });
                    
                    return { ...apt, data: updatedData };
                });
                
                // Projeyi g√ºncelle
                updateProjects(projects.map(p => 
                    p.id === currentPrj ? { ...p, apartments: updatedApartments } : p
                ));
                
                // Modal'ƒ± kapat ve sƒ±fƒ±rla
                setShowBulkMaterialModal(false);
                setBulkMaterialFields({});
                setBulkMaterialSelections({});
                setBulkTargetApartments('all');
                setBulkSelectedApartments([]);
                setBulkTargetRoomTypes('all');
                setBulkSelectedRoomTypes([]);
                
                alert(`‚úÖ Toplu malzeme atama tamamlandƒ±!\n\n${updatedCount} alan g√ºncellendi.`);
            };

            // Toplu Miktar Atama Fonksiyonu
            const applyBulkAmounts = () => {
                // Se√ßilen alanlarƒ± kontrol et
                const selectedFields = Object.keys(bulkAmountFields).filter(f => bulkAmountFields[f]);
                if (selectedFields.length === 0) {
                    alert('‚ö†Ô∏è L√ºtfen en az bir alan se√ßin!');
                    return;
                }
                
                // Her alan i√ßin miktar girilmi≈ü mi kontrol et
                const missingAmounts = selectedFields.filter(field => {
                    const amount = bulkAmountValues[field];
                    return !amount || amount.trim() === '';
                });
                
                if (missingAmounts.length > 0) {
                    alert('‚ö†Ô∏è Se√ßilen t√ºm alanlar i√ßin miktar girmelisiniz!\n\nEksik alanlar:\n' + 
                        missingAmounts.map(f => fieldLabels[f]?.label || f).join('\n'));
                    return;
                }
                
                // Hedef daireleri belirle
                let targetApts = [];
                if (bulkAmountTargetApartments === 'all') {
                    targetApts = apartments;
                } else {
                    targetApts = apartments.filter(apt => bulkAmountSelectedApartments.includes(apt.id));
                }
                
                if (targetApts.length === 0) {
                    alert('‚ö†Ô∏è L√ºtfen en az bir daire se√ßin!');
                    return;
                }
                
                // Hedef mekan tiplerini belirle
                let shouldApplyToRoom = (roomName) => {
                    if (bulkAmountTargetRoomTypes === 'all') return true;
                    
                    const roomLower = roomName.toLowerCase();
                    return bulkAmountSelectedRoomTypes.some(type => {
                        const typeLower = type.toLowerCase();
                        return roomLower.includes(typeLower);
                    });
                };
                
                // Onay mesajƒ±
                const fieldNames = selectedFields.map(f => fieldLabels[f]?.label || f).join(', ');
                const roomTypeText = bulkAmountTargetRoomTypes === 'all' 
                    ? 'T√úM MEKANLARA' 
                    : bulkAmountSelectedRoomTypes.join(', ') + ' mekanlarƒ±na';
                
                if (!confirm(
                    `üìä Toplu Miktar Atama\n\n` +
                    `üé® Alanlar: ${fieldNames}\n` +
                    `üè† Daireler: ${targetApts.length} adet\n` +
                    `üìç Mekanlar: ${roomTypeText}\n\n` +
                    `Bu i≈ülem mevcut miktarlarƒ±n √úZERƒ∞NE yazacak!\n` +
                    `Devam etmek istediƒüinize emin misiniz?`
                )) {
                    return;
                }
                
                // Miktarlarƒ± uygula
                let updatedCount = 0;
                const currentProj = getProject();
                const updatedApartments = currentProj.apartments.map(apt => {
                    // Bu daire hedef deƒüilse atla
                    if (!targetApts.find(t => t.id === apt.id)) return apt;
                    
                    const updatedData = { ...apt.data };
                    
                    // Her mekan i√ßin
                    Object.keys(updatedData).forEach(roomId => {
                        const room = allRooms.find(r => r.id === roomId);
                        if (!room) return;
                        
                        // Bu mekan hedef tipte mi?
                        if (!shouldApplyToRoom(room.name)) return;
                        
                        // Se√ßilen alanlarƒ± g√ºncelle
                        selectedFields.forEach(field => {
                            // Bu mekanda bu alan var mƒ±?
                            const roomFields = room.fields || [];
                            if (!roomFields.includes(field)) return;
                            
                            const amountValue = bulkAmountValues[field];
                            
                            if (field === 'duvar_kaplama') {
                                // Duvar kaplama √∂zel - her duvara aynƒ± miktarƒ± ata
                                const wallCount = apt.wallCount?.[roomId] || 4;
                                if (!updatedData[roomId][field]) {
                                    updatedData[roomId][field] = {};
                                }
                                for (let i = 0; i < wallCount; i++) {
                                    if (!updatedData[roomId][field][i]) {
                                        updatedData[roomId][field][i] = {};
                                    }
                                    updatedData[roomId][field][i].miktar = amountValue;
                                }
                            } else {
                                // Normal alan
                                if (!updatedData[roomId][field]) {
                                    updatedData[roomId][field] = {};
                                }
                                updatedData[roomId][field].miktar = amountValue;
                                // Malzeme deƒüi≈ütirilmesin
                            }
                            
                            updatedCount++;
                        });
                    });
                    
                    return { ...apt, data: updatedData };
                });
                
                // Projeyi g√ºncelle
                updateProjects(projects.map(p => 
                    p.id === currentPrj ? { ...p, apartments: updatedApartments } : p
                ));
                
                // Modal'ƒ± kapat ve sƒ±fƒ±rla
                setShowBulkAmountModal(false);
                setBulkAmountFields({});
                setBulkAmountValues({});
                setBulkAmountTargetApartments('all');
                setBulkAmountSelectedApartments([]);
                setBulkAmountTargetRoomTypes('all');
                setBulkAmountSelectedRoomTypes([]);
                
                alert(`‚úÖ Toplu miktar atama tamamlandƒ±!\n\n${updatedCount} alan g√ºncellendi.`);
            };


            // Tema deƒüi≈ütirme
            const toggleTheme = async () => {
                const newTheme = theme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Firebase'e kaydet (kullanƒ±cƒ± giri≈ü yapmƒ±≈üsa)
                if (user && firebaseEnabled && db) {
                    try {
                        await db.collection('userSettings').doc(user.uid).set({
                            theme: newTheme,
                            updatedAt: new Date().toISOString()
                        }, { merge: true });
                        console.log('‚úÖ Tema tercihi Firebase\'e kaydedildi:', newTheme);
                    } catch (error) {
                        console.error('‚ùå Tema Firebase\'e kaydedilemedi:', error);
                    }
                }
                
                // Dropdown option'larƒ± i√ßin global CSS g√ºncelle
                const themeStyle = document.getElementById('theme-style');
                if (themeStyle) {
                    if (newTheme === 'dark') {
                        themeStyle.innerHTML = `
                            select option {
                                background-color: #374151 !important;
                                color: #f3f4f6 !important;
                            }
                        `;
                    } else {
                        themeStyle.innerHTML = `
                            select option {
                                background-color: white !important;
                                color: #111827 !important;
                            }
                        `;
                    }
                }
            };

            // Daire kopyalama fonksiyonu
            const copyApartment = () => {
                const sourceApt = getApt();
                const count = parseInt(copyCount) || 1;
                
                if (count < 1 || count > 50) {
                    alert('L√ºtfen 1-50 arasƒ± bir sayƒ± girin!');
                    return;
                }
                
                // Kaynak daire isminden sayƒ±yƒ± √ßƒ±kar
                const baseName = sourceApt.name.replace(/\s*\d+\s*$/, '').trim() || 'Daire';
                
                // Mevcut en b√ºy√ºk numarayƒ± bul
                const existingNumbers = apartments
                    .map(a => {
                        const match = a.name.match(new RegExp(baseName + '\\s*(\\d+)'));
                        return match ? parseInt(match[1]) : 0;
                    })
                    .filter(n => n > 0);
                
                const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
                
                // Numaralarƒ± olu≈ütur
                let numbers = [];
                
                // Ba≈ülangƒ±√ß numarasƒ±nƒ± belirle
                let baseNumber = maxNumber;
                if (startNumber && startNumber.trim() !== '') {
                    const parsedStart = parseInt(startNumber);
                    if (!isNaN(parsedStart) && parsedStart > 0) {
                        baseNumber = parsedStart - 1; // D√∂ng√º +1 ile ba≈ülayacaƒüƒ± i√ßin -1
                    }
                }
                
                if (numberingMode === 'sequential') {
                    // Ardƒ±≈üƒ±k: 1, 2, 3, 4, 5...
                    for (let i = 0; i < count; i++) {
                        numbers.push(baseNumber + i + 1);
                    }
                } else if (numberingMode === 'odd') {
                    // Tek sayƒ±lar: 1, 3, 5, 7, 9...
                    let currentNumber = baseNumber % 2 === 0 ? baseNumber + 1 : baseNumber + 2;
                    for (let i = 0; i < count; i++) {
                        numbers.push(currentNumber);
                        currentNumber += 2;
                    }
                } else if (numberingMode === 'even') {
                    // √áift sayƒ±lar: 2, 4, 6, 8, 10...
                    let currentNumber = baseNumber % 2 === 1 ? baseNumber + 1 : baseNumber + 2;
                    for (let i = 0; i < count; i++) {
                        numbers.push(currentNumber);
                        currentNumber += 2;
                    }
                } else if (numberingMode === 'custom') {
                    // √ñzel numaralar
                    const customNumArray = customNumbers.split(',')
                        .map(n => parseInt(n.trim()))
                        .filter(n => !isNaN(n) && n > 0);
                    
                    if (customNumArray.length === 0) {
                        alert('L√ºtfen ge√ßerli numaralar girin! (√ñrnek: 101, 102, 201, 202)');
                        return;
                    }
                    
                    numbers = customNumArray;
                }
                
                // Mevcut numaralarla √ßakƒ±≈üma kontrol√º
                const conflicts = numbers.filter(num => existingNumbers.includes(num));
                if (conflicts.length > 0) {
                    if (!confirm(`‚ö†Ô∏è A≈üaƒüƒ±daki numaralar zaten mevcut:\n${conflicts.join(', ')}\n\nYine de devam edilsin mi? (Var olan daireler √ºzerine yazƒ±lacak!)`)) {
                        return;
                    }
                }
                
                const newApartments = [];
                let nextId = Math.max(...apartments.map(a => a.id), 0) + 1;
                
                // Belirlenen sayƒ±da daire olu≈ütur
                for (let i = 0; i < numbers.length; i++) {
                    const newNumber = numbers[i];
                    const newName = `${baseName} ${newNumber}`;
                    
                    const newData = {};
                    const newWallCount = {};
                    const newHiddenRooms = [...(sourceApt.hiddenRooms || [])];
                    
                    // Se√ßili mekanlarƒ± kopyala
                    if (copyOptions.rooms) {
                        Object.keys(sourceApt.data).forEach(roomId => {
                            const roomData = sourceApt.data[roomId];
                            newData[roomId] = {};
                            
                            Object.keys(roomData).forEach(field => {
                                if (field === 'foto') {
                                    // Fotoƒüraflarƒ± sadece se√ßiliyse kopyala
                                    if (copyOptions.photos) {
                                        newData[roomId][field] = { ...roomData[field] };
                                    }
                                } else if (field === 'duvar_kaplama') {
                                    // Duvar kaplama - hem array hem obje olabilir
                                    if (Array.isArray(roomData[field])) {
                                        // Array formatƒ± (yeni)
                                        const copiedWalls = roomData[field].map(wall => {
                                            const newWall = {};
                                            if (copyOptions.materials) {
                                                newWall.subgroup = wall.subgroup || '';
                                                newWall.malzeme = wall.malzeme || '';
                                            }
                                            if (copyOptions.amounts) {
                                                newWall.miktar = wall.miktar || '';
                                            }
                                            return newWall;
                                        });
                                        // Sadece dolu duvarlarƒ± kopyala
                                        if (copiedWalls.some(w => w.subgroup || w.malzeme || w.miktar)) {
                                            newData[roomId][field] = copiedWalls;
                                        }
                                    } else if (typeof roomData[field] === 'object') {
                                        // Obje formatƒ± (eski) - her key bir duvar indexi
                                        const copiedWalls = {};
                                        Object.keys(roomData[field]).forEach(wallIdx => {
                                            const wall = roomData[field][wallIdx];
                                            if (wall && typeof wall === 'object') {
                                                const newWall = {};
                                                if (copyOptions.materials) {
                                                    newWall.subgroup = wall.subgroup || '';
                                                    newWall.malzeme = wall.malzeme || '';
                                                }
                                                if (copyOptions.amounts) {
                                                    newWall.miktar = wall.miktar || '';
                                                }
                                                // Sadece dolu duvarlarƒ± ekle
                                                if (newWall.subgroup || newWall.malzeme || newWall.miktar) {
                                                    copiedWalls[wallIdx] = newWall;
                                                }
                                            }
                                        });
                                        if (Object.keys(copiedWalls).length > 0) {
                                            newData[roomId][field] = copiedWalls;
                                        }
                                    }
                                } else if (roomData[field] && typeof roomData[field] === 'object') {
                                    // Diƒüer malzeme alanlarƒ±
                                    const newField = {};
                                    if (copyOptions.materials) {
                                        newField.subgroup = roomData[field].subgroup || '';
                                        newField.malzeme = roomData[field].malzeme || '';
                                    }
                                    if (copyOptions.amounts) {
                                        newField.miktar = roomData[field].miktar || '';
                                    }
                                    // Sadece dolu alanlarƒ± ekle
                                    if (newField.subgroup || newField.malzeme || newField.miktar) {
                                        newData[roomId][field] = newField;
                                    }
                                }
                            });
                        });
                        
                        // Duvar sayƒ±larƒ±nƒ± her zaman kopyala (mekanlar se√ßiliyse)
                        if (sourceApt.wallCount) {
                            Object.assign(newWallCount, sourceApt.wallCount);
                        }
                    }
                    
                    const newApartment = {
                        id: nextId++,
                        name: newName,
                        data: newData,
                        wallCount: newWallCount,
                        hiddenRooms: newHiddenRooms
                    };
                    
                    newApartments.push(newApartment);
                }
                
                updateApartments([...apartments, ...newApartments]);
                setCurrentApt(newApartments[0].id); // ƒ∞lk olu≈üturulan daireye ge√ß
                setShowCopyModal(false);
                
                // Kopyalama se√ßeneklerini sƒ±fƒ±rla
                setCopyOptions({
                    rooms: true,
                    materials: true,
                    amounts: true,
                    photos: false
                });
                setCopyCount(1);
                setNumberingMode('sequential');
                setCustomNumbers('');
                setStartNumber('');
                
                alert(`‚úÖ ${newApartments.length} adet daire ba≈üarƒ±yla kopyalandƒ±!\n\n${newApartments.map(a => a.name).join('\n')}`);
            };
            
            // Toplu daire silme
            const bulkDeleteApartments = () => {
                if (selectedApartmentsForDelete.length === 0) {
                    alert('L√ºtfen silmek istediƒüiniz daireleri se√ßin!');
                    return;
                }
                
                const selectedNames = apartments
                    .filter(a => selectedApartmentsForDelete.includes(a.id))
                    .map(a => a.name)
                    .join('\n');
                
                if (!confirm(`${selectedApartmentsForDelete.length} adet daireyi silmek istediƒüinize emin misiniz?\n\n${selectedNames}\n\nBu i≈ülem GERƒ∞ ALINAMAZ!`)) {
                    return;
                }
                
                const remaining = apartments.filter(a => !selectedApartmentsForDelete.includes(a.id));
                
                if (remaining.length === 0) {
                    alert('En az 1 daire kalmalƒ±dƒ±r!');
                    return;
                }
                
                updateApartments(remaining);
                setCurrentApt(remaining[0].id);
                setShowBulkDeleteModal(false);
                setSelectedApartmentsForDelete([]);
                alert(`‚úÖ ${selectedApartmentsForDelete.length} adet daire ba≈üarƒ±yla silindi!`);
            };
            
            // T√ºm daireleri se√ß/bƒ±rak
            const toggleAllApartments = () => {
                if (selectedApartmentsForDelete.length === apartments.length) {
                    setSelectedApartmentsForDelete([]);
                } else {
                    setSelectedApartmentsForDelete(apartments.map(a => a.id));
                }
            };
            
            // Daire se√ßimi toggle
            const toggleApartmentSelection = (aptId) => {
                if (selectedApartmentsForDelete.includes(aptId)) {
                    setSelectedApartmentsForDelete(selectedApartmentsForDelete.filter(id => id !== aptId));
                } else {
                    setSelectedApartmentsForDelete([...selectedApartmentsForDelete, aptId]);
                }
            };

            // Ba≈üka daireden miktar kopyalama
            const copyAmountsFromApartment = () => {
                if (!sourceAptForAmounts) return;
                
                const sourceApt = apartments.find(a => a.id === sourceAptForAmounts);
                const targetApt = getApt();
                
                if (!sourceApt) return;
                
                const updatedData = { ...targetApt.data };
                
                // Her mekan i√ßin
                Object.keys(sourceApt.data).forEach(roomId => {
                    if (!updatedData[roomId]) return; // Hedef dairede bu mekan yoksa atla
                    
                    const sourceRoomData = sourceApt.data[roomId];
                    const targetRoomData = updatedData[roomId];
                    
                    // Her alan i√ßin
                    Object.keys(sourceRoomData).forEach(field => {
                        if (field === 'foto') return; // Fotoƒüraflarƒ± atla
                        
                        // Alan se√ßilmemi≈üse atla
                        if (!selectedFieldsForCopy[field]) return;
                        
                        if (field === 'duvar_kaplama') {
                            // Duvar kaplama - T√úM duvarlarƒ± kopyala
                            if (typeof sourceRoomData[field] === 'object' && sourceRoomData[field] !== null) {
                                // Hedefte duvar_kaplama objesi yoksa olu≈ütur
                                if (!targetRoomData[field] || typeof targetRoomData[field] !== 'object') {
                                    targetRoomData[field] = {};
                                }
                                
                                // Obje formatƒ± (her duvar index ile)
                                Object.keys(sourceRoomData[field]).forEach(wallIdx => {
                                    const sourceWall = sourceRoomData[field][wallIdx];
                                    
                                    // Kaynak duvarda miktar alanƒ± varsa (bo≈ü bile olsa) kopyala
                                    if (sourceWall && typeof sourceWall === 'object' && ('miktar' in sourceWall)) {
                                        // Hedefte bu duvar yoksa olu≈ütur
                                        if (!targetRoomData[field][wallIdx]) {
                                            targetRoomData[field][wallIdx] = {};
                                        }
                                        // Miktarƒ± kopyala (bo≈ü string veya 0 olsa bile)
                                        targetRoomData[field][wallIdx] = {
                                            ...targetRoomData[field][wallIdx],
                                            miktar: sourceWall.miktar
                                        };
                                    }
                                });
                            }
                        } else if (sourceRoomData[field] && typeof sourceRoomData[field] === 'object') {
                            // Diƒüer alanlar - hedefte alan yoksa atla
                            if (!targetRoomData[field]) return;
                            
                            // Kaynak alanda miktar alanƒ± varsa kopyala (bo≈ü bile olsa)
                            if ('miktar' in sourceRoomData[field]) {
                                targetRoomData[field] = {
                                    ...targetRoomData[field],
                                    miktar: sourceRoomData[field].miktar
                                };
                            }
                        }
                    });
                });
                
                // G√ºncellenmi≈ü veriyi kaydet
                updateApartments(apartments.map(a => 
                    a.id === currentApt ? { ...a, data: updatedData } : a
                ));
                
                setShowCopyAmountsModal(false);
                setSourceAptForAmounts(null);
                setSelectedFieldsForCopy({});
            };

            // Malzeme kullanƒ±m analizi
            // Admin fonksiyonlarƒ±
            const loadAllUsersData = async () => {
                if (!isAdmin || !db) return;
                
                try {
                    // T√ºm kullanƒ±cƒ±larƒ± y√ºkle
                    const usersSnapshot = await db.collection('appData').get();
                    const usersData = {};
                    const usersList = [];
                    
                    for (const doc of usersSnapshot.docs) {
                        const userId = doc.id;
                        
                        // mainData dok√ºmanƒ±nƒ± atla (eski veri yapƒ±sƒ±)
                        if (userId === 'mainData' || userId === 'projects' || userId === 'rooms' || userId === 'materials' || userId === 'metadata') {
                            console.log('‚è≠Ô∏è Atlandƒ±:', userId, '(sistem dok√ºmanƒ±)');
                            continue;
                        }
                        
                        const data = doc.data();
                        
                        // Kullanƒ±cƒ± email'ini bul (3 farklƒ± yerden)
                        let userEmail = 'Bilinmeyen';
                        
                        // 1. userSettings'den dene
                        try {
                            const userDoc = await db.collection('userSettings').doc(userId).get();
                            if (userDoc.exists && userDoc.data().email) {
                                userEmail = userDoc.data().email;
                            }
                        } catch (e) {
                            console.log('userSettings email alƒ±namadƒ±:', userId);
                        }
                        
                        // 2. Hala bilinmiyorsa, activeSessions'dan dene
                        if (userEmail === 'Bilinmeyen') {
                            try {
                                const sessionDoc = await db.collection('activeSessions').doc(userId).get();
                                if (sessionDoc.exists && sessionDoc.data().userEmail) {
                                    userEmail = sessionDoc.data().userEmail;
                                }
                            } catch (e) {
                                console.log('activeSessions email alƒ±namadƒ±:', userId);
                            }
                        }
                        
                        // 3. Hala bilinmiyorsa, admins'den dene
                        if (userEmail === 'Bilinmeyen') {
                            try {
                                const adminDoc = await db.collection('admins').doc(userId).get();
                                if (adminDoc.exists && adminDoc.data().email) {
                                    userEmail = adminDoc.data().email;
                                }
                            } catch (e) {
                                console.log('admins email alƒ±namadƒ±:', userId);
                            }
                        }
                        
                        // Hala bilinmiyorsa, UID'yi g√∂ster
                        if (userEmail === 'Bilinmeyen') {
                            userEmail = `Kullanƒ±cƒ± (${userId.substring(0, 8)}...)`;
                        }
                        
                        usersData[userId] = {
                            ...data,
                            userId,
                            email: userEmail
                        };
                        
                        usersList.push({
                            userId,
                            email: userEmail,
                            projectCount: data.projects?.length || 0,
                            apartmentCount: data.projects?.reduce((sum, p) => sum + (p.apartments?.length || 0), 0) || 0,
                            lastUpdate: data.lastUpdate
                        });
                    }
                    
                    setAllUsersData(usersData);
                    setAllUsers(usersList);
                    console.log('‚úÖ Admin: T√ºm kullanƒ±cƒ± verileri y√ºklendi', usersList.length, 'kullanƒ±cƒ±');
                } catch (error) {
                    console.error('‚ùå Admin veri y√ºkleme hatasƒ±:', error);
                }
            };
            
            const getSystemStats = () => {
                let totalProjects = 0;
                let totalApartments = 0;
                let totalPhotos = 0;
                let totalMaterials = 0;
                
                Object.values(allUsersData).forEach(userData => {
                    if (userData.projects) {
                        totalProjects += userData.projects.length;
                        userData.projects.forEach(project => {
                            if (project.apartments) {
                                totalApartments += project.apartments.length;
                                project.apartments.forEach(apt => {
                                    allRooms.forEach(room => {
                                        const rd = apt.data[room.id];
                                        if (rd) {
                                            if (rd.foto) {
                                                totalPhotos += Object.keys(rd.foto).length;
                                            }
                                            room.fields.forEach(f => {
                                                if (f === 'foto') return;
                                                if (f === 'duvar_kaplama' && rd[f]) {
                                                    totalMaterials += Object.values(rd[f]).filter(v => v && v.malzeme).length;
                                                } else if (rd[f] && rd[f].malzeme) {
                                                    totalMaterials++;
                                                }
                                            });
                                        }
                                    });
                                });
                            }
                        });
                    }
                });
                
                return {
                    totalUsers: allUsers.length,
                    totalProjects,
                    totalApartments,
                    totalPhotos,
                    totalMaterials
                };
            };
            
            // Admin: Proje veya daireyi ba≈üka kullanƒ±cƒ±ya kopyala
            const adminCopyToUser = async () => {
                if (!adminCopySource || !adminCopyTarget) return;
                
                try {
                    // Hedef kullanƒ±cƒ±nƒ±n verilerini al
                    const targetUserDoc = await db.collection('appData').doc(adminCopyTarget).get();
                    let targetData = targetUserDoc.exists ? targetUserDoc.data() : { projects: [] };
                    
                    if (!targetData.projects) targetData.projects = [];
                    
                    if (adminCopySource.type === 'project') {
                        // Proje kopyala
                        const newProject = {
                            ...adminCopySource.data,
                            id: Math.max(...targetData.projects.map(p => p.id), 0) + 1,
                            name: adminCopySource.data.name + ' (Kopya)'
                        };
                        targetData.projects.push(newProject);
                        
                        await db.collection('appData').doc(adminCopyTarget).set(targetData);
                        alert(`‚úÖ Proje "${adminCopySource.data.name}" kullanƒ±cƒ±ya kopyalandƒ±!`);
                        
                    } else if (adminCopySource.type === 'apartment') {
                        // Daire kopyala - hedef projeye ekle
                        if (targetData.projects.length === 0) {
                            // Proje yoksa olu≈ütur
                            targetData.projects.push({
                                id: 1,
                                name: 'Proje 1',
                                apartments: []
                            });
                        }
                        
                        // ƒ∞lk projeye ekle
                        const targetProject = targetData.projects[0];
                        const newApt = {
                            ...adminCopySource.data,
                            id: Math.max(...targetProject.apartments.map(a => a.id), 0) + 1,
                            name: adminCopySource.data.name + ' (Kopya)'
                        };
                        targetProject.apartments.push(newApt);
                        
                        await db.collection('appData').doc(adminCopyTarget).set(targetData);
                        alert(`‚úÖ Daire "${adminCopySource.data.name}" kullanƒ±cƒ±nƒ±n ilk projesine kopyalandƒ±!`);
                    }
                    
                    setShowAdminCopyModal(false);
                    setAdminCopySource(null);
                    setAdminCopyTarget(null);
                    loadAllUsersData(); // Verileri yenile
                    
                } catch (error) {
                    console.error('‚ùå Admin kopyalama hatasƒ±:', error);
                    alert('‚ùå Kopyalama ba≈üarƒ±sƒ±z!');
                }
            };


            const getMaterialUsageAnalysis = () => {
                const analysis = {};
                
                projects.forEach(project => {
                    project.apartments.forEach(apt => {
                        allRooms.forEach(room => {
                            const rd = apt.data[room.id];
                            if (!rd) return;
                            
                            room.fields.forEach(f => {
                                if (f === 'foto') return;
                                const fc = fieldLabels[f];
                                if (!fc) return;
                                
                                if (f === 'duvar_kaplama' && rd[f]) {
                                    const wallCount = apt.wallCount && apt.wallCount[room.id] ? apt.wallCount[room.id] : 1;
                                    for (let wallIdx = 0; wallIdx < wallCount; wallIdx++) {
                                        const v = rd[f][wallIdx];
                                        if (v && v.malzeme) {
                                            const key = `${fc.category}|${v.subgroup || '-'}|${v.malzeme}`;
                                            if (!analysis[key]) {
                                                analysis[key] = {
                                                    category: fc.category,
                                                    subgroup: v.subgroup || '-',
                                                    material: v.malzeme,
                                                    unit: fc.unit || '',
                                                    totalAmount: 0,
                                                    usages: []
                                                };
                                            }
                                            analysis[key].totalAmount += parseFloat(v.miktar || 0);
                                            analysis[key].usages.push({
                                                project: project.name,
                                                apartment: apt.name,
                                                room: room.name,
                                                field: v.name || `Duvar ${wallIdx + 1}`, // √ñzel duvar ismi veya varsayƒ±lan
                                                amount: parseFloat(v.miktar || 0)
                                            });
                                        }
                                    }
                                } else if (rd[f] && rd[f].malzeme) {
                                    const key = `${fc.category}|${rd[f].subgroup || '-'}|${rd[f].malzeme}`;
                                    if (!analysis[key]) {
                                        analysis[key] = {
                                            category: fc.category,
                                            subgroup: rd[f].subgroup || '-',
                                            material: rd[f].malzeme,
                                            unit: fc.unit || '',
                                            totalAmount: 0,
                                            usages: []
                                        };
                                    }
                                    analysis[key].totalAmount += parseFloat(rd[f].miktar || 0);
                                    analysis[key].usages.push({
                                        project: project.name,
                                        apartment: apt.name,
                                        room: room.name,
                                        field: fc.label,
                                        amount: parseFloat(rd[f].miktar || 0)
                                    });
                                }
                            });
                        });
                    });
                });
                
                return Object.values(analysis).sort((a, b) => {
                    if (a.category !== b.category) return a.category.localeCompare(b.category);
                    if (a.subgroup !== b.subgroup) return a.subgroup.localeCompare(b.subgroup);
                    return a.material.localeCompare(b.material);
                });
            };

            const exportData = () => {
                const exportObj = {
                    projects: projects,
                    customRooms: customRooms,
                    baseRooms: baseRooms,
                    fieldLabels: fieldLabels,
                    materials: materials,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'malzeme_sistemi_yedek_' + new Date().toISOString().split('T')[0] + '.json';
                link.click();
                URL.revokeObjectURL(url);
                alert('Veriler indirildi! Bu dosyayi baska cihazda yukleyebilirsiniz.');
            };

            const importData = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const imported = JSON.parse(ev.target.result);
                            if (!imported.projects || !Array.isArray(imported.projects)) {
                                alert('Gecersiz dosya formati!');
                                return;
                            }
                            if (confirm('Mevcut veriler silinecek ve yukleyeceginiz veriler ile degistirilecek. Devam etmek istiyor musunuz?\n\n(Oneri: Once mevcut verilerinizi yedegin disa aktarin)')) {
                                setProjects(imported.projects || []);
                                setCustomRooms(imported.customRooms || []);
                                setBaseRooms(imported.baseRooms || DEFAULT_ROOMS);
                                setFieldLabels(imported.fieldLabels || DEFAULT_FIELD_LABELS);
                                setMaterials(imported.materials || DEFAULT_MATERIALS);
                                localStorage.setItem('projects_data', JSON.stringify(imported.projects));
                                localStorage.setItem('custom_rooms', JSON.stringify(imported.customRooms || []));
                                localStorage.setItem('base_rooms', JSON.stringify(imported.baseRooms || DEFAULT_ROOMS));
                                localStorage.setItem('field_labels', JSON.stringify(imported.fieldLabels || DEFAULT_FIELD_LABELS));
                                localStorage.setItem('material_database', JSON.stringify(imported.materials || DEFAULT_MATERIALS));
                                if (imported.projects[0]) {
                                    setCurrentPrj(imported.projects[0].id);
                                    if (imported.projects[0].apartments[0]) {
                                        setCurrentApt(imported.projects[0].apartments[0].id);
                                    }
                                }
                                alert('Veriler basariyla yuklendi!\nProje sayisi: ' + imported.projects.length + '\nOzel mekan sayisi: ' + (imported.customRooms?.length || 0));
                            }
                        } catch (err) {
                            alert('Dosya okunamadi! Hata: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            const downloadExcel = () => {
                const wb = XLSX.utils.book_new();
                const proj = getProject();
                
                // GENEL √ñZET SAYFASI
                const summaryData = [
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    ['üìä PROJE √ñZET RAPORU'],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    [],
                    ['üè¢ Proje Adƒ±:', proj.name],
                    ['üìÖ Rapor Tarihi:', new Date().toLocaleDateString('tr-TR')],
                    ['üè† Toplam Daire Sayƒ±sƒ±:', proj.apartments.length],
                    [],
                    ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'],
                    ['üìã DAƒ∞RE Lƒ∞STESƒ∞'],
                    ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'],
                    ['No', 'Daire Adƒ±', 'Mekan Sayƒ±sƒ±', 'Malzeme Sayƒ±sƒ±', 'Fotoƒüraf Sayƒ±sƒ±']
                ];
                
                proj.apartments.forEach((apt, idx) => {
                    let mekanSayisi = 0;
                    let malzemeSayisi = 0;
                    let fotoSayisi = 0;
                    
                    allRooms.forEach(room => {
                        const rd = apt.data[room.id];
                        if (rd) {
                            mekanSayisi++;
                            room.fields.forEach(f => {
                                if (f === 'foto') {
                                    fotoSayisi += Object.keys(rd.foto || {}).length;
                                } else if (f === 'duvar_kaplama' && rd[f]) {
                                    malzemeSayisi += Object.values(rd[f]).filter(v => v && v.malzeme).length;
                                } else if (rd[f] && rd[f].malzeme) {
                                    malzemeSayisi++;
                                }
                            });
                        }
                    });
                    
                    summaryData.push([idx + 1, apt.name, mekanSayisi, malzemeSayisi, fotoSayisi]);
                });
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWs['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
                summaryWs['!rows'] = [
                    { hpt: 5 },  // √úst √ßizgi
                    { hpt: 25 }, // Ba≈ülƒ±k
                    { hpt: 5 },  // Alt √ßizgi
                    { hpt: 10 }, // Bo≈üluk
                    { hpt: 18 }, // Proje adƒ±
                    { hpt: 18 }, // Tarih
                    { hpt: 18 }, // Daire sayƒ±sƒ±
                    { hpt: 10 }, // Bo≈üluk
                    { hpt: 5 },  // Ayƒ±rƒ±cƒ± √ßizgi
                    { hpt: 20 }, // Alt ba≈ülƒ±k
                    { hpt: 5 },  // Ayƒ±rƒ±cƒ± √ßizgi
                    { hpt: 20 }  // Tablo ba≈ülƒ±klarƒ±
                ];
                // Ba≈ülƒ±k satƒ±rƒ±nƒ± birle≈ütir
                if (!summaryWs['!merges']) summaryWs['!merges'] = [];
                summaryWs['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }); // √úst √ßizgi
                summaryWs['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } }); // Ba≈ülƒ±k
                summaryWs['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 4 } }); // Alt √ßizgi
                summaryWs['!merges'].push({ s: { r: 8, c: 0 }, e: { r: 8, c: 4 } }); // Ayƒ±rƒ±cƒ±
                summaryWs['!merges'].push({ s: { r: 9, c: 0 }, e: { r: 9, c: 4 } }); // Alt ba≈ülƒ±k
                summaryWs['!merges'].push({ s: { r: 10, c: 0 }, e: { r: 10, c: 4 } }); // Ayƒ±rƒ±cƒ±
                // Otomatik filtre ekleme (tablo ba≈ülƒ±k satƒ±rƒ± = 11. satƒ±r, index 11)
                summaryWs['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r: 11, c: 0 }, e: { r: 11 + proj.apartments.length, c: 4 } }) };
                XLSX.utils.book_append_sheet(wb, summaryWs, 'üìä √ñZET');
                
                // PROJE TOPLAM MALZEME Lƒ∞STESƒ∞
                const allMaterials = {};
                proj.apartments.forEach(apt => {
                    allRooms.forEach(room => {
                        const rd = apt.data[room.id];
                        if (!rd) return;
                        room.fields.forEach(f => {
                            if (f === 'foto') return;
                            const fc = fieldLabels[f];
                            if (!fc) return; // Alan tanƒ±mƒ± yoksa atla
                            if (!rd[f]) return; // Veri yoksa atla
                            
                            if (f === 'duvar_kaplama' && rd[f]) {
                                // wallCount'a g√∂re sadece o kadar duvar say
                                const wallCount = apt.wallCount && apt.wallCount[room.id] ? apt.wallCount[room.id] : 1;
                                for (let wallIdx = 0; wallIdx < wallCount; wallIdx++) {
                                    const v = rd[f][wallIdx];
                                    if (v && v.malzeme) {
                                        const subgroup = v.subgroup || '-';
                                        const materialKey = fc.category + '|' + subgroup + '|' + v.malzeme + '|' + (fc.unit || '');
                                        allMaterials[materialKey] = (allMaterials[materialKey] || 0) + parseFloat(v.miktar || 0);
                                    }
                                }
                            } else if (rd[f] && rd[f].malzeme) {
                                const subgroup = rd[f].subgroup || '-';
                                const key = fc.category + '|' + subgroup + '|' + rd[f].malzeme + '|' + (fc.unit || '');
                                allMaterials[key] = (allMaterials[key] || 0) + parseFloat(rd[f].miktar || 0);
                            }
                        });
                    });
                });
                
                const totalData = [
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    ['üì¶ PROJE TOPLAM MALZEME Lƒ∞STESƒ∞'],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    [],
                    ['üè¢ Proje:', proj.name],
                    ['üìÖ Tarih:', new Date().toLocaleDateString('tr-TR')],
                    [],
                    ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'],
                    ['KATEGORƒ∞', 'ALT GRUP', 'MALZEME', 'TOPLAM Mƒ∞KTAR', 'Bƒ∞Rƒ∞M']
                ];
                
                Object.keys(allMaterials).sort().forEach(key => {
                    const [category, subgroup, material, unit] = key.split('|');
                    // Sayƒ±yƒ± number olarak tut, Excel'de g√∂r√ºnmesi i√ßin
                    totalData.push([category, subgroup, material, parseFloat(allMaterials[key].toFixed(2)), unit]);
                });
                
                const totalWs = XLSX.utils.aoa_to_sheet(totalData);
                totalWs['!cols'] = [{ wch: 18 }, { wch: 18 }, { wch: 35 }, { wch: 15 }, { wch: 10 }];
                if (!totalWs['!merges']) totalWs['!merges'] = [];
                totalWs['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }); // √úst √ßizgi
                totalWs['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } }); // Ba≈ülƒ±k
                totalWs['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 4 } }); // Alt √ßizgi
                totalWs['!merges'].push({ s: { r: 7, c: 0 }, e: { r: 7, c: 4 } }); // Ayƒ±rƒ±cƒ±
                // Otomatik filtre (tablo ba≈ülƒ±k satƒ±rƒ± = 8. satƒ±r, index 8)
                const totalDataRows = totalData.length - 1; // Veri satƒ±r sayƒ±sƒ±
                totalWs['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r: 8, c: 0 }, e: { r: totalDataRows, c: 4 } }) };
                XLSX.utils.book_append_sheet(wb, totalWs, 'üì¶ TOPLAM MALZEME');
                
                // HER DAƒ∞RE ƒ∞√áƒ∞N AYRI SAYFA
                proj.apartments.forEach(apt => {
                    const data = [
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        ['üè† ' + apt.name.toUpperCase() + ' - DETAYLI MALZEME Lƒ∞STESƒ∞'],
                        ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                        [],
                        ['üè¢ Proje:', proj.name],
                        ['üìÖ Tarih:', new Date().toLocaleDateString('tr-TR')],
                        [],
                        ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'],
                        ['MEKAN', 'T√úR', 'ALT GRUP', 'MALZEME', 'Mƒ∞KTAR', 'Bƒ∞Rƒ∞M']
                    ];
                    
                    let hasData = false;
                    allRooms.forEach(room => {
                        const rd = apt.data[room.id];
                        if (!rd) return;
                        
                        let roomHasData = false;
                        const roomData = [];
                        
                        room.fields.forEach(f => {
                            if (f === 'foto') return;
                            const fc = fieldLabels[f];
                            if (!fc) return; // Alan tanƒ±mƒ± yoksa atla
                            if (!rd[f]) return; // Veri yoksa atla
                            
                            if (f === 'duvar_kaplama' && rd[f]) {
                                // wallCount'a g√∂re sadece o kadar duvar yaz
                                const wallCount = apt.wallCount && apt.wallCount[room.id] ? apt.wallCount[room.id] : 1;
                                for (let wallIdx = 0; wallIdx < wallCount; wallIdx++) {
                                    const v = rd[f][wallIdx];
                                    if (v && v.malzeme) {
                                        const miktar = v.miktar ? (isNaN(v.miktar) ? v.miktar : parseFloat(v.miktar)) : '-';
                                        const subgroup = v.subgroup || '-';
                                        // √ñzel duvar ismi varsa kullan, yoksa varsayƒ±lan
                                        const wallName = v.name || `Duvar ${wallIdx + 1}`;
                                        roomData.push([room.name, wallName, subgroup, v.malzeme, miktar, fc.unit || '']);
                                        roomHasData = true;
                                    }
                                }
                            } else if (rd[f] && rd[f].malzeme) {
                                const miktar = rd[f].miktar ? (isNaN(rd[f].miktar) ? rd[f].miktar : parseFloat(rd[f].miktar)) : '-';
                                const subgroup = rd[f].subgroup || '-';
                                roomData.push([room.name, fc.label, subgroup, rd[f].malzeme, miktar, fc.unit || '']);
                                roomHasData = true;
                            }
                        });
                        
                        if (roomHasData) {
                            data.push(...roomData);
                            hasData = true;
                        }
                    });
                    
                    if (hasData) {
                        // Fotoƒüraf sayƒ±sƒ± bilgisi ekle
                        let totalPhotos = 0;
                        allRooms.forEach(room => {
                            const rd = apt.data[room.id];
                            if (rd && rd.foto) {
                                totalPhotos += Object.keys(rd.foto).length;
                            }
                        });
                        
                        if (totalPhotos > 0) {
                            data.push([]);
                            data.push(['FOTOƒûRAF Bƒ∞LGƒ∞Sƒ∞']);
                            allRooms.forEach(room => {
                                const rd = apt.data[room.id];
                                if (rd && rd.foto && Object.keys(rd.foto).length > 0) {
                                    data.push([room.name, 'Fotoƒüraf', Object.keys(rd.foto).length + ' adet', '', '']);
                                }
                            });
                        }
                        
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        ws['!cols'] = [{ wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 30 }, { wch: 15 }, { wch: 12 }];
                        if (!ws['!merges']) ws['!merges'] = [];
                        ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }); // √úst √ßizgi
                        ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 5 } }); // Ba≈ülƒ±k
                        ws['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 5 } }); // Alt √ßizgi
                        ws['!merges'].push({ s: { r: 7, c: 0 }, e: { r: 7, c: 5 } }); // Ayƒ±rƒ±cƒ±
                        // Otomatik filtre (tablo ba≈ülƒ±k satƒ±rƒ± = 8. satƒ±r)
                        const dataRows = data.length - 1;
                        ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r: 8, c: 0 }, e: { r: dataRows, c: 5 } }) };
                        XLSX.utils.book_append_sheet(wb, ws, 'üè† ' + apt.name.substring(0, 28));
                    }
                });
                
                // MEKAN BAZLI √ñZET
                const roomSummaryData = [
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    ['üèòÔ∏è MEKAN BAZLI MALZEME √ñZET'],
                    ['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'],
                    [],
                    ['üè¢ Proje:', proj.name],
                    [],
                    ['‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'],
                    ['MEKAN', 'MALZEME T√úR√ú', 'TOPLAM KULLANIM (Daire Sayƒ±sƒ±)']
                ];
                
                const roomMaterials = {};
                proj.apartments.forEach(apt => {
                    allRooms.forEach(room => {
                        const rd = apt.data[room.id];
                        if (!rd) return;
                        
                        if (!roomMaterials[room.name]) roomMaterials[room.name] = {};
                        
                        room.fields.forEach(f => {
                            if (f === 'foto') return;
                            const fc = fieldLabels[f];
                            if (!fc) return; // Alan tanƒ±mƒ± yoksa atla
                            if (!rd[f]) return; // Veri yoksa atla
                            
                            if (f === 'duvar_kaplama' && rd[f]) {
                                // wallCount'a g√∂re sadece o kadar duvar say
                                const wallCount = apt.wallCount && apt.wallCount[room.id] ? apt.wallCount[room.id] : 1;
                                for (let wallIdx = 0; wallIdx < wallCount; wallIdx++) {
                                    const v = rd[f][wallIdx];
                                    if (v && v.malzeme) {
                                        if (!roomMaterials[room.name][fc.label]) roomMaterials[room.name][fc.label] = 0;
                                        roomMaterials[room.name][fc.label]++;
                                    }
                                }
                            } else if (rd[f] && rd[f].malzeme) {
                                if (!roomMaterials[room.name][fc.label]) roomMaterials[room.name][fc.label] = 0;
                                roomMaterials[room.name][fc.label]++;
                            }
                        });
                    });
                });
                
                Object.keys(roomMaterials).sort().forEach(roomName => {
                    Object.keys(roomMaterials[roomName]).sort().forEach(materialType => {
                        roomSummaryData.push([roomName, materialType, roomMaterials[roomName][materialType] + ' daire']);
                    });
                });
                
                const roomSummaryWs = XLSX.utils.aoa_to_sheet(roomSummaryData);
                roomSummaryWs['!cols'] = [{ wch: 28 }, { wch: 28 }, { wch: 22 }];
                if (!roomSummaryWs['!merges']) roomSummaryWs['!merges'] = [];
                roomSummaryWs['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }); // √úst √ßizgi
                roomSummaryWs['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 2 } }); // Ba≈ülƒ±k
                roomSummaryWs['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 2 } }); // Alt √ßizgi
                roomSummaryWs['!merges'].push({ s: { r: 6, c: 0 }, e: { r: 6, c: 2 } }); // Ayƒ±rƒ±cƒ±
                // Otomatik filtre (tablo ba≈ülƒ±k satƒ±rƒ± = 7. satƒ±r)
                const roomDataRows = roomSummaryData.length - 1;
                roomSummaryWs['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r: 7, c: 0 }, e: { r: roomDataRows, c: 2 } }) };
                XLSX.utils.book_append_sheet(wb, roomSummaryWs, 'üèòÔ∏è MEKAN √ñZET');
                
                XLSX.writeFile(wb, proj.name + '_detayli_rapor_' + new Date().toISOString().split('T')[0] + '.xlsx');
                alert('‚úÖ Detaylƒ± Excel raporu olu≈üturuldu!\n\nüìä Sayfalar:\n- üìä √ñZET\n- üì¶ TOPLAM MALZEME (Alt gruplu)\n- üèòÔ∏è MEKAN √ñZET\n- üè† Her daire i√ßin ayrƒ± sayfa\n\n‚ú® √ñzellikler:\n‚úÖ Profesyonel g√∂r√ºn√ºm\n‚úÖ Hiyerar≈üik malzeme yapƒ±sƒ±\nüîç Otomatik filtreler (t√ºm sayfalarda)');
            };

            const generatePrintForm = () => {
                const apt = getApt();
                const proj = getProject();
                const photoSize = prompt('Fotograf boyutu:\n1=Kucuk(200px) 2=Orta(300px) 3=Buyuk(400px) 4=CokBuyuk(500px)', '3');
                const size = { '1': 200, '2': 300, '3': 400, '4': 500 }[photoSize] || 400;
                
                let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + proj.name + ' - ' + apt.name + '</title><style>';
                html += 'body{font-family:Arial;margin:40px}h1{text-align:center;color:#2563eb;border-bottom:3px solid #2563eb;padding-bottom:10px}';
                html += 'h2{color:#1e40af;margin-top:30px;border-bottom:2px solid #ddd}table{width:100%;border-collapse:collapse;margin:20px 0;table-layout:fixed}';
                html += 'th,td{border:1px solid #ddd;padding:12px;word-wrap:break-word}th{background:#2563eb;color:white}tr:nth-child(even){background:#f8f9fa}';
                html += 'th:nth-child(1),td:nth-child(1){width:20%}th:nth-child(2),td:nth-child(2){width:18%}th:nth-child(3),td:nth-child(3){width:32%}th:nth-child(4),td:nth-child(4){width:18%}th:nth-child(5),td:nth-child(5){width:12%}';
                html += '.photo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(' + size + 'px,1fr));gap:20px;margin:20px 0}';
                html += '.photo-item{border:3px solid #ddd;padding:15px;text-align:center;border-radius:8px}';
                html += '.photo-item img{max-width:100%;height:' + size + 'px;object-fit:cover;border-radius:5px}';
                html += '.print-btn{position:fixed;top:20px;right:20px;background:#2563eb;color:white;padding:15px 30px;cursor:pointer;border-radius:5px}';
                html += '@media print{.print-btn{display:none}}</style></head><body>';
                html += '<button class="print-btn" onclick="window.print()">Yazdir/PDF</button>';
                html += '<h1>MALZEME ONAY FORMU</h1><div style="text-align:center;font-size:20px;margin-bottom:30px">' + proj.name + ' - ' + apt.name + '<br>Tarih: ' + new Date().toLocaleDateString('tr-TR') + '</div>';
                
                allRooms.forEach(room => {
                    const rd = apt.data[room.id];
                    if (!rd) return;
                    html += '<h2>' + room.name + '</h2><table><tr><th>Tur</th><th>Alt Grup</th><th>Malzeme</th><th>Miktar/Detay</th><th>Birim</th></tr>';
                    room.fields.forEach(f => {
                        if (f === 'foto') return;
                        const fc = fieldLabels[f];
                        if (!fc) return; // Alan tanƒ±mƒ± yoksa atla
                        if (!rd[f]) return; // Veri yoksa atla
                        
                        if (f === 'duvar_kaplama' && rd[f]) {
                            // wallCount'a g√∂re sadece o kadar duvar yaz
                            const wallCount = apt.wallCount && apt.wallCount[room.id] ? apt.wallCount[room.id] : 1;
                            for (let wallIdx = 0; wallIdx < wallCount; wallIdx++) {
                                const v = rd[f][wallIdx];
                                if (v && v.malzeme) {
                                    const subgroup = v.subgroup || '-';
                                    // √ñzel duvar ismi varsa kullan, yoksa varsayƒ±lan
                                    const wallName = v.name || ('Duvar ' + (wallIdx + 1));
                                    html += '<tr><td>' + wallName + '</td><td>' + subgroup + '</td><td>' + v.malzeme + '</td><td>' + (v.miktar || '-') + '</td><td>' + (fc.unit || '-') + '</td></tr>';
                                }
                            }
                        } else if (rd[f] && rd[f].malzeme) {
                            const subgroup = rd[f].subgroup || '-';
                            html += '<tr><td>' + fc.label + '</td><td>' + subgroup + '</td><td>' + rd[f].malzeme + '</td><td>' + (rd[f].miktar || '-') + '</td><td>' + (fc.unit || '-') + '</td></tr>';
                        }
                    });
                    html += '</table>';
                    if (rd.foto && Object.keys(rd.foto).length > 0) {
                        html += '<h3>Fotograflar</h3><div class="photo-grid">';
                        Object.values(rd.foto).forEach((p, i) => {
                            if (p) html += '<div class="photo-item"><img src="' + p + '"><div>Foto ' + (i + 1) + '</div></div>';
                        });
                        html += '</div>';
                    }
                });
                html += '<div style="margin-top:50px;border-top:2px solid #333;padding-top:30px"><h2>ONAY</h2><p>Belirtilen malzemeleri onayliyorum.</p><br><br>';
                html += 'Daire Sahibi: _____________________ Imza: _____________________ Tarih: _____________________</div></body></html>';
                
                const w = window.open('', '_blank');
                w.document.write(html);
                w.document.close();
            };

            const renderField = (f) => {
                const data = getRoomData();
                const fc = fieldLabels[f];
                if (!fc) return null; // Alan tanƒ±mƒ± yoksa g√∂sterme
                const opts = materials[fc.category] || [];

                if (f === 'foto') {
                    const photos = Object.entries(data.foto || {}).filter(([_, p]) => p);
                    return (
                        <div key="foto" className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 border border-purple-100">
                            <label className="block text-sm font-semibold text-purple-900 mb-4 flex items-center gap-2">
                                <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Fotoƒüraflar
                                <span className="ml-auto bg-purple-600 text-white text-xs px-2.5 py-1 rounded-full">{photos.length}</span>
                            </label>
                            <input type="file" accept="image/*" onChange={uploadPhoto} className="hidden" id="file-up" />
                            <label htmlFor="file-up" className="inline-flex items-center gap-2 px-5 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg cursor-pointer hover:from-purple-700 hover:to-pink-700 shadow-md hover:shadow-lg transition-all">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Fotoƒüraf Ekle
                            </label>
                            {photos.length > 0 && (
                                <div className="grid grid-cols-3 gap-3 mt-4">
                                    {photos.map(([i, p]) => (
                                        <div key={i} className="relative group">
                                            <img src={p} className="w-full h-32 object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-purple-400 transition-all shadow-sm" onClick={() => setLightbox(p)} />
                                            <button onClick={() => delPhoto(i)} className="absolute top-2 right-2 bg-red-500 text-white w-7 h-7 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-lg hover:bg-red-600 flex items-center justify-center">√ó</button>
                                            <div className="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">#{parseInt(i) + 1}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    );
                }

                if (f === 'duvar_kaplama') {
                    const apt = getApt();
                    const count = apt.wallCount && apt.wallCount[currentRoom] ? apt.wallCount[currentRoom] : 1;
                    const categoryData = materials[fc.category] || {};
                    const isHierarchical = typeof categoryData === 'object' && !Array.isArray(categoryData);
                    
                    return (
                        <div key={f} className="bg-gradient-to-br from-orange-50 to-yellow-50 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 border border-orange-100">
                            <div className="flex justify-between items-center mb-4">
                                <label className="font-semibold text-orange-900 flex items-center gap-2">
                                    {fc.icon ? (
                                        (fc.icon.startsWith('data:image') || fc.icon.startsWith('http')) ? (
                                            <img src={fc.icon} className="w-12 h-12 object-contain" alt="icon" />
                                        ) : (
                                            <span className="text-4xl">{fc.icon}</span>
                                        )
                                    ) : (
                                        <svg className="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                                        </svg>
                                    )}
                                    {fc.label}
                                    <span className="ml-auto bg-orange-600 text-white text-xs px-2.5 py-1 rounded-full">{count} Duvar</span>
                                </label>
                                <button onClick={addWallCover} className="px-3 py-1.5 bg-gradient-to-r from-green-500 to-green-600 text-white text-xs rounded-lg hover:from-green-600 hover:to-green-700 shadow-md flex items-center gap-1">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Duvar Ekle
                                </button>
                            </div>
                            <div className="space-y-3">
                                {[...Array(count)].map((_, i) => {
                                    const wallData = data.duvar_kaplama && data.duvar_kaplama[i] ? data.duvar_kaplama[i] : {};
                                    return (
                                        <div key={i} className={`rounded-lg p-4 border-2 transition-all ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 border-orange-600 hover:border-orange-500'
                                                : 'bg-white border-orange-200 hover:border-orange-300'
                                        }`}>
                                            <div className="flex justify-between items-center mb-3">
                                                <div className="flex items-center gap-2 flex-1">
                                                    <span className="w-6 h-6 bg-orange-500 text-white rounded-full flex items-center justify-center text-xs flex-shrink-0">{i + 1}</span>
                                                    <input
                                                        type="text"
                                                        placeholder={`Duvar ${i + 1}`}
                                                        value={wallData.name || ''}
                                                        onChange={(e) => {
                                                            const newData = { ...(data.duvar_kaplama || {}) };
                                                            newData[i] = { ...(newData[i] || {}), name: e.target.value };
                                                            updateApartments(apartments.map(a => 
                                                                a.id === currentApt 
                                                                    ? { ...a, data: { ...a.data, [currentRoom]: { ...a.data[currentRoom], duvar_kaplama: newData } } }
                                                                    : a
                                                            ));
                                                        }}
                                                        className={`flex-1 px-3 py-1.5 border rounded-lg text-sm font-semibold focus:ring-2 focus:border-orange-400 transition-colors ${
                                                            theme === 'dark'
                                                                ? 'bg-gray-800 text-orange-200 border-gray-600 focus:ring-orange-500 placeholder-gray-500'
                                                                : 'bg-gray-50 text-orange-800 border-gray-300 focus:ring-orange-200 placeholder-gray-400'
                                                        }`}
                                                    />
                                                </div>
                                                {count > 1 && (
                                                    <button 
                                                        onClick={() => {
                                                            if (confirm('Bu duvar kaplamasƒ±nƒ± silmek istediƒüinize emin misiniz?')) {
                                                                // G√úNCEL veriyi al
                                                                const currentData = getRoomData();
                                                                const currentWalls = currentData.duvar_kaplama || {};
                                                                
                                                                // Sadece malzemesi olan duvarlarƒ± array'e al (se√ßileni hari√ß tut)
                                                                const newWallArray = [];
                                                                for (let j = 0; j < count; j++) {
                                                                    if (j !== i) { // Se√ßilen duvarƒ± atlama
                                                                        if (currentWalls[j] && currentWalls[j].malzeme) {
                                                                            // Sadece dolu duvarlarƒ± ekle
                                                                            newWallArray.push(currentWalls[j]);
                                                                        }
                                                                    }
                                                                }
                                                                
                                                                // Yeni object olu≈ütur - array'i 0'dan ba≈ülayarak indexle
                                                                const newWallData = {};
                                                                newWallArray.forEach((wall, idx) => {
                                                                    newWallData[idx] = wall;
                                                                });
                                                                
                                                                // wallCount'u azalt
                                                                const newCount = count - 1;
                                                                
                                                                // ƒ∞Kƒ∞ state'i de aynƒ± anda g√ºncelle
                                                                const updatedApts = apartments.map(a => {
                                                                    if (a.id === currentApt) {
                                                                        return {
                                                                            ...a,
                                                                            wallCount: { ...a.wallCount, [currentRoom]: newCount },
                                                                            data: {
                                                                                ...a.data,
                                                                                [currentRoom]: {
                                                                                    ...a.data[currentRoom],
                                                                                    duvar_kaplama: newWallData
                                                                                }
                                                                            }
                                                                        };
                                                                    }
                                                                    return a;
                                                                });
                                                                
                                                                updateApartments(updatedApts);
                                                            }
                                                        }}
                                                        className="px-2 py-1 bg-red-500 text-white rounded-lg text-xs hover:bg-red-600 flex items-center gap-1"
                                                    >
                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                        Sil
                                                    </button>
                                                )}
                                            </div>
                                        {isHierarchical ? (
                                            /* Hiyerar≈üik Se√ßim */
                                            <div className="space-y-2">
                                                <div className="flex flex-col gap-2">
                                                    <select 
                                                        value={wallData.subgroup || ''} 
                                                        onChange={(e) => updateWallCover(i, 'subgroup', e.target.value)} 
                                                        className={`border-2 rounded-lg px-3 py-2 text-sm w-auto min-w-full focus:ring transition-all ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-orange-400 focus:ring-orange-500'
                                                                : 'border-gray-200 bg-white text-gray-900 focus:border-orange-500 focus:ring-orange-200'
                                                        }`}
                                                        style={{ width: 'fit-content', minWidth: '100%' }}
                                                    >
                                                        <option value="">üîπ Alt Grup Se√ßiniz</option>
                                                        {Object.keys(categoryData).map(sg => (
                                                            <option key={sg} value={sg}>{sg}</option>
                                                        ))}
                                                    </select>
                                                    {wallData.subgroup ? (
                                                        wallData.subgroup === 'Seramik' ? (
                                                            /* √ñZEL SERAMƒ∞K SE√áƒ∞Mƒ∞ - Fƒ∞LTRELEME ƒ∞LE */
                                                            <div className={`border-2 rounded-lg p-4 ${
                                                                theme === 'dark'
                                                                    ? 'border-purple-700 bg-purple-900/20'
                                                                    : 'border-purple-200 bg-purple-50'
                                                            }`}>
                                                                <div className="grid grid-cols-2 gap-2 mb-3">
                                                                    {/* Seri Filtresi */}
                                                                    <select 
                                                                        id={`wall-ceramic-filter-serie-${i}`}
                                                                        className={`border-2 rounded-lg px-3 py-2 text-sm focus:ring transition-all ${
                                                                            theme === 'dark'
                                                                                ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-purple-400'
                                                                                : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500'
                                                                        }`}
                                                                        onChange={() => {
                                                                            // Filtre deƒüi≈ütiƒüinde se√ßimi sƒ±fƒ±rla
                                                                            updateWallCover(i, 'malzeme', '');
                                                                        }}
                                                                    >
                                                                        <option value="">üè∑Ô∏è T√ºm Seriler</option>
                                                                        {[...ceramicData.series].sort((a, b) => a.localeCompare(b, 'tr')).map(serie => (
                                                                            <option key={serie} value={serie}>{serie}</option>
                                                                        ))}
                                                                    </select>
                                                                    
                                                                    {/* Boyut Filtresi */}
                                                                    <select 
                                                                        id={`wall-ceramic-filter-size-${i}`}
                                                                        className={`border-2 rounded-lg px-3 py-2 text-sm focus:ring transition-all ${
                                                                            theme === 'dark'
                                                                                ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-purple-400'
                                                                                : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500'
                                                                        }`}
                                                                        onChange={() => {
                                                                            // Filtre deƒüi≈ütiƒüinde se√ßimi sƒ±fƒ±rla
                                                                            updateWallCover(i, 'malzeme', '');
                                                                        }}
                                                                    >
                                                                        <option value="">üìè T√ºm Boyutlar</option>
                                                                        {[...ceramicData.sizes].sort((a, b) => a.localeCompare(b, 'tr')).map(size => (
                                                                            <option key={size} value={size}>{size}</option>
                                                                        ))}
                                                                    </select>
                                                                </div>
                                                                
                                                                {/* Seramik Se√ßimi */}
                                                                <select 
                                                                    value={wallData.malzeme || ''} 
                                                                    onChange={(e) => updateWallCover(i, 'malzeme', e.target.value)} 
                                                                    className={`w-full border-2 rounded-lg px-3 py-2.5 font-medium focus:ring transition-all ${
                                                                        theme === 'dark'
                                                                            ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-purple-400 focus:ring-purple-500'
                                                                            : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500 focus:ring-purple-200'
                                                                    }`}
                                                                >
                                                                    <option value="">üî∏ Seramik Se√ßiniz</option>
                                                                    {(() => {
                                                                        const serieFilter = document.getElementById(`wall-ceramic-filter-serie-${i}`)?.value || '';
                                                                        const sizeFilter = document.getElementById(`wall-ceramic-filter-size-${i}`)?.value || '';
                                                                        
                                                                        return ceramicData.items
                                                                            .filter(item => {
                                                                                if (serieFilter && item.serie !== serieFilter) return false;
                                                                                if (sizeFilter && item.size !== sizeFilter) return false;
                                                                                return true;
                                                                            })
                                                                            .sort((a, b) => a.fullName.localeCompare(b.fullName, 'tr'))
                                                                            .map(item => (
                                                                                <option key={item.fullName} value={item.fullName}>
                                                                                    {item.fullName}
                                                                                </option>
                                                                            ));
                                                                    })()}
                                                                </select>
                                                                
                                                                <div className={`mt-2 text-xs ${
                                                                    theme === 'dark' ? 'text-purple-300' : 'text-purple-600'
                                                                }`}>
                                                                    üí° Seri ve boyut filtrelerini kullanarak arama yapabilirsiniz
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            /* NORMAL MALZEME SE√áƒ∞Mƒ∞ */
                                                            <select 
                                                                value={wallData.malzeme || ''} 
                                                                onChange={(e) => updateWallCover(i, 'malzeme', e.target.value)} 
                                                                className={`border-2 rounded-lg px-3 py-2 text-sm w-auto min-w-full focus:ring transition-all ${
                                                                    theme === 'dark'
                                                                        ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-orange-400 focus:ring-orange-500'
                                                                        : 'border-gray-200 bg-white text-gray-900 focus:border-orange-500 focus:ring-orange-200'
                                                                }`}
                                                                style={{ width: 'fit-content', minWidth: '100%' }}
                                                            >
                                                                <option value="">üî∏ Malzeme Se√ßiniz</option>
                                                                {(categoryData[wallData.subgroup] || []).map(m => (
                                                                    <option key={m} value={m}>{m}</option>
                                                                ))}
                                                            </select>
                                                        )
                                                    ) : (
                                                        <div className="border-2 border-dashed border-gray-200 rounded-lg px-3 py-2 bg-gray-50 text-gray-400 flex items-center text-xs">
                                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                            </svg>
                                                            √ñnce alt grup se√ßiniz
                                                        </div>
                                                    )}
                                                </div>
                                                {wallData.malzeme && (
                                                    <div className="relative">
                                                        <input 
                                                            type="number" 
                                                            step="0.01" 
                                                            value={wallData.miktar || ''} 
                                                            onChange={(e) => updateWallCover(i, 'miktar', e.target.value)} 
                                                            placeholder="0.00" 
                                                            className={`border-2 rounded-lg px-3 py-2 text-sm w-full focus:ring transition-all pr-12 ${
                                                                theme === 'dark'
                                                                    ? 'border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 focus:border-green-400 focus:ring-green-500'
                                                                    : 'border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-200'
                                                            }`}
                                                        />
                                                        <span className={`absolute right-3 top-1/2 -translate-y-1/2 text-sm font-medium ${
                                                            theme === 'dark' ? 'text-gray-400' : 'text-gray-500'
                                                        }`}>m¬≤</span>
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            /* D√ºz Liste */
                                            <div className="flex flex-col gap-2">
                                                <select 
                                                    value={wallData.malzeme || ''} 
                                                    onChange={(e) => updateWallCover(i, 'malzeme', e.target.value)} 
                                                    className={`border-2 rounded-lg px-3 py-2 text-sm w-auto min-w-full focus:ring transition-all ${
                                                        theme === 'dark'
                                                            ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-orange-400 focus:ring-orange-500'
                                                            : 'border-gray-200 bg-white text-gray-900 focus:border-orange-500 focus:ring-orange-200'
                                                    }`}
                                                    style={{ width: 'fit-content', minWidth: '100%' }}
                                                >
                                                    <option value="">Se√ßiniz...</option>
                                                    {(Array.isArray(categoryData) ? categoryData : []).map(m => (
                                                        <option key={m} value={m}>{m}</option>
                                                    ))}
                                                </select>
                                                <div className="relative">
                                                    <input 
                                                        type="number" 
                                                        step="0.01" 
                                                        value={wallData.miktar || ''} 
                                                        onChange={(e) => updateWallCover(i, 'miktar', e.target.value)} 
                                                        placeholder="0.00" 
                                                        className={`border-2 rounded-lg px-3 py-2 text-sm w-full focus:ring transition-all pr-12 ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 focus:border-green-400 focus:ring-green-500'
                                                                : 'border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-200'
                                                        }`}
                                                    />
                                                    <span className={`absolute right-3 top-1/2 -translate-y-1/2 text-sm font-medium ${
                                                        theme === 'dark' ? 'text-gray-400' : 'text-gray-500'
                                                    }`}>m¬≤</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            </div>
                        </div>
                    );
                }

                // Kategoriye g√∂re renk ve ikon belirleme
                const getCategoryStyle = (category) => {
                    // √ñnceden tanƒ±mlƒ± stiller
                    const predefinedStyles = {
                        'Zemin': { 
                            from: 'from-emerald-50', to: 'to-green-50', border: 'border-emerald-200', 
                            icon: 'text-emerald-600', badge: 'bg-emerald-600',
                            headerFrom: 'from-emerald-500', headerTo: 'to-green-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>'
                        },
                        'Boya': { 
                            from: 'from-blue-50', to: 'to-cyan-50', border: 'border-blue-200', 
                            icon: 'text-blue-600', badge: 'bg-blue-600',
                            headerFrom: 'from-blue-500', headerTo: 'to-cyan-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>'
                        },
                        'Kaplama': { 
                            from: 'from-purple-50', to: 'to-pink-50', border: 'border-purple-200', 
                            icon: 'text-purple-600', badge: 'bg-purple-600',
                            headerFrom: 'from-purple-500', headerTo: 'to-pink-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>'
                        },
                        'Dolap': { 
                            from: 'from-amber-50', to: 'to-yellow-50', border: 'border-amber-200', 
                            icon: 'text-amber-600', badge: 'bg-amber-600',
                            headerFrom: 'from-amber-500', headerTo: 'to-yellow-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>'
                        },
                        'Tezgah': { 
                            from: 'from-orange-50', to: 'to-red-50', border: 'border-orange-200', 
                            icon: 'text-orange-600', badge: 'bg-orange-600',
                            headerFrom: 'from-orange-500', headerTo: 'to-red-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>'
                        },
                        'Panel': { 
                            from: 'from-teal-50', to: 'to-cyan-50', border: 'border-teal-200', 
                            icon: 'text-teal-600', badge: 'bg-teal-600',
                            headerFrom: 'from-teal-500', headerTo: 'to-cyan-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>'
                        },
                        'Armat√ºr': { 
                            from: 'from-indigo-50', to: 'to-purple-50', border: 'border-indigo-200', 
                            icon: 'text-indigo-600', badge: 'bg-indigo-600',
                            headerFrom: 'from-indigo-500', headerTo: 'to-purple-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>'
                        },
                        'Aksesuar': { 
                            from: 'from-pink-50', to: 'to-rose-50', border: 'border-pink-200', 
                            icon: 'text-pink-600', badge: 'bg-pink-600',
                            headerFrom: 'from-pink-500', headerTo: 'to-rose-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>'
                        },
                        'Elektrik': { 
                            from: 'from-yellow-50', to: 'to-amber-50', border: 'border-yellow-200', 
                            icon: 'text-yellow-600', badge: 'bg-yellow-600',
                            headerFrom: 'from-yellow-500', headerTo: 'to-amber-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>'
                        },
                        'Doƒürama': { 
                            from: 'from-slate-50', to: 'to-gray-50', border: 'border-slate-200', 
                            icon: 'text-slate-600', badge: 'bg-slate-600',
                            headerFrom: 'from-slate-500', headerTo: 'to-gray-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>'
                        },
                        'Tekstil': { 
                            from: 'from-rose-50', to: 'to-pink-50', border: 'border-rose-200', 
                            icon: 'text-rose-600', badge: 'bg-rose-600',
                            headerFrom: 'from-rose-500', headerTo: 'to-pink-600',
                            svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>'
                        }
                    };
                    
                    // Eƒüer √∂nceden tanƒ±mlƒ± varsa onu d√∂nd√ºr
                    if (predefinedStyles[category]) {
                        return predefinedStyles[category];
                    }
                    
                    // Dinamik renk paleti √ºret
                    const colors = [
                        { from: 'from-red-50', to: 'to-orange-50', border: 'border-red-200', icon: 'text-red-600', badge: 'bg-red-600', headerFrom: 'from-red-500', headerTo: 'to-orange-600' },
                        { from: 'from-lime-50', to: 'to-green-50', border: 'border-lime-200', icon: 'text-lime-600', badge: 'bg-lime-600', headerFrom: 'from-lime-500', headerTo: 'to-green-600' },
                        { from: 'from-sky-50', to: 'to-blue-50', border: 'border-sky-200', icon: 'text-sky-600', badge: 'bg-sky-600', headerFrom: 'from-sky-500', headerTo: 'to-blue-600' },
                        { from: 'from-violet-50', to: 'to-purple-50', border: 'border-violet-200', icon: 'text-violet-600', badge: 'bg-violet-600', headerFrom: 'from-violet-500', headerTo: 'to-purple-600' },
                        { from: 'from-fuchsia-50', to: 'to-pink-50', border: 'border-fuchsia-200', icon: 'text-fuchsia-600', badge: 'bg-fuchsia-600', headerFrom: 'from-fuchsia-500', headerTo: 'to-pink-600' },
                        { from: 'from-cyan-50', to: 'to-teal-50', border: 'border-cyan-200', icon: 'text-cyan-600', badge: 'bg-cyan-600', headerFrom: 'from-cyan-500', headerTo: 'to-teal-600' },
                        { from: 'from-orange-50', to: 'to-amber-50', border: 'border-orange-200', icon: 'text-orange-600', badge: 'bg-orange-600', headerFrom: 'from-orange-500', headerTo: 'to-amber-600' },
                        { from: 'from-green-50', to: 'to-emerald-50', border: 'border-green-200', icon: 'text-green-600', badge: 'bg-green-600', headerFrom: 'from-green-500', headerTo: 'to-emerald-600' }
                    ];
                    
                    // Kategori ismine g√∂re sabit bir renk se√ß (hash based)
                    let hash = 0;
                    for (let i = 0; i < category.length; i++) {
                        hash = category.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    const colorIndex = Math.abs(hash) % colors.length;
                    
                    return {
                        ...colors[colorIndex],
                        svg: '<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>'
                    };
                };

                const categoryStyle = getCategoryStyle(fc.category);

                return (
                    <div key={f} className={`bg-gradient-to-br ${categoryStyle.from} ${categoryStyle.to} rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 border-2 ${categoryStyle.border}`}>
                        <label className={`block text-sm font-semibold mb-4 flex items-center gap-2 ${categoryStyle.icon}`}>
                            {fc.icon ? (
                                (fc.icon.startsWith('data:image') || fc.icon.startsWith('http')) ? (
                                    <img src={fc.icon} className="w-12 h-12 object-contain" alt="icon" />
                                ) : (
                                    <span className="text-4xl">{fc.icon}</span>
                                )
                            ) : (
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" dangerouslySetInnerHTML={{ __html: categoryStyle.svg }}>
                                </svg>
                            )}
                            {fc.label}
                            {fc.unit && <span className={`ml-auto text-white text-xs px-3 py-1 rounded-full ${categoryStyle.badge}`}>{fc.unit}</span>}
                        </label>
                        <div className="flex flex-col gap-3">
                            {/* Ana Kategori Altƒ±nda Alt Gruplar Var mƒ± Kontrol */}
                            {typeof materials[fc.category] === 'object' && !Array.isArray(materials[fc.category]) ? (
                                <>
                                    {/* Alt Grup Se√ßimi */}
                                    <select 
                                        value={data[f] ? data[f].subgroup || '' : ''} 
                                        onChange={(e) => updateField(f, { ...(data[f] || {}), subgroup: e.target.value, malzeme: '' })} 
                                        className={`border-2 rounded-lg px-4 py-2.5 w-auto min-w-full focus:ring transition-all ${
                                            theme === 'dark'
                                                ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-blue-400 focus:ring-blue-500'
                                                : 'border-gray-200 bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-200'
                                        }`}
                                        style={{ width: 'fit-content', minWidth: '100%' }}
                                    >
                                        <option value="">üîπ Alt Grup Se√ßiniz</option>
                                        {Object.keys(materials[fc.category]).map(sg => (
                                            <option key={sg} value={sg}>{sg}</option>
                                        ))}
                                    </select>
                                    {/* Malzeme Se√ßimi - Sadece alt grup se√ßilmi≈üse */}
                                    {data[f] && data[f].subgroup ? (
                                        data[f].subgroup === 'Seramik' ? (
                                            /* √ñZEL SERAMƒ∞K SE√áƒ∞Mƒ∞ - Fƒ∞LTRELEME ƒ∞LE */
                                            <div className={`border-2 rounded-lg p-4 ${
                                                theme === 'dark'
                                                    ? 'border-purple-700 bg-purple-900/20'
                                                    : 'border-purple-200 bg-purple-50'
                                            }`}>
                                                <div className="grid grid-cols-2 gap-2 mb-3">
                                                    {/* Seri Filtresi */}
                                                    <select 
                                                        id={`ceramic-filter-serie-${f}`}
                                                        className={`border-2 rounded-lg px-3 py-2 text-sm focus:ring transition-all ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-purple-400'
                                                                : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500'
                                                        }`}
                                                        onChange={() => {
                                                            // Filtre deƒüi≈ütiƒüinde se√ßimi sƒ±fƒ±rla
                                                            updateField(f, { ...(data[f] || {}), malzeme: '' });
                                                        }}
                                                    >
                                                        <option value="">üè∑Ô∏è T√ºm Seriler</option>
                                                        {[...ceramicData.series].sort((a, b) => a.localeCompare(b, 'tr')).map(serie => (
                                                            <option key={serie} value={serie}>{serie}</option>
                                                        ))}
                                                    </select>
                                                    
                                                    {/* Boyut Filtresi */}
                                                    <select 
                                                        id={`ceramic-filter-size-${f}`}
                                                        className={`border-2 rounded-lg px-3 py-2 text-sm focus:ring transition-all ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-purple-400'
                                                                : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500'
                                                        }`}
                                                        onChange={() => {
                                                            // Filtre deƒüi≈ütiƒüinde se√ßimi sƒ±fƒ±rla
                                                            updateField(f, { ...(data[f] || {}), malzeme: '' });
                                                        }}
                                                    >
                                                        <option value="">üìè T√ºm Boyutlar</option>
                                                        {[...ceramicData.sizes].sort((a, b) => a.localeCompare(b, 'tr')).map(size => (
                                                            <option key={size} value={size}>{size}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                
                                                {/* Seramik Se√ßimi */}
                                                <select 
                                                    value={data[f].malzeme || ''} 
                                                    onChange={(e) => updateField(f, { ...(data[f] || {}), malzeme: e.target.value })} 
                                                    className={`w-full border-2 rounded-lg px-3 py-2.5 font-medium focus:ring transition-all ${
                                                        theme === 'dark'
                                                            ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-purple-400 focus:ring-purple-500'
                                                            : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500 focus:ring-purple-200'
                                                    }`}
                                                >
                                                    <option value="">üî∏ Seramik Se√ßiniz</option>
                                                    {(() => {
                                                        const serieFilter = document.getElementById(`ceramic-filter-serie-${f}`)?.value || '';
                                                        const sizeFilter = document.getElementById(`ceramic-filter-size-${f}`)?.value || '';
                                                        
                                                        return ceramicData.items
                                                            .filter(item => {
                                                                if (serieFilter && item.serie !== serieFilter) return false;
                                                                if (sizeFilter && item.size !== sizeFilter) return false;
                                                                return true;
                                                            })
                                                            .sort((a, b) => a.fullName.localeCompare(b.fullName, 'tr'))
                                                            .map(item => (
                                                                <option key={item.fullName} value={item.fullName}>
                                                                    {item.fullName}
                                                                </option>
                                                            ));
                                                    })()}
                                                </select>
                                                
                                                <div className={`mt-2 text-xs ${
                                                    theme === 'dark' ? 'text-purple-300' : 'text-purple-600'
                                                }`}>
                                                    üí° Seri ve boyut filtrelerini kullanarak arama yapabilirsiniz
                                                </div>
                                            </div>
                                        ) : (
                                            /* NORMAL MALZEME SE√áƒ∞Mƒ∞ */
                                            <select 
                                                value={data[f].malzeme || ''} 
                                                onChange={(e) => updateField(f, { ...(data[f] || {}), malzeme: e.target.value })} 
                                                className={`border-2 rounded-lg px-4 py-2.5 w-auto min-w-full focus:ring transition-all ${
                                                    theme === 'dark'
                                                        ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-blue-400 focus:ring-blue-500'
                                                        : 'border-gray-200 bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-200'
                                                }`}
                                                style={{ width: 'fit-content', minWidth: '100%' }}
                                            >
                                                <option value="">üî∏ Malzeme Se√ßiniz</option>
                                                {(materials[fc.category][data[f].subgroup] || []).map(m => (
                                                    <option key={m} value={m}>{m}</option>
                                                ))}
                                            </select>
                                        )
                                    ) : (
                                        <div className="border-2 border-dashed border-gray-300 rounded-lg px-4 py-3 bg-white text-gray-400 flex items-center text-sm">
                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            √ñnce alt grup se√ßiniz
                                        </div>
                                    )}
                                </>
                            ) : (
                                /* Eski D√ºz Liste Yapƒ±sƒ± - Geriye Uyumluluk */
                                <select 
                                    value={data[f] ? data[f].malzeme || '' : ''} 
                                    onChange={(e) => updateField(f, { ...(data[f] || {}), malzeme: e.target.value })} 
                                    className="border-2 border-gray-200 bg-white rounded-lg px-4 py-2.5 w-auto min-w-full focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all"
                                    style={{ width: 'fit-content', minWidth: '100%' }}
                                >
                                    <option value="">Se√ßiniz...</option>
                                    {(Array.isArray(materials[fc.category]) ? materials[fc.category] : []).map(m => (
                                        <option key={m} value={m}>{m}</option>
                                    ))}
                                </select>
                            )}
                        </div>
                        {/* Miktar/Detay - Alt satƒ±r */}
                        {(data[f] && data[f].malzeme) && (
                            <div className="mt-3 pt-3 border-t-2 border-white">
                                {fc.unit ? (
                                    <div className="relative">
                                        <input 
                                            type="number" 
                                            step="0.01" 
                                            value={data[f].miktar || ''} 
                                            onChange={(e) => updateField(f, { ...(data[f] || {}), miktar: e.target.value })} 
                                            placeholder="0.00" 
                                            className={`border-2 rounded-lg px-4 py-2.5 w-full focus:ring transition-all pr-16 ${
                                                theme === 'dark'
                                                    ? 'border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 focus:border-green-400 focus:ring-green-500'
                                                    : 'border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-200'
                                            }`}
                                        />
                                        <span className={`absolute right-4 top-1/2 -translate-y-1/2 text-white text-sm font-bold px-2 py-1 rounded ${categoryStyle.badge}`}>{fc.unit}</span>
                                    </div>
                                ) : (
                                    <input 
                                        type="text" 
                                        value={data[f].miktar || ''} 
                                        onChange={(e) => updateField(f, { ...(data[f] || {}), miktar: e.target.value })} 
                                        placeholder="Detay giriniz..." 
                                        className={`border-2 rounded-lg px-4 py-2.5 w-full focus:ring transition-all ${
                                            theme === 'dark'
                                                ? 'border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 focus:border-green-400 focus:ring-green-500'
                                                : 'border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-200'
                                        }`} 
                                    />
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            const room = allRooms.find(r => r.id === currentRoom);

            // Auth y√ºkleniyor ekranƒ±
            if (authLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                            <p className="text-white text-xl font-semibold">Y√ºkleniyor...</p>
                        </div>
                    </div>
                );
            }

            // Giri≈ü yapƒ±lmamƒ±≈üsa login ekranƒ±nƒ± g√∂ster
            if (!user && firebaseEnabled) {
                return <LoginScreen />;
            }

            return (
                <div className={`min-h-screen p-4 transition-colors duration-300 ${
                    theme === 'dark' 
                        ? 'bg-gray-900' 
                        : 'bg-gray-100'
                }`}>
                    {/* VARSAYILAN AYARLAR MODAL */}
                    {showDefaultSettings && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-lg">
                                            <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h2 className={`text-2xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                Sistem Ayarlarƒ±
                                            </h2>
                                            <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                Kategoriler, alanlar ve varsayƒ±lan deƒüerleri y√∂netin
                                            </p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => setShowDefaultSettings(false)}
                                        className={`text-3xl hover:opacity-70 transition-opacity ${theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}`}
                                    >√ó</button>
                                </div>

                                <div className="flex-1 overflow-y-auto space-y-6">
                                    {/* Kategori Y√∂netimi */}
                                    <div className={`p-4 rounded-lg border-2 ${theme === 'dark' ? 'border-blue-700 bg-blue-900 bg-opacity-20' : 'border-blue-300 bg-blue-50'}`}>
                                        <h3 className={`text-lg font-bold mb-4 ${theme === 'dark' ? 'text-blue-200' : 'text-blue-800'}`}>
                                            üìÇ Kategori Y√∂netimi
                                        </h3>
                                        
                                        {/* Yeni Kategori Ekle */}
                                        <div className="flex gap-2 mb-4">
                                            <input
                                                type="text"
                                                value={newCategoryName}
                                                onChange={(e) => setNewCategoryName(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && addCategory()}
                                                placeholder="Yeni kategori adƒ±..."
                                                className={`flex-1 px-3 py-2 border rounded-lg ${
                                                    theme === 'dark'
                                                        ? 'border-gray-600 bg-gray-700 text-white placeholder-gray-400'
                                                        : 'border-gray-300 bg-white placeholder-gray-400'
                                                }`}
                                            />
                                            <button
                                                onClick={addCategory}
                                                className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center gap-2"
                                            >
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                                </svg>
                                                Ekle
                                            </button>
                                        </div>
                                        
                                        {/* Mevcut Kategoriler */}
                                        <div className="space-y-2">
                                            {Object.keys(materials).sort((a, b) => 
                                                a.toLocaleLowerCase('tr-TR').localeCompare(b.toLocaleLowerCase('tr-TR'), 'tr-TR')
                                            ).map(cat => (
                                                <div key={cat} className={`p-3 rounded-lg border flex items-center justify-between ${
                                                    theme === 'dark' ? 'border-gray-600 bg-gray-700' : 'border-gray-300 bg-white'
                                                }`}>
                                                    {editingCategory === cat ? (
                                                        <input
                                                            type="text"
                                                            defaultValue={cat}
                                                            autoFocus
                                                            onKeyPress={(e) => {
                                                                if (e.key === 'Enter') {
                                                                    renameCategory(cat, e.target.value);
                                                                }
                                                            }}
                                                            onBlur={(e) => renameCategory(cat, e.target.value)}
                                                            className={`flex-1 px-2 py-1 border rounded ${
                                                                theme === 'dark'
                                                                    ? 'border-gray-500 bg-gray-600 text-white'
                                                                    : 'border-gray-300 bg-white'
                                                            }`}
                                                        />
                                                    ) : (
                                                        <span className={`flex-1 font-semibold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                            üìÅ {cat}
                                                        </span>
                                                    )}
                                                    
                                                    <div className="flex gap-2">
                                                        {editingCategory === cat ? (
                                                            <button
                                                                onClick={() => setEditingCategory(null)}
                                                                className="px-2 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
                                                            >
                                                                ƒ∞ptal
                                                            </button>
                                                        ) : (
                                                            <>
                                                                <button
                                                                    onClick={() => {
                                                                        // Alt gruplarƒ± g√∂ster/d√ºzenle
                                                                        const subgroupsExist = typeof materials[cat] === 'object' && !Array.isArray(materials[cat]) && Object.keys(materials[cat]).length > 0;
                                                                        
                                                                        if (!subgroupsExist) {
                                                                            const addSubgroup = confirm(`"${cat}" kategorisine alt grup eklemek ister misiniz?\n\nAlt gruplar malzemelerinizi daha organize etmenizi saƒülar.\n(√ñrn: Zemin ‚Üí Seramik, Parke, Granit)`);
                                                                            if (addSubgroup) {
                                                                                const newSubgroup = prompt(`${cat} i√ßin yeni alt grup adƒ±:`);
                                                                                if (newSubgroup && newSubgroup.trim()) {
                                                                                    const newMat = { ...materials };
                                                                                    if (Array.isArray(newMat[cat])) {
                                                                                        // D√ºz listeden hiyerar≈üik yapƒ±ya d√∂n√º≈üt√ºr
                                                                                        newMat[cat] = { [newSubgroup.trim()]: [] };
                                                                                    } else {
                                                                                        newMat[cat][newSubgroup.trim()] = [];
                                                                                    }
                                                                                    setMaterials(newMat);
                                                                                    localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                                    alert(`‚úÖ "${newSubgroup.trim()}" alt grubu eklendi!`);
                                                                                }
                                                                            }
                                                                        } else {
                                                                            alert(`"${cat}" kategorisinde ${Object.keys(materials[cat]).length} alt grup var.\n\nAlt gruplarƒ± y√∂netmek i√ßin "Malzeme DB" men√ºs√ºn√º kullanƒ±n.`);
                                                                        }
                                                                    }}
                                                                    className="px-3 py-1 text-sm bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded hover:from-purple-600 hover:to-pink-700 transition-colors flex items-center gap-1"
                                                                    title="Alt Gruplarƒ± Y√∂net"
                                                                >
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                                                    </svg>
                                                                    {typeof materials[cat] === 'object' && !Array.isArray(materials[cat]) && Object.keys(materials[cat]).length > 0
                                                                        ? `${Object.keys(materials[cat]).length} Alt Grup`
                                                                        : 'Alt Grup Ekle'
                                                                    }
                                                                </button>
                                                                <button
                                                                    onClick={() => setEditingCategory(cat)}
                                                                    className="p-2 text-blue-600 hover:bg-blue-100 rounded transition-colors"
                                                                    title="Yeniden Adlandƒ±r"
                                                                >
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                    </svg>
                                                                </button>
                                                                <button
                                                                    onClick={() => deleteCategory(cat)}
                                                                    className="p-2 text-red-600 hover:bg-red-100 rounded transition-colors"
                                                                    title="Sil"
                                                                >
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                    </svg>
                                                                </button>
                                                            </>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Alan Tanƒ±mlarƒ± */}
                                    <div>
                                        <h3 className={`text-lg font-bold mb-4 ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                            üè∑Ô∏è Alan Tanƒ±mlarƒ±
                                        </h3>
                                    </div>
                                    
                                    {/* Field Labels - Kategorilere G√∂re Gruplandƒ±rƒ±lmƒ±≈ü */}
                                    {(() => {
                                        // fieldLabels'ƒ±n kendi sƒ±rasƒ±nƒ± kullan
                                        const grouped = {};
                                        const fieldOrder = Object.keys(fieldLabels);
                                        
                                        // fieldLabels'daki alanlarƒ± sƒ±rasƒ±yla kategorilere ekle
                                        Object.entries(fieldLabels).forEach(([key, config]) => {
                                            const category = config.category || 'Diƒüer';
                                            if (!grouped[category]) grouped[category] = [];
                                            grouped[category].push([key, config]);
                                        });
                                        
                                        // Her kategorideki alanlarƒ± fieldLabels sƒ±rasƒ±na g√∂re sƒ±rala
                                        Object.keys(grouped).forEach(cat => {
                                            grouped[cat].sort((a, b) => {
                                                return fieldOrder.indexOf(a[0]) - fieldOrder.indexOf(b[0]);
                                            });
                                        });
                                        
                                        // Kategorileri fieldLabels'da ilk g√∂r√ºnme sƒ±rasƒ±na g√∂re sƒ±rala
                                        const categoryFirstAppearance = {};
                                        fieldOrder.forEach((fieldKey, idx) => {
                                            const fc = fieldLabels[fieldKey];
                                            const cat = fc.category || 'Diƒüer';
                                            if (categoryFirstAppearance[cat] === undefined) {
                                                categoryFirstAppearance[cat] = idx;
                                            }
                                        });
                                        
                                        const categories = Object.keys(grouped).sort((a, b) => {
                                            return categoryFirstAppearance[a] - categoryFirstAppearance[b];
                                        });
                                        
                                        return categories.map(category => (
                                            <div key={category}>
                                                {/* Kategori Ba≈ülƒ±ƒüƒ± */}
                                                <div className={`mb-3 mt-6 first:mt-0 flex items-center gap-3 ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                    <div className="flex-1 h-px bg-gradient-to-r from-transparent via-gray-400 to-transparent"></div>
                                                    <h3 className="text-lg font-bold px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg shadow-md">
                                                        üìÅ {category}
                                                    </h3>
                                                    <div className="flex-1 h-px bg-gradient-to-r from-transparent via-gray-400 to-transparent"></div>
                                                </div>
                                                
                                                {/* Kategorideki Alanlar */}
                                                <div className="space-y-3">
                                                    {grouped[category].map(([key, config]) => (
                                                        <div key={key} className={`p-4 rounded-lg border-2 ${theme === 'dark' ? 'border-gray-700 bg-gray-700' : 'border-gray-200 bg-gray-50'}`}>
                                                            {/* Alan Silme Butonu */}
                                                            <div className="flex justify-end mb-2">
                                                                <button
                                                                    onClick={() => deleteField(key)}
                                                                    className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors flex items-center gap-1"
                                                                    title="Alanƒ± Sil"
                                                                >
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                    </svg>
                                                                    Sil
                                                                </button>
                                                            </div>
                                            <div className="grid grid-cols-4 gap-4">
                                                <div>
                                                    <label className={`block text-sm font-semibold mb-2 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                        Alan Adƒ± (Kod: {key})
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={config.label}
                                                        onChange={(e) => {
                                                            setFieldLabels({
                                                                ...fieldLabels,
                                                                [key]: { ...config, label: e.target.value }
                                                            });
                                                        }}
                                                        className={`w-full px-3 py-2 border rounded-lg ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-600 text-white'
                                                                : 'border-gray-300 bg-white'
                                                        }`}
                                                    />
                                                </div>
                                                <div>
                                                    <label className={`block text-sm font-semibold mb-2 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                        Kategori
                                                    </label>
                                                    <select
                                                        value={config.category || ''}
                                                        onChange={(e) => {
                                                            setFieldLabels({
                                                                ...fieldLabels,
                                                                [key]: { ...config, category: e.target.value }
                                                            });
                                                        }}
                                                        className={`w-full px-3 py-2 border rounded-lg ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-600 text-white'
                                                                : 'border-gray-300 bg-white'
                                                        }`}
                                                    >
                                                        <option value="">Kategori Se√ß</option>
                                                        {Object.keys(materials).sort((a, b) => 
                                                            a.toLocaleLowerCase('tr-TR').localeCompare(b.toLocaleLowerCase('tr-TR'), 'tr-TR')
                                                        ).map(cat => (
                                                            <option key={cat} value={cat}>{cat}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className={`block text-sm font-semibold mb-2 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                        Birim
                                                    </label>
                                                    <input
                                                        type="text"
                                                        value={config.unit || ''}
                                                        onChange={(e) => {
                                                            setFieldLabels({
                                                                ...fieldLabels,
                                                                [key]: { ...config, unit: e.target.value }
                                                            });
                                                        }}
                                                        placeholder="m¬≤, adet, vs."
                                                        className={`w-full px-3 py-2 border rounded-lg ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-600 text-white placeholder-gray-400'
                                                                : 'border-gray-300 bg-white placeholder-gray-400'
                                                        }`}
                                                    />
                                                </div>
                                                <div>
                                                    <label className={`block text-sm font-semibold mb-2 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                        ƒ∞kon
                                                    </label>
                                                    <button
                                                        onClick={() => {
                                                            setSelectedFieldForIcon(key);
                                                            setShowIconPicker(true);
                                                        }}
                                                        className={`w-full px-3 py-2 border-2 rounded-lg transition-all flex items-center justify-center gap-2 ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-600 text-white hover:border-purple-500'
                                                                : 'border-gray-300 bg-white hover:border-purple-500'
                                                        }`}
                                                        title="ƒ∞kon se√ß"
                                                    >
                                                        {config.icon ? (
                                                            (config.icon.startsWith('data:image') || config.icon.startsWith('http')) ? (
                                                                <img src={config.icon} className="w-16 h-16 object-contain" alt="icon" />
                                                            ) : (
                                                                <span className="text-5xl">{config.icon}</span>
                                                            )
                                                        ) : (
                                                            <>
                                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                </svg>
                                                                ƒ∞kon Se√ß
                                                            </>
                                                        )}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                                    ))}
                                                    
                                                    {/* Bu Kategoriye Yeni Alan Ekle */}
                                                    <div 
                                                        onClick={() => {
                                                            const fieldId = prompt('Yeni alan kodu (√∂rn: yeni_alan, lavabo_tipi):\n\nNot: K√º√ß√ºk harf, rakam ve alt √ßizgi kullanƒ±n. Bo≈üluk kullanmayƒ±n.');
                                                            if (!fieldId || !fieldId.trim()) return;
                                                            
                                                            const cleanId = fieldId.trim().toLowerCase().replace(/[^a-z0-9_]/g, '_');
                                                            
                                                            if (fieldLabels[cleanId]) {
                                                                alert('Bu alan kodu zaten mevcut!');
                                                                return;
                                                            }
                                                            
                                                            const fieldLabel = prompt('Alan adƒ± (g√∂r√ºnen isim):');
                                                            if (!fieldLabel || !fieldLabel.trim()) return;
                                                            
                                                            const fieldUnit = prompt('Birim (m¬≤, adet, vb.) - ƒ∞steƒüe baƒülƒ±:') || '';
                                                            
                                                            const newFieldLabels = {
                                                                ...fieldLabels,
                                                                [cleanId]: {
                                                                    label: fieldLabel.trim(),
                                                                    unit: fieldUnit.trim(),
                                                                    category: category
                                                                }
                                                            };
                                                            
                                                            setFieldLabels(newFieldLabels);
                                                            localStorage.setItem('field_labels', JSON.stringify(newFieldLabels));
                                                            alert(`‚úÖ "${fieldLabel}" alanƒ± "${category}" kategorisine eklendi!`);
                                                        }}
                                                        className={`p-3 rounded-lg border-2 border-dashed cursor-pointer transition-all hover:border-green-500 ${
                                                            theme === 'dark' 
                                                                ? 'border-green-700 bg-green-900 bg-opacity-10 hover:bg-green-900 hover:bg-opacity-20' 
                                                                : 'border-green-300 bg-green-50 hover:bg-green-100'
                                                        }`}
                                                    >
                                                        <div className="flex items-center justify-center gap-2 py-2">
                                                            <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                                            </svg>
                                                            <span className={`text-sm font-semibold ${theme === 'dark' ? 'text-green-400' : 'text-green-700'}`}>
                                                                Yeni Alan Ekle
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ));
                                    })()}
                                </div>

                                <div className="flex gap-3 mt-6 pt-4 border-t">
                                    <button
                                        onClick={() => {
                                            if (confirm('Varsayƒ±lan deƒüerlere sƒ±fƒ±rlamak istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!')) {
                                                setFieldLabels(DEFAULT_FIELD_LABELS);
                                                alert('‚úÖ Varsayƒ±lan deƒüerler geri y√ºklendi!');
                                            }
                                        }}
                                        className={`px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-red-600 text-white hover:bg-red-700'
                                                : 'bg-red-500 text-white hover:bg-red-600'
                                        }`}
                                    >
                                        üîÑ Sƒ±fƒ±rla
                                    </button>
                                    <button
                                        onClick={() => setShowDefaultSettings(false)}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-200 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        Kapat
                                    </button>
                                    <button
                                        onClick={() => {
                                            // fieldLabels'ƒ± alfabetik sƒ±rala
                                            const sortedEntries = Object.entries(fieldLabels).sort((a, b) => {
                                                const categoryCompare = (a[1].category || 'Diƒüer').toLocaleLowerCase('tr-TR')
                                                    .localeCompare((b[1].category || 'Diƒüer').toLocaleLowerCase('tr-TR'), 'tr-TR');
                                                if (categoryCompare !== 0) return categoryCompare;
                                                return a[1].label.toLocaleLowerCase('tr-TR')
                                                    .localeCompare(b[1].label.toLocaleLowerCase('tr-TR'), 'tr-TR');
                                            });
                                            
                                            const sortedFieldLabels = Object.fromEntries(sortedEntries);
                                            setFieldLabels(sortedFieldLabels);
                                            localStorage.setItem('field_labels', JSON.stringify(sortedFieldLabels));
                                            
                                            alert('‚úÖ Ayarlar kaydedildi ve alfabetik sƒ±ralandƒ±!\n\nDeƒüi≈üiklikler t√ºm yeni veriler i√ßin ge√ßerli olacak.');
                                        }}
                                        className="flex-1 px-4 py-3 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-lg font-semibold hover:from-emerald-700 hover:to-teal-700 transition-all"
                                    >
                                        üíæ Kaydet
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showDB && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between mb-4">
                                    <h2 className={`text-xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Malzeme Veritabani</h2>
                                    <div className="flex gap-2 items-center">
                                        <button onClick={() => {
                                            if (confirm('Malzeme veritabanini varsayilan degerlere sifirlamak istediginize emin misiniz?\n\nBu islem geri alinamaz!')) {
                                                setMaterials(DEFAULT_MATERIALS);
                                                localStorage.setItem('material_database', JSON.stringify(DEFAULT_MATERIALS));
                                                alert('Malzeme veritabani sifirandi!');
                                            }
                                        }} className="px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600">üîÑ Sƒ±fƒ±rla</button>
                                        <button onClick={() => setShowDB(false)} className={`text-2xl ${theme === 'dark' ? 'text-gray-300 hover:text-white' : 'text-gray-600 hover:text-gray-900'}`}>√ó</button>
                                    </div>
                                </div>
                                
                                {/* Arama Kutusu */}
                                <div className="mb-4">
                                    <div className="relative">
                                        <input
                                            type="text"
                                            placeholder="Malzeme ara..."
                                            value={searchMaterial}
                                            onChange={(e) => setSearchMaterial(e.target.value)}
                                            className={`w-full pl-10 pr-4 py-2.5 border-2 rounded-lg focus:ring-2 transition-all ${
                                                theme === 'dark'
                                                    ? 'border-gray-600 bg-gray-700 text-white placeholder-gray-400 focus:border-blue-400 focus:ring-blue-500'
                                                    : 'border-gray-300 bg-white text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:ring-blue-200'
                                            }`}
                                        />
                                        <svg className="absolute left-3 top-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                
                                {/* Sekmeler */}
                                <div className={`flex gap-2 mb-4 overflow-x-auto pb-2 border-b-2 flex-shrink-0 ${
                                    theme === 'dark' ? 'border-gray-700' : 'border-gray-300'
                                }`}>
                                    {Object.keys(materials).map((cat, index) => (
                                        <button
                                            key={cat}
                                            draggable
                                            onDragStart={() => setDraggedTab(index)}
                                            onDragOver={(e) => {
                                                e.preventDefault();
                                                e.currentTarget.style.borderLeft = '3px solid #3b82f6';
                                            }}
                                            onDragLeave={(e) => {
                                                e.currentTarget.style.borderLeft = 'none';
                                            }}
                                            onDrop={(e) => {
                                                e.preventDefault();
                                                e.currentTarget.style.borderLeft = 'none';
                                                if (draggedTab !== null && draggedTab !== index) {
                                                    reorderTabs(draggedTab, index);
                                                }
                                                setDraggedTab(null);
                                            }}
                                            onClick={() => setActiveDBTab(cat)}
                                            className={`px-4 py-2 rounded-t-lg font-semibold whitespace-nowrap transition-all cursor-move ${
                                                activeDBTab === cat 
                                                    ? cat === 'Seramik'
                                                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg'
                                                        : 'bg-blue-500 text-white shadow-md'
                                                    : cat === 'Seramik'
                                                        ? theme === 'dark'
                                                            ? 'bg-purple-900 text-purple-200 hover:bg-purple-800'
                                                            : 'bg-purple-100 text-purple-700 hover:bg-purple-200'
                                                        : theme === 'dark'
                                                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }`}
                                            title={cat === 'Seramik' ? 'üéØ √ñzel Seramik Veri Tabanƒ±' : 'S√ºr√ºkleyerek sƒ±ra deƒüi≈ütir'}
                                        >
                                            {cat === 'Seramik' ? 'üéØ ' : '‚†ø '}{cat}
                                        </button>
                                    ))}
                                </div>
                                
                                {/* Sekme ƒ∞√ßeriƒüi */}
                                <div className="flex-1 overflow-auto">
                                    {/* √ñZEL SERAMƒ∞K UI */}
                                    {activeDBTab === 'Seramik' && (
                                        <div className={`border-2 rounded-lg p-4 ${
                                            theme === 'dark'
                                                ? 'border-gray-700 bg-gradient-to-br from-gray-800 to-gray-750'
                                                : 'border-gray-300 bg-gradient-to-br from-white to-gray-50'
                                        }`}>
                                            <div className={`flex justify-between items-center mb-4 pb-3 border-b-2 ${
                                                theme === 'dark' ? 'border-gray-700' : 'border-gray-200'
                                            }`}>
                                                <h3 className={`font-bold text-xl flex items-center gap-2 ${
                                                    theme === 'dark' ? 'text-blue-400' : 'text-blue-700'
                                                }`}>
                                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"></path>
                                                    </svg>
                                                    Seramik Veri Tabanƒ±
                                                </h3>
                                            </div>

                                            {/* Seri ve Boyut Y√∂netimi */}
                                            <div className="grid grid-cols-2 gap-4 mb-6">
                                                {/* Seri Y√∂netimi */}
                                                <div className={`border-2 rounded-lg p-4 ${
                                                    theme === 'dark' ? 'border-blue-800 bg-blue-900/20' : 'border-blue-200 bg-blue-50'
                                                }`}>
                                                    <h4 className={`font-bold mb-3 flex items-center gap-2 ${
                                                        theme === 'dark' ? 'text-blue-300' : 'text-blue-700'
                                                    }`}>
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                                        </svg>
                                                        √úr√ºn Serileri
                                                    </h4>
                                                    
                                                    {/* Yeni Seri Ekle */}
                                                    <div className="flex gap-2 mb-3">
                                                        <input 
                                                            type="text" 
                                                            id="new-serie"
                                                            placeholder="Yeni seri ekle..."
                                                            className={`flex-1 border-2 rounded-lg px-3 py-2 text-sm focus:ring-2 transition-all ${
                                                                theme === 'dark'
                                                                    ? 'border-blue-700 bg-gray-800 text-gray-100 focus:border-blue-500 focus:ring-blue-500/30'
                                                                    : 'border-blue-300 bg-white text-gray-900 focus:border-blue-500 focus:ring-blue-200'
                                                            }`}
                                                            onKeyPress={(e) => {
                                                                if (e.key === 'Enter') {
                                                                    const inp = document.getElementById('new-serie');
                                                                    if (inp.value.trim()) {
                                                                        addCeramicSerie(inp.value.trim());
                                                                        inp.value = '';
                                                                    }
                                                                }
                                                            }}
                                                        />
                                                        <button 
                                                            onClick={() => {
                                                                const inp = document.getElementById('new-serie');
                                                                if (inp.value.trim()) {
                                                                    addCeramicSerie(inp.value.trim());
                                                                    inp.value = '';
                                                                }
                                                            }}
                                                            className="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-sm font-bold hover:from-blue-600 hover:to-blue-700 shadow-md hover:shadow-lg transition-all"
                                                        >
                                                            + Ekle
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Seri Listesi */}
                                                    <div className="space-y-2 max-h-40 overflow-auto">
                                                        {[...ceramicData.series].sort((a, b) => a.localeCompare(b, 'tr')).map(serie => (
                                                            <div key={serie} className={`flex justify-between items-center px-3 py-2 rounded-lg group transition-all ${
                                                                theme === 'dark'
                                                                    ? 'bg-gray-800 hover:bg-gray-700 border border-gray-700'
                                                                    : 'bg-white hover:bg-blue-50 border border-blue-200'
                                                            }`}>
                                                                <span className={`font-medium ${
                                                                    theme === 'dark' ? 'text-gray-200' : 'text-gray-800'
                                                                }`}>{serie}</span>
                                                                <button
                                                                    onClick={() => deleteCeramicSerie(serie)}
                                                                    className="px-2 py-1 bg-red-500 text-white rounded text-xs font-semibold hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-all"
                                                                >
                                                                    Sil
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                {/* Boyut Y√∂netimi */}
                                                <div className={`border-2 rounded-lg p-4 ${
                                                    theme === 'dark' ? 'border-green-800 bg-green-900/20' : 'border-green-200 bg-green-50'
                                                }`}>
                                                    <h4 className={`font-bold mb-3 flex items-center gap-2 ${
                                                        theme === 'dark' ? 'text-green-300' : 'text-green-700'
                                                    }`}>
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                                        </svg>
                                                        Boyutlar
                                                    </h4>
                                                    
                                                    {/* Yeni Boyut Ekle */}
                                                    <div className="flex gap-2 mb-3">
                                                        <input 
                                                            type="text" 
                                                            id="new-size"
                                                            placeholder="√ñrn: 60x120"
                                                            className={`flex-1 border-2 rounded-lg px-3 py-2 text-sm focus:ring-2 transition-all ${
                                                                theme === 'dark'
                                                                    ? 'border-green-700 bg-gray-800 text-gray-100 focus:border-green-500 focus:ring-green-500/30'
                                                                    : 'border-green-300 bg-white text-gray-900 focus:border-green-500 focus:ring-green-200'
                                                            }`}
                                                            onKeyPress={(e) => {
                                                                if (e.key === 'Enter') {
                                                                    const inp = document.getElementById('new-size');
                                                                    if (inp.value.trim()) {
                                                                        addCeramicSize(inp.value.trim());
                                                                        inp.value = '';
                                                                    }
                                                                }
                                                            }}
                                                        />
                                                        <button 
                                                            onClick={() => {
                                                                const inp = document.getElementById('new-size');
                                                                if (inp.value.trim()) {
                                                                    addCeramicSize(inp.value.trim());
                                                                    inp.value = '';
                                                                }
                                                            }}
                                                            className="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg text-sm font-bold hover:from-green-600 hover:to-green-700 shadow-md hover:shadow-lg transition-all"
                                                        >
                                                            + Ekle
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Boyut Listesi */}
                                                    <div className="space-y-2 max-h-40 overflow-auto">
                                                        {[...ceramicData.sizes].sort((a, b) => a.localeCompare(b, 'tr')).map(size => (
                                                            <div key={size} className={`flex justify-between items-center px-3 py-2 rounded-lg group transition-all ${
                                                                theme === 'dark'
                                                                    ? 'bg-gray-800 hover:bg-gray-700 border border-gray-700'
                                                                    : 'bg-white hover:bg-green-50 border border-green-200'
                                                            }`}>
                                                                <span className={`font-medium ${
                                                                    theme === 'dark' ? 'text-gray-200' : 'text-gray-800'
                                                                }`}>{size}</span>
                                                                <button
                                                                    onClick={() => deleteCeramicSize(size)}
                                                                    className="px-2 py-1 bg-red-500 text-white rounded text-xs font-semibold hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-all"
                                                                >
                                                                    Sil
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Seramik Ekleme Formu */}
                                            <div className={`border-2 rounded-lg p-4 mb-4 ${
                                                theme === 'dark' ? 'border-purple-800 bg-purple-900/20' : 'border-purple-200 bg-purple-50'
                                            }`}>
                                                <h4 className={`font-bold mb-3 flex items-center gap-2 ${
                                                    theme === 'dark' ? 'text-purple-300' : 'text-purple-700'
                                                }`}>
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                                    </svg>
                                                    Yeni Seramik Ekle
                                                </h4>
                                                
                                                <div className="grid grid-cols-4 gap-3">
                                                    <select 
                                                        id="ceramic-serie"
                                                        className={`border-2 rounded-lg px-3 py-2.5 text-sm font-medium focus:ring-2 transition-all ${
                                                            theme === 'dark'
                                                                ? 'border-gray-700 bg-gray-800 text-gray-100 focus:border-purple-500 focus:ring-purple-500/30'
                                                                : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500 focus:ring-purple-200'
                                                        }`}
                                                    >
                                                        <option value="">Seri Se√ßin</option>
                                                        {[...ceramicData.series].sort((a, b) => a.localeCompare(b, 'tr')).map(serie => (
                                                            <option key={serie} value={serie}>{serie}</option>
                                                        ))}
                                                    </select>
                                                    
                                                    <input 
                                                        type="text" 
                                                        id="ceramic-name"
                                                        placeholder="√úr√ºn Adƒ± (Excel'den √ßoklu yapƒ±≈ütƒ±r)"
                                                        className={`col-span-2 border-2 rounded-lg px-3 py-2.5 text-sm font-medium focus:ring-2 transition-all ${
                                                            theme === 'dark'
                                                                ? 'border-gray-700 bg-gray-800 text-gray-100 focus:border-purple-500 focus:ring-purple-500/30'
                                                                : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500 focus:ring-purple-200'
                                                        }`}
                                                        onPaste={(e) => {
                                                            // Paste edilen metni al
                                                            const pastedText = e.clipboardData.getData('text');
                                                            
                                                            // Satƒ±rlara ayƒ±r
                                                            const lines = pastedText.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
                                                            
                                                            // Eƒüer birden fazla satƒ±r varsa toplu ekleme
                                                            if (lines.length > 1) {
                                                                e.preventDefault(); // Varsayƒ±lan paste'i engelle
                                                                
                                                                // Seri ve boyut se√ßilmi≈ü mi kontrol et
                                                                const serie = document.getElementById('ceramic-serie').value;
                                                                const size = document.getElementById('ceramic-size').value;
                                                                
                                                                if (!serie || !size) {
                                                                    alert('‚ö†Ô∏è √ñnce Seri ve Boyut se√ßiniz!\n\nToplu ekleme i√ßin:\n1. Seri se√ßin\n2. Boyut se√ßin\n3. Excel\'den √ºr√ºn adlarƒ±nƒ± yapƒ±≈ütƒ±rƒ±n');
                                                                    return;
                                                                }
                                                                
                                                                let addedCount = 0;
                                                                let skippedCount = 0;
                                                                const newData = { ...ceramicData };
                                                                
                                                                lines.forEach(productName => {
                                                                    if (!productName) return;
                                                                    
                                                                    const fullName = `${serie} - ${productName} (${size})`;
                                                                    
                                                                    // Aynƒ± seramik var mƒ± kontrol et
                                                                    const exists = newData.items.some(item => 
                                                                        item.serie === serie && item.name === productName && item.size === size
                                                                    );
                                                                    
                                                                    if (!exists) {
                                                                        newData.items.push({
                                                                            serie: serie,
                                                                            name: productName,
                                                                            size: size,
                                                                            fullName: fullName
                                                                        });
                                                                        addedCount++;
                                                                    } else {
                                                                        skippedCount++;
                                                                    }
                                                                });
                                                                
                                                                setCeramicData(newData);
                                                                localStorage.setItem('ceramic_data', JSON.stringify(newData));
                                                                
                                                                // Input'u temizle
                                                                const inp = document.getElementById('ceramic-name');
                                                                if (inp) inp.value = '';
                                                                
                                                                // Bildirim g√∂ster
                                                                let message = `‚úÖ ${addedCount} seramik eklendi!`;
                                                                if (skippedCount > 0) {
                                                                    message += `\n‚ö†Ô∏è ${skippedCount} seramik zaten mevcut (atlandƒ±)`;
                                                                }
                                                                alert(message);
                                                            }
                                                            // Tek satƒ±rsa normal paste devam etsin
                                                        }}
                                                    />
                                                    
                                                    <select 
                                                        id="ceramic-size"
                                                        className={`border-2 rounded-lg px-3 py-2.5 text-sm font-medium focus:ring-2 transition-all ${
                                                            theme === 'dark'
                                                                ? 'border-gray-700 bg-gray-800 text-gray-100 focus:border-purple-500 focus:ring-purple-500/30'
                                                                : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500 focus:ring-purple-200'
                                                        }`}
                                                    >
                                                        <option value="">Boyut Se√ßin</option>
                                                        {[...ceramicData.sizes].sort((a, b) => a.localeCompare(b, 'tr')).map(size => (
                                                            <option key={size} value={size}>{size}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                
                                                <button 
                                                    onClick={() => {
                                                        const serie = document.getElementById('ceramic-serie').value;
                                                        const name = document.getElementById('ceramic-name').value;
                                                        const size = document.getElementById('ceramic-size').value;
                                                        
                                                        if (addCeramicItem(serie, name, size)) {
                                                            document.getElementById('ceramic-serie').value = '';
                                                            document.getElementById('ceramic-name').value = '';
                                                            document.getElementById('ceramic-size').value = '';
                                                        }
                                                    }}
                                                    className="w-full mt-3 px-4 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg font-bold hover:from-purple-600 hover:to-purple-700 shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2"
                                                >
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                                    </svg>
                                                    Seramik Ekle
                                                </button>
                                            </div>

                                            {/* Seramik Listesi */}
                                            <div className={`border-2 rounded-lg p-4 ${
                                                theme === 'dark' ? 'border-gray-700' : 'border-gray-300'
                                            }`}>
                                                <h4 className={`font-bold mb-3 ${
                                                    theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                                }`}>
                                                    Kayƒ±tlƒ± Seramikler ({ceramicData.items.length})
                                                </h4>
                                                
                                                <div className="space-y-2 max-h-96 overflow-auto">
                                                    {ceramicData.items
                                                        .sort((a, b) => a.fullName.localeCompare(b.fullName, 'tr'))
                                                        .map((item, idx) => (
                                                        <div key={idx} className={`flex justify-between items-center px-4 py-3 rounded-lg group transition-all ${
                                                            theme === 'dark'
                                                                ? 'bg-gray-800 hover:bg-gray-700 border border-gray-700'
                                                                : 'bg-white hover:bg-gray-50 border-2 border-gray-200'
                                                        }`}>
                                                            <div className="flex-1">
                                                                <div className={`font-medium ${
                                                                    theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                                                }`}>
                                                                    {item.fullName}
                                                                </div>
                                                                <div className="flex gap-2 mt-1">
                                                                    <span className={`text-xs px-2 py-0.5 rounded ${
                                                                        theme === 'dark' ? 'bg-blue-900 text-blue-200' : 'bg-blue-100 text-blue-700'
                                                                    }`}>
                                                                        {item.serie}
                                                                    </span>
                                                                    <span className={`text-xs px-2 py-0.5 rounded ${
                                                                        theme === 'dark' ? 'bg-green-900 text-green-200' : 'bg-green-100 text-green-700'
                                                                    }`}>
                                                                        {item.size}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button
                                                                    onClick={() => {
                                                                        const newName = prompt('Yeni √ºr√ºn adƒ±:', item.name);
                                                                        if (newName && newName.trim() && newName !== item.name) {
                                                                            updateCeramicItem(item, newName);
                                                                        }
                                                                    }}
                                                                    className="px-3 py-1.5 bg-blue-500 text-white rounded text-xs font-semibold hover:bg-blue-600 transition-all"
                                                                >
                                                                    D√ºzenle
                                                                </button>
                                                                <button
                                                                    onClick={() => deleteCeramicItem(item)}
                                                                    className="px-3 py-1.5 bg-red-500 text-white rounded text-xs font-semibold hover:bg-red-600 transition-all"
                                                                >
                                                                    Sil
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* NORMAL MALZEME UI */}
                                    {Object.keys(materials).map(cat => activeDBTab === cat && cat !== 'Seramik' && (
                                        <div key={cat} className={`border-2 rounded-lg p-4 ${
                                            theme === 'dark'
                                                ? 'border-gray-700 bg-gradient-to-br from-gray-800 to-gray-750'
                                                : 'border-gray-300 bg-gradient-to-br from-white to-gray-50'
                                        }`}>
                                            <div className={`flex justify-between items-center mb-3 pb-3 border-b-2 ${
                                                theme === 'dark' ? 'border-gray-700' : 'border-gray-200'
                                            }`}>
                                                <h3 className={`font-bold text-lg flex items-center gap-2 ${
                                                    theme === 'dark' ? 'text-blue-400' : 'text-blue-700'
                                                }`}>
                                                    <span className={`w-2 h-2 rounded-full ${
                                                        theme === 'dark' ? 'bg-blue-400' : 'bg-blue-600'
                                                    }`}></span>
                                                    {cat}
                                                </h3>
                                                <div className="flex gap-2">
                                                    {cat !== 'Seramik' && (
                                                        <>
                                                            <button 
                                                                onClick={() => {
                                                                    const newName = prompt('Yeni kategori adƒ±:', cat);
                                                                    if (newName && newName.trim() && newName !== cat) {
                                                                        if (materials[newName.trim()]) {
                                                                            alert('Bu kategori adƒ± zaten mevcut!');
                                                                            return;
                                                                        }
                                                                        const newMat = { ...materials };
                                                                        newMat[newName.trim()] = newMat[cat];
                                                                        delete newMat[cat];
                                                                        setMaterials(newMat);
                                                                        localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                    }
                                                                }}
                                                                className="px-3 py-2 bg-gradient-to-r from-yellow-500 to-amber-500 text-white rounded-lg text-sm font-semibold hover:from-yellow-600 hover:to-amber-600 shadow-md hover:shadow-lg transition-all flex items-center gap-1"
                                                                title="Kategori adƒ±nƒ± deƒüi≈ütir"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                </svg>
                                                                D√ºzenle
                                                            </button>
                                                            <button 
                                                                onClick={() => {
                                                                    if (confirm(`"${cat}" kategorisini ve t√ºm i√ßeriƒüini silmek istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`)) {
                                                                        const newMat = { ...materials };
                                                                        delete newMat[cat];
                                                                        setMaterials(newMat);
                                                                        localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                    }
                                                                }}
                                                                className="px-3 py-2 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg text-sm font-semibold hover:from-red-600 hover:to-rose-700 shadow-md hover:shadow-lg transition-all flex items-center gap-1"
                                                        title="Kategoriyi sil"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                        Sil
                                                    </button>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Hiyerar≈üik Yapƒ± */}
                                            {typeof materials[cat] === 'object' && !Array.isArray(materials[cat]) ? (
                                                <div className="space-y-4">
                                                    {/* Bo≈ü kategori uyarƒ±sƒ± */}
                                                    {Object.keys(materials[cat]).length === 0 && (
                                                        <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 text-center">
                                                            <div className="text-4xl mb-3">üì¶</div>
                                                            <p className="text-gray-700 font-semibold mb-2">Bu kategori hen√ºz bo≈ü</p>
                                                            <p className="text-sm text-gray-600 mb-4">
                                                                Alt grup ekleyerek malzemelerinizi organize edin
                                                            </p>
                                                            <div className="text-xs text-gray-500 bg-white rounded p-2 border border-yellow-200">
                                                                üí° √ñrnek: "Seramik", "Parke", "Granit" gibi alt gruplar ekleyebilirsiniz
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {Object.keys(materials[cat]).map(subgroup => (
                                                        <div key={subgroup} className={`border-2 rounded-lg p-4 shadow-sm ${
                                                            theme === 'dark'
                                                                ? 'border-blue-700 bg-blue-900 bg-opacity-20'
                                                                : 'border-blue-300 bg-blue-50'
                                                        }`}>
                                                            {/* Alt Grup Header */}
                                                            <div className={`flex justify-between items-center mb-3 pb-2 border-b-2 ${
                                                                theme === 'dark' ? 'border-blue-800' : 'border-blue-200'
                                                            }`}>
                                                                <div className={`font-bold text-base ${
                                                                    theme === 'dark' ? 'text-gray-200' : 'text-gray-800'
                                                                }`}>{subgroup}</div>
                                                                <div className="flex gap-2">
                                                                    <button
                                                                        onClick={() => {
                                                                            const newName = prompt('Yeni alt grup adƒ±:', subgroup);
                                                                            if (newName && newName.trim() && newName !== subgroup) {
                                                                                if (materials[cat][newName.trim()]) {
                                                                                    alert('Bu alt grup adƒ± zaten mevcut!');
                                                                                    return;
                                                                                }
                                                                                const newMat = { ...materials };
                                                                                newMat[cat][newName.trim()] = newMat[cat][subgroup];
                                                                                delete newMat[cat][subgroup];
                                                                                setMaterials(newMat);
                                                                                localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                            }
                                                                        }}
                                                                        className="px-3 py-1.5 bg-gradient-to-r from-yellow-400 to-amber-400 text-white rounded-lg text-sm font-semibold hover:from-yellow-500 hover:to-amber-500 shadow-sm hover:shadow-md transition-all flex items-center gap-1"
                                                                        title="Alt grup adƒ±nƒ± deƒüi≈ütir"
                                                                    >
                                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                        </svg>
                                                                    </button>
                                                                    <button
                                                                        onClick={() => {
                                                                            if (confirm(`"${subgroup}" alt grubunu ve t√ºm malzemelerini silmek istediƒüinize emin misiniz?`)) {
                                                                                const newMat = { ...materials };
                                                                                delete newMat[cat][subgroup];
                                                                                setMaterials(newMat);
                                                                                localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                            }
                                                                        }}
                                                                        className="px-3 py-1.5 bg-gradient-to-r from-red-400 to-rose-500 text-white rounded-lg text-sm font-semibold hover:from-red-500 hover:to-rose-600 shadow-sm hover:shadow-md transition-all flex items-center gap-1"
                                                                        title="Alt grubu sil"
                                                                    >
                                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Yeni Malzeme Input - √ústte */}
                                                            <div className="flex gap-2 mb-3">
                                                                <input 
                                                                    type="text" 
                                                                    id={'new-' + cat + '-' + subgroup} 
                                                                    placeholder="Yeni malzeme ekle... (Excel'den kopyala-yapƒ±≈ütƒ±r yapabilirsiniz)" 
                                                                    className="flex-1 border-2 border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all" 
                                                                    onPaste={(e) => {
                                                                        // Paste edilen metni al
                                                                        const pastedText = e.clipboardData.getData('text');
                                                                        
                                                                        // Satƒ±rlara ayƒ±r
                                                                        const lines = pastedText.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
                                                                        
                                                                        // Eƒüer birden fazla satƒ±r varsa
                                                                        if (lines.length > 1) {
                                                                            e.preventDefault(); // Varsayƒ±lan paste'i engelle
                                                                            
                                                                            // Her satƒ±rƒ± malzeme olarak ekle
                                                                            const newMat = { ...materials };
                                                                            let addedCount = 0;
                                                                            
                                                                            lines.forEach(line => {
                                                                                // Aynƒ± malzeme zaten varsa ekleme
                                                                                if (!newMat[cat][subgroup].includes(line)) {
                                                                                    newMat[cat][subgroup].push(line);
                                                                                    addedCount++;
                                                                                }
                                                                            });
                                                                            
                                                                            setMaterials(newMat);
                                                                            localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                            
                                                                            // Input'u temizle
                                                                            const inp = document.getElementById('new-' + cat + '-' + subgroup);
                                                                            if (inp) inp.value = '';
                                                                            
                                                                            // Bildirim g√∂ster
                                                                            if (addedCount > 0) {
                                                                                alert(`‚úÖ ${addedCount} malzeme eklendi!`);
                                                                            } else {
                                                                                alert('‚ö†Ô∏è T√ºm malzemeler zaten mevcut!');
                                                                            }
                                                                        }
                                                                        // Tek satƒ±rsa normal paste devam etsin
                                                                    }}
                                                                    onKeyPress={(e) => {
                                                                        if (e.key === 'Enter') {
                                                                            const inp = document.getElementById('new-' + cat + '-' + subgroup);
                                                                            if (inp.value.trim()) {
                                                                                const newMat = { ...materials };
                                                                                newMat[cat][subgroup].push(inp.value.trim());
                                                                                setMaterials(newMat);
                                                                                localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                                inp.value = '';
                                                                            }
                                                                        }
                                                                    }}
                                                                />
                                                                <button onClick={() => {
                                                                    const inp = document.getElementById('new-' + cat + '-' + subgroup);
                                                                    if (inp.value.trim()) {
                                                                        const newMat = { ...materials };
                                                                        newMat[cat][subgroup].push(inp.value.trim());
                                                                        setMaterials(newMat);
                                                                        localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                        inp.value = '';
                                                                    }
                                                                }} className="px-6 py-2.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-sm font-bold hover:from-green-600 hover:to-emerald-700 shadow-md hover:shadow-lg transition-all whitespace-nowrap">+ Ekle</button>
                                                            </div>
                                                            
                                                            {/* Malzeme Listesi */}
                                                            <div className="space-y-2 max-h-64 overflow-auto">
                                                                {materials[cat][subgroup].filter(m => 
                                                                    m.toLowerCase().includes(searchMaterial.toLowerCase())
                                                                ).map(m => (
                                                                    <div key={m} className="flex justify-between items-center bg-white border-2 border-gray-200 px-4 py-3 rounded-lg text-sm group hover:border-blue-400 hover:shadow-md transition-all">
                                                                        <span className="text-gray-800 font-medium">{m}</span>
                                                                        <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                            <button 
                                                                                onClick={() => {
                                                                                    const newName = prompt('Yeni malzeme adƒ±:', m);
                                                                                    if (newName && newName.trim() && newName !== m) {
                                                                                        const newMat = { ...materials };
                                                                                        const index = newMat[cat][subgroup].indexOf(m);
                                                                                        if (index !== -1) {
                                                                                            newMat[cat][subgroup][index] = newName.trim();
                                                                                            setMaterials(newMat);
                                                                                            localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                                        }
                                                                                    }
                                                                                }}
                                                                                className="px-2 py-1 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-lg text-xs font-semibold hover:from-blue-600 hover:to-cyan-700 shadow-sm hover:shadow-md transition-all flex items-center gap-1"
                                                                                title="Malzeme adƒ±nƒ± deƒüi≈ütir"
                                                                            >
                                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                                </svg>
                                                                            </button>
                                                                            <button 
                                                                                onClick={() => {
                                                                                    if (confirm('Silmek istediginize emin misiniz?\n' + m)) {
                                                                                        const newMat = { ...materials };
                                                                                        newMat[cat][subgroup] = newMat[cat][subgroup].filter(item => item !== m);
                                                                                        setMaterials(newMat);
                                                                                        localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                                    }
                                                                                }}
                                                                                className="px-2 py-1 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg text-xs font-semibold hover:from-red-600 hover:to-rose-700 shadow-sm hover:shadow-md transition-all flex items-center gap-1"
                                                                                title="Malzemeyi sil"
                                                                            >
                                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                                </svg>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                    {/* Yeni Alt Grup Ekle */}
                                                    <button onClick={() => {
                                                        const newSubgroup = prompt('Yeni alt grup adƒ± (' + cat + ' i√ßin):');
                                                        if (newSubgroup && newSubgroup.trim()) {
                                                            const newMat = { ...materials };
                                                            newMat[cat][newSubgroup.trim()] = [];
                                                            setMaterials(newMat);
                                                            localStorage.setItem('material_database', JSON.stringify(newMat));
                                                        }
                                                    }} className="w-full px-4 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-bold text-base shadow-lg hover:from-blue-600 hover:to-blue-700 hover:shadow-xl transition-all flex items-center justify-center gap-2">
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                                        </svg>
                                                        Yeni Alt Grup Ekle
                                                    </button>
                                                </div>
                                            ) : (
                                                /* Eski D√ºz Liste */
                                                <div>
                                                    <div className="flex gap-2 mb-2">
                                                        <input 
                                                            type="text" 
                                                            id={'new-' + cat} 
                                                            placeholder="Yeni malzeme ekle... (Excel'den kopyala-yapƒ±≈ütƒ±r yapabilirsiniz)" 
                                                            className="flex-1 border-2 border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all"
                                                            onPaste={(e) => {
                                                                // Paste edilen metni al
                                                                const pastedText = e.clipboardData.getData('text');
                                                                
                                                                // Satƒ±rlara ayƒ±r
                                                                const lines = pastedText.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
                                                                
                                                                // Eƒüer birden fazla satƒ±r varsa
                                                                if (lines.length > 1) {
                                                                    e.preventDefault(); // Varsayƒ±lan paste'i engelle
                                                                    
                                                                    // Her satƒ±rƒ± malzeme olarak ekle
                                                                    let addedCount = 0;
                                                                    
                                                                    lines.forEach(line => {
                                                                        // Aynƒ± malzeme zaten varsa ekleme
                                                                        if (!materials[cat].includes(line)) {
                                                                            addMaterial(cat, line);
                                                                            addedCount++;
                                                                        }
                                                                    });
                                                                    
                                                                    // Input'u temizle
                                                                    const inp = document.getElementById('new-' + cat);
                                                                    if (inp) inp.value = '';
                                                                    
                                                                    // Bildirim g√∂ster
                                                                    if (addedCount > 0) {
                                                                        alert(`‚úÖ ${addedCount} malzeme eklendi!`);
                                                                    } else {
                                                                        alert('‚ö†Ô∏è T√ºm malzemeler zaten mevcut!');
                                                                    }
                                                                }
                                                                // Tek satƒ±rsa normal paste devam etsin
                                                            }}
                                                        />
                                                        <button onClick={() => {
                                                            const inp = document.getElementById('new-' + cat);
                                                            if (inp.value.trim()) { addMaterial(cat, inp.value.trim()); inp.value = ''; }
                                                        }} className="px-3 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-sm font-bold hover:from-green-600 hover:to-emerald-700 shadow-md hover:shadow-lg transition-all">+</button>
                                                    </div>
                                                    <div className="space-y-2 max-h-40 overflow-auto">
                                                        {(Array.isArray(materials[cat]) ? materials[cat] : []).map(m => (
                                                            <div key={m} className="flex justify-between items-center bg-white border border-gray-200 px-3 py-2 rounded-lg text-sm group hover:border-blue-300 hover:shadow-sm transition-all">
                                                                <span className="text-gray-700">{m}</span>
                                                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <button 
                                                                        onClick={() => {
                                                                            const newName = prompt('Yeni malzeme adƒ±:', m);
                                                                            if (newName && newName.trim() && newName !== m) {
                                                                                const newMat = { ...materials };
                                                                                const index = newMat[cat].indexOf(m);
                                                                                if (index !== -1) {
                                                                                    newMat[cat][index] = newName.trim();
                                                                                    setMaterials(newMat);
                                                                                    localStorage.setItem('material_database', JSON.stringify(newMat));
                                                                                }
                                                                            }
                                                                        }}
                                                                        className="px-2 py-1 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-lg text-xs font-semibold hover:from-blue-600 hover:to-cyan-700 shadow-sm hover:shadow-md transition-all flex items-center gap-1"
                                                                        title="Malzeme adƒ±nƒ± deƒüi≈ütir"
                                                                    >
                                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                                        </svg>
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => deleteMaterial(cat, m)} 
                                                                        className="px-2 py-1 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg text-xs font-semibold hover:from-red-600 hover:to-rose-700 shadow-sm hover:shadow-md transition-all flex items-center gap-1" 
                                                                        title="Malzemeyi sil"
                                                                    >
                                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                        </svg>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* DAƒ∞RE KOPYALAMA MODAL */}
                    {showCopyModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                            <div className={`rounded-lg p-6 max-w-2xl w-full my-8 max-h-[90vh] overflow-y-auto transition-colors ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between items-center mb-6 pb-4 border-b sticky top-0 ${
                                    theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                                } z-10">
                                    <h2 className={`text-2xl font-bold flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                        Daire Kopyala
                                    </h2>
                                    <button 
                                        onClick={() => setShowCopyModal(false)} 
                                        className="text-3xl hover:text-gray-600 transition-colors"
                                    >√ó</button>
                                </div>
                                
                                <div className={`mb-4 p-4 rounded-lg ${
                                    theme === 'dark' ? 'bg-purple-900 border-purple-700' : 'bg-purple-50 border-purple-200'
                                } border-l-4`}>
                                    <p className={`text-sm ${theme === 'dark' ? 'text-purple-100' : 'text-purple-800'}`}>
                                        <strong>{getApt().name}</strong> dairesinden hangi verileri kopyalamak istiyorsunuz?
                                    </p>
                                </div>
                                
                                <div className="space-y-4 mb-6">
                                    {/* Mekanlar */}
                                    <label className={`flex items-center gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                        copyOptions.rooms
                                            ? theme === 'dark'
                                                ? 'border-purple-600 bg-purple-900 bg-opacity-20'
                                                : 'border-purple-500 bg-purple-50'
                                            : theme === 'dark'
                                                ? 'border-gray-700 bg-gray-750'
                                                : 'border-gray-200 bg-gray-50'
                                    }`}>
                                        <input
                                            type="checkbox"
                                            checked={copyOptions.rooms}
                                            onChange={(e) => setCopyOptions({ ...copyOptions, rooms: e.target.checked })}
                                            className="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
                                        />
                                        <div className="flex-1">
                                            <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                üè† Mekanlar ve Yapƒ±
                                            </div>
                                            <div className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                Gizli/g√∂r√ºn√ºr mekanlar, duvar sayƒ±larƒ±
                                            </div>
                                        </div>
                                    </label>
                                    
                                    {/* Malzemeler */}
                                    <label className={`flex items-center gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                        copyOptions.materials
                                            ? theme === 'dark'
                                                ? 'border-purple-600 bg-purple-900 bg-opacity-20'
                                                : 'border-purple-500 bg-purple-50'
                                            : theme === 'dark'
                                                ? 'border-gray-700 bg-gray-750'
                                                : 'border-gray-200 bg-gray-50'
                                    }`}>
                                        <input
                                            type="checkbox"
                                            checked={copyOptions.materials}
                                            onChange={(e) => setCopyOptions({ ...copyOptions, materials: e.target.checked })}
                                            className="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
                                            disabled={!copyOptions.rooms}
                                        />
                                        <div className="flex-1">
                                            <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                üé® Malzemeler
                                            </div>
                                            <div className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                Se√ßili malzemeler ve alt gruplar
                                            </div>
                                        </div>
                                    </label>
                                    
                                    {/* Miktarlar */}
                                    <label className={`flex items-center gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                        copyOptions.amounts
                                            ? theme === 'dark'
                                                ? 'border-purple-600 bg-purple-900 bg-opacity-20'
                                                : 'border-purple-500 bg-purple-50'
                                            : theme === 'dark'
                                                ? 'border-gray-700 bg-gray-750'
                                                : 'border-gray-200 bg-gray-50'
                                    }`}>
                                        <input
                                            type="checkbox"
                                            checked={copyOptions.amounts}
                                            onChange={(e) => setCopyOptions({ ...copyOptions, amounts: e.target.checked })}
                                            className="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
                                            disabled={!copyOptions.rooms}
                                        />
                                        <div className="flex-1">
                                            <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                üìè Miktarlar
                                            </div>
                                            <div className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                m¬≤, adet gibi miktar bilgileri (Malzemelerden baƒüƒ±msƒ±z)
                                            </div>
                                        </div>
                                    </label>
                                    
                                    {/* Fotoƒüraflar */}
                                    <label className={`flex items-center gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                        copyOptions.photos
                                            ? theme === 'dark'
                                                ? 'border-purple-600 bg-purple-900 bg-opacity-20'
                                                : 'border-purple-500 bg-purple-50'
                                            : theme === 'dark'
                                                ? 'border-gray-700 bg-gray-750'
                                                : 'border-gray-200 bg-gray-50'
                                    }`}>
                                        <input
                                            type="checkbox"
                                            checked={copyOptions.photos}
                                            onChange={(e) => setCopyOptions({ ...copyOptions, photos: e.target.checked })}
                                            className="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
                                            disabled={!copyOptions.rooms}
                                        />
                                        <div className="flex-1">
                                            <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                üì∏ Fotoƒüraflar
                                            </div>
                                            <div className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                T√ºm y√ºkl√º fotoƒüraflar
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                
                                {/* Numaralandƒ±rma Modu */}
                                <div className={`mb-4 p-4 rounded-lg border-2 ${
                                    theme === 'dark'
                                        ? 'border-indigo-700 bg-indigo-900 bg-opacity-20'
                                        : 'border-indigo-300 bg-indigo-50'
                                }`}>
                                    <label className={`block text-sm font-semibold mb-2 ${
                                        theme === 'dark' ? 'text-indigo-200' : 'text-indigo-800'
                                    }`}>
                                        üéØ Numaralandƒ±rma Modu
                                    </label>
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                        {/* Ardƒ±≈üƒ±k */}
                                        <label className={`flex items-center gap-2 p-2 rounded-lg border cursor-pointer transition-all ${
                                            numberingMode === 'sequential'
                                                ? theme === 'dark'
                                                    ? 'border-indigo-500 bg-indigo-900 bg-opacity-40'
                                                    : 'border-indigo-500 bg-indigo-100'
                                                : theme === 'dark'
                                                    ? 'border-gray-700 hover:border-gray-600'
                                                    : 'border-gray-300 hover:border-gray-400'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="numberingMode"
                                                checked={numberingMode === 'sequential'}
                                                onChange={() => setNumberingMode('sequential')}
                                                className="w-4 h-4 text-indigo-600"
                                            />
                                            <div className="flex-1">
                                                <div className={`text-sm font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                    ‚û°Ô∏è Ardƒ±≈üƒ±k
                                                </div>
                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                    1, 2, 3...
                                                </div>
                                            </div>
                                        </label>
                                        
                                        {/* Tek Sayƒ±lar */}
                                        <label className={`flex items-center gap-2 p-2 rounded-lg border cursor-pointer transition-all ${
                                            numberingMode === 'odd'
                                                ? theme === 'dark'
                                                    ? 'border-indigo-500 bg-indigo-900 bg-opacity-40'
                                                    : 'border-indigo-500 bg-indigo-100'
                                                : theme === 'dark'
                                                    ? 'border-gray-700 hover:border-gray-600'
                                                    : 'border-gray-300 hover:border-gray-400'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="numberingMode"
                                                checked={numberingMode === 'odd'}
                                                onChange={() => setNumberingMode('odd')}
                                                className="w-4 h-4 text-indigo-600"
                                            />
                                            <div className="flex-1">
                                                <div className={`text-sm font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                    üîµ Tek
                                                </div>
                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                    1, 3, 5...
                                                </div>
                                            </div>
                                        </label>
                                        
                                        {/* √áift Sayƒ±lar */}
                                        <label className={`flex items-center gap-2 p-2 rounded-lg border cursor-pointer transition-all ${
                                            numberingMode === 'even'
                                                ? theme === 'dark'
                                                    ? 'border-indigo-500 bg-indigo-900 bg-opacity-40'
                                                    : 'border-indigo-500 bg-indigo-100'
                                                : theme === 'dark'
                                                    ? 'border-gray-700 hover:border-gray-600'
                                                    : 'border-gray-300 hover:border-gray-400'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="numberingMode"
                                                checked={numberingMode === 'even'}
                                                onChange={() => setNumberingMode('even')}
                                                className="w-4 h-4 text-indigo-600"
                                            />
                                            <div className="flex-1">
                                                <div className={`text-sm font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                    üî¥ √áift
                                                </div>
                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                    2, 4, 6...
                                                </div>
                                            </div>
                                        </label>
                                        
                                        {/* √ñzel Numaralar */}
                                        <label className={`flex items-center gap-2 p-2 rounded-lg border cursor-pointer transition-all ${
                                            numberingMode === 'custom'
                                                ? theme === 'dark'
                                                    ? 'border-indigo-500 bg-indigo-900 bg-opacity-40'
                                                    : 'border-indigo-500 bg-indigo-100'
                                                : theme === 'dark'
                                                    ? 'border-gray-700 hover:border-gray-600'
                                                    : 'border-gray-300 hover:border-gray-400'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="numberingMode"
                                                checked={numberingMode === 'custom'}
                                                onChange={() => setNumberingMode('custom')}
                                                className="w-4 h-4 text-indigo-600"
                                            />
                                            <div className="flex-1">
                                                <div className={`text-sm font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                    ‚≠ê √ñzel
                                                </div>
                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                    Elle gir
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    {/* √ñzel Numara Giri≈üi */}
                                    {numberingMode === 'custom' && (
                                        <div className="mt-3">
                                            <input
                                                type="text"
                                                placeholder="√ñrnek: 101, 102, 201, 202"
                                                value={customNumbers}
                                                onChange={(e) => setCustomNumbers(e.target.value)}
                                                className={`w-full px-3 py-2 border-2 rounded-lg text-sm focus:ring-2 transition-colors ${
                                                    theme === 'dark'
                                                        ? 'border-indigo-600 bg-gray-700 text-indigo-200 focus:border-indigo-400 focus:ring-indigo-500 placeholder-gray-500'
                                                        : 'border-indigo-400 bg-white text-indigo-900 focus:border-indigo-500 focus:ring-indigo-200 placeholder-gray-400'
                                                }`}
                                            />
                                        </div>
                                    )}
                                </div>
                                
                                {/* Kopyalama Sayƒ±sƒ± */}
                                {numberingMode !== 'custom' && (
                                    <>
                                        <div className={`mb-4 p-4 rounded-lg border-2 ${
                                            theme === 'dark'
                                                ? 'border-blue-700 bg-blue-900 bg-opacity-20'
                                                : 'border-blue-300 bg-blue-50'
                                        }`}>
                                            <label className={`block text-sm font-semibold mb-2 ${
                                                theme === 'dark' ? 'text-blue-200' : 'text-blue-800'
                                            }`}>
                                                üéØ Ba≈ülangƒ±√ß Numarasƒ± (ƒ∞steƒüe Baƒülƒ±)
                                            </label>
                                            <input
                                                type="number"
                                                min="1"
                                                placeholder="Bo≈ü bƒ±rakƒ±rsanƒ±z otomatik devam eder"
                                                value={startNumber}
                                                onChange={(e) => setStartNumber(e.target.value)}
                                                className={`w-full px-4 py-3 border-2 rounded-lg text-center text-lg font-semibold focus:ring-2 transition-colors ${
                                                    theme === 'dark'
                                                        ? 'border-blue-600 bg-gray-700 text-blue-200 focus:border-blue-400 focus:ring-blue-500 placeholder-gray-500'
                                                        : 'border-blue-400 bg-white text-blue-900 focus:border-blue-500 focus:ring-blue-200 placeholder-gray-400'
                                                }`}
                                            />
                                            <p className={`text-xs mt-2 ${theme === 'dark' ? 'text-blue-300' : 'text-blue-700'}`}>
                                                üí° √ñrnek: 5 girip 3 adet kopyalarsanƒ±z ‚Üí Daire 5, 6, 7
                                            </p>
                                        </div>
                                        
                                        <div className={`mb-6 p-4 rounded-lg border-2 ${
                                            theme === 'dark'
                                                ? 'border-amber-700 bg-amber-900 bg-opacity-20'
                                                : 'border-amber-300 bg-amber-50'
                                        }`}>
                                            <label className={`block text-sm font-semibold mb-2 ${
                                                theme === 'dark' ? 'text-amber-200' : 'text-amber-800'
                                            }`}>
                                                üî¢ Ka√ß Adet Kopyalamak ƒ∞stiyorsunuz?
                                            </label>
                                            <input
                                                type="number"
                                                min="1"
                                                max="50"
                                                value={copyCount}
                                                onChange={(e) => setCopyCount(e.target.value)}
                                                className={`w-full px-4 py-3 border-2 rounded-lg text-center text-xl font-bold focus:ring-2 transition-colors ${
                                                    theme === 'dark'
                                                        ? 'border-amber-600 bg-gray-700 text-amber-200 focus:border-amber-400 focus:ring-amber-500'
                                                        : 'border-amber-400 bg-white text-amber-900 focus:border-amber-500 focus:ring-amber-200'
                                                }`}
                                            />
                                        </div>
                                    </>
                                )}
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowCopyModal(false)}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-100 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                    <button
                                        onClick={copyApartment}
                                        className="flex-1 px-4 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                        Kopyala
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Mƒ∞KTAR KOPYALAMA MODAL */}
                    {showCopyAmountsModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-md w-full transition-colors ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <h2 className={`text-2xl font-bold flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-7 h-7 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                        Miktar Kopyala
                                    </h2>
                                    <button 
                                        onClick={() => {
                                            setShowCopyAmountsModal(false);
                                            setSourceAptForAmounts(null);
                                            setSelectedFieldsForCopy({});
                                        }} 
                                        className="text-3xl hover:text-gray-600 transition-colors"
                                    >√ó</button>
                                </div>
                                
                                <div className={`mb-4 p-4 rounded-lg ${
                                    theme === 'dark' ? 'bg-cyan-900 border-cyan-700' : 'bg-cyan-50 border-cyan-200'
                                } border-l-4`}>
                                    <p className={`text-sm mb-2 ${theme === 'dark' ? 'text-cyan-100' : 'text-cyan-800'}`}>
                                        <strong>{getApt().name}</strong> dairesine hangi daireden miktarlarƒ± kopyalamak istiyorsunuz?
                                    </p>
                                    <p className={`text-xs ${theme === 'dark' ? 'text-cyan-200' : 'text-cyan-700'}`}>
                                        ‚ÑπÔ∏è Sadece e≈üle≈üen mekan ve malzemeler i√ßin miktarlar kopyalanƒ±r
                                    </p>
                                </div>
                                
                                <div className="mb-6">
                                    <label className={`block text-sm font-semibold mb-2 ${
                                        theme === 'dark' ? 'text-gray-200' : 'text-gray-700'
                                    }`}>
                                        Kaynak Daire:
                                    </label>
                                    <select 
                                        value={sourceAptForAmounts || ''}
                                        onChange={(e) => setSourceAptForAmounts(parseInt(e.target.value))}
                                        className={`w-full px-4 py-3 border-2 rounded-lg focus:ring-2 transition-colors ${
                                            theme === 'dark'
                                                ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-cyan-400 focus:ring-cyan-500'
                                                : 'border-gray-300 bg-white text-gray-900 focus:border-cyan-500 focus:ring-cyan-200'
                                        }`}
                                    >
                                        <option value="">Daire se√ßin...</option>
                                        {apartments.filter(a => a.id !== currentApt).map(apt => (
                                            <option key={apt.id} value={apt.id} className={theme === 'dark' ? 'bg-gray-700 text-gray-100' : 'bg-white text-gray-900'}>
                                                {apt.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                
                                {/* Alan Se√ßimi */}
                                {sourceAptForAmounts && (
                                    <div className="mb-6">
                                        <label className={`block text-sm font-semibold mb-3 ${
                                            theme === 'dark' ? 'text-gray-200' : 'text-gray-700'
                                        }`}>
                                            Hangi Alanlarƒ±n Miktarlarƒ±nƒ± Kopyalamak ƒ∞stiyorsunuz?
                                        </label>
                                        <div className="space-y-2 max-h-48 overflow-y-auto">
                                            {Object.keys(fieldLabels).filter(f => f !== 'foto').map(field => {
                                                const fc = fieldLabels[field];
                                                return (
                                                    <label 
                                                        key={field}
                                                        className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all ${
                                                            selectedFieldsForCopy[field]
                                                                ? theme === 'dark'
                                                                    ? 'border-cyan-600 bg-cyan-900 bg-opacity-20'
                                                                    : 'border-cyan-500 bg-cyan-50'
                                                                : theme === 'dark'
                                                                    ? 'border-gray-700 hover:border-gray-600'
                                                                    : 'border-gray-200 hover:border-gray-300'
                                                        }`}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedFieldsForCopy[field] || false}
                                                            onChange={(e) => setSelectedFieldsForCopy({
                                                                ...selectedFieldsForCopy,
                                                                [field]: e.target.checked
                                                            })}
                                                            className="w-4 h-4 text-cyan-600 rounded focus:ring-2 focus:ring-cyan-500"
                                                        />
                                                        <div className="flex-1">
                                                            <span className={`font-medium text-sm ${
                                                                theme === 'dark' ? 'text-gray-100' : 'text-gray-900'
                                                            }`}>
                                                                {fc.label}
                                                            </span>
                                                            {fc.unit && (
                                                                <span className={`ml-2 text-xs ${
                                                                    theme === 'dark' ? 'text-gray-400' : 'text-gray-500'
                                                                }`}>
                                                                    ({fc.unit})
                                                                </span>
                                                            )}
                                                        </div>
                                                    </label>
                                                );
                                            })}
                                        </div>
                                        <button
                                            onClick={() => {
                                                const allFields = {};
                                                Object.keys(fieldLabels).filter(f => f !== 'foto').forEach(f => {
                                                    allFields[f] = true;
                                                });
                                                setSelectedFieldsForCopy(allFields);
                                            }}
                                            className={`mt-2 text-xs font-semibold ${
                                                theme === 'dark' ? 'text-cyan-400 hover:text-cyan-300' : 'text-cyan-600 hover:text-cyan-700'
                                            }`}
                                        >
                                            ‚úì T√ºm√ºn√º Se√ß
                                        </button>
                                    </div>
                                )}
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setShowCopyAmountsModal(false);
                                            setSourceAptForAmounts(null);
                                            setSelectedFieldsForCopy({});
                                        }}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-100 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                    <button
                                        onClick={copyAmountsFromApartment}
                                        disabled={!sourceAptForAmounts || Object.values(selectedFieldsForCopy).every(v => !v)}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${
                                            sourceAptForAmounts && Object.values(selectedFieldsForCopy).some(v => v)
                                                ? 'bg-cyan-600 text-white hover:bg-cyan-700'
                                                : theme === 'dark'
                                                    ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
                                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                        Kopyala
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* OTURUM √áAKI≈ûMASI MODAL */}
                    {showSessionConflictModal && sessionConflict && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full shadow-2xl">
                                <div className="text-center mb-6">
                                    <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <svg className="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                    </div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-2">Ba≈üka Bir Cihazdan Giri≈ü Yapƒ±ldƒ±</h2>
                                    <p className="text-gray-600 mb-4">
                                        Hesabƒ±nƒ±za ba≈üka bir cihazdan giri≈ü yapƒ±lmƒ±≈ü. G√ºvenlik nedeniyle bu oturumu kapatmanƒ±z gerekiyor.
                                    </p>
                                    
                                    <div className="bg-gray-100 rounded-lg p-4 mb-4 text-left">
                                        <p className="text-sm text-gray-700 mb-2">
                                            <strong>Email:</strong> {sessionConflict.email}
                                        </p>
                                        <p className="text-sm text-gray-700 mb-2">
                                            <strong>Platform:</strong> {sessionConflict.platform}
                                        </p>
                                        <p className="text-xs text-gray-500 mt-2">
                                            üí° Aynƒ± hesapla aynƒ± anda birden fazla cihazdan √ßalƒ±≈üamazsƒ±nƒ±z.
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="space-y-3">
                                    <button
                                        onClick={async () => {
                                            // Verileri kaydet
                                            if (!navigator.onLine) {
                                                localStorage.setItem('projects_data', JSON.stringify(projects));
                                                localStorage.setItem('custom_rooms', JSON.stringify(customRooms));
                                                localStorage.setItem('base_rooms', JSON.stringify(baseRooms));
                                                localStorage.setItem('room_order', JSON.stringify(roomOrder));
                                                localStorage.setItem('field_labels', JSON.stringify(fieldLabels));
                                                localStorage.setItem('material_database', JSON.stringify(materials));
                                            } else if (firebaseSync && firebaseEnabled && user) {
                                                await saveToFirebase({
                                                    projects,
                                                    customRooms,
                                                    baseRooms,
                                                    roomOrder,
                                                    fieldLabels,
                                                    materials,
                                                    ceramicData
                                                });
                                            }
                                            
                                            // √áƒ±kƒ±≈ü yap
                                            await signOut();
                                            setShowSessionConflictModal(false);
                                        }}
                                        className="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                        </svg>
                                        Verileri Kaydet ve √áƒ±kƒ±≈ü Yap
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            // Bu oturumu ge√ßerli yap
                                            updateSessionInfo(user);
                                            setShowSessionConflictModal(false);
                                            setSessionConflict(null);
                                        }}
                                        className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Bu Cihazda Devam Et
                                    </button>
                                    
                                    <p className="text-xs text-center text-gray-500 mt-2">
                                        ‚ö†Ô∏è "Bu Cihazda Devam Et" se√ßeneƒüi diƒüer cihazƒ± √ßƒ±kƒ±≈ü yapmaya zorlayacaktƒ±r.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* TOPLU DAƒ∞RE Sƒ∞LME MODAL */}
                    {showBulkDeleteModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-auto transition-colors ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <h2 className={`text-2xl font-bold flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Toplu Daire Silme
                                    </h2>
                                    <button 
                                        onClick={() => {
                                            setShowBulkDeleteModal(false);
                                            setSelectedApartmentsForDelete([]);
                                        }} 
                                        className="text-3xl hover:text-gray-600 transition-colors"
                                    >√ó</button>
                                </div>
                                
                                <div className={`mb-4 p-4 rounded-lg ${
                                    theme === 'dark' ? 'bg-red-900 border-red-700' : 'bg-red-50 border-red-200'
                                } border-l-4`}>
                                    <p className={`text-sm font-semibold ${theme === 'dark' ? 'text-red-100' : 'text-red-800'}`}>
                                        ‚ö†Ô∏è Dikkat: Se√ßtiƒüiniz daireler kalƒ±cƒ± olarak silinecektir!
                                    </p>
                                </div>
                                
                                {/* T√ºm√ºn√º Se√ß/Bƒ±rak */}
                                <div className="mb-4">
                                    <button
                                        onClick={toggleAllApartments}
                                        className={`px-4 py-2 rounded-lg font-semibold text-sm ${
                                            selectedApartmentsForDelete.length === apartments.length
                                                ? 'bg-gray-500 text-white hover:bg-gray-600'
                                                : 'bg-blue-500 text-white hover:bg-blue-600'
                                        }`}
                                    >
                                        {selectedApartmentsForDelete.length === apartments.length ? 'T√ºm√ºn√º Bƒ±rak' : 'T√ºm√ºn√º Se√ß'}
                                    </button>
                                    <span className={`ml-3 text-sm ${theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}`}>
                                        {selectedApartmentsForDelete.length} / {apartments.length} daire se√ßildi
                                    </span>
                                </div>
                                
                                {/* Daire Listesi */}
                                <div className="space-y-2 mb-6 max-h-96 overflow-y-auto">
                                    {apartments.map(apt => (
                                        <label 
                                            key={apt.id}
                                            className={`flex items-center gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                                selectedApartmentsForDelete.includes(apt.id)
                                                    ? theme === 'dark'
                                                        ? 'border-red-600 bg-red-900 bg-opacity-20'
                                                        : 'border-red-500 bg-red-50'
                                                    : theme === 'dark'
                                                        ? 'border-gray-700 bg-gray-750 hover:border-gray-600'
                                                        : 'border-gray-200 bg-gray-50 hover:border-gray-300'
                                            }`}
                                        >
                                            <input
                                                type="checkbox"
                                                checked={selectedApartmentsForDelete.includes(apt.id)}
                                                onChange={() => toggleApartmentSelection(apt.id)}
                                                className="w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500"
                                            />
                                            <div className="flex-1">
                                                <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                    {apt.name}
                                                </div>
                                                {apt.id === currentApt && (
                                                    <div className="text-xs text-blue-600 font-medium">
                                                        üìç ≈ûu an g√∂r√ºnt√ºlenen daire
                                                    </div>
                                                )}
                                            </div>
                                        </label>
                                    ))}
                                </div>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setShowBulkDeleteModal(false);
                                            setSelectedApartmentsForDelete([]);
                                        }}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-100 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                    <button
                                        onClick={bulkDeleteApartments}
                                        disabled={selectedApartmentsForDelete.length === 0}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${
                                            selectedApartmentsForDelete.length === 0
                                                ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                                : 'bg-red-600 text-white hover:bg-red-700'
                                        }`}
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Se√ßilenleri Sil ({selectedApartmentsForDelete.length})
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* TOPLU MALZEME ATAMA MODAL */}
                    {showBulkMaterialModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-auto transition-colors ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <h2 className={`text-2xl font-bold flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                                        </svg>
                                        Toplu Malzeme Atama
                                    </h2>
                                    <button 
                                        onClick={() => {
                                            setShowBulkMaterialModal(false);
                                            setBulkMaterialFields({});
                                            setBulkMaterialSelections({});
                                            setBulkTargetApartments('all');
                                            setBulkSelectedApartments([]);
                                            setBulkTargetRoomTypes('all');
                                            setBulkSelectedRoomTypes([]);
                                        }} 
                                        className="text-3xl hover:text-gray-600 transition-colors"
                                    >√ó</button>
                                </div>
                                
                                {/* Adƒ±m 1: Alan Se√ßimi */}
                                <div className="mb-6">
                                    <h3 className={`text-lg font-bold mb-3 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                        1Ô∏è‚É£ Hangi Alanlar?
                                    </h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        {Object.entries(fieldLabels).filter(([key]) => key !== 'foto' && key !== 'duvar_kaplama').map(([fieldKey, fieldConfig]) => (
                                            <label 
                                                key={fieldKey}
                                                className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                                    bulkMaterialFields[fieldKey]
                                                        ? theme === 'dark'
                                                            ? 'border-blue-500 bg-blue-900 bg-opacity-30'
                                                            : 'border-blue-500 bg-blue-50'
                                                        : theme === 'dark'
                                                            ? 'border-gray-700 bg-gray-750 hover:border-gray-600'
                                                            : 'border-gray-200 bg-gray-50 hover:border-gray-300'
                                                }`}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={bulkMaterialFields[fieldKey] || false}
                                                    onChange={(e) => {
                                                        setBulkMaterialFields({
                                                            ...bulkMaterialFields,
                                                            [fieldKey]: e.target.checked
                                                        });
                                                        if (!e.target.checked) {
                                                            const newSelections = { ...bulkMaterialSelections };
                                                            delete newSelections[fieldKey];
                                                            setBulkMaterialSelections(newSelections);
                                                        }
                                                    }}
                                                    className="w-4 h-4 text-blue-600 rounded"
                                                />
                                                <span className={`text-sm font-medium ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                    {fieldConfig.label}
                                                </span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Adƒ±m 2: Malzeme Se√ßimi */}
                                {Object.keys(bulkMaterialFields).filter(f => bulkMaterialFields[f]).length > 0 && (
                                    <div className="mb-6">
                                        <h3 className={`text-lg font-bold mb-3 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                            2Ô∏è‚É£ Malzeme Se√ßin
                                        </h3>
                                        <div className="space-y-4">
                                            {Object.keys(bulkMaterialFields).filter(f => bulkMaterialFields[f]).map(fieldKey => {
                                                const fieldConfig = fieldLabels[fieldKey];
                                                const currentSelection = bulkMaterialSelections[fieldKey] || {};
                                                
                                                return (
                                                    <div 
                                                        key={fieldKey}
                                                        className={`p-4 rounded-lg border-2 ${
                                                            theme === 'dark' ? 'border-gray-700 bg-gray-750' : 'border-gray-200 bg-gray-50'
                                                        }`}
                                                    >
                                                        <div className={`font-semibold mb-3 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                            {fieldConfig.label}
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-3">
                                                            {/* Alt Grup Se√ßimi */}
                                                            <div>
                                                                <label className={`text-xs font-medium mb-1 block ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                    Kategori
                                                                </label>
                                                                <select
                                                                    value={currentSelection.subgroup || ''}
                                                                    onChange={(e) => {
                                                                        setBulkMaterialSelections({
                                                                            ...bulkMaterialSelections,
                                                                            [fieldKey]: {
                                                                                subgroup: e.target.value,
                                                                                malzeme: ''
                                                                            }
                                                                        });
                                                                    }}
                                                                    className={`w-full px-3 py-2 border rounded-lg ${
                                                                        theme === 'dark'
                                                                            ? 'border-gray-600 bg-gray-700 text-gray-200'
                                                                            : 'border-gray-300 bg-white text-gray-900'
                                                                    }`}
                                                                >
                                                                    <option value="">Se√ßiniz...</option>
                                                                    {Object.keys(materials).flatMap(cat => 
                                                                        Object.keys(materials[cat]).map(subgroup => (
                                                                            <option key={`${cat}-${subgroup}`} value={subgroup}>
                                                                                {subgroup}
                                                                            </option>
                                                                        ))
                                                                    )}
                                                                </select>
                                                            </div>
                                                            
                                                            {/* Malzeme Se√ßimi */}
                                                            <div className="col-span-2">
                                                                <label className={`text-xs font-medium mb-1 block ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                    Malzeme
                                                                </label>
                                                                {currentSelection.subgroup === 'Seramik' ? (
                                                                    /* √ñZEL SERAMƒ∞K SE√áƒ∞Mƒ∞ */
                                                                    <div className={`border-2 rounded-lg p-4 ${
                                                                        theme === 'dark'
                                                                            ? 'border-purple-700 bg-purple-900/20'
                                                                            : 'border-purple-200 bg-purple-50'
                                                                    }`}>
                                                                        <div className="grid grid-cols-2 gap-2 mb-3">
                                                                            {/* Seri Filtresi */}
                                                                            <select 
                                                                                id={`bulk-ceramic-filter-serie-${fieldKey}`}
                                                                                className={`border-2 rounded-lg px-3 py-2 text-sm focus:ring transition-all ${
                                                                                    theme === 'dark'
                                                                                        ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-purple-400'
                                                                                        : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500'
                                                                                }`}
                                                                                onChange={() => {
                                                                                    setBulkMaterialSelections({
                                                                                        ...bulkMaterialSelections,
                                                                                        [fieldKey]: {
                                                                                            ...currentSelection,
                                                                                            malzeme: ''
                                                                                        }
                                                                                    });
                                                                                }}
                                                                            >
                                                                                <option value="">üè∑Ô∏è T√ºm Seriler</option>
                                                                                {[...ceramicData.series].sort((a, b) => a.localeCompare(b, 'tr')).map(serie => (
                                                                                    <option key={serie} value={serie}>{serie}</option>
                                                                                ))}
                                                                            </select>
                                                                            
                                                                            {/* Boyut Filtresi */}
                                                                            <select 
                                                                                id={`bulk-ceramic-filter-size-${fieldKey}`}
                                                                                className={`border-2 rounded-lg px-3 py-2 text-sm focus:ring transition-all ${
                                                                                    theme === 'dark'
                                                                                        ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-purple-400'
                                                                                        : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500'
                                                                                }`}
                                                                                onChange={() => {
                                                                                    setBulkMaterialSelections({
                                                                                        ...bulkMaterialSelections,
                                                                                        [fieldKey]: {
                                                                                            ...currentSelection,
                                                                                            malzeme: ''
                                                                                        }
                                                                                    });
                                                                                }}
                                                                            >
                                                                                <option value="">üìè T√ºm Boyutlar</option>
                                                                                {[...ceramicData.sizes].sort((a, b) => a.localeCompare(b, 'tr')).map(size => (
                                                                                    <option key={size} value={size}>{size}</option>
                                                                                ))}
                                                                            </select>
                                                                        </div>
                                                                        
                                                                        {/* Seramik Se√ßimi */}
                                                                        <select
                                                                            value={currentSelection.malzeme || ''}
                                                                            onChange={(e) => {
                                                                                setBulkMaterialSelections({
                                                                                    ...bulkMaterialSelections,
                                                                                    [fieldKey]: {
                                                                                        ...currentSelection,
                                                                                        malzeme: e.target.value
                                                                                    }
                                                                                });
                                                                            }}
                                                                            className={`w-full border-2 rounded-lg px-3 py-2.5 font-medium focus:ring transition-all ${
                                                                                theme === 'dark'
                                                                                    ? 'border-gray-600 bg-gray-700 text-gray-100 focus:border-purple-400 focus:ring-purple-500'
                                                                                    : 'border-purple-300 bg-white text-gray-900 focus:border-purple-500 focus:ring-purple-200'
                                                                            }`}
                                                                        >
                                                                            <option value="">üî∏ Seramik Se√ßiniz</option>
                                                                            {(() => {
                                                                                const serieFilter = document.getElementById(`bulk-ceramic-filter-serie-${fieldKey}`)?.value || '';
                                                                                const sizeFilter = document.getElementById(`bulk-ceramic-filter-size-${fieldKey}`)?.value || '';
                                                                                
                                                                                return ceramicData.items
                                                                                    .filter(item => {
                                                                                        if (serieFilter && item.serie !== serieFilter) return false;
                                                                                        if (sizeFilter && item.size !== sizeFilter) return false;
                                                                                        return true;
                                                                                    })
                                                                                    .sort((a, b) => a.fullName.localeCompare(b.fullName, 'tr'))
                                                                                    .map(item => (
                                                                                        <option key={item.fullName} value={item.fullName}>
                                                                                            {item.fullName}
                                                                                        </option>
                                                                                    ));
                                                                            })()}
                                                                        </select>
                                                                        
                                                                        <div className={`mt-2 text-xs ${
                                                                            theme === 'dark' ? 'text-purple-300' : 'text-purple-600'
                                                                        }`}>
                                                                            üí° Seri ve boyut filtrelerini kullanarak arama yapabilirsiniz
                                                                        </div>
                                                                    </div>
                                                                ) : (
                                                                    /* NORMAL MALZEME SE√áƒ∞Mƒ∞ */
                                                                    <select
                                                                        value={currentSelection.malzeme || ''}
                                                                        onChange={(e) => {
                                                                            setBulkMaterialSelections({
                                                                                ...bulkMaterialSelections,
                                                                                [fieldKey]: {
                                                                                    ...currentSelection,
                                                                                    malzeme: e.target.value
                                                                                }
                                                                            });
                                                                        }}
                                                                        disabled={!currentSelection.subgroup}
                                                                        className={`w-full px-3 py-2 border rounded-lg ${
                                                                            theme === 'dark'
                                                                                ? 'border-gray-600 bg-gray-700 text-gray-200 disabled:opacity-50'
                                                                                : 'border-gray-300 bg-white text-gray-900 disabled:opacity-50'
                                                                        }`}
                                                                    >
                                                                        <option value="">Se√ßiniz...</option>
                                                                        {currentSelection.subgroup && 
                                                                            Object.keys(materials).flatMap(cat => 
                                                                                materials[cat][currentSelection.subgroup]?.map(mat => (
                                                                                    <option key={mat} value={mat}>{mat}</option>
                                                                                )) || []
                                                                            )
                                                                        }
                                                                    </select>
                                                                )}
                                                            </div>
                                                        </div>
                                                        {currentSelection.subgroup && currentSelection.malzeme && (
                                                            <div className={`mt-2 text-sm p-2 rounded ${
                                                                theme === 'dark' ? 'bg-green-900 text-green-200' : 'bg-green-50 text-green-700'
                                                            }`}>
                                                                ‚úì Se√ßildi: <strong>{currentSelection.subgroup} - {currentSelection.malzeme}</strong>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Adƒ±m 3: Hedef Daireler */}
                                <div className="mb-6">
                                    <h3 className={`text-lg font-bold mb-3 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                        3Ô∏è‚É£ Hangi Dairelere?
                                    </h3>
                                    <div className="space-y-3">
                                        <label className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer ${
                                            bulkTargetApartments === 'all'
                                                ? theme === 'dark' ? 'border-blue-500 bg-blue-900 bg-opacity-30' : 'border-blue-500 bg-blue-50'
                                                : theme === 'dark' ? 'border-gray-700 bg-gray-750' : 'border-gray-200 bg-gray-50'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="bulkTargetApartments"
                                                checked={bulkTargetApartments === 'all'}
                                                onChange={() => setBulkTargetApartments('all')}
                                                className="w-4 h-4 text-blue-600"
                                            />
                                            <span className={`font-medium ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                üèòÔ∏è T√ºm Daireler ({apartments.length} adet)
                                            </span>
                                        </label>
                                        
                                        <label className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer ${
                                            bulkTargetApartments === 'selected'
                                                ? theme === 'dark' ? 'border-blue-500 bg-blue-900 bg-opacity-30' : 'border-blue-500 bg-blue-50'
                                                : theme === 'dark' ? 'border-gray-700 bg-gray-750' : 'border-gray-200 bg-gray-50'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="bulkTargetApartments"
                                                checked={bulkTargetApartments === 'selected'}
                                                onChange={() => setBulkTargetApartments('selected')}
                                                className="w-4 h-4 text-blue-600"
                                            />
                                            <span className={`font-medium ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                ‚òëÔ∏è Se√ßili Daireler
                                            </span>
                                        </label>
                                        
                                        {bulkTargetApartments === 'selected' && (
                                            <div className="ml-6 mt-2 space-y-2 max-h-48 overflow-y-auto">
                                                {apartments.map(apt => (
                                                    <label 
                                                        key={apt.id}
                                                        className={`flex items-center gap-2 p-2 rounded cursor-pointer ${
                                                            theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                                        }`}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={bulkSelectedApartments.includes(apt.id)}
                                                            onChange={(e) => {
                                                                if (e.target.checked) {
                                                                    setBulkSelectedApartments([...bulkSelectedApartments, apt.id]);
                                                                } else {
                                                                    setBulkSelectedApartments(bulkSelectedApartments.filter(id => id !== apt.id));
                                                                }
                                                            }}
                                                            className="w-4 h-4 text-blue-600 rounded"
                                                        />
                                                        <span className={`text-sm ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                            {apt.name}
                                                        </span>
                                                    </label>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Adƒ±m 4: Hedef Mekanlar */}
                                <div className="mb-6">
                                    <h3 className={`text-lg font-bold mb-3 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                        4Ô∏è‚É£ Hangi Mekanlara?
                                    </h3>
                                    <div className="space-y-3">
                                        <label className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer ${
                                            bulkTargetRoomTypes === 'all'
                                                ? theme === 'dark' ? 'border-blue-500 bg-blue-900 bg-opacity-30' : 'border-blue-500 bg-blue-50'
                                                : theme === 'dark' ? 'border-gray-700 bg-gray-750' : 'border-gray-200 bg-gray-50'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="bulkTargetRoomTypes"
                                                checked={bulkTargetRoomTypes === 'all'}
                                                onChange={() => setBulkTargetRoomTypes('all')}
                                                className="w-4 h-4 text-blue-600"
                                            />
                                            <span className={`font-medium ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                üìç T√ºm Mekanlar
                                            </span>
                                        </label>
                                        
                                        <label className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer ${
                                            bulkTargetRoomTypes === 'selected'
                                                ? theme === 'dark' ? 'border-blue-500 bg-blue-900 bg-opacity-30' : 'border-blue-500 bg-blue-50'
                                                : theme === 'dark' ? 'border-gray-700 bg-gray-750' : 'border-gray-200 bg-gray-50'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="bulkTargetRoomTypes"
                                                checked={bulkTargetRoomTypes === 'selected'}
                                                onChange={() => setBulkTargetRoomTypes('selected')}
                                                className="w-4 h-4 text-blue-600"
                                            />
                                            <span className={`font-medium ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                ‚òëÔ∏è Se√ßili Mekan Tipleri
                                            </span>
                                        </label>
                                        
                                        {bulkTargetRoomTypes === 'selected' && (
                                            <div className="ml-6 mt-2 grid grid-cols-2 gap-2">
                                                {['Salon', 'Mutfak', 'Banyo', 'Oda', 'Hol', 'Balkon'].map(roomType => (
                                                    <label 
                                                        key={roomType}
                                                        className={`flex items-center gap-2 p-2 rounded cursor-pointer ${
                                                            theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                                        }`}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={bulkSelectedRoomTypes.includes(roomType)}
                                                            onChange={(e) => {
                                                                if (e.target.checked) {
                                                                    setBulkSelectedRoomTypes([...bulkSelectedRoomTypes, roomType]);
                                                                } else {
                                                                    setBulkSelectedRoomTypes(bulkSelectedRoomTypes.filter(t => t !== roomType));
                                                                }
                                                            }}
                                                            className="w-4 h-4 text-blue-600 rounded"
                                                        />
                                                        <span className={`text-sm ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                            {roomType}
                                                        </span>
                                                    </label>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Butonlar */}
                                <div className="flex gap-3 pt-4 border-t">
                                    <button
                                        onClick={() => {
                                            setShowBulkMaterialModal(false);
                                            setBulkMaterialFields({});
                                            setBulkMaterialSelections({});
                                            setBulkTargetApartments('all');
                                            setBulkSelectedApartments([]);
                                            setBulkTargetRoomTypes('all');
                                            setBulkSelectedRoomTypes([]);
                                        }}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-100 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                    <button
                                        onClick={applyBulkMaterials}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${
                                            'bg-blue-600 text-white hover:bg-blue-700'
                                        }`}
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Malzemeleri Uygula
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* TOPLU Mƒ∞KTAR ATAMA MODAL */}
                    {showBulkAmountModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-auto transition-colors ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <h2 className={`text-2xl font-bold flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                        Toplu Miktar Atama
                                    </h2>
                                    <button 
                                        onClick={() => {
                                            setShowBulkAmountModal(false);
                                            setBulkAmountFields({});
                                            setBulkAmountValues({});
                                            setBulkAmountTargetApartments('all');
                                            setBulkAmountSelectedApartments([]);
                                            setBulkAmountTargetRoomTypes('all');
                                            setBulkAmountSelectedRoomTypes([]);
                                        }} 
                                        className="text-3xl hover:text-gray-600 transition-colors"
                                    >√ó</button>
                                </div>
                                
                                {/* Adƒ±m 1: Alan Se√ßimi */}
                                <div className="mb-6">
                                    <h3 className={`text-lg font-bold mb-3 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                        1Ô∏è‚É£ Hangi Alanlar?
                                    </h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        {Object.entries(fieldLabels).filter(([key]) => key !== 'foto').map(([fieldKey, fieldConfig]) => (
                                            <label 
                                                key={fieldKey}
                                                className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                                    bulkAmountFields[fieldKey]
                                                        ? theme === 'dark'
                                                            ? 'border-green-500 bg-green-900 bg-opacity-30'
                                                            : 'border-green-500 bg-green-50'
                                                        : theme === 'dark'
                                                            ? 'border-gray-700 bg-gray-750 hover:border-gray-600'
                                                            : 'border-gray-200 bg-gray-50 hover:border-gray-300'
                                                }`}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={bulkAmountFields[fieldKey] || false}
                                                    onChange={(e) => {
                                                        setBulkAmountFields({
                                                            ...bulkAmountFields,
                                                            [fieldKey]: e.target.checked
                                                        });
                                                        if (!e.target.checked) {
                                                            const newValues = { ...bulkAmountValues };
                                                            delete newValues[fieldKey];
                                                            setBulkAmountValues(newValues);
                                                        }
                                                    }}
                                                    className="w-4 h-4 text-green-600 rounded"
                                                />
                                                <span className={`text-sm font-medium ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                    {fieldConfig.label}
                                                </span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Adƒ±m 2: Miktar Giri≈üi */}
                                {Object.keys(bulkAmountFields).filter(f => bulkAmountFields[f]).length > 0 && (
                                    <div className="mb-6">
                                        <h3 className={`text-lg font-bold mb-3 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                            2Ô∏è‚É£ Miktar Girin
                                        </h3>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            {Object.keys(bulkAmountFields).filter(f => bulkAmountFields[f]).map(fieldKey => {
                                                const fieldConfig = fieldLabels[fieldKey];
                                                
                                                return (
                                                    <div 
                                                        key={fieldKey}
                                                        className={`p-3 rounded-lg border-2 ${
                                                            theme === 'dark' ? 'border-gray-700 bg-gray-750' : 'border-gray-200 bg-gray-50'
                                                        }`}
                                                    >
                                                        <label className={`text-sm font-medium mb-2 block ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                            {fieldConfig.label}
                                                        </label>
                                                        <div className="flex items-center gap-2">
                                                            <input
                                                                type="number"
                                                                step="0.01"
                                                                value={bulkAmountValues[fieldKey] || ''}
                                                                onChange={(e) => {
                                                                    setBulkAmountValues({
                                                                        ...bulkAmountValues,
                                                                        [fieldKey]: e.target.value
                                                                    });
                                                                }}
                                                                placeholder="0"
                                                                className={`flex-1 px-3 py-2 border rounded-lg ${
                                                                    theme === 'dark'
                                                                        ? 'border-gray-600 bg-gray-700 text-gray-200'
                                                                        : 'border-gray-300 bg-white text-gray-900'
                                                                }`}
                                                            />
                                                            <span className={`text-sm font-medium ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                {fieldConfig.unit}
                                                            </span>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Adƒ±m 3: Hedef Daireler */}
                                <div className="mb-6">
                                    <h3 className={`text-lg font-bold mb-3 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                        3Ô∏è‚É£ Hangi Dairelere?
                                    </h3>
                                    <div className="space-y-3">
                                        <label className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer ${
                                            bulkAmountTargetApartments === 'all'
                                                ? theme === 'dark' ? 'border-green-500 bg-green-900 bg-opacity-30' : 'border-green-500 bg-green-50'
                                                : theme === 'dark' ? 'border-gray-700 bg-gray-750' : 'border-gray-200 bg-gray-50'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="bulkAmountTargetApartments"
                                                checked={bulkAmountTargetApartments === 'all'}
                                                onChange={() => setBulkAmountTargetApartments('all')}
                                                className="w-4 h-4 text-green-600"
                                            />
                                            <span className={`font-medium ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                üèòÔ∏è T√ºm Daireler ({apartments.length} adet)
                                            </span>
                                        </label>
                                        
                                        <label className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer ${
                                            bulkAmountTargetApartments === 'selected'
                                                ? theme === 'dark' ? 'border-green-500 bg-green-900 bg-opacity-30' : 'border-green-500 bg-green-50'
                                                : theme === 'dark' ? 'border-gray-700 bg-gray-750' : 'border-gray-200 bg-gray-50'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="bulkAmountTargetApartments"
                                                checked={bulkAmountTargetApartments === 'selected'}
                                                onChange={() => setBulkAmountTargetApartments('selected')}
                                                className="w-4 h-4 text-green-600"
                                            />
                                            <span className={`font-medium ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                ‚òëÔ∏è Se√ßili Daireler
                                            </span>
                                        </label>
                                        
                                        {bulkAmountTargetApartments === 'selected' && (
                                            <div className="ml-6 mt-2 space-y-2 max-h-48 overflow-y-auto">
                                                {apartments.map(apt => (
                                                    <label 
                                                        key={apt.id}
                                                        className={`flex items-center gap-2 p-2 rounded cursor-pointer ${
                                                            theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                                        }`}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={bulkAmountSelectedApartments.includes(apt.id)}
                                                            onChange={(e) => {
                                                                if (e.target.checked) {
                                                                    setBulkAmountSelectedApartments([...bulkAmountSelectedApartments, apt.id]);
                                                                } else {
                                                                    setBulkAmountSelectedApartments(bulkAmountSelectedApartments.filter(id => id !== apt.id));
                                                                }
                                                            }}
                                                            className="w-4 h-4 text-green-600 rounded"
                                                        />
                                                        <span className={`text-sm ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                            {apt.name}
                                                        </span>
                                                    </label>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Adƒ±m 4: Hedef Mekanlar */}
                                <div className="mb-6">
                                    <h3 className={`text-lg font-bold mb-3 ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                        4Ô∏è‚É£ Hangi Mekanlara?
                                    </h3>
                                    <div className="space-y-3">
                                        <label className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer ${
                                            bulkAmountTargetRoomTypes === 'all'
                                                ? theme === 'dark' ? 'border-green-500 bg-green-900 bg-opacity-30' : 'border-green-500 bg-green-50'
                                                : theme === 'dark' ? 'border-gray-700 bg-gray-750' : 'border-gray-200 bg-gray-50'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="bulkAmountTargetRoomTypes"
                                                checked={bulkAmountTargetRoomTypes === 'all'}
                                                onChange={() => setBulkAmountTargetRoomTypes('all')}
                                                className="w-4 h-4 text-green-600"
                                            />
                                            <span className={`font-medium ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                üìç T√ºm Mekanlar
                                            </span>
                                        </label>
                                        
                                        <label className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer ${
                                            bulkAmountTargetRoomTypes === 'selected'
                                                ? theme === 'dark' ? 'border-green-500 bg-green-900 bg-opacity-30' : 'border-green-500 bg-green-50'
                                                : theme === 'dark' ? 'border-gray-700 bg-gray-750' : 'border-gray-200 bg-gray-50'
                                        }`}>
                                            <input
                                                type="radio"
                                                name="bulkAmountTargetRoomTypes"
                                                checked={bulkAmountTargetRoomTypes === 'selected'}
                                                onChange={() => setBulkAmountTargetRoomTypes('selected')}
                                                className="w-4 h-4 text-green-600"
                                            />
                                            <span className={`font-medium ${theme === 'dark' ? 'text-gray-200' : 'text-gray-800'}`}>
                                                ‚òëÔ∏è Se√ßili Mekan Tipleri
                                            </span>
                                        </label>
                                        
                                        {bulkAmountTargetRoomTypes === 'selected' && (
                                            <div className="ml-6 mt-2 grid grid-cols-2 gap-2">
                                                {['Salon', 'Mutfak', 'Banyo', 'Oda', 'Hol', 'Balkon'].map(roomType => (
                                                    <label 
                                                        key={roomType}
                                                        className={`flex items-center gap-2 p-2 rounded cursor-pointer ${
                                                            theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                                                        }`}
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            checked={bulkAmountSelectedRoomTypes.includes(roomType)}
                                                            onChange={(e) => {
                                                                if (e.target.checked) {
                                                                    setBulkAmountSelectedRoomTypes([...bulkAmountSelectedRoomTypes, roomType]);
                                                                } else {
                                                                    setBulkAmountSelectedRoomTypes(bulkAmountSelectedRoomTypes.filter(t => t !== roomType));
                                                                }
                                                            }}
                                                            className="w-4 h-4 text-green-600 rounded"
                                                        />
                                                        <span className={`text-sm ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                            {roomType}
                                                        </span>
                                                    </label>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Butonlar */}
                                <div className="flex gap-3 pt-4 border-t">
                                    <button
                                        onClick={() => {
                                            setShowBulkAmountModal(false);
                                            setBulkAmountFields({});
                                            setBulkAmountValues({});
                                            setBulkAmountTargetApartments('all');
                                            setBulkAmountSelectedApartments([]);
                                            setBulkAmountTargetRoomTypes('all');
                                            setBulkAmountSelectedRoomTypes([]);
                                        }}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-100 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                    <button
                                        onClick={applyBulkAmounts}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${
                                            'bg-green-600 text-white hover:bg-green-700'
                                        }`}
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Miktarlarƒ± Uygula
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* MALZEME ANALƒ∞Zƒ∞ MODAL */}
                    {/* ADMƒ∞N PANELƒ∞ MODAL */}
                    {showAdminPanel && isAdmin && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 w-full max-w-7xl max-h-[90vh] overflow-hidden flex flex-col ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                {/* Header */}
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg">
                                            <svg className="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h2 className={`text-2xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                Admin Paneli
                                            </h2>
                                            <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                Sistem y√∂netimi ve kullanƒ±cƒ± analizi
                                            </p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => setShowAdminPanel(false)}
                                        className={`text-3xl hover:opacity-70 transition-opacity ${theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}`}
                                    >√ó</button>
                                </div>

                                {/* Tabs */}
                                <div className="flex gap-2 mb-6 border-b overflow-x-auto">
                                    <button
                                        onClick={() => setAdminTab('mydata')}
                                        className={`px-6 py-3 font-semibold border-b-2 transition-colors whitespace-nowrap ${
                                            adminTab === 'mydata'
                                                ? 'border-purple-600 text-purple-600'
                                                : theme === 'dark'
                                                    ? 'border-transparent text-gray-400 hover:text-gray-200'
                                                    : 'border-transparent text-gray-600 hover:text-gray-800'
                                        }`}
                                    >
                                        <div className="flex items-center gap-2">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                            Benim Verilerim
                                        </div>
                                    </button>
                                    <button
                                        onClick={() => setAdminTab('users')}
                                        className={`px-6 py-3 font-semibold border-b-2 transition-colors whitespace-nowrap ${
                                            adminTab === 'users'
                                                ? 'border-purple-600 text-purple-600'
                                                : theme === 'dark'
                                                    ? 'border-transparent text-gray-400 hover:text-gray-200'
                                                    : 'border-transparent text-gray-600 hover:text-gray-800'
                                        }`}
                                    >
                                        <div className="flex items-center gap-2">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                            </svg>
                                            Kullanƒ±cƒ±lar ({allUsers.length})
                                        </div>
                                    </button>
                                    <button
                                        onClick={() => setAdminTab('stats')}
                                        className={`px-6 py-3 font-semibold border-b-2 transition-colors whitespace-nowrap ${
                                            adminTab === 'stats'
                                                ? 'border-purple-600 text-purple-600'
                                                : theme === 'dark'
                                                    ? 'border-transparent text-gray-400 hover:text-gray-200'
                                                    : 'border-transparent text-gray-600 hover:text-gray-800'
                                        }`}
                                    >
                                        <div className="flex items-center gap-2">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                            ƒ∞statistikler
                                        </div>
                                    </button>
                                </div>

                                {/* Content */}
                                <div className="flex-1 overflow-y-auto">
                                    {adminTab === 'mydata' && (
                                        <div className="space-y-6">
                                            <div className={`p-4 rounded-lg border-2 ${theme === 'dark' ? 'border-purple-700 bg-purple-900 bg-opacity-20' : 'border-purple-300 bg-purple-50'}`}>
                                                <p className={`text-sm ${theme === 'dark' ? 'text-purple-200' : 'text-purple-800'}`}>
                                                    üí° Kendi projelerinizi ve dairelerinizi diƒüer kullanƒ±cƒ±lara kopyalayabilirsiniz. 
                                                    Bir proje veya daire se√ßin, sonra hedef kullanƒ±cƒ±yƒ± se√ßin.
                                                </p>
                                            </div>

                                            {projects.map(project => (
                                                <div key={project.id} className={`p-6 rounded-lg border-2 ${theme === 'dark' ? 'border-gray-700 bg-gray-700' : 'border-gray-200 bg-white'}`}>
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div>
                                                            <h3 className={`text-xl font-bold mb-2 ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                                üìÅ {project.name}
                                                            </h3>
                                                            <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                {project.apartments?.length || 0} daire
                                                            </p>
                                                        </div>
                                                        <button
                                                            onClick={() => {
                                                                setAdminCopySource({ type: 'project', data: project });
                                                                setShowAdminCopyModal(true);
                                                            }}
                                                            className="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all flex items-center gap-2"
                                                        >
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                            </svg>
                                                            Projeyi Kopyala
                                                        </button>
                                                    </div>

                                                    {/* Daireler */}
                                                    <div className="space-y-2 mt-4">
                                                        {project.apartments?.map(apt => (
                                                            <div 
                                                                key={apt.id}
                                                                className={`p-3 rounded border flex justify-between items-center ${theme === 'dark' ? 'bg-gray-600 border-gray-500' : 'bg-gray-50 border-gray-300'}`}
                                                            >
                                                                <span className={`font-semibold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                                    üè† {apt.name}
                                                                </span>
                                                                <button
                                                                    onClick={() => {
                                                                        setAdminCopySource({ type: 'apartment', data: apt });
                                                                        setShowAdminCopyModal(true);
                                                                    }}
                                                                    className="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 transition-colors flex items-center gap-1"
                                                                >
                                                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                                    </svg>
                                                                    Kopyala
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {adminTab === 'users' && (
                                        <div className="space-y-4">
                                            {allUsers.length === 0 ? (
                                                <div className="text-center py-12">
                                                    <svg className="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                                    </svg>
                                                    <p className={theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}>
                                                        Hen√ºz kullanƒ±cƒ± yok
                                                    </p>
                                                </div>
                                            ) : (
                                                <div className="grid gap-4">
                                                    {allUsers.map(u => (
                                                        <div 
                                                            key={u.userId}
                                                            className={`p-6 rounded-lg border-2 transition-all cursor-pointer ${
                                                                selectedUser === u.userId
                                                                    ? 'border-purple-600 bg-purple-50'
                                                                    : theme === 'dark'
                                                                        ? 'border-gray-700 bg-gray-700 hover:border-gray-600'
                                                                        : 'border-gray-200 hover:border-gray-300'
                                                            }`}
                                                            onClick={() => setSelectedUser(selectedUser === u.userId ? null : u.userId)}
                                                        >
                                                            <div className="flex items-start justify-between">
                                                                <div className="flex items-center gap-4">
                                                                    <div className="p-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full">
                                                                        <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                                        </svg>
                                                                    </div>
                                                                    <div>
                                                                        <h3 className={`text-lg font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                                            {u.email}
                                                                        </h3>
                                                                        <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                            ID: {u.userId.substring(0, 8)}...
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <div className="flex gap-2 mb-2">
                                                                        <span className="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">
                                                                            {u.projectCount} Proje
                                                                        </span>
                                                                        <span className="px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">
                                                                            {u.apartmentCount} Daire
                                                                        </span>
                                                                    </div>
                                                                    {u.lastUpdate && (
                                                                        <p className={`text-xs ${theme === 'dark' ? 'text-gray-500' : 'text-gray-500'}`}>
                                                                            Son: {new Date(u.lastUpdate.seconds * 1000).toLocaleDateString('tr-TR')}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Kullanƒ±cƒ± detaylarƒ± */}
                                                            {selectedUser === u.userId && allUsersData[u.userId] && (
                                                                <div className="mt-4 pt-4 border-t space-y-3">
                                                                    <div className="flex justify-between items-center mb-3">
                                                                        <h4 className={`font-semibold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                                            Projeler:
                                                                        </h4>
                                                                        <button
                                                                            onClick={() => {
                                                                                // Kullanƒ±cƒ±nƒ±n verilerini y√ºkle
                                                                                const userData = allUsersData[u.userId];
                                                                                if (userData.projects) {
                                                                                    setProjects(userData.projects);
                                                                                    setCustomRooms(userData.customRooms || []);
                                                                                    setBaseRooms(userData.baseRooms || DEFAULT_ROOMS);
                                                                                    setRoomOrder(userData.roomOrder || []);
                                                                                    setFieldLabels(userData.fieldLabels || DEFAULT_FIELD_LABELS);
                                                                                    setMaterials(userData.materials || DEFAULT_MATERIALS);
                                                                                    
                                                                                    // G√∂r√ºnt√ºlenen kullanƒ±cƒ±yƒ± kaydet
                                                                                    setViewingUserId(u.userId);
                                                                                    
                                                                                    // ƒ∞lk projeyi ve daireyi se√ß
                                                                                    if (userData.projects.length > 0) {
                                                                                        setCurrentPrj(userData.projects[0].id);
                                                                                        if (userData.projects[0].apartments?.length > 0) {
                                                                                            setCurrentApt(userData.projects[0].apartments[0].id);
                                                                                        }
                                                                                    }
                                                                                    
                                                                                    setShowAdminPanel(false);
                                                                                    alert(`üìã ${u.email} kullanƒ±cƒ±sƒ±nƒ±n verileri y√ºklendi!\n\n‚ö†Ô∏è Deƒüi≈üiklikler bu kullanƒ±cƒ±ya kaydedilecek.`);
                                                                                }
                                                                            }}
                                                                            className="px-3 py-1.5 bg-gradient-to-r from-blue-600 to-cyan-600 text-white text-sm rounded-lg font-semibold hover:from-blue-700 hover:to-cyan-700 transition-all flex items-center gap-2"
                                                                        >
                                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                                            </svg>
                                                                            G√∂r√ºnt√ºle
                                                                        </button>
                                                                    </div>
                                                                    {allUsersData[u.userId].projects?.map(project => (
                                                                        <div key={project.id} className={`p-3 rounded ${theme === 'dark' ? 'bg-gray-600' : 'bg-white border'}`}>
                                                                            <div className="flex justify-between items-center">
                                                                                <span className={`font-semibold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                                                    {project.name}
                                                                                </span>
                                                                                <span className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                                    {project.apartments?.length || 0} daire
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {adminTab === 'stats' && (
                                        <div className="space-y-6">
                                            {(() => {
                                                const stats = getSystemStats();
                                                return (
                                                    <>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                            <div className={`p-6 rounded-lg border-2 ${theme === 'dark' ? 'border-gray-700 bg-gray-700' : 'border-blue-200 bg-blue-50'}`}>
                                                                <div className="flex items-center gap-4">
                                                                    <div className="p-3 bg-blue-500 rounded-lg">
                                                                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                                                        </svg>
                                                                    </div>
                                                                    <div>
                                                                        <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-blue-600'}`}>Toplam Kullanƒ±cƒ±</p>
                                                                        <p className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-blue-900'}`}>{stats.totalUsers}</p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div className={`p-6 rounded-lg border-2 ${theme === 'dark' ? 'border-gray-700 bg-gray-700' : 'border-green-200 bg-green-50'}`}>
                                                                <div className="flex items-center gap-4">
                                                                    <div className="p-3 bg-green-500 rounded-lg">
                                                                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                                                        </svg>
                                                                    </div>
                                                                    <div>
                                                                        <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-green-600'}`}>Toplam Daire</p>
                                                                        <p className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-green-900'}`}>{stats.totalApartments}</p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div className={`p-6 rounded-lg border-2 ${theme === 'dark' ? 'border-gray-700 bg-gray-700' : 'border-purple-200 bg-purple-50'}`}>
                                                                <div className="flex items-center gap-4">
                                                                    <div className="p-3 bg-purple-500 rounded-lg">
                                                                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                                        </svg>
                                                                    </div>
                                                                    <div>
                                                                        <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-purple-600'}`}>Toplam Fotoƒüraf</p>
                                                                        <p className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-purple-900'}`}>{stats.totalPhotos}</p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div className={`p-6 rounded-lg border-2 ${theme === 'dark' ? 'border-gray-700 bg-gray-700' : 'border-orange-200 bg-orange-50'}`}>
                                                                <div className="flex items-center gap-4">
                                                                    <div className="p-3 bg-orange-500 rounded-lg">
                                                                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                                                        </svg>
                                                                    </div>
                                                                    <div>
                                                                        <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-orange-600'}`}>Toplam Malzeme</p>
                                                                        <p className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-orange-900'}`}>{stats.totalMaterials}</p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div className={`p-6 rounded-lg border-2 ${theme === 'dark' ? 'border-gray-700 bg-gray-700' : 'border-cyan-200 bg-cyan-50'}`}>
                                                                <div className="flex items-center gap-4">
                                                                    <div className="p-3 bg-cyan-500 rounded-lg">
                                                                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                                                        </svg>
                                                                    </div>
                                                                    <div>
                                                                        <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-cyan-600'}`}>Toplam Proje</p>
                                                                        <p className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-cyan-900'}`}>{stats.totalProjects}</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ADMƒ∞N KOPYALAMA MODAL */}
                    {showAdminCopyModal && isAdmin && adminCopySource && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
                            <div className={`rounded-lg p-6 w-full max-w-2xl ${theme === 'dark' ? 'bg-gray-800' : 'bg-white'}`}>
                                <h2 className={`text-2xl font-bold mb-4 ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                    {adminCopySource.type === 'project' ? 'üìÅ Projeyi' : 'üè† Daireyi'} Kullanƒ±cƒ±ya Kopyala
                                </h2>
                                
                                <div className={`p-4 rounded-lg mb-6 border-2 ${theme === 'dark' ? 'border-purple-700 bg-purple-900 bg-opacity-20' : 'border-purple-300 bg-purple-50'}`}>
                                    <p className={`font-semibold mb-2 ${theme === 'dark' ? 'text-purple-200' : 'text-purple-800'}`}>
                                        Kopyalanacak {adminCopySource.type === 'project' ? 'Proje' : 'Daire'}:
                                    </p>
                                    <p className={`text-lg font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                        {adminCopySource.data.name}
                                    </p>
                                    {adminCopySource.type === 'project' && (
                                        <p className={`text-sm mt-1 ${theme === 'dark' ? 'text-purple-300' : 'text-purple-700'}`}>
                                            {adminCopySource.data.apartments?.length || 0} daire i√ßeriyor
                                        </p>
                                    )}
                                </div>

                                <h3 className={`text-lg font-semibold mb-3 ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                    Hedef Kullanƒ±cƒ± Se√ßin:
                                </h3>

                                <div className="space-y-2 max-h-96 overflow-y-auto mb-6">
                                    {allUsers.filter(u => u.userId !== user.uid).map(u => (
                                        <div
                                            key={u.userId}
                                            onClick={() => setAdminCopyTarget(adminCopyTarget === u.userId ? null : u.userId)}
                                            className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${
                                                adminCopyTarget === u.userId
                                                    ? 'border-purple-600 bg-purple-50'
                                                    : theme === 'dark'
                                                        ? 'border-gray-700 bg-gray-700 hover:border-gray-600'
                                                        : 'border-gray-200 hover:border-gray-300'
                                            }`}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <div className="p-2 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full">
                                                        <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                        </svg>
                                                    </div>
                                                    <div>
                                                        <p className={`font-semibold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                            {u.email}
                                                        </p>
                                                        <p className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                            {u.projectCount} proje, {u.apartmentCount} daire
                                                        </p>
                                                    </div>
                                                </div>
                                                {adminCopyTarget === u.userId && (
                                                    <svg className="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"></path>
                                                    </svg>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {adminCopySource.type === 'apartment' && (
                                    <div className={`p-3 rounded-lg mb-4 text-sm ${theme === 'dark' ? 'bg-blue-900 bg-opacity-20 text-blue-200' : 'bg-blue-50 text-blue-800'}`}>
                                        üí° Daire, se√ßilen kullanƒ±cƒ±nƒ±n ilk projesine eklenecek. Proje yoksa otomatik olu≈üturulacak.
                                    </div>
                                )}

                                <div className="flex gap-3">
                                    <button
                                        onClick={() => {
                                            setShowAdminCopyModal(false);
                                            setAdminCopySource(null);
                                            setAdminCopyTarget(null);
                                        }}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-200 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                    <button
                                        onClick={adminCopyToUser}
                                        disabled={!adminCopyTarget}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors flex items-center justify-center gap-2 ${
                                            adminCopyTarget
                                                ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white hover:from-purple-700 hover:to-pink-700'
                                                : 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                        }`}
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                        Kopyala
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showMaterialAnalysis && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-7xl w-full h-[90vh] flex flex-col transition-colors ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between mb-6 pb-4 border-b">
                                    <h2 className={`text-2xl font-bold flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-7 h-7 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                        Malzeme Kullanƒ±m Analizi
                                    </h2>
                                    <button 
                                        onClick={() => setShowMaterialAnalysis(false)} 
                                        className="text-3xl hover:text-gray-600 transition-colors"
                                    >√ó</button>
                                </div>
                                
                                {(() => {
                                    const analysis = getMaterialUsageAnalysis();
                                    
                                    // Kategorileri al ve alfabetik sƒ±rala, T√ºm√º'y√º sona ekle
                                    const uniqueCategories = [...new Set(analysis.map(item => item.category))].sort();
                                    const categories = [...uniqueCategories, 'T√ºm√º'];
                                    
                                    // Aktif sekmeye g√∂re filtrele
                                    const filteredAnalysis = activeAnalysisTab === 'T√ºm√º' 
                                        ? analysis 
                                        : analysis.filter(item => item.category === activeAnalysisTab);
                                    
                                    return analysis.length === 0 ? (
                                        <div className={`text-center py-12 ${
                                            theme === 'dark' ? 'text-gray-400' : 'text-gray-500'
                                        }`}>
                                            <svg className="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                            </svg>
                                            <p className="text-lg font-medium">Hen√ºz malzeme kullanƒ±mƒ± yok</p>
                                            <p className="text-sm mt-2">Dairelere malzeme ekledik√ße burada g√∂r√ºnecek</p>
                                        </div>
                                    ) : (
                                        <>
                                            {/* Sekmeler */}
                                            <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                                                {categories.map(category => (
                                                    <button
                                                        key={category}
                                                        onClick={() => setActiveAnalysisTab(category)}
                                                        className={`px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap transition-all ${
                                                            activeAnalysisTab === category
                                                                ? theme === 'dark'
                                                                    ? 'bg-cyan-600 text-white shadow-lg'
                                                                    : 'bg-cyan-500 text-white shadow-lg'
                                                                : theme === 'dark'
                                                                    ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                                                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                        }`}
                                                    >
                                                        {category}
                                                        <span className={`ml-2 px-2 py-0.5 rounded-full text-xs ${
                                                            activeAnalysisTab === category
                                                                ? 'bg-white bg-opacity-30'
                                                                : theme === 'dark'
                                                                    ? 'bg-gray-600'
                                                                    : 'bg-gray-300'
                                                        }`}>
                                                            {category === 'T√ºm√º' 
                                                                ? analysis.length 
                                                                : analysis.filter(item => item.category === category).length
                                                            }
                                                        </span>
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            {/* Malzeme Listesi */}
                                            <div className="flex-1 overflow-auto">
                                                <div className="space-y-3">
                                                    {filteredAnalysis.map((item, idx) => {
                                                    const uniqueProjects = [...new Set(item.usages.map(u => u.project))];
                                                    const uniqueApartments = [...new Set(item.usages.map(u => `${u.project}|${u.apartment}`))];
                                                    
                                                    return (
                                                        <div 
                                                            key={idx} 
                                                            className={`border-2 rounded-lg p-4 transition-all ${
                                                                theme === 'dark'
                                                                    ? 'border-gray-700 bg-gray-750 hover:bg-gray-700'
                                                                    : 'border-gray-200 bg-white hover:shadow-md'
                                                            }`}
                                                        >
                                                            <div className="flex items-center justify-between mb-3">
                                                                <div className="flex-1">
                                                                    <div className="flex items-center gap-3 mb-2">
                                                                        <h3 className={`font-bold text-lg ${
                                                                            theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                                                        }`}>
                                                                            {item.material}
                                                                        </h3>
                                                                        <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                            theme === 'dark'
                                                                                ? 'bg-blue-900 text-blue-100'
                                                                                : 'bg-blue-100 text-blue-800'
                                                                        }`}>
                                                                            {item.category}
                                                                        </span>
                                                                        {item.subgroup !== '-' && (
                                                                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                                                                                theme === 'dark'
                                                                                    ? 'bg-purple-900 text-purple-100'
                                                                                    : 'bg-purple-100 text-purple-800'
                                                                            }`}>
                                                                                {item.subgroup}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    <div className={`flex gap-6 text-sm ${
                                                                        theme === 'dark' ? 'text-gray-400' : 'text-gray-600'
                                                                    }`}>
                                                                        <span>üè¢ {uniqueProjects.length} Proje</span>
                                                                        <span>üè† {uniqueApartments.length} Daire</span>
                                                                        <span>üìç {item.usages.length} Kullanƒ±m</span>
                                                                    </div>
                                                                </div>
                                                                <div className={`text-right ${
                                                                    theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                                                }`}>
                                                                    <div className="text-2xl font-bold text-cyan-600">
                                                                        {item.totalAmount.toFixed(2)}
                                                                    </div>
                                                                    <div className="text-sm">{item.unit}</div>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Kullanƒ±m Detaylarƒ± */}
                                                            <details className="mt-3">
                                                                <summary className={`cursor-pointer font-medium ${
                                                                    theme === 'dark' ? 'text-cyan-400' : 'text-cyan-600'
                                                                } hover:underline`}>
                                                                    Detaylarƒ± G√∂ster ({item.usages.length} kullanƒ±m)
                                                                </summary>
                                                                <div className="mt-3 space-y-2 max-h-48 overflow-auto">
                                                                    {item.usages.map((usage, uIdx) => (
                                                                        <div 
                                                                            key={uIdx}
                                                                            className={`flex justify-between items-center p-3 rounded-lg text-sm ${
                                                                                theme === 'dark'
                                                                                    ? 'bg-gray-800 border border-gray-700'
                                                                                    : 'bg-gray-50 border border-gray-200'
                                                                            }`}
                                                                        >
                                                                            <div className={theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}>
                                                                                <span className="font-medium">{usage.project}</span>
                                                                                <span className="mx-2">‚Üí</span>
                                                                                <span className="font-medium">{usage.apartment}</span>
                                                                                <span className="mx-2">‚Üí</span>
                                                                                <span>{usage.room}</span>
                                                                                <span className="mx-2 text-gray-400">‚Ä¢</span>
                                                                                <span className={theme === 'dark' ? 'text-gray-500' : 'text-gray-500'}>
                                                                                    {usage.field}
                                                                                </span>
                                                                            </div>
                                                                            <div className={`font-bold ${
                                                                                theme === 'dark' ? 'text-cyan-400' : 'text-cyan-600'
                                                                            }`}>
                                                                                {usage.amount.toFixed(2)} {item.unit}
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </details>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                        </>
                                    );
                                })()}
                            </div>
                        </div>
                    )}
                    
                    
                    {/* YENƒ∞ PROJE MODAL */}
                    {showNewProjectModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                {/* Header */}
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-gradient-to-r from-purple-500 to-pink-600 rounded-lg">
                                            <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h2 className={`text-2xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                Yeni Proje Olu≈ütur
                                            </h2>
                                            <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                Proje ve daire ≈üablonunu se√ßin
                                            </p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => setShowNewProjectModal(false)}
                                        className={`text-3xl hover:opacity-70 transition-opacity ${theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}`}
                                    >√ó</button>
                                </div>

                                {/* ƒ∞√ßerik */}
                                <div className="flex-1 overflow-y-auto space-y-6">
                                    {/* Proje Adƒ± */}
                                    <div>
                                        <label className={`block text-sm font-semibold mb-2 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                            Proje Adƒ±
                                        </label>
                                        <input
                                            type="text"
                                            value={newProjectName}
                                            onChange={(e) => setNewProjectName(e.target.value)}
                                            placeholder="√ñrn: G√ºl Sitesi A Blok"
                                            className={`w-full px-4 py-3 border-2 rounded-lg focus:ring-2 transition-all ${
                                                theme === 'dark'
                                                    ? 'border-gray-600 bg-gray-700 text-white placeholder-gray-400 focus:border-purple-400 focus:ring-purple-500'
                                                    : 'border-gray-300 bg-white text-gray-900 placeholder-gray-400 focus:border-purple-500 focus:ring-purple-200'
                                            }`}
                                        />
                                    </div>

                                    {/* Daire Tipi Se√ßimi */}
                                    <div>
                                        <label className={`block text-sm font-semibold mb-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                            Daire Tipi ≈ûablonu
                                        </label>
                                        <div className="grid grid-cols-4 gap-3">
                                            {['1+1', '2+1', '3+1', '4+1'].map(template => (
                                                <button
                                                    key={template}
                                                    onClick={() => {
                                                        setSelectedTemplate(template);
                                                        setCustomRoomSetup(JSON.parse(JSON.stringify(APARTMENT_TEMPLATES[template])));
                                                    }}
                                                    className={`p-4 rounded-lg border-2 font-semibold transition-all ${
                                                        selectedTemplate === template
                                                            ? 'border-purple-600 bg-purple-50 text-purple-700'
                                                            : theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-700 text-gray-300 hover:border-gray-500'
                                                                : 'border-gray-300 bg-white text-gray-700 hover:border-gray-400'
                                                    }`}
                                                >
                                                    <div className="text-2xl mb-2">üè†</div>
                                                    <div className="text-lg">{template}</div>
                                                    <div className={`text-xs mt-1 ${selectedTemplate === template ? 'text-purple-600' : 'text-gray-500'}`}>
                                                        {APARTMENT_TEMPLATES[template].length} Mekan
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Mekan Listesi ve D√ºzenleme */}
                                    <div>
                                        <div className="flex justify-between items-center mb-3">
                                            <label className={`text-sm font-semibold ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                Dairede Bulunacak Mekanlar
                                            </label>
                                            <span className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                ƒ∞stediƒüiniz mekanlarƒ± se√ßin/kaldƒ±rƒ±n
                                            </span>
                                        </div>
                                        
                                        <div className="space-y-2 max-h-96 overflow-y-auto">
                                            {customRoomSetup.map((room, idx) => (
                                                <div key={idx} className={`p-4 rounded-lg border-2 ${
                                                    theme === 'dark' ? 'border-gray-700 bg-gray-700' : 'border-gray-200 bg-gray-50'
                                                }`}>
                                                    <div className="flex items-start gap-3">
                                                        {/* Mekan Adƒ± */}
                                                        <div className="flex-1">
                                                            <input
                                                                type="text"
                                                                value={room.name}
                                                                onChange={(e) => {
                                                                    const updated = [...customRoomSetup];
                                                                    updated[idx].name = e.target.value;
                                                                    setCustomRoomSetup(updated);
                                                                }}
                                                                className={`w-full px-3 py-2 border rounded-lg font-semibold ${
                                                                    theme === 'dark'
                                                                        ? 'border-gray-600 bg-gray-600 text-white'
                                                                        : 'border-gray-300 bg-white text-gray-900'
                                                                }`}
                                                            />
                                                            
                                                            {/* Alan Se√ßimi */}
                                                            <div className="mt-3 flex flex-wrap gap-2">
                                                                {Object.entries(fieldLabels).filter(([key]) => key !== 'foto').map(([fieldKey, fieldConfig]) => (
                                                                    <label key={fieldKey} className="flex items-center gap-2 cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={room.fields.includes(fieldKey)}
                                                                            onChange={(e) => {
                                                                                const updated = [...customRoomSetup];
                                                                                if (e.target.checked) {
                                                                                    updated[idx].fields.push(fieldKey);
                                                                                } else {
                                                                                    updated[idx].fields = updated[idx].fields.filter(f => f !== fieldKey);
                                                                                }
                                                                                setCustomRoomSetup(updated);
                                                                            }}
                                                                            className="w-4 h-4 text-purple-600 rounded focus:ring-2 focus:ring-purple-500"
                                                                        />
                                                                        <span className={`text-xs ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                                            {fieldConfig.label}
                                                                        </span>
                                                                    </label>
                                                                ))}
                                                                {/* Fotoƒüraf her zaman dahil */}
                                                                <span className={`text-xs px-2 py-1 rounded ${
                                                                    theme === 'dark' ? 'bg-purple-900 text-purple-200' : 'bg-purple-100 text-purple-700'
                                                                }`}>
                                                                    üì∑ Fotoƒüraf (Her zaman dahil)
                                                                </span>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Sil Butonu */}
                                                        <button
                                                            onClick={() => {
                                                                const updated = customRoomSetup.filter((_, i) => i !== idx);
                                                                setCustomRoomSetup(updated);
                                                            }}
                                                            className="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                                                            title="Mekanƒ± kaldƒ±r"
                                                        >
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                            
                                            {/* Yeni Mekan Ekle */}
                                            <button
                                                onClick={() => {
                                                    setCustomRoomSetup([...customRoomSetup, {
                                                        id: 'custom_' + Date.now(),
                                                        name: 'Yeni Mekan',
                                                        fields: ['zemin', 'boya', 'foto']
                                                    }]);
                                                }}
                                                className={`w-full p-4 rounded-lg border-2 border-dashed font-semibold transition-all ${
                                                    theme === 'dark'
                                                        ? 'border-gray-600 bg-gray-750 text-gray-300 hover:border-gray-500 hover:bg-gray-700'
                                                        : 'border-gray-300 bg-gray-50 text-gray-700 hover:border-gray-400 hover:bg-gray-100'
                                                }`}
                                            >
                                                + Yeni Mekan Ekle
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Footer Butonlar */}
                                <div className="flex gap-3 mt-6 pt-4 border-t">
                                    <button
                                        onClick={() => setShowNewProjectModal(false)}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-200 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (!newProjectName.trim()) {
                                                alert('L√ºtfen proje adƒ± girin!');
                                                return;
                                            }
                                            if (customRoomSetup.length === 0) {
                                                alert('En az bir mekan eklemelisiniz!');
                                                return;
                                            }
                                            
                                            // Her mekan i√ßin foto alanƒ±nƒ± ekle (eƒüer yoksa)
                                            const roomsWithPhoto = customRoomSetup.map(room => ({
                                                ...room,
                                                fields: room.fields.includes('foto') ? room.fields : [...room.fields, 'foto']
                                            }));
                                            
                                            // Yeni projeyi olu≈ütur
                                            const newId = Math.max(...projects.map(p => p.id), 0) + 1;
                                            const newProject = {
                                                id: newId,
                                                name: newProjectName.trim(),
                                                apartments: [{
                                                    id: 1,
                                                    name: 'Daire 1',
                                                    data: {},
                                                    wallCount: {},
                                                    hiddenRooms: [],
                                                    customRooms: roomsWithPhoto
                                                }]
                                            };
                                            
                                            updateProjects([...projects, newProject]);
                                            setCurrentPrj(newId);
                                            setCurrentApt(1);
                                            setShowNewProjectModal(false);
                                            
                                            alert(`‚úÖ "${newProjectName.trim()}" projesi olu≈üturuldu!\n\n${roomsWithPhoto.length} mekan eklendi.`);
                                        }}
                                        className="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all"
                                    >
                                        üéâ Projeyi Olu≈ütur
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* AR≈ûƒ∞V MODAL */}
                    {showArchiveModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-5xl w-full max-h-[85vh] overflow-hidden flex flex-col ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                {/* Header */}
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-lg">
                                            <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h2 className={`text-2xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                üì¶ Proje Ar≈üivi
                                            </h2>
                                            <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                Ar≈üivlenmi≈ü projeleri g√∂r√ºnt√ºleyin ve geri y√ºkleyin
                                            </p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => setShowArchiveModal(false)}
                                        className={`text-3xl hover:opacity-70 transition-opacity ${theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}`}
                                    >√ó</button>
                                </div>

                                {/* ƒ∞√ßerik */}
                                <div className="flex-1 overflow-y-auto">
                                    {loadingArchives ? (
                                        <div className="flex items-center justify-center h-64">
                                            <div className="text-center">
                                                <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                                <p className={theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}>
                                                    Ar≈üivler y√ºkleniyor...
                                                </p>
                                            </div>
                                        </div>
                                    ) : archivedProjects.length === 0 ? (
                                        <div className="flex flex-col items-center justify-center h-64">
                                            <svg className="w-24 h-24 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                            </svg>
                                            <p className={`text-lg font-semibold mb-2 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                Hen√ºz ar≈üivlenmi≈ü proje yok
                                            </p>
                                            <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                Tamamlanmƒ±≈ü projeleri ar≈üivleyerek d√ºzenli tutun
                                            </p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {archivedProjects.map((archive, idx) => (
                                                <div 
                                                    key={idx} 
                                                    className={`p-4 rounded-lg border-2 transition-all ${
                                                        theme === 'dark' 
                                                            ? 'border-gray-700 bg-gray-700 hover:border-blue-500' 
                                                            : 'border-gray-200 bg-gray-50 hover:border-blue-500'
                                                    }`}
                                                >
                                                    <div className="flex items-start justify-between gap-4">
                                                        {/* Sol Taraf: Proje Bilgileri */}
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <h3 className={`text-lg font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>
                                                                    {archive.projectName}
                                                                </h3>
                                                                <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-semibold">
                                                                    {archive.apartmentCount} Daire
                                                                </span>
                                                            </div>
                                                            <div className={`text-sm space-y-1 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                                <p className="flex items-center gap-2">
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                                    </svg>
                                                                    {new Date(archive.archivedAt).toLocaleDateString('tr-TR', { 
                                                                        year: 'numeric', 
                                                                        month: 'long', 
                                                                        day: 'numeric',
                                                                        hour: '2-digit',
                                                                        minute: '2-digit'
                                                                    })}
                                                                </p>
                                                                <p className="flex items-center gap-2">
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                                                    </svg>
                                                                    Dosya Boyutu: {archive.size}
                                                                </p>
                                                            </div>
                                                        </div>

                                                        {/* Saƒü Taraf: Aksiyon Butonlarƒ± */}
                                                        <div className="flex flex-col gap-2">
                                                            <button
                                                                onClick={() => restoreProject(archive)}
                                                                className="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold hover:from-green-600 hover:to-emerald-700 transition-all flex items-center gap-2"
                                                                title="Projeyi geri y√ºkle"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                                                </svg>
                                                                Geri Y√ºkle
                                                            </button>
                                                            <button
                                                                onClick={() => downloadArchive(archive)}
                                                                className={`px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 ${
                                                                    theme === 'dark'
                                                                        ? 'bg-gray-600 text-white hover:bg-gray-500'
                                                                        : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                                                }`}
                                                                title="Bilgisayara indir"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                                </svg>
                                                                ƒ∞ndir
                                                            </button>
                                                            <button
                                                                onClick={() => deleteArchive(archive)}
                                                                className="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition-all flex items-center gap-2"
                                                                title="Ar≈üivi sil"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                </svg>
                                                                Sil
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Footer */}
                                <div className="mt-6 pt-4 border-t flex justify-between items-center">
                                    <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                        Toplam {archivedProjects.length} ar≈üivlenmi≈ü proje
                                    </p>
                                    <button
                                        onClick={() => setShowArchiveModal(false)}
                                        className={`px-6 py-2 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-200 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        Kapat
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* YENƒ∞ DAƒ∞RE MODAL */}
                    {showNewApartmentModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                {/* Header */}
                                <div className="flex justify-between items-center mb-6 pb-4 border-b">
                                    <div className="flex items-center gap-3">
                                        <div className="p-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg">
                                            <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h2 className={`text-2xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>
                                                Yeni Daire Ekle
                                            </h2>
                                            <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>
                                                Daire ≈üablonunu se√ßin
                                            </p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={() => setShowNewApartmentModal(false)}
                                        className={`text-3xl hover:opacity-70 transition-opacity ${theme === 'dark' ? 'text-gray-300' : 'text-gray-600'}`}
                                    >√ó</button>
                                </div>

                                {/* ƒ∞√ßerik */}
                                <div className="flex-1 overflow-y-auto space-y-6">
                                    {/* Daire Adƒ± */}
                                    <div>
                                        <label className={`block text-sm font-semibold mb-2 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                            Daire Adƒ±
                                        </label>
                                        <input
                                            type="text"
                                            value={newApartmentName}
                                            onChange={(e) => setNewApartmentName(e.target.value)}
                                            placeholder="√ñrn: A Blok 3. Kat 12"
                                            className={`w-full px-4 py-3 border-2 rounded-lg focus:ring-2 transition-all ${
                                                theme === 'dark'
                                                    ? 'border-gray-600 bg-gray-700 text-white placeholder-gray-400 focus:border-green-400 focus:ring-green-500'
                                                    : 'border-gray-300 bg-white text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-200'
                                            }`}
                                        />
                                    </div>

                                    {/* ≈ûablon Se√ßimi */}
                                    <div>
                                        <label className={`block text-sm font-semibold mb-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                            Daire ≈ûablonu
                                        </label>
                                        <div className="grid grid-cols-5 gap-3">
                                            <button
                                                onClick={() => {
                                                    setSelectedTemplate('copy');
                                                    if (apartments[0] && apartments[0].customRooms) {
                                                        setCustomRoomSetup(JSON.parse(JSON.stringify(apartments[0].customRooms)));
                                                    }
                                                }}
                                                className={`p-4 rounded-lg border-2 font-semibold transition-all ${
                                                    selectedTemplate === 'copy'
                                                        ? 'border-blue-600 bg-blue-50 text-blue-700'
                                                        : theme === 'dark'
                                                            ? 'border-gray-600 bg-gray-700 text-gray-300 hover:border-gray-500'
                                                            : 'border-gray-300 bg-white text-gray-700 hover:border-gray-400'
                                                }`}
                                            >
                                                <div className="text-2xl mb-2">üìã</div>
                                                <div className="text-sm">ƒ∞lk Daire</div>
                                                <div className="text-sm">Gibi</div>
                                            </button>
                                            {['1+1', '2+1', '3+1', '4+1'].map(template => (
                                                <button
                                                    key={template}
                                                    onClick={() => {
                                                        setSelectedTemplate(template);
                                                        setCustomRoomSetup(JSON.parse(JSON.stringify(APARTMENT_TEMPLATES[template])));
                                                    }}
                                                    className={`p-4 rounded-lg border-2 font-semibold transition-all ${
                                                        selectedTemplate === template
                                                            ? 'border-green-600 bg-green-50 text-green-700'
                                                            : theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-700 text-gray-300 hover:border-gray-500'
                                                                : 'border-gray-300 bg-white text-gray-700 hover:border-gray-400'
                                                    }`}
                                                >
                                                    <div className="text-2xl mb-2">üè†</div>
                                                    <div className="text-lg">{template}</div>
                                                    <div className={`text-xs mt-1 ${selectedTemplate === template ? 'text-green-600' : 'text-gray-500'}`}>
                                                        {APARTMENT_TEMPLATES[template].length} Mekan
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Mekan Listesi (Yeni Proje ile aynƒ±) */}
                                    <div>
                                        <div className="flex justify-between items-center mb-3">
                                            <label className={`text-sm font-semibold ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                Dairede Bulunacak Mekanlar
                                            </label>
                                            <span className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                ƒ∞stediƒüiniz mekanlarƒ± se√ßin/kaldƒ±rƒ±n
                                            </span>
                                        </div>
                                        
                                        <div className="space-y-2 max-h-96 overflow-y-auto">
                                            {customRoomSetup.map((room, idx) => (
                                                <div key={idx} className={`p-4 rounded-lg border-2 ${
                                                    theme === 'dark' ? 'border-gray-700 bg-gray-700' : 'border-gray-200 bg-gray-50'
                                                }`}>
                                                    <div className="flex items-start gap-3">
                                                        <div className="flex-1">
                                                            <input
                                                                type="text"
                                                                value={room.name}
                                                                onChange={(e) => {
                                                                    const updated = [...customRoomSetup];
                                                                    updated[idx].name = e.target.value;
                                                                    setCustomRoomSetup(updated);
                                                                }}
                                                                className={`w-full px-3 py-2 border rounded-lg font-semibold ${
                                                                    theme === 'dark'
                                                                        ? 'border-gray-600 bg-gray-600 text-white'
                                                                        : 'border-gray-300 bg-white text-gray-900'
                                                                }`}
                                                            />
                                                            
                                                            <div className="mt-3 flex flex-wrap gap-2">
                                                                {Object.entries(fieldLabels).filter(([key]) => key !== 'foto').map(([fieldKey, fieldConfig]) => (
                                                                    <label key={fieldKey} className="flex items-center gap-2 cursor-pointer">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={room.fields.includes(fieldKey)}
                                                                            onChange={(e) => {
                                                                                const updated = [...customRoomSetup];
                                                                                if (e.target.checked) {
                                                                                    updated[idx].fields.push(fieldKey);
                                                                                } else {
                                                                                    updated[idx].fields = updated[idx].fields.filter(f => f !== fieldKey);
                                                                                }
                                                                                setCustomRoomSetup(updated);
                                                                            }}
                                                                            className="w-4 h-4 text-green-600 rounded focus:ring-2 focus:ring-green-500"
                                                                        />
                                                                        <span className={`text-xs ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                                            {fieldConfig.label}
                                                                        </span>
                                                                    </label>
                                                                ))}
                                                                <span className={`text-xs px-2 py-1 rounded ${
                                                                    theme === 'dark' ? 'bg-green-900 text-green-200' : 'bg-green-100 text-green-700'
                                                                }`}>
                                                                    üì∑ Fotoƒüraf (Her zaman dahil)
                                                                </span>
                                                            </div>
                                                        </div>
                                                        
                                                        <button
                                                            onClick={() => {
                                                                const updated = customRoomSetup.filter((_, i) => i !== idx);
                                                                setCustomRoomSetup(updated);
                                                            }}
                                                            className="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                                                            title="Mekanƒ± kaldƒ±r"
                                                        >
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                            
                                            <button
                                                onClick={() => {
                                                    setCustomRoomSetup([...customRoomSetup, {
                                                        id: 'custom_' + Date.now(),
                                                        name: 'Yeni Mekan',
                                                        fields: ['zemin', 'boya', 'foto']
                                                    }]);
                                                }}
                                                className={`w-full p-4 rounded-lg border-2 border-dashed font-semibold transition-all ${
                                                    theme === 'dark'
                                                        ? 'border-gray-600 bg-gray-750 text-gray-300 hover:border-gray-500 hover:bg-gray-700'
                                                        : 'border-gray-300 bg-gray-50 text-gray-700 hover:border-gray-400 hover:bg-gray-100'
                                                }`}
                                            >
                                                + Yeni Mekan Ekle
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Footer Butonlar */}
                                <div className="flex gap-3 mt-6 pt-4 border-t">
                                    <button
                                        onClick={() => setShowNewApartmentModal(false)}
                                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-colors ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-200 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (!newApartmentName.trim()) {
                                                alert('L√ºtfen daire adƒ± girin!');
                                                return;
                                            }
                                            if (customRoomSetup.length === 0) {
                                                alert('En az bir mekan eklemelisiniz!');
                                                return;
                                            }
                                            
                                            // Her mekan i√ßin foto alanƒ±nƒ± ekle
                                            const roomsWithPhoto = customRoomSetup.map(room => ({
                                                ...room,
                                                fields: room.fields.includes('foto') ? room.fields : [...room.fields, 'foto']
                                            }));
                                            
                                            // Yeni daireyi olu≈ütur
                                            const newId = Math.max(...apartments.map(a => a.id), 0) + 1;
                                            updateApartments([...apartments, {
                                                id: newId,
                                                name: newApartmentName.trim(),
                                                data: {},
                                                wallCount: {},
                                                hiddenRooms: [],
                                                customRooms: roomsWithPhoto
                                            }]);
                                            setCurrentApt(newId);
                                            setShowNewApartmentModal(false);
                                            
                                            alert(`‚úÖ "${newApartmentName.trim()}" dairesi eklendi!\n\n${roomsWithPhoto.length} mekan eklendi.`);
                                        }}
                                        className="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 transition-all"
                                    >
                                        üéâ Daireyi Ekle
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* ICON PICKER MODAL */}
                    {showIconPicker && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className={`rounded-lg p-6 max-w-4xl w-full max-h-[85vh] overflow-hidden flex flex-col ${
                                theme === 'dark' ? 'bg-gray-800' : 'bg-white'
                            }`}>
                                <div className="flex justify-between items-center mb-4 pb-3 border-b">
                                    <h3 className={`text-xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>
                                        üé® ƒ∞kon Se√ß <span className="text-sm font-normal opacity-70">(Emoji veya Resim)</span>
                                    </h3>
                                    <button 
                                        onClick={() => {
                                            setShowIconPicker(false);
                                            setSelectedRoomForIcon(null);
                                            setSelectedFieldForIcon(null);
                                        }}
                                        className={`text-2xl ${theme === 'dark' ? 'text-gray-300 hover:text-white' : 'text-gray-600 hover:text-gray-900'}`}
                                    >√ó</button>
                                </div>
                                
                                {/* √ñzel Emoji Giri≈ü Alanƒ± */}
                                <div className={`mb-4 p-4 rounded-lg border-2 ${
                                    theme === 'dark' ? 'border-gray-700 bg-gray-700' : 'border-gray-200 bg-gray-50'
                                }`}>
                                    <label className={`block text-sm font-semibold mb-2 ${
                                        theme === 'dark' ? 'text-gray-300' : 'text-gray-700'
                                    }`}>
                                        ‚ú® √ñzel ƒ∞kon Ekle
                                    </label>
                                    
                                    {/* Emoji Input */}
                                    <div className="flex gap-2 mb-3">
                                        <input
                                            type="text"
                                            placeholder="Emoji girin (√∂rn: üèóÔ∏è, üéØ, üíº)"
                                            className={`flex-1 px-3 py-2 rounded-lg border-2 text-2xl text-center ${
                                                theme === 'dark'
                                                    ? 'bg-gray-800 border-gray-600 text-white placeholder-gray-500'
                                                    : 'bg-white border-gray-300 text-gray-900 placeholder-gray-400'
                                            }`}
                                            maxLength="4"
                                            onKeyDown={async (e) => {
                                                if (e.key === 'Enter' && e.target.value.trim()) {
                                                    // Eski icon'u sil (eƒüer Firebase Storage URL'i ise)
                                                    if (selectedFieldForIcon) {
                                                        const oldIcon = fieldLabels[selectedFieldForIcon]?.icon;
                                                        if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                                                            await deletePhotoFromStorage(oldIcon);
                                                            console.log('üóëÔ∏è Eski field icon silindi (emoji deƒüi≈üimi)');
                                                        }
                                                    } else if (selectedRoomForIcon) {
                                                        const room = allRooms.find(r => r.id === selectedRoomForIcon);
                                                        const oldIcon = room?.customIcon;
                                                        if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                                                            await deletePhotoFromStorage(oldIcon);
                                                            console.log('üóëÔ∏è Eski room icon silindi (emoji deƒüi≈üimi)');
                                                        }
                                                    }
                                                    
                                                    // Alan i√ßin emoji
                                                    if (selectedFieldForIcon) {
                                                        const updated = {
                                                            ...fieldLabels,
                                                            [selectedFieldForIcon]: {
                                                                ...fieldLabels[selectedFieldForIcon],
                                                                icon: e.target.value.trim()
                                                            }
                                                        };
                                                        setFieldLabels(updated);
                                                        localStorage.setItem('field_labels', JSON.stringify(updated));
                                                        setShowIconPicker(false);
                                                        setSelectedFieldForIcon(null);
                                                        e.target.value = '';
                                                        return;
                                                    }
                                                    
                                                    // Mekan i√ßin emoji
                                                    const room = allRooms.find(r => r.id === selectedRoomForIcon);
                                                    if (!room) return;
                                                    
                                                    if (room.custom) {
                                                        const updated = customRooms.map(r => 
                                                            r.id === selectedRoomForIcon ? { ...r, customIcon: e.target.value.trim() } : r
                                                        );
                                                        setCustomRooms(updated);
                                                        localStorage.setItem('custom_rooms', JSON.stringify(updated));
                                                    } else {
                                                        const updated = baseRooms.map(r => 
                                                            r.id === selectedRoomForIcon ? { ...r, customIcon: e.target.value.trim() } : r
                                                        );
                                                        setBaseRooms(updated);
                                                        localStorage.setItem('base_rooms', JSON.stringify(updated));
                                                    }
                                                    
                                                    setShowIconPicker(false);
                                                    setSelectedRoomForIcon(null);
                                                    e.target.value = '';
                                                }
                                            }}
                                        />
                                        <button
                                            onClick={async (e) => {
                                                const input = e.target.parentElement.querySelector('input');
                                                if (!input.value.trim()) return;
                                                
                                                // Eski icon'u sil (eƒüer Firebase Storage URL'i ise)
                                                if (selectedFieldForIcon) {
                                                    const oldIcon = fieldLabels[selectedFieldForIcon]?.icon;
                                                    if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                                                        await deletePhotoFromStorage(oldIcon);
                                                        console.log('üóëÔ∏è Eski field icon silindi (Kullan butonu)');
                                                    }
                                                } else if (selectedRoomForIcon) {
                                                    const room = allRooms.find(r => r.id === selectedRoomForIcon);
                                                    const oldIcon = room?.customIcon;
                                                    if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                                                        await deletePhotoFromStorage(oldIcon);
                                                        console.log('üóëÔ∏è Eski room icon silindi (Kullan butonu)');
                                                    }
                                                }
                                                
                                                // Alan i√ßin emoji
                                                if (selectedFieldForIcon) {
                                                    const updated = {
                                                        ...fieldLabels,
                                                        [selectedFieldForIcon]: {
                                                            ...fieldLabels[selectedFieldForIcon],
                                                            icon: input.value.trim()
                                                        }
                                                    };
                                                    setFieldLabels(updated);
                                                    localStorage.setItem('field_labels', JSON.stringify(updated));
                                                    setShowIconPicker(false);
                                                    setSelectedFieldForIcon(null);
                                                    input.value = '';
                                                    return;
                                                }
                                                
                                                // Mekan i√ßin emoji
                                                const room = allRooms.find(r => r.id === selectedRoomForIcon);
                                                if (!room) return;
                                                
                                                if (room.custom) {
                                                    const updated = customRooms.map(r => 
                                                        r.id === selectedRoomForIcon ? { ...r, customIcon: input.value.trim() } : r
                                                    );
                                                    setCustomRooms(updated);
                                                    localStorage.setItem('custom_rooms', JSON.stringify(updated));
                                                } else {
                                                    const updated = baseRooms.map(r => 
                                                        r.id === selectedRoomForIcon ? { ...r, customIcon: input.value.trim() } : r
                                                    );
                                                    setBaseRooms(updated);
                                                    localStorage.setItem('base_rooms', JSON.stringify(updated));
                                                }
                                                
                                                setShowIconPicker(false);
                                                setSelectedRoomForIcon(null);
                                                input.value = '';
                                            }}
                                            className={`px-4 py-2 rounded-lg font-semibold transition-colors ${
                                                theme === 'dark'
                                                    ? 'bg-purple-600 text-white hover:bg-purple-700'
                                                    : 'bg-purple-500 text-white hover:bg-purple-600'
                                            }`}
                                        >
                                            Kullan
                                        </button>
                                    </div>
                                    
                                    {/* Resim Y√ºkleme */}
                                    <div className="space-y-2 mt-3">
                                        <div className="flex gap-2 items-center">
                                            <input
                                                type="file"
                                                accept="image/*"
                                                id="iconImageUpload"
                                                className="hidden"
                                                onChange={async (e) => {
                                                    const file = e.target.files[0];
                                                    if (!file) return;
                                                    
                                                    // Dosya boyutu kontrol√º (max 500KB)
                                                    if (file.size > 500000) {
                                                        alert('‚ö†Ô∏è Dosya √ßok b√ºy√ºk! L√ºtfen 500KB\'dan k√º√ß√ºk bir resim se√ßin.');
                                                        e.target.value = '';
                                                        return;
                                                    }
                                                    
                                                    console.log('üì§ Icon y√ºkleniyor...');
                                                    
                                                    // Eski icon'u sil (eƒüer Firebase Storage URL'i ise)
                                                    if (selectedFieldForIcon) {
                                                        const oldIcon = fieldLabels[selectedFieldForIcon]?.icon;
                                                        if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                                                            await deletePhotoFromStorage(oldIcon);
                                                            console.log('üóëÔ∏è Eski field icon silindi');
                                                        }
                                                    } else if (selectedRoomForIcon) {
                                                        const room = allRooms.find(r => r.id === selectedRoomForIcon);
                                                        const oldIcon = room?.customIcon;
                                                        if (oldIcon && (oldIcon.startsWith('http') && oldIcon.includes('firebasestorage'))) {
                                                            await deletePhotoFromStorage(oldIcon);
                                                            console.log('üóëÔ∏è Eski room icon silindi');
                                                        }
                                                    }
                                                    
                                                    const reader = new FileReader();
                                                    reader.onload = async (event) => {
                                                        const base64Image = event.target.result;
                                                        let iconURL = base64Image;
                                                        
                                                        // Firebase Storage'a y√ºkle (eƒüer aktifse)
                                                        if (user) {
                                                            try {
                                                                if (selectedFieldForIcon) {
                                                                    iconURL = await uploadIconToStorage(base64Image, user.uid, 'field', selectedFieldForIcon);
                                                                } else if (selectedRoomForIcon) {
                                                                    iconURL = await uploadIconToStorage(base64Image, user.uid, 'room', selectedRoomForIcon);
                                                                }
                                                            } catch (error) {
                                                                console.error('Storage y√ºkleme hatasƒ±:', error);
                                                                // Hata olursa base64 kullan
                                                            }
                                                        }
                                                        
                                                        // K√ºt√ºphaneye ekle checkbox'ƒ± i≈üaretliyse k√ºt√ºphaneye de ekle
                                                        const addToLibraryCheckbox = document.getElementById('addToLibraryCheckbox');
                                                        if (addToLibraryCheckbox && addToLibraryCheckbox.checked) {
                                                            const iconName = prompt('Icon i√ßin bir isim girin:', file.name.replace(/\.[^/.]+$/, ''));
                                                            if (iconName) {
                                                                await addIconToLibrary(iconURL, iconName);
                                                                alert('‚úÖ Icon k√ºt√ºphaneye eklendi!');
                                                            }
                                                        }
                                                        
                                                        // Alan i√ßin resim
                                                        if (selectedFieldForIcon) {
                                                            const updated = {
                                                                ...fieldLabels,
                                                                [selectedFieldForIcon]: {
                                                                    ...fieldLabels[selectedFieldForIcon],
                                                                    icon: iconURL
                                                                }
                                                            };
                                                            setFieldLabels(updated);
                                                            localStorage.setItem('field_labels', JSON.stringify(updated));
                                                            setShowIconPicker(false);
                                                            setSelectedFieldForIcon(null);
                                                            e.target.value = '';
                                                            return;
                                                        }
                                                        
                                                        // Mekan i√ßin resim
                                                        const room = allRooms.find(r => r.id === selectedRoomForIcon);
                                                        if (!room) return;
                                                        
                                                        if (room.custom) {
                                                            const updated = customRooms.map(r => 
                                                                r.id === selectedRoomForIcon ? { ...r, customIcon: iconURL } : r
                                                            );
                                                            setCustomRooms(updated);
                                                            localStorage.setItem('custom_rooms', JSON.stringify(updated));
                                                        } else {
                                                            const updated = baseRooms.map(r => 
                                                                r.id === selectedRoomForIcon ? { ...r, customIcon: iconURL } : r
                                                            );
                                                            setBaseRooms(updated);
                                                            localStorage.setItem('base_rooms', JSON.stringify(updated));
                                                        }
                                                        
                                                        setShowIconPicker(false);
                                                        setSelectedRoomForIcon(null);
                                                        e.target.value = '';
                                                    };
                                                    reader.readAsDataURL(file);
                                                }}
                                            />
                                            <label 
                                                htmlFor="iconImageUpload"
                                                className={`flex-1 px-4 py-2 rounded-lg font-semibold cursor-pointer text-center transition-colors ${
                                                    theme === 'dark'
                                                        ? 'bg-blue-600 text-white hover:bg-blue-700'
                                                        : 'bg-blue-500 text-white hover:bg-blue-600'
                                                }`}
                                            >
                                                üì∑ Resim Y√ºkle
                                            </label>
                                        </div>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                id="addToLibraryCheckbox"
                                                defaultChecked={false}
                                                className="w-4 h-4 text-blue-600 rounded"
                                            />
                                            <span className={`text-sm ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                                ‚ú® Icon'u k√ºt√ºphaneye de ekle (Diƒüer projelerde kullanmak i√ßin)
                                            </span>
                                        </label>
                                    </div>
                                    
                                    <p className={`text-xs mt-2 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                        üí° ƒ∞pucu: Emoji i√ßin <kbd className="px-1 py-0.5 bg-gray-200 text-gray-800 rounded text-xs">Win + .</kbd> (Windows) veya <kbd className="px-1 py-0.5 bg-gray-200 text-gray-800 rounded text-xs">Ctrl + Cmd + Space</kbd> (Mac) ‚Ä¢ Resimler Firebase Storage'da saklanƒ±r (max 500KB)
                                    </p>
                                </div>
                                
                                {/* Icon K√ºt√ºphanesi */}
                                {iconLibrary.length > 0 && (
                                    <div className="mt-4 pt-4 border-t">
                                        <h3 className={`text-sm font-bold mb-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                            üìö Icon K√ºt√ºphanem ({iconLibrary.length})
                                        </h3>
                                        <div className="grid grid-cols-6 gap-2 max-h-48 overflow-y-auto">
                                            {iconLibrary.map((iconItem) => (
                                                <div key={iconItem.id} className="relative group">
                                                    <button
                                                        onClick={() => applyIconFromLibrary(iconItem.icon)}
                                                        className={`w-full p-3 rounded-lg border-2 transition-all hover:scale-105 hover:shadow-lg ${
                                                            theme === 'dark'
                                                                ? 'border-gray-600 bg-gray-700 hover:border-blue-500'
                                                                : 'border-gray-200 bg-white hover:border-blue-500'
                                                        } ${iconItem.isDefault ? 'ring-2 ring-green-500' : ''}`}
                                                        title={iconItem.name}
                                                    >
                                                        {iconItem.icon.startsWith('data:image') || iconItem.icon.startsWith('http') ? (
                                                            <img src={iconItem.icon} className="w-10 h-10 mx-auto object-contain" alt={iconItem.name} />
                                                        ) : (
                                                            <span className="text-2xl">{iconItem.icon}</span>
                                                        )}
                                                        {iconItem.isDefault && (
                                                            <div className="absolute top-0 right-0 bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
                                                                ‚úì
                                                            </div>
                                                        )}
                                                    </button>
                                                    <div className="absolute top-0 left-0 right-0 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 justify-center">
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                toggleIconDefault(iconItem.id);
                                                            }}
                                                            className={`p-1 rounded text-xs ${
                                                                iconItem.isDefault
                                                                    ? 'bg-green-600 text-white'
                                                                    : 'bg-gray-600 text-white'
                                                            }`}
                                                            title={iconItem.isDefault ? 'Varsayƒ±lan' : 'Varsayƒ±lan yap'}
                                                        >
                                                            ‚úì
                                                        </button>
                                                        <button
                                                            onClick={async (e) => {
                                                                e.stopPropagation();
                                                                if (confirm(`"${iconItem.name}" icon'unu silmek istediƒüinize emin misiniz?`)) {
                                                                    await deleteIconFromLibrary(iconItem.id);
                                                                }
                                                            }}
                                                            className="bg-red-600 text-white p-1 rounded text-xs"
                                                            title="Sil"
                                                        >
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <p className={`text-xs mt-2 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                            üí° Ye≈üil tik i≈üareti varsayƒ±lan icon'larƒ± g√∂sterir - bu icon'lar yeni projelerde otomatik kullanƒ±lƒ±r
                                        </p>
                                    </div>
                                )}
                                
                                <div className="flex-1 overflow-y-auto mt-4" style={{maxHeight: '40vh'}}>
                                    <h3 className={`text-sm font-bold mb-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'}`}>
                                        üé® Hazƒ±r ƒ∞conlar
                                    </h3>
                                    <div className="grid grid-cols-8 gap-2">
                                        {Object.entries(ROOM_ICONS).map(([key, emoji]) => (
                                            <button
                                                key={key}
                                                onClick={() => applyIconToRoom(key)}
                                                className={`p-3 rounded-lg border-2 transition-all hover:scale-110 hover:shadow-lg ${
                                                    theme === 'dark'
                                                        ? 'border-gray-600 bg-gray-700 hover:border-purple-500'
                                                        : 'border-gray-200 bg-white hover:border-purple-500'
                                                }`}
                                                title={key}
                                            >
                                                <span className="text-2xl">{emoji}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="mt-4 pt-3 border-t">
                                    <button
                                        onClick={() => {
                                            setShowIconPicker(false);
                                            setSelectedRoomForIcon(null);
                                            setSelectedFieldForIcon(null);
                                        }}
                                        className={`w-full px-4 py-2 rounded-lg font-semibold ${
                                            theme === 'dark'
                                                ? 'bg-gray-700 text-gray-200 hover:bg-gray-600'
                                                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                                        }`}
                                    >
                                        ƒ∞ptal
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {lightbox && (
                        <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50" onClick={() => setLightbox(null)}>
                            <img src={lightbox} className="max-w-full max-h-full rounded" />
                            <button className="absolute top-4 right-4 text-white text-3xl bg-black bg-opacity-50 w-12 h-12 rounded-full">√ó</button>
                        </div>
                    )}
                    
                    <div className={`max-w-6xl mx-auto rounded-lg shadow p-6 transition-colors ${
                        theme === 'dark'
                            ? 'bg-gray-800 text-gray-100'
                            : 'bg-white text-gray-900'
                    }`}>
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center gap-3">
                                <h1 className={`text-2xl font-bold ${theme === 'dark' ? 'text-blue-400' : 'text-blue-600'}`}>Daire Se√ßim Listeleri</h1>
                                
                                {/* Admin Badge */}
                                {isAdmin && (
                                    <div className="flex items-center gap-2">
                                        <span className="px-3 py-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs font-bold rounded-full shadow-lg flex items-center gap-1">
                                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                            </svg>
                                            ADMIN
                                        </span>
                                        
                                        {viewingUserId && (
                                            <button
                                                onClick={async () => {
                                                    if (confirm('Kendi verilerinize d√∂nmek istiyor musunuz?\n\nKaydedilmemi≈ü deƒüi≈üiklikler kaybolacak!')) {
                                                        setViewingUserId(null);
                                                        
                                                        // Kendi verilerini y√ºkle
                                                        const data = await loadFromFirebase();
                                                        if (data) {
                                                            setProjects(data.projects || [{ id: 1, name: 'Proje 1', apartments: [{ id: 1, name: 'Daire 1', data: {}, wallCount: {} }] }]);
                                                            setCustomRooms(data.customRooms || []);
                                                            setBaseRooms(data.baseRooms || DEFAULT_ROOMS);
                                                            setRoomOrder(data.roomOrder || []);
                                                            setFieldLabels(data.fieldLabels || DEFAULT_FIELD_LABELS);
                                                            setMaterials(data.materials || DEFAULT_MATERIALS);
                                                        }
                                                        
                                                        alert('‚úÖ Kendi verilerinize d√∂nd√ºn√ºz!');
                                                    }
                                                }}
                                                className="px-3 py-1 bg-blue-600 text-white text-xs font-bold rounded-full shadow-lg hover:bg-blue-700 transition-colors flex items-center gap-1"
                                            >
                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                                </svg>
                                                Geri D√∂n
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                            
                            {/* Firebase Durum G√∂stergesi */}
                            <div className="flex items-center gap-3">
                                {/* Ge√ßici Bildirimler (ba≈üarƒ±/hata) */}
                                {firebaseStatus.message && firebaseStatus.type !== 'connected' && (
                                    <div className={`flex items-center gap-2 px-4 py-2 rounded-lg shadow-md animate-pulse ${
                                        firebaseStatus.type === 'success' 
                                            ? 'bg-green-100 text-green-800 border border-green-300' 
                                            : firebaseStatus.type === 'error'
                                            ? 'bg-red-100 text-red-800 border border-red-300'
                                            : firebaseStatus.type === 'loading'
                                            ? 'bg-blue-100 text-blue-800 border border-blue-300'
                                            : 'bg-yellow-100 text-yellow-800 border border-yellow-300'
                                    }`}>
                                        {firebaseStatus.type === 'success' && (
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        )}
                                        {firebaseStatus.type === 'error' && (
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        )}
                                        {firebaseStatus.type === 'loading' && (
                                            <svg className="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                            </svg>
                                        )}
                                        {firebaseStatus.type === 'warning' && (
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                        )}
                                        <span className="text-sm font-semibold">{firebaseStatus.message}</span>
                                    </div>
                                )}
                                
                                {/* Sabit Online/Offline G√∂stergesi */}
                                {firebaseEnabled && user && (
                                    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full shadow-sm border ${
                                        firebaseStatus.connected
                                            ? 'bg-green-50 text-green-700 border-green-200'
                                            : 'bg-red-50 text-red-700 border-red-200'
                                    }`}>
                                        <div className={`w-2 h-2 rounded-full ${
                                            firebaseStatus.connected ? 'bg-green-500' : 'bg-red-500'
                                        }`}></div>
                                        <span className="text-xs font-medium">
                                            {firebaseStatus.connected ? '√áevrimi√ßi' : '√áevrimdƒ±≈üƒ±'}
                                        </span>
                                        {lastSyncTime && firebaseStatus.connected && (
                                            <span className="text-xs opacity-60">
                                                ‚Ä¢ {lastSyncTime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                            </span>
                                        )}
                                    </div>
                                )}
                                
                                {/* √áƒ±kƒ±≈ü Butonu */}
                                <button 
                                    onClick={async () => {
                                        if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?')) {
                                            if (user && firebaseEnabled) {
                                                await signOut();
                                            } else {
                                                // Firebase yoksa manuel √ßƒ±kƒ±≈ü
                                                window.location.reload();
                                            }
                                        }
                                    }}
                                    className="bg-red-500 hover:bg-red-600 rounded-lg px-4 py-2 flex items-center gap-2 transition-all shadow-md hover:shadow-lg"
                                    title={user?.email || '√áƒ±kƒ±≈ü'}
                                >
                                    <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    <span className="text-white text-sm font-bold">√áƒ±kƒ±≈ü</span>
                                </button>
                            </div>
                        </div>
                        <div className="mb-4 pb-3 border-b space-y-3">
                            <div className="flex gap-2 items-center">
                                <span className={`font-semibold ${theme === 'dark' ? 'text-purple-400' : 'text-purple-600'}`}>Proje:</span>
                                <select value={currentPrj} onChange={(e) => { 
                                    const newPrj = parseInt(e.target.value);
                                    setCurrentPrj(newPrj); 
                                    const proj = projects.find(p => p.id === newPrj);
                                    if (proj && proj.apartments[0]) setCurrentApt(proj.apartments[0].id); 
                                }} className={`px-4 py-2 border-2 rounded-lg font-semibold focus:ring-2 transition-colors ${
                                    theme === 'dark'
                                        ? 'border-purple-600 text-purple-300 bg-gray-700 focus:ring-purple-500'
                                        : 'border-purple-500 text-purple-700 bg-white focus:ring-purple-300'
                                }`}>
                                    {projects.map(proj => (
                                        <option key={proj.id} value={proj.id} className={theme === 'dark' ? 'bg-gray-700 text-gray-100' : 'bg-white text-gray-900'}>{proj.name}</option>
                                    ))}
                                </select>
                                <button onClick={() => {
                                    const newName = prompt('Proje adi:', getProject().name);
                                    if (newName && newName.trim()) {
                                        updateProjects(projects.map(p => p.id === currentPrj ? { ...p, name: newName.trim() } : p));
                                    }
                                }} className="px-3 py-2 bg-yellow-500 text-white rounded-lg text-sm hover:bg-yellow-600" title="Proje adini degistir">‚úèÔ∏è</button>
                                <button onClick={() => {
                                    const newId = Math.max(...projects.map(p => p.id), 0) + 1;
                                    setNewProjectName('Proje ' + newId);
                                    setSelectedTemplate('2+1');
                                    setCustomRoomSetup(JSON.parse(JSON.stringify(APARTMENT_TEMPLATES['2+1'])));
                                    setShowNewProjectModal(true);
                                }} className="px-3 py-2 bg-purple-500 text-white rounded-lg text-sm font-semibold hover:bg-purple-600">+ Yeni Proje</button>
                                
                                {/* Sil Butonu - Sadece birden fazla proje varsa */}
                                {projects.length > 1 && (
                                    <button 
                                        onClick={() => { 
                                            if (confirm('Bu projeyi silmek istediginize emin misiniz?')) {
                                                const remaining = projects.filter(p => p.id !== currentPrj);
                                                updateProjects(remaining);
                                                setCurrentPrj(remaining[0].id);
                                                if (remaining[0].apartments[0]) setCurrentApt(remaining[0].apartments[0].id);
                                            }
                                        }} 
                                        className="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600" 
                                        title="Projeyi sil"
                                    >üóëÔ∏è</button>
                                )}
                            </div>
                            
                            <div className="flex gap-2 items-center flex-wrap">
                                <span className={`font-semibold ${theme === 'dark' ? 'text-blue-400' : 'text-blue-600'}`}>Daire:</span>
                                <select value={currentApt} onChange={(e) => setCurrentApt(parseInt(e.target.value))} className={`px-4 py-2 border-2 rounded-lg font-semibold focus:ring-2 min-w-[200px] transition-colors ${
                                    theme === 'dark'
                                        ? 'border-blue-600 text-blue-300 bg-gray-700 focus:ring-blue-500'
                                        : 'border-blue-500 text-blue-700 bg-white focus:ring-blue-300'
                                }`}>
                                    {apartments.map(apt => (
                                        <option key={apt.id} value={apt.id} className={theme === 'dark' ? 'bg-gray-700 text-gray-100' : 'bg-white text-gray-900'}>{apt.name}</option>
                                    ))}
                                </select>
                                <button onClick={() => {
                                    const newName = prompt('Daire adi:', getApt().name);
                                    if (newName && newName.trim()) {
                                        updateApartments(apartments.map(a => a.id === currentApt ? { ...a, name: newName.trim() } : a));
                                    }
                                }} className="px-3 py-2 bg-yellow-500 text-white rounded-lg text-sm hover:bg-yellow-600" title="Daire adini degistir">‚úèÔ∏è</button>
                                
                                {/* Kopyala Dropdown */}
                                <div className="relative dropdown-container">
                                    <button 
                                        onClick={() => setShowCopyDropdown(!showCopyDropdown)}
                                        className="px-3 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg text-sm font-semibold hover:from-purple-700 hover:to-pink-700 flex items-center gap-2 shadow-md transition-all"
                                        title="Kopyala men√ºs√º"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                        Kopyala
                                        <svg className={`w-4 h-4 transition-transform ${showCopyDropdown ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    
                                    {/* Dropdown Menu */}
                                    {showCopyDropdown && (
                                        <div className={`absolute right-0 mt-2 w-56 rounded-lg shadow-xl z-50 border-2 ${
                                            theme === 'dark' 
                                                ? 'bg-gray-800 border-gray-700' 
                                                : 'bg-white border-gray-200'
                                        }`}>
                                            <div className="py-1">
                                                {/* Daire Kopyala */}
                                                <button
                                                    onClick={() => {
                                                        setShowCopyDropdown(false);
                                                        setShowCopyModal(true);
                                                    }}
                                                    className={`w-full px-4 py-3 text-left flex items-center gap-3 transition-colors ${
                                                        theme === 'dark'
                                                            ? 'hover:bg-gray-700 text-gray-200'
                                                            : 'hover:bg-gray-50 text-gray-800'
                                                    }`}
                                                >
                                                    <div className="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                                        <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                        </svg>
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                            Daire Kopyala
                                                        </div>
                                                        <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                            Daireyi √ßoƒüalt
                                                        </div>
                                                    </div>
                                                </button>
                                                
                                                {/* Ayƒ±rƒ±cƒ± √ßizgi */}
                                                <div className={`border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}></div>
                                                
                                                {/* Miktar Kopyala */}
                                                <button
                                                    onClick={() => {
                                                        setShowCopyDropdown(false);
                                                        setShowCopyAmountsModal(true);
                                                    }}
                                                    className={`w-full px-4 py-3 text-left flex items-center gap-3 transition-colors ${
                                                        theme === 'dark'
                                                            ? 'hover:bg-gray-700 text-gray-200'
                                                            : 'hover:bg-gray-50 text-gray-800'
                                                    }`}
                                                >
                                                    <div className="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                                                        <svg className="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                                        </svg>
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                            Miktar Kopyala
                                                        </div>
                                                        <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                            Ba≈üka daireden miktarlarƒ± al
                                                        </div>
                                                    </div>
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <button onClick={() => {
                                    const newId = Math.max(...apartments.map(a => a.id), 0) + 1;
                                    setNewApartmentName('Daire ' + newId);
                                    // ƒ∞lk dairenin ≈üablonunu kopyala
                                    if (apartments[0] && apartments[0].customRooms) {
                                        setCustomRoomSetup(JSON.parse(JSON.stringify(apartments[0].customRooms)));
                                    } else {
                                        setCustomRoomSetup(JSON.parse(JSON.stringify(APARTMENT_TEMPLATES['2+1'])));
                                    }
                                    setSelectedTemplate('copy'); // ƒ∞lk daire gibi
                                    setShowNewApartmentModal(true);
                                }} className="px-3 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold hover:bg-green-600">+ Yeni Daire</button>
                                {apartments.length > 1 && (
                                    <>
                                        <button onClick={() => {
                                            if (confirm('Bu daireyi silmek istediginize emin misiniz?')) {
                                                const remaining = apartments.filter(a => a.id !== currentApt);
                                                updateApartments(remaining);
                                                if (remaining[0]) setCurrentApt(remaining[0].id);
                                            }
                                        }} className="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600" title="Daireyi sil">üóëÔ∏è</button>
                                        
                                        {/* Toplu ƒ∞≈ülemler Dropdown */}
                                        <div className="relative dropdown-container">
                                            <button 
                                                onClick={() => setShowBulkActionsDropdown(!showBulkActionsDropdown)}
                                                className="px-3 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg text-sm font-semibold hover:from-purple-700 hover:to-indigo-700 flex items-center gap-2 shadow-md transition-all"
                                                title="Toplu i≈ülemler men√ºs√º"
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                                </svg>
                                                Toplu ƒ∞≈ülemler
                                                <svg className={`w-4 h-4 transition-transform ${showBulkActionsDropdown ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                            
                                            {/* Dropdown Menu */}
                                            {showBulkActionsDropdown && (
                                                <div className={`absolute right-0 mt-2 w-56 rounded-lg shadow-xl z-50 border-2 ${
                                                    theme === 'dark' 
                                                        ? 'bg-gray-800 border-gray-700' 
                                                        : 'bg-white border-gray-200'
                                                }`}>
                                                    <div className="py-1">
                                                        {/* Toplu Sil */}
                                                        <button
                                                            onClick={() => {
                                                                setShowBulkActionsDropdown(false);
                                                                setSelectedApartmentsForDelete([]);
                                                                setShowBulkDeleteModal(true);
                                                            }}
                                                            className={`w-full px-4 py-3 text-left flex items-center gap-3 transition-colors ${
                                                                theme === 'dark'
                                                                    ? 'hover:bg-gray-700 text-gray-200'
                                                                    : 'hover:bg-gray-50 text-gray-800'
                                                            }`}
                                                        >
                                                            <div className="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                                                <svg className="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                </svg>
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                                    Toplu Sil
                                                                </div>
                                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                                    Birden fazla daireyi sil
                                                                </div>
                                                            </div>
                                                        </button>
                                                        
                                                        {/* Ayƒ±rƒ±cƒ± √ßizgi */}
                                                        <div className={`border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}></div>
                                                        
                                                        {/* Toplu Malzeme */}
                                                        <button
                                                            onClick={() => {
                                                                setShowBulkActionsDropdown(false);
                                                                setShowBulkMaterialModal(true);
                                                            }}
                                                            className={`w-full px-4 py-3 text-left flex items-center gap-3 transition-colors ${
                                                                theme === 'dark'
                                                                    ? 'hover:bg-gray-700 text-gray-200'
                                                                    : 'hover:bg-gray-50 text-gray-800'
                                                            }`}
                                                        >
                                                            <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                                                <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                                                                </svg>
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                                    Toplu Malzeme
                                                                </div>
                                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                                    Malzeme se√ßimi uygula
                                                                </div>
                                                            </div>
                                                        </button>
                                                        
                                                        {/* Ayƒ±rƒ±cƒ± √ßizgi */}
                                                        <div className={`border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}></div>
                                                        
                                                        {/* Toplu Miktar */}
                                                        <button
                                                            onClick={() => {
                                                                setShowBulkActionsDropdown(false);
                                                                setShowBulkAmountModal(true);
                                                            }}
                                                            className={`w-full px-4 py-3 text-left flex items-center gap-3 transition-colors ${
                                                                theme === 'dark'
                                                                    ? 'hover:bg-gray-700 text-gray-200'
                                                                    : 'hover:bg-gray-50 text-gray-800'
                                                            }`}
                                                        >
                                                            <div className="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                                                <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                                                </svg>
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                                    Toplu Miktar
                                                                </div>
                                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                                    Miktar giri≈üi uygula
                                                                </div>
                                                            </div>
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Ar≈üiv Dropdown */}
                                        <div className="relative dropdown-container">
                                            <button 
                                                onClick={() => setShowArchiveDropdown(!showArchiveDropdown)}
                                                className="px-3 py-2 bg-gradient-to-r from-orange-600 to-amber-600 text-white rounded-lg text-sm font-semibold hover:from-orange-700 hover:to-amber-700 flex items-center gap-2 shadow-md transition-all"
                                                title="Ar≈üiv i≈ülemleri men√ºs√º"
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                                                </svg>
                                                Ar≈üiv
                                                <svg className={`w-4 h-4 transition-transform ${showArchiveDropdown ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                            
                                            {/* Dropdown Menu */}
                                            {showArchiveDropdown && (
                                                <div className={`absolute right-0 mt-2 w-56 rounded-lg shadow-xl z-50 border-2 ${
                                                    theme === 'dark' 
                                                        ? 'bg-gray-800 border-gray-700' 
                                                        : 'bg-white border-gray-200'
                                                }`}>
                                                    <div className="py-1">
                                                        {/* Projeyi Kaydet */}
                                                        <button
                                                            onClick={async () => {
                                                                setShowArchiveDropdown(false);
                                                                await saveProjectToFirebase();
                                                            }}
                                                            className={`w-full px-4 py-3 text-left flex items-center gap-3 transition-colors ${
                                                                theme === 'dark'
                                                                    ? 'hover:bg-gray-700 text-gray-200'
                                                                    : 'hover:bg-gray-50 text-gray-800'
                                                            }`}
                                                        >
                                                            <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                                                <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                                                </svg>
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                                    Firebase'e Kaydet
                                                                </div>
                                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                                    Buluta anƒ±nda kaydet
                                                                </div>
                                                            </div>
                                                        </button>
                                                        
                                                        {/* Ayƒ±rƒ±cƒ± √ßizgi */}
                                                        <div className={`border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}></div>
                                                        
                                                        {/* Bilgisayara ƒ∞ndir */}
                                                        <button
                                                            onClick={() => {
                                                                setShowArchiveDropdown(false);
                                                                const project = getProject();
                                                                const exportData = {
                                                                    project: project,
                                                                    exportedAt: Date.now(),
                                                                    exportedBy: auth?.currentUser?.email || 'local',
                                                                    version: '1.0'
                                                                };
                                                                
                                                                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                                                                const url = URL.createObjectURL(blob);
                                                                const a = document.createElement('a');
                                                                a.href = url;
                                                                a.download = `${project.name.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.json`;
                                                                document.body.appendChild(a);
                                                                a.click();
                                                                document.body.removeChild(a);
                                                                URL.revokeObjectURL(url);
                                                                
                                                                alert('‚úÖ Proje bilgisayarƒ±nƒ±za kaydedildi!');
                                                            }}
                                                            className={`w-full px-4 py-3 text-left flex items-center gap-3 transition-colors ${
                                                                theme === 'dark'
                                                                    ? 'hover:bg-gray-700 text-gray-200'
                                                                    : 'hover:bg-gray-50 text-gray-800'
                                                            }`}
                                                        >
                                                            <div className="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                                                                <svg className="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                                </svg>
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                                    Bilgisayara ƒ∞ndir
                                                                </div>
                                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                                    JSON dosyasƒ± olarak indir
                                                                </div>
                                                            </div>
                                                        </button>
                                                        
                                                        {/* Ayƒ±rƒ±cƒ± √ßizgi */}
                                                        <div className={`border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}></div>
                                                        
                                                        {/* Bilgisayardan Y√ºkle */}
                                                        <button
                                                            onClick={() => {
                                                                setShowArchiveDropdown(false);
                                                                const input = document.createElement('input');
                                                                input.type = 'file';
                                                                input.accept = '.json';
                                                                input.onchange = async (e) => {
                                                                    const file = e.target.files[0];
                                                                    if (!file) return;
                                                                    
                                                                    try {
                                                                        const text = await file.text();
                                                                        const data = JSON.parse(text);
                                                                        
                                                                        if (!data.project) {
                                                                            alert('‚ùå Ge√ßersiz proje dosyasƒ±!');
                                                                            return;
                                                                        }
                                                                        
                                                                        // Yeni ID ata
                                                                        const newId = Math.max(...projects.map(p => p.id), 0) + 1;
                                                                        data.project.id = newId;
                                                                        data.project.name = data.project.name + ' (Y√ºklendi)';
                                                                        
                                                                        // Projeyi ekle
                                                                        const updatedProjects = [...projects, data.project];
                                                                        updateProjects(updatedProjects);
                                                                        setCurrentPrj(newId);
                                                                        
                                                                        if (data.project.apartments[0]) {
                                                                            setCurrentApt(data.project.apartments[0].id);
                                                                        }
                                                                        
                                                                        alert(`‚úÖ "${data.project.name}" ba≈üarƒ±yla y√ºklendi!`);
                                                                    } catch (error) {
                                                                        console.error('‚ùå Dosya y√ºkleme hatasƒ±:', error);
                                                                        alert('‚ùå Dosya y√ºkleme ba≈üarƒ±sƒ±z: ' + error.message);
                                                                    }
                                                                };
                                                                input.click();
                                                            }}
                                                            className={`w-full px-4 py-3 text-left flex items-center gap-3 transition-colors ${
                                                                theme === 'dark'
                                                                    ? 'hover:bg-gray-700 text-gray-200'
                                                                    : 'hover:bg-gray-50 text-gray-800'
                                                            }`}
                                                        >
                                                            <div className="w-8 h-8 bg-teal-100 rounded-lg flex items-center justify-center">
                                                                <svg className="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                                </svg>
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                                    Bilgisayardan Y√ºkle
                                                                </div>
                                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                                    JSON dosyasƒ±ndan proje y√ºkle
                                                                </div>
                                                            </div>
                                                        </button>
                                                        
                                                        {/* Ayƒ±rƒ±cƒ± √ßizgi */}
                                                        <div className={`border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}></div>
                                                        
                                                        {/* Projeyi Ar≈üivle */}
                                                        <button
                                                            onClick={async () => {
                                                                setShowArchiveDropdown(false);
                                                                const project = getProject();
                                                                
                                                                // Tek proje varsa uyarƒ± g√∂ster
                                                                if (projects.length === 1) {
                                                                    if (!confirm(`"${project.name}" tek projeniz. Ar≈üivlediƒüinizde aktif proje kalmayacak.\n\nDevam etmek istiyor musunuz?`)) {
                                                                        return;
                                                                    }
                                                                }
                                                                
                                                                if (confirm(`"${project.name}" projesini ar≈üivlemek istediƒüinize emin misiniz?\n\nProje Firebase Storage'a kaydedilecek ve aktif listeden kaldƒ±rƒ±lacak.`)) {
                                                                    const success = await archiveProject(project);
                                                                    if (success) {
                                                                        // Projeyi aktif listeden kaldƒ±r
                                                                        const remaining = projects.filter(p => p.id !== currentPrj);
                                                                        
                                                                        if (remaining.length > 0) {
                                                                            updateProjects(remaining);
                                                                            setCurrentPrj(remaining[0].id);
                                                                            if (remaining[0].apartments[0]) setCurrentApt(remaining[0].apartments[0].id);
                                                                        } else {
                                                                            // T√ºm projeler ar≈üivlendi, yeni proje olu≈ütur
                                                                            const newProject = {
                                                                                id: 1,
                                                                                name: 'Yeni Proje',
                                                                                apartments: [{ id: 1, name: 'Daire 1', data: {}, wallCount: {} }]
                                                                            };
                                                                            updateProjects([newProject]);
                                                                            setCurrentPrj(1);
                                                                            setCurrentApt(1);
                                                                        }
                                                                        
                                                                        alert(`‚úÖ "${project.name}" ba≈üarƒ±yla ar≈üivlendi!`);
                                                                    }
                                                                }
                                                            }}
                                                            className={`w-full px-4 py-3 text-left flex items-center gap-3 transition-colors ${
                                                                theme === 'dark'
                                                                    ? 'hover:bg-gray-700 text-gray-200'
                                                                    : 'hover:bg-gray-50 text-gray-800'
                                                            }`}
                                                        >
                                                            <div className="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                                                <svg className="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                                                                </svg>
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                                    Projeyi Ar≈üivle
                                                                </div>
                                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                                    Aktif listeden kaldƒ±r
                                                                </div>
                                                            </div>
                                                        </button>
                                                        
                                                        {/* Ayƒ±rƒ±cƒ± √ßizgi */}
                                                        <div className={`border-t ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}`}></div>
                                                        
                                                        {/* Ar≈üiv Y√∂netimi */}
                                                        <button
                                                            onClick={() => {
                                                                setShowArchiveDropdown(false);
                                                                setShowArchiveModal(true);
                                                                loadArchivedProjects();
                                                            }}
                                                            className={`w-full px-4 py-3 text-left flex items-center gap-3 transition-colors ${
                                                                theme === 'dark'
                                                                    ? 'hover:bg-gray-700 text-gray-200'
                                                                    : 'hover:bg-gray-50 text-gray-800'
                                                            }`}
                                                        >
                                                            <div className="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                                                <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                                                                </svg>
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className={`font-semibold ${theme === 'dark' ? 'text-gray-100' : 'text-gray-900'}`}>
                                                                    Ar≈üiv Y√∂netimi
                                                                </div>
                                                                <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>
                                                                    Ar≈üivlenmi≈ü projeleri g√∂r
                                                                </div>
                                                            </div>
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-[420px,1fr,1fr] gap-4">
                            <div className={`rounded-xl shadow-lg p-5 border transition-colors ${
                                theme === 'dark'
                                    ? 'bg-gray-800 border-gray-700'
                                    : 'bg-white border-gray-200'
                            }`}>
                                {/* Header */}
                                <div className="flex justify-between items-center mb-4 pb-3 border-b-2 border-gray-100">
                                    <h3 className={`font-bold text-lg flex items-center gap-2 ${
                                        theme === 'dark' ? 'text-gray-100' : 'text-gray-800'
                                    }`}>
                                        <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                        </svg>
                                        Mahaller
                                    </h3>
                                    <div className="flex gap-2">
                                        <button onClick={resetRoomOrder} className="px-3 py-2 bg-gray-500 text-white rounded-lg text-sm font-medium hover:bg-gray-600 shadow-sm hover:shadow-md transition-all" title="Sƒ±ralamayƒ± sƒ±fƒ±rla">
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                            </svg>
                                        </button>
                                        <button onClick={addCustomRoom} className="px-3 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600 shadow-sm hover:shadow-md transition-all flex items-center gap-1" title="Yeni mekan ekle">
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Arama Kutusu */}
                                <div className="mb-3">
                                    <div className="relative">
                                        <input
                                            type="text"
                                            placeholder="Mekan ara..."
                                            value={searchRoom}
                                            onChange={(e) => setSearchRoom(e.target.value)}
                                            className="w-full pl-10 pr-4 py-2.5 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                                        />
                                        <svg className="absolute left-3 top-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                
                                {/* Mekan Listesi */}
                                <div className="space-y-2">
                                {visibleRooms.filter(r => r.name.toLowerCase().includes(searchRoom.toLowerCase())).map(r => (
                                    <div 
                                        key={r.id} 
                                        className={`group relative rounded-lg border-2 transition-all duration-200 ${
                                            currentRoom === r.id 
                                                ? 'border-blue-500 bg-gradient-to-r from-blue-50 to-blue-100 shadow-md' 
                                                : 'border-gray-200 bg-white hover:border-blue-300 hover:shadow-md'
                                        }`}
                                        draggable="true"
                                        onDragStart={(e) => handleDragStart(e, r.id)}
                                        onDragEnd={handleDragEnd}
                                        onDragOver={handleDragOver}
                                        onDrop={(e) => handleDrop(e, r.id)}
                                    >
                                        <div className="flex items-center gap-2 p-2">
                                            {/* Drag Handle */}
                                            <span className="text-gray-400 hover:text-blue-600 cursor-move px-1 transition-colors" title="S√ºr√ºkleyip ta≈üƒ±yƒ±n">
                                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z"></path>
                                                </svg>
                                            </span>
                                            
                                            {/* Mekan Adƒ± */}
                                            <button 
                                                onClick={() => setCurrentRoom(r.id)} 
                                                className={`flex-1 text-left px-3 py-3 rounded-lg font-medium text-sm transition-all flex items-center gap-3 ${
                                                    currentRoom === r.id 
                                                        ? 'text-blue-700 font-semibold' 
                                                        : 'text-gray-700 hover:text-blue-600'
                                                }`}
                                            >
                                                <span className={`flex-shrink-0 ${currentRoom === r.id ? 'text-blue-600' : 'text-gray-400'}`}>
                                                    {getRoomIcon(r)}
                                                </span>
                                                <span className="flex-1 break-words">{r.name}</span>
                                            </button>
                                            
                                            {/* Action Buttons - Hover'da g√∂r√ºn√ºr */}
                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                {/* Icon Se√ßme */}
                                                <button 
                                                    onClick={() => selectIconForRoom(r.id)} 
                                                    className="p-1.5 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition-colors shadow-sm" 
                                                    title="Icon se√ß"
                                                >
                                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </button>
                                                
                                                {/* Alan D√ºzenleme */}
                                                {(r.custom || r.editable) && (
                                                    <button 
                                                        onClick={() => editRoomFields(r.id)} 
                                                        className="p-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors shadow-sm" 
                                                        title="Alanlarƒ± d√ºzenle"
                                                    >
                                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                        </svg>
                                                    </button>
                                                )}
                                                
                                                {/* ƒ∞sim D√ºzenleme */}
                                                <button 
                                                    onClick={() => editRoomName(r.id)} 
                                                    className="p-1.5 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors shadow-sm" 
                                                    title="ƒ∞sim d√ºzenle"
                                                >
                                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                    </svg>
                                                </button>
                                                
                                                {/* Kopyalama */}
                                                <button 
                                                    onClick={() => copyRoom(r.id)} 
                                                    className="p-1.5 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors shadow-sm" 
                                                    title="Kopyala"
                                                >
                                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                    </svg>
                                                </button>
                                                
                                                {/* Silme */}
                                                {(r.custom || r.deletable) && (
                                                    <button 
                                                        onClick={() => deleteRoom(r.id)} 
                                                        className="p-1.5 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors shadow-sm" 
                                                        title="Sil"
                                                    >
                                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                </div>
                                
                                {/* Kaydet Butonu */}
                                <button onClick={save} className="w-full mt-6 px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-green-600 hover:to-emerald-700 transition-all flex items-center justify-center gap-2">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                    </svg>
                                    Kaydet
                                </button>
                                
                                {/* Tema Deƒüi≈ütirme */}
                                <div className="mt-4 border-t pt-4">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Analiz & Raporlar</h4>
                                    
                                    {/* Admin Panel Butonu */}
                                    {isAdmin && (
                                        <button 
                                            onClick={() => {
                                                loadAllUsersData();
                                                setShowAdminPanel(true);
                                            }}
                                            className="w-full mb-3 px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-purple-700 hover:to-pink-700 transition-all flex items-center justify-center gap-2"
                                        >
                                            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                            </svg>
                                            Admin Paneli
                                        </button>
                                    )}
                                    
                                    <button 
                                        onClick={() => setShowMaterialAnalysis(true)}
                                        className="w-full mb-3 px-4 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-cyan-600 hover:to-blue-700 transition-all flex items-center justify-center gap-2"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                        </svg>
                                        Malzeme Analizi
                                    </button>
                                </div>
                                
                                <div className="mt-4 border-t pt-4">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">G√∂r√ºn√ºm</h4>
                                    
                                    <button 
                                        onClick={toggleTheme}
                                        className="w-full px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-indigo-600 hover:to-purple-700 transition-all flex items-center justify-center gap-2"
                                    >
                                        {theme === 'light' ? (
                                            <>
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                                </svg>
                                                Koyu Tema
                                            </>
                                        ) : (
                                            <>
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                                </svg>
                                                A√ßƒ±k Tema
                                            </>
                                        )}
                                    </button>
                                </div>
                                
                                <div className="border-t pt-3 mt-3">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Bulut Senkronizasyon</h4>
                                    
                                    {firebaseEnabled ? (
                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border border-blue-200">
                                                <div className="flex items-center gap-2">
                                                    <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                                                    </svg>
                                                    <div>
                                                        <div className="text-sm font-semibold text-blue-900">Firebase Senkronizasyon</div>
                                                        <div className="text-xs text-blue-700">√áoklu cihaz desteƒüi</div>
                                                    </div>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={firebaseSync} 
                                                        onChange={(e) => {
                                                            setFirebaseSync(e.target.checked);
                                                            localStorage.setItem('firebase_sync', e.target.checked);
                                                        }}
                                                        className="sr-only peer" 
                                                    />
                                                    <div className="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                                </label>
                                            </div>
                                            {lastSyncTime && (
                                                <p className="text-xs text-gray-600 flex items-center gap-1 px-2">
                                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    Son senkronizasyon: {lastSyncTime.toLocaleString('tr-TR')}
                                                </p>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                            <div className="flex items-start gap-2">
                                                <svg className="w-5 h-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                </svg>
                                                <div className="text-xs text-yellow-800">
                                                    <p className="font-semibold mb-1">Firebase yapƒ±landƒ±rmasƒ± eksik</p>
                                                    <p>√áoklu cihaz senkronizasyonu i√ßin Firebase yapƒ±landƒ±rmasƒ± gerekiyor.</p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="border-t pt-3 mt-3">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Veri Y√∂netimi</h4>
                                    <button onClick={exportData} className="w-full mb-2 px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-indigo-600 hover:to-purple-700 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                        </svg>
                                        Dƒ±≈üa Aktar
                                    </button>
                                    <button onClick={importData} className="w-full px-4 py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-orange-600 hover:to-red-700 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        ƒ∞√ße Aktar
                                    </button>
                                </div>
                                
                                <div className="border-t pt-3 mt-3">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Raporlar</h4>
                                    <button onClick={generatePrintForm} className="w-full mb-2 px-4 py-3 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-red-600 hover:to-rose-700 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Onay Formu
                                    </button>
                                    <button onClick={downloadExcel} className="w-full px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-700 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-green-700 hover:to-emerald-800 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Excel Raporu
                                    </button>
                                </div>
                                
                                <div className="border-t pt-3 mt-3">
                                    <h4 className="text-xs font-bold text-gray-500 mb-3 tracking-wide uppercase">Ayarlar</h4>
                                    <button onClick={() => setShowDB(true)} className="w-full mb-2 px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-purple-600 hover:to-pink-700 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                                        </svg>
                                        Malzeme DB
                                    </button>
                                    <button onClick={() => setShowDefaultSettings(true)} className="w-full mb-2 px-4 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-emerald-600 hover:to-teal-700 transition-all flex items-center justify-center gap-2">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        Sistem Ayarlarƒ±
                                    </button>
                                    <button onClick={convertAllText} className="w-full px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg hover:from-amber-600 hover:to-orange-700 transition-all flex items-center justify-center gap-2" title="T√ºm metinleri 'ƒ∞lk Harf B√ºy√ºk diƒüerleri k√º√ß√ºk' formatƒ±na √ßevirir">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                                        </svg>
                                        Metin Formatƒ±
                                    </button>
                                </div>
                            </div>
                            
                            <div className="col-span-2">
                                {/* Modern Header */}
                                <div className="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg shadow-lg p-6 mb-6">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-4">
                                            {/* Logo */}
                                            <div className="bg-white rounded-full p-3 shadow-md">
                                                <svg className="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                                </svg>
                                            </div>
                                            {/* Ba≈ülƒ±k Bilgileri */}
                                            <div>
                                                <h1 className="text-2xl font-bold text-white">{room ? room.name : ''}</h1>
                                                <p className="text-blue-100 text-sm flex items-center gap-2">
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                                    </svg>
                                                    {getProject().name}
                                                    <span className="mx-2">‚Ä¢</span>
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                                    </svg>
                                                    {getApt().name}
                                                </p>
                                            </div>
                                        </div>
                                        {/* Saƒü Taraf: Tarih */}
                                        <div className="flex items-center gap-3">
                                            {/* Tarih Badge */}
                                            <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-lg px-4 py-2">
                                                <p className="text-white text-xs font-medium">
                                                    {new Date().toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Veri Giri≈ü Alanlarƒ± - Kategorilere G√∂re Gruplandƒ±rƒ±lmƒ±≈ü */}
                                <div className="space-y-6" key={refreshKey}>
                                    {room && (() => {
                                        // fieldLabels'ƒ±n sƒ±rasƒ±na g√∂re grupla (Kaydet'teki sƒ±rayƒ± koru)
                                        const grouped = {};
                                        const fotoField = room.fields.includes('foto') ? 'foto' : null;
                                        const fieldOrder = Object.keys(fieldLabels); // fieldLabels'ƒ±n sƒ±rasƒ±
                                        
                                        room.fields.filter(f => f !== 'foto').forEach(f => {
                                            const fc = fieldLabels[f];
                                            if (!fc) return;
                                            
                                            const category = fc.category || 'Diƒüer';
                                            if (!grouped[category]) grouped[category] = [];
                                            grouped[category].push(f);
                                        });
                                        
                                        // Her kategorideki field'larƒ± fieldLabels sƒ±rasƒ±na g√∂re sƒ±rala
                                        Object.keys(grouped).forEach(cat => {
                                            grouped[cat].sort((a, b) => {
                                                return fieldOrder.indexOf(a) - fieldOrder.indexOf(b);
                                            });
                                        });
                                        
                                        // Kategorileri de fieldLabels'da ilk g√∂r√ºnme sƒ±rasƒ±na g√∂re al
                                        const categoryFirstAppearance = {};
                                        fieldOrder.forEach((fieldKey, idx) => {
                                            const fc = fieldLabels[fieldKey];
                                            const cat = fc.category || 'Diƒüer';
                                            if (categoryFirstAppearance[cat] === undefined) {
                                                categoryFirstAppearance[cat] = idx;
                                            }
                                        });
                                        
                                        const sortedCategories = Object.keys(grouped).sort((a, b) => {
                                            return categoryFirstAppearance[a] - categoryFirstAppearance[b];
                                        });
                                        
                                        return (
                                            <>
                                                {sortedCategories.map(category => (
                                                    <div key={category}>
                                                        {/* Kategori Ba≈ülƒ±ƒüƒ± */}
                                                        <div className="mb-4">
                                                            <div className={`flex items-center gap-2 px-4 py-2.5 rounded-lg ${
                                                                theme === 'dark'
                                                                    ? 'bg-gradient-to-r from-blue-600 to-purple-700'
                                                                    : 'bg-gradient-to-r from-blue-500 to-purple-600'
                                                            }`}>
                                                                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                                </svg>
                                                                <h3 className="text-white font-bold text-lg">
                                                                    {category}
                                                                </h3>
                                                                <span className="ml-auto text-white text-sm bg-white bg-opacity-20 px-2.5 py-0.5 rounded-full">
                                                                    {grouped[category].length} Alan
                                                                </span>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Kategorideki Alanlar */}
                                                        <div className="mb-6">
                                                            {grouped[category].map((f, idx) => (
                                                                <div 
                                                                    key={f}
                                                                    className={idx > 0 ? 'mt-3' : ''}
                                                                >
                                                                    {renderField(f)}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                                
                                                {/* Foto alanƒ±nƒ± her zaman en sona ekle */}
                                                {fotoField && (
                                                    <div>
                                                        <div className="mb-4">
                                                            <div className={`flex items-center gap-2 px-4 py-2.5 rounded-lg ${
                                                                theme === 'dark'
                                                                    ? 'bg-gradient-to-r from-purple-600 to-pink-700'
                                                                    : 'bg-gradient-to-r from-purple-500 to-pink-600'
                                                            }`}>
                                                                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                                </svg>
                                                                <h3 className="text-white font-bold text-lg">
                                                                    Fotoƒüraflar
                                                                </h3>
                                                            </div>
                                                        </div>
                                                        {renderField(fotoField)}
                                                    </div>
                                                )}
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
